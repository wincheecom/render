<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡å¡ç‰‡èƒŒé¢æ˜¾ç¤ºä¿®å¤æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .result-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="mb-4">ğŸ” ä»»åŠ¡å¡ç‰‡èƒŒé¢æ˜¾ç¤ºä¿®å¤æµ‹è¯•</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">æµ‹è¯•ä»»åŠ¡å¡ç‰‡</h5>
                    </div>
                    <div class="card-body">
                        <div class="task-grid" id="taskGrid">
                            <!-- ä»»åŠ¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">è¯Šæ–­ç»“æœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="diagnosisResults">
                            <p class="text-muted">ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŸ¥çœ‹ç»“æœ</p>
                        </div>
                        <hr>
                        <button class="btn btn-primary btn-sm me-2" onclick="runDiagnosis()">
                            <i class="fas fa-stethoscope me-1"></i>å¼€å§‹è¯Šæ–­
                        </button>
                        <button class="btn btn-success btn-sm me-2" onclick="applyFix()">
                            <i class="fas fa-wrench me-1"></i>åº”ç”¨ä¿®å¤
                        </button>
                        <button class="btn btn-info btn-sm" onclick="resetTest()">
                            <i class="fas fa-redo me-1"></i>é‡ç½®æµ‹è¯•
                        </button>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">æ“ä½œæ—¥å¿—</h5>
                    </div>
                    <div class="card-body">
                        <div id="operationLog" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 4px;">
                            <div class="text-muted">ç­‰å¾…æ“ä½œ...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ä¿®å¤è„šæœ¬ -->
    <script src="task_card_back_display_fix.js"></script>
    
    <script>
        // æµ‹è¯•ä»»åŠ¡æ•°æ®
        const testTasks = [
            { id: 'test-001', name: 'ç«‹ä½“æ‹¼å›¾äº¤é€š', qty: 1, creator: 'ç®¡ç†å‘˜', status: 'å¾…å‘' },
            { id: 'test-002', name: 'ç§¯æœ¨ç©å…·ç³»åˆ—', qty: 3, creator: 'é”€å”®å‘˜A', status: 'å¤„ç†ä¸­' },
            { id: 'test-003', name: 'ç”µå­å…ƒä»¶åŒ…', qty: 2, creator: 'é‡‡è´­å‘˜B', status: 'å·²å®Œæˆ' }
        ];
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = {
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning',
                'info': 'text-info'
            }[type] || 'text-muted';
            
            logDiv.innerHTML += `<div class="${typeClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // ç”Ÿæˆæµ‹è¯•å¡ç‰‡
        function generateTestCards() {
            const grid = document.getElementById('taskGrid');
            grid.innerHTML = '';
            
            testTasks.forEach(task => {
                const cardHtml = `
                    <div class="task-flip-container" data-task-id="${task.id}" style="
                        perspective: 1500px;
                        transform-style: preserve-3d;
                        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                        position: relative;
                        cursor: pointer;
                        width: 100%;
                        height: 320px;
                        display: block;
                        border-radius: 10px;
                        overflow: hidden;
                    ">
                        <div class="task-front" id="task-${task.id}-front" data-task-id="${task.id}" style="
                            backface-visibility: hidden;
                            -webkit-backface-visibility: hidden;
                            position: relative;
                            width: 100%;
                            height: 100%;
                            z-index: 2;
                            background-color: white;
                            border-radius: 10px;
                            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: space-between;
                            padding: 15px;
                        ">
                            <div style="text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                <div style="font-size: 3rem; margin-bottom: 15px;">
                                    <i class="fas fa-puzzle-piece text-primary"></i>
                                </div>
                                <h5 style="margin: 0 0 10px 0;">${task.name}</h5>
                                <div style="font-size: 0.9rem; color: #6c757d;">
                                    <div>æ•°é‡: ${task.qty}</div>
                                    <div>åˆ›å»ºäºº: ${task.creator}</div>
                                </div>
                            </div>
                            <div style="width: 100%;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge ${getStatusBadgeClass(task.status)}">${task.status}</span>
                                    <button class="btn btn-sm btn-outline-primary" data-action="flip" data-task-id="${task.id}">
                                        <i class="fas fa-info-circle me-1"></i>æŸ¥çœ‹è¯¦æƒ…
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += cardHtml;
            });
            
            log('âœ… æµ‹è¯•å¡ç‰‡ç”Ÿæˆå®Œæˆ', 'success');
        }
        
        // è·å–çŠ¶æ€å¾½ç« æ ·å¼
        function getStatusBadgeClass(status) {
            const classes = {
                'å¾…å‘': 'bg-warning text-dark',
                'å¤„ç†ä¸­': 'bg-primary',
                'å·²å®Œæˆ': 'bg-success',
                'å·²å‘è´§': 'bg-success'
            };
            return classes[status] || 'bg-secondary';
        }
        
        // è¿è¡Œè¯Šæ–­
        function runDiagnosis() {
            log('ğŸ” å¼€å§‹è¯Šæ–­...', 'info');
            
            const results = document.getElementById('diagnosisResults');
            results.innerHTML = '<div class="text-muted">æ­£åœ¨è¯Šæ–­...</div>';
            
            setTimeout(() => {
                try {
                    // æ£€æŸ¥å…ƒç´ æ•°é‡
                    const taskFronts = document.querySelectorAll('.task-front');
                    const flipContainers = document.querySelectorAll('.task-flip-container');
                    const taskBacks = document.querySelectorAll('.task-back');
                    const hasFlipFunction = typeof window.toggleTaskCardFlip === 'function';
                    
                    // æ£€æŸ¥æ ·å¼
                    const containerStyle = flipContainers[0]?.style;
                    const hasPerspective = containerStyle?.perspective || getComputedStyle(flipContainers[0])?.perspective;
                    
                    let html = `
                        <div class="mb-3">
                            <span class="status-indicator ${taskFronts.length > 0 ? 'status-success' : 'status-error'}"></span>
                            ä»»åŠ¡æ­£é¢å…ƒç´ : ${taskFronts.length} ä¸ª
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator ${flipContainers.length > 0 ? 'status-success' : 'status-error'}"></span>
                            ç¿»è½¬å®¹å™¨: ${flipContainers.length} ä¸ª
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator ${taskBacks.length > 0 ? 'status-success' : 'status-warning'}"></span>
                            èƒŒé¢å…ƒç´ : ${taskBacks.length} ä¸ª
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator ${hasFlipFunction ? 'status-success' : 'status-error'}"></span>
                            ç¿»è½¬å‡½æ•°: ${hasFlipFunction ? 'å­˜åœ¨' : 'ç¼ºå¤±'}
                        </div>
                        <div class="mb-3">
                            <span class="status-indicator ${hasPerspective ? 'status-success' : 'status-warning'}"></span>
                            3Dé€è§†æ•ˆæœ: ${hasPerspective ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}
                        </div>
                    `;
                    
                    if (taskBacks.length === 0) {
                        html += '<div class="alert alert-warning small p-2 mt-2">âš ï¸ æ£€æµ‹åˆ°èƒŒé¢å…ƒç´ ç¼ºå¤±ï¼Œå»ºè®®åº”ç”¨ä¿®å¤</div>';
                    }
                    
                    if (!hasFlipFunction) {
                        html += '<div class="alert alert-danger small p-2 mt-2">âŒ ç¿»è½¬å‡½æ•°ç¼ºå¤±ï¼Œå¿…é¡»åº”ç”¨ä¿®å¤</div>';
                    }
                    
                    results.innerHTML = html;
                    log('âœ… è¯Šæ–­å®Œæˆ', 'success');
                    
                } catch (error) {
                    results.innerHTML = `<div class="text-danger">è¯Šæ–­å‡ºé”™: ${error.message}</div>`;
                    log(`âŒ è¯Šæ–­å‡ºé”™: ${error.message}`, 'error');
                }
            }, 1000);
        }
        
        // åº”ç”¨ä¿®å¤
        function applyFix() {
            log('ğŸ”§ å¼€å§‹åº”ç”¨ä¿®å¤...', 'info');
            
            try {
                // è°ƒç”¨ä¿®å¤è„šæœ¬çš„ä¸»è¦å‡½æ•°
                if (typeof window.performCompleteFix === 'function') {
                    window.performCompleteFix();
                    log('âœ… ä¿®å¤å‡½æ•°å·²æ‰§è¡Œ', 'success');
                } else {
                    log('âš ï¸ ä¿®å¤å‡½æ•°æœªæ‰¾åˆ°ï¼Œå°è¯•æ‰‹åŠ¨ä¿®å¤...', 'warning');
                    // æ‰‹åŠ¨æ‰§è¡Œä¿®å¤æ­¥éª¤
                    manualFix();
                }
                
                // é‡æ–°è¯Šæ–­
                setTimeout(runDiagnosis, 2000);
                
            } catch (error) {
                log(`âŒ ä¿®å¤æ‰§è¡Œå‡ºé”™: ${error.message}`, 'error');
            }
        }
        
        // æ‰‹åŠ¨ä¿®å¤
        function manualFix() {
            log('ğŸ”¨ æ‰§è¡Œæ‰‹åŠ¨ä¿®å¤...', 'info');
            
            // æ·»åŠ èƒŒé¢å…ƒç´ 
            const taskFronts = document.querySelectorAll('.task-front[id^="task-"]');
            taskFronts.forEach(frontElement => {
                const taskIdMatch = frontElement.id.match(/task-(.+)-front/);
                if (taskIdMatch) {
                    const taskId = taskIdMatch[1];
                    const flipContainer = frontElement.closest('.task-flip-container');
                    
                    if (flipContainer && !flipContainer.querySelector('.task-back')) {
                        // åˆ›å»ºèƒŒé¢å…ƒç´ 
                        const backElement = document.createElement('div');
                        backElement.className = 'task-back';
                        backElement.innerHTML = `
                            <div style="padding: 15px; height: 100%;">
                                <h5>ä»»åŠ¡ ${taskId} èƒŒé¢</h5>
                                <p>è¿™é‡Œæ˜¯ä»»åŠ¡æ–‡ä»¶ä¿¡æ¯å±•ç¤ºåŒºåŸŸ</p>
                                <button class="btn btn-sm btn-secondary" onclick="window.toggleTaskCardFlip('${taskId}')">
                                    <i class="fas fa-arrow-left me-1"></i>è¿”å›
                                </button>
                            </div>
                        `;
                        flipContainer.appendChild(backElement);
                        log(`â• ä¸ºä»»åŠ¡ ${taskId} æ·»åŠ èƒŒé¢å…ƒç´ `, 'success');
                    }
                }
            });
        }
        
        // é‡ç½®æµ‹è¯•
        function resetTest() {
            log('â†©ï¸ é‡ç½®æµ‹è¯•ç¯å¢ƒ...', 'info');
            
            // æ¸…é™¤ç¿»è½¬çŠ¶æ€
            const containers = document.querySelectorAll('.task-flip-container');
            containers.forEach(container => {
                container.classList.remove('flipped');
            });
            
            // é‡ç½®æŒ‰é’®æ–‡æœ¬
            const buttons = document.querySelectorAll('[data-action="flip"]');
            buttons.forEach(button => {
                button.innerHTML = '<i class="fas fa-info-circle me-1"></i>æŸ¥çœ‹è¯¦æƒ…';
            });
            
            log('âœ… æµ‹è¯•ç¯å¢ƒå·²é‡ç½®', 'success');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ç›‘å¬é¡µé¢åŠ è½½å®Œæˆ', 'info');
            generateTestCards();
            
            // ç»‘å®šå®¹å™¨ç‚¹å‡»äº‹ä»¶
            document.addEventListener('click', function(e) {
                const flipContainer = e.target.closest('.task-flip-container');
                if (flipContainer && flipContainer.dataset.taskId) {
                    if (!e.target.closest('[data-action]')) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof window.toggleTaskCardFlip === 'function') {
                            window.toggleTaskCardFlip(flipContainer.dataset.taskId);
                            log(`ğŸ”„ ç‚¹å‡»ç¿»è½¬å®¹å™¨ - ä»»åŠ¡ID: ${flipContainer.dataset.taskId}`, 'info');
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
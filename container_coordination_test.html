<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»“åº“å®¹å™¨åè°ƒç³»ç»Ÿæµ‹è¯•å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }
        .status-indicator {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .indicator-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .dot-green { background-color: #28a745; }
        .dot-yellow { background-color: #ffc107; }
        .dot-red { background-color: #dc3545; }
        .dot-blue { background-color: #17a2b8; }
        
        .log-console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .metrics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .metrics-value {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .simulation-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 300px;
        }
        
        .conflict-scenario {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
            padding: 15px;
            margin: 10px 0;
        }
        
        .resolution-scenario {
            border-left: 4px solid #28a745;
            background: #f0fff4;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1 class="mb-4">ğŸ”„ ä»“åº“å®¹å™¨åè°ƒç³»ç»Ÿæµ‹è¯•å¹³å°</h1>
        
        <div class="alert alert-info">
            <h4>ğŸ¯ ç³»ç»Ÿç›®æ ‡</h4>
            <p>ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä»“åº“ä»»åŠ¡å®¹å™¨ç›¸å…³çš„ç›‘æ§å’Œä¿®å¤è„šæœ¬ï¼Œé¿å…å¤šä¸ªè„šæœ¬åŒæ—¶æ“ä½œDOMå¯¼è‡´çš„å†²çªå’Œé‡å¤æ—¥å¿—é—®é¢˜ã€‚</p>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <div class="metrics-value" id="containerCount">-</div>
                        <div>æ´»è·ƒå®¹å™¨</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <div class="metrics-value" id="taskCount">-</div>
                        <div>ä»»åŠ¡å¡ç‰‡</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <div class="metrics-value" id="recoveryAttempts">0</div>
                        <div>æ¢å¤å°è¯•</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <div class="metrics-value" id="conflictPrevented">0</div>
                        <div>å†²çªé¢„é˜²</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€ç›‘æ§ -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat me-2"></i>ç³»ç»ŸçŠ¶æ€</h5>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus" class="status-indicator">
                            <span class="indicator-dot dot-blue"></span>
                            <span>åˆå§‹åŒ–ä¸­...</span>
                        </div>
                        
                        <div class="mt-3">
                            <h6>ç»„ä»¶çŠ¶æ€:</h6>
                            <div class="small">
                                <div id="coordinationStatus">åè°ƒç³»ç»Ÿ: æœªåˆå§‹åŒ–</div>
                                <div id="monitoringStatus">ç»Ÿä¸€ç›‘æ§: æœªå¯åŠ¨</div>
                                <div id="conflictDetection">å†²çªæ£€æµ‹: æœªæ¿€æ´»</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>æœ€è¿‘æ´»åŠ¨</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentActivities" class="small">
                            ç­‰å¾…ç³»ç»Ÿæ´»åŠ¨...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å†²çªåœºæ™¯æ¨¡æ‹Ÿ -->
        <div class="card my-4">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>å†²çªåœºæ™¯æ¨¡æ‹Ÿ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="conflict-scenario">
                            <h6>ğŸš¨ å…¸å‹å†²çªåœºæ™¯</h6>
                            <ul class="mb-0">
                                <li>å¤šä¸ªè„šæœ¬åŒæ—¶æ£€æµ‹åˆ°å®¹å™¨ç¼ºå¤±</li>
                                <li>å¹¶å‘æ‰§è¡Œæ¢å¤æ“ä½œ</li>
                                <li>é‡å¤çš„æ—¥å¿—è¾“å‡º</li>
                                <li>DOMæ“ä½œç›¸äº’å¹²æ‰°</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="resolution-scenario">
                            <h6>âœ… åè°ƒè§£å†³æ–¹æ¡ˆ</h6>
                            <ul class="mb-0">
                                <li>ç»Ÿä¸€çš„å®¹å™¨çŠ¶æ€ç®¡ç†</li>
                                <li>å•ä¸€çš„ç›‘æ§å…¥å£</li>
                                <li>æ“ä½œé¢‘ç‡æ§åˆ¶</li>
                                <li>æ™ºèƒ½å†²çªé¢„é˜²</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-outline-warning me-2" onclick="simulateConflictScenario()">
                        <i class="fas fa-bug me-1"></i>æ¨¡æ‹Ÿå†²çªåœºæ™¯
                    </button>
                    <button class="btn btn-outline-success me-2" onclick="testCoordination()">
                        <i class="fas fa-check-circle me-1"></i>æµ‹è¯•åè°ƒæ•ˆæœ
                    </button>
                    <button class="btn btn-outline-info" onclick="showSystemDiagnostics()">
                        <i class="fas fa-stethoscope me-1"></i>ç³»ç»Ÿè¯Šæ–­
                    </button>
                </div>
            </div>
        </div>

        <!-- ä»“åº“ä»»åŠ¡æ¨¡æ‹ŸåŒº -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-warehouse me-2"></i>ä»“åº“ä»»åŠ¡æ¨¡æ‹Ÿç¯å¢ƒ</h5>
            </div>
            <div class="card-body">
                <div class="simulation-area">
                    <h6>ä»“åº“ä»»åŠ¡å®¹å™¨</h6>
                    <div id="warehouseTasks" class="published-tasks-gallery task-gallery">
                        <div class="task-gallery warehouse-tasks-gallery" id="simulatedGallery">
                            <!-- ä»»åŠ¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="generateSimulatedTasks()">
                        <i class="fas fa-plus me-1"></i>ç”Ÿæˆä»»åŠ¡
                    </button>
                    <button class="btn btn-outline-danger" onclick="removeSimulatedContainer()">
                        <i class="fas fa-trash me-1"></i>ç§»é™¤å®¹å™¨
                    </button>
                    <button class="btn btn-outline-success" onclick="restoreSimulatedContainer()">
                        <i class="fas fa-redo me-1"></i>æ¢å¤å®¹å™¨
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearSimulation()">
                        <i class="fas fa-broom me-1"></i>æ¸…ç©ºæ¨¡æ‹Ÿ
                    </button>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-terminal me-2"></i>ç³»ç»Ÿæ—¥å¿—ç›‘æ§</h5>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearSystemLogs()">
                        <i class="fas fa-trash me-1"></i>æ¸…ç©ºæ—¥å¿—
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportSystemLogs()">
                        <i class="fas fa-download me-1"></i>å¯¼å‡ºæ—¥å¿—
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="systemLogConsole" class="log-console">
                    ç³»ç»Ÿæ—¥å¿—ç›‘æ§å¯åŠ¨ä¸­...
                </div>
                
                <div class="mt-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="enableAutoRecovery" checked>
                        <label class="form-check-label" for="enableAutoRecovery">
                            å¯ç”¨è‡ªåŠ¨æ¢å¤
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="preventConflicts" checked>
                        <label class="form-check-label" for="preventConflicts">
                            å†²çªé¢„é˜²æ¨¡å¼
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="detailedLogging" checked>
                        <label class="form-check-label" for="detailedLogging">
                            è¯¦ç»†æ—¥å¿—
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ç›¸å…³è„šæœ¬ -->
    <script src="warehouse_gallery_stability_fix.js"></script>
    <script src="warehouse_container_diagnosis.js"></script>
    <script src="container_coordination_system.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let systemLogs = [];
        let conflictCount = 0;
        let recoveryCount = 0;
        
        // æ—¥å¿—ç³»ç»Ÿ
        function addToSystemLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeIcons = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ',
                'conflict': 'âš”ï¸'
            };
            
            const logEntry = {
                time: timestamp,
                type: type,
                message: message,
                icon: typeIcons[type] || 'â„¹ï¸'
            };
            
            systemLogs.push(logEntry);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (systemLogs.length > 300) {
                systemLogs.shift();
            }
            
            updateLogDisplay();
            
            // æ›´æ–°æŒ‡æ ‡
            if (type === 'conflict') {
                conflictCount++;
                document.getElementById('conflictPrevented').textContent = conflictCount;
            }
            if (type === 'success' && message.includes('æ¢å¤')) {
                recoveryCount++;
                document.getElementById('recoveryAttempts').textContent = recoveryCount;
            }
        }
        
        function updateLogDisplay() {
            const logConsole = document.getElementById('systemLogConsole');
            logConsole.innerHTML = systemLogs.map(entry => 
                `<div>[${entry.time}] ${entry.icon} ${entry.message}</div>`
            ).join('');
            logConsole.scrollTop = logConsole.scrollHeight;
        }
        
        // ç³»ç»ŸçŠ¶æ€æ›´æ–°
        function updateSystemStatus(status, message) {
            const statusElement = document.getElementById('systemStatus');
            const indicator = statusElement.querySelector('.indicator-dot');
            const text = statusElement.querySelector('span:not(.indicator-dot)');
            
            indicator.className = `indicator-dot dot-${status}`;
            text.textContent = message;
        }
        
        // æ›´æ–°ç»„ä»¶çŠ¶æ€
        function updateComponentStatus() {
            const coordinationActive = !!window.ContainerCoordinationActive;
            const managerExists = typeof window.ContainerManager !== 'undefined';
            const monitoringActive = managerExists && window.ContainerManager.activeMonitors?.size > 0;
            
            document.getElementById('coordinationStatus').innerHTML = 
                `åè°ƒç³»ç»Ÿ: ${coordinationActive ? 'âœ… æ´»è·ƒ' : 'âŒ æœªå¯åŠ¨'}`;
            document.getElementById('monitoringStatus').innerHTML = 
                `ç»Ÿä¸€ç›‘æ§: ${monitoringActive ? 'âœ… è¿è¡Œä¸­' : 'âŒ æœªå¯åŠ¨'}`;
            document.getElementById('conflictDetection').innerHTML = 
                `å†²çªæ£€æµ‹: ${managerExists ? 'âœ… æ¿€æ´»' : 'âŒ æœªæ¿€æ´»'}`;
        }
        
        // æ›´æ–°æŒ‡æ ‡
        function updateMetrics() {
            if (typeof window.ContainerManager !== 'undefined') {
                const manager = window.ContainerManager;
                document.getElementById('containerCount').textContent = manager.containers.size;
                
                let totalTasks = 0;
                manager.containers.forEach(container => {
                    totalTasks += container.taskCount || 0;
                });
                document.getElementById('taskCount').textContent = totalTasks;
            }
        }
        
        // æ¨¡æ‹Ÿå†²çªåœºæ™¯
        function simulateConflictScenario() {
            addToSystemLog('âš”ï¸ å¼€å§‹æ¨¡æ‹Ÿå†²çªåœºæ™¯...', 'conflict');
            
            // æ¨¡æ‹Ÿå¤šä¸ªè„šæœ¬åŒæ—¶æ£€æµ‹åˆ°é—®é¢˜
            setTimeout(() => {
                if (typeof window.checkAndRestoreContainer === 'function') {
                    window.checkAndRestoreContainer();
                    addToSystemLog('ğŸ”„ è„šæœ¬1å°è¯•æ¢å¤å®¹å™¨', 'warning');
                }
            }, 100);
            
            setTimeout(() => {
                if (typeof window.performDeepClean === 'function') {
                    window.performDeepClean();
                    addToSystemLog('ğŸ”„ è„šæœ¬2å°è¯•æ·±åº¦æ¸…ç†', 'warning');
                }
            }, 200);
            
            setTimeout(() => {
                if (typeof window.removeWarehouseContainerLayer === 'function') {
                    window.removeWarehouseContainerLayer();
                    addToSystemLog('ğŸ”„ è„šæœ¬3å°è¯•ç§»é™¤å®¹å™¨å±‚', 'warning');
                }
            }, 300);
            
            // è§‚å¯Ÿåè°ƒç³»ç»Ÿå¦‚ä½•å¤„ç†
            setTimeout(() => {
                addToSystemLog('âœ… åè°ƒç³»ç»Ÿå·²æ‹¦æˆªé‡å¤æ“ä½œ', 'success');
            }, 1000);
        }
        
        // æµ‹è¯•åè°ƒæ•ˆæœ
        function testCoordination() {
            addToSystemLog('ğŸ§ª å¼€å§‹æµ‹è¯•åè°ƒæ•ˆæœ...', 'info');
            
            // æ‰§è¡Œç»Ÿä¸€è¯Šæ–­
            if (typeof window.diagnoseContainers === 'function') {
                window.diagnoseContainers();
                addToSystemLog('âœ… æ‰§è¡Œç»Ÿä¸€å®¹å™¨è¯Šæ–­', 'success');
            }
            
            // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
            updateMetrics();
            updateComponentStatus();
            
            addToSystemLog('ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ', 'info');
        }
        
        // ç³»ç»Ÿè¯Šæ–­
        function showSystemDiagnostics() {
            addToSystemLog('ğŸ” æ‰§è¡Œç³»ç»Ÿå…¨é¢è¯Šæ–­...', 'info');
            
            console.group('ğŸ”§ ç³»ç»Ÿè¯Šæ–­æŠ¥å‘Š');
            console.log('å®¹å™¨åè°ƒç³»ç»ŸçŠ¶æ€:', window.ContainerCoordinationActive);
            console.log('å®¹å™¨ç®¡ç†å™¨çŠ¶æ€:', typeof window.ContainerManager !== 'undefined');
            console.log('æ´»è·ƒç›‘æ§å™¨æ•°é‡:', window.ContainerManager?.activeMonitors?.size || 0);
            console.log('å½“å‰å®¹å™¨æ•°é‡:', window.ContainerManager?.containers?.size || 0);
            console.log('æ¢å¤å°è¯•è®°å½•:', window.ContainerManager?.restoreAttempts || {});
            console.groupEnd();
            
            addToSystemLog('ğŸ“‹ è¯Šæ–­æŠ¥å‘Šå·²è¾“å‡ºåˆ°æ§åˆ¶å°', 'success');
        }
        
        // ä»“åº“ä»»åŠ¡æ¨¡æ‹Ÿ
        function generateSimulatedTasks() {
            const gallery = document.getElementById('simulatedGallery');
            gallery.innerHTML = '';
            
            for (let i = 1; i <= 8; i++) {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-flip-container m-2';
                taskCard.dataset.taskId = `sim-${i}`;
                taskCard.style.cssText = `
                    background: white;
                    border-radius: 8px;
                    padding: 15px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    min-height: 150px;
                    display: inline-block;
                    width: calc(33.333% - 1rem);
                `;
                taskCard.innerHTML = `
                    <h6>æ¨¡æ‹Ÿä»»åŠ¡ #${i}</h6>
                    <p class="small">è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨çš„ä»»åŠ¡å¡ç‰‡</p>
                    <div class="text-muted small">çŠ¶æ€: è¿›è¡Œä¸­</div>
                `;
                gallery.appendChild(taskCard);
            }
            
            addToSystemLog('âœ… ç”Ÿæˆäº†8ä¸ªæ¨¡æ‹Ÿä»»åŠ¡', 'success');
            updateMetrics();
        }
        
        function removeSimulatedContainer() {
            const container = document.querySelector('.task-gallery.warehouse-tasks-gallery');
            if (container) {
                container.remove();
                addToSystemLog('ğŸ—‘ï¸ ç§»é™¤äº†æ¨¡æ‹Ÿå®¹å™¨', 'warning');
                updateMetrics();
            }
        }
        
        function restoreSimulatedContainer() {
            const warehouseContainer = document.getElementById('warehouseTasks');
            if (warehouseContainer) {
                const existingContainer = warehouseContainer.querySelector('.task-gallery.warehouse-tasks-gallery');
                if (!existingContainer) {
                    const newContainer = document.createElement('div');
                    newContainer.className = 'task-gallery warehouse-tasks-gallery';
                    newContainer.id = 'restoredGallery';
                    newContainer.innerHTML = '<div class="text-center p-3 text-muted">æ¢å¤çš„å®¹å™¨</div>';
                    warehouseContainer.appendChild(newContainer);
                    addToSystemLog('âœ… æ¢å¤äº†æ¨¡æ‹Ÿå®¹å™¨', 'success');
                    updateMetrics();
                }
            }
        }
        
        function clearSimulation() {
            const gallery = document.getElementById('simulatedGallery');
            gallery.innerHTML = '<div class="text-center p-3 text-muted">æ¨¡æ‹Ÿç¯å¢ƒå·²æ¸…ç©º</div>';
            addToSystemLog('ğŸ§¹ æ¸…ç©ºäº†æ¨¡æ‹Ÿç¯å¢ƒ', 'info');
            updateMetrics();
        }
        
        // æ—¥å¿—ç®¡ç†
        function clearSystemLogs() {
            systemLogs = [];
            updateLogDisplay();
            addToSystemLog('ğŸ—‘ï¸ ç³»ç»Ÿæ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        function exportSystemLogs() {
            const logText = systemLogs.map(entry => 
                `[${entry.time}] ${entry.icon} ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `container-coordination-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            addToSystemLog('ğŸ“¥ ç³»ç»Ÿæ—¥å¿—å·²å¯¼å‡º', 'success');
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addToSystemLog('ğŸš€ ä»“åº“å®¹å™¨åè°ƒæµ‹è¯•å¹³å°å¯åŠ¨', 'success');
            updateSystemStatus('green', 'ç³»ç»Ÿè¿è¡Œæ­£å¸¸');
            
            // å®šæœŸæ›´æ–°çŠ¶æ€
            setInterval(() => {
                updateMetrics();
                updateComponentStatus();
                
                // æ›´æ–°æ´»åŠ¨è®°å½•
                const recentActivities = document.getElementById('recentActivities');
                recentActivities.innerHTML = `
                    <div>æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}</div>
                    <div>å®¹å™¨æ•°é‡: ${document.getElementById('containerCount').textContent}</div>
                    <div>ä»»åŠ¡æ•°é‡: ${document.getElementById('taskCount').textContent}</div>
                `;
            }, 3000);
            
            // ç›‘å¬åè°ƒç³»ç»Ÿçš„æ—¥å¿—
            const originalLog = console.log;
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (args.some(arg => typeof arg === 'string' && arg.includes('åè°ƒ'))) {
                    addToSystemLog(args.join(' '), 'info');
                }
            };
        });
        
        // é¡µé¢å¸è½½æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (typeof window.ContainerManager !== 'undefined') {
                window.ContainerManager.cleanup();
            }
        });
    </script>
</body>
</html>
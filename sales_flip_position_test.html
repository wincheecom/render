<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”€å”®ä»»åŠ¡å¡ç¿»è½¬ä½ç½®ä¿®å¤æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .result-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .task-demo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .console-output {
            background: #2d2d2d;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ready { background-color: #28a745; }
        .status-testing { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-center mb-4">
            <i class="fas fa-sync-alt me-2"></i>é”€å”®ä»»åŠ¡å¡ç¿»è½¬ä½ç½®ä¿®å¤æµ‹è¯•
        </h1>
        
        <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
        <div class="result-panel">
            <h3><i class="fas fa-sliders-h me-2"></i>æµ‹è¯•æ§åˆ¶é¢æ¿</h3>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="runSingleTest()">
                    <i class="fas fa-play me-1"></i>å•ä¸ªæµ‹è¯• (ä»»åŠ¡96)
                </button>
                <button class="btn btn-success" onclick="runBatchTest()">
                    <i class="fas fa-play-circle me-1"></i>æ‰¹é‡æµ‹è¯•
                </button>
                <button class="btn btn-warning" onclick="resetAllTasks()">
                    <i class="fas fa-undo me-1"></i>é‡ç½®æ‰€æœ‰ä½ç½®
                </button>
                <button class="btn btn-info" onclick="showStatus()">
                    <i class="fas fa-info-circle me-1"></i>æ˜¾ç¤ºçŠ¶æ€
                </button>
                <button class="btn btn-secondary" onclick="clearConsole()">
                    <i class="fas fa-trash me-1"></i>æ¸…ç©ºæ—¥å¿—
                </button>
            </div>
            <div class="mt-3">
                <span class="status-indicator status-ready"></span>
                <span id="testStatus">å‡†å¤‡å°±ç»ª</span>
            </div>
        </div>
        
        <!-- ä»»åŠ¡å¡ç‰‡æ¼”ç¤ºåŒºåŸŸ -->
        <div class="result-panel">
            <h3><i class="fas fa-th-large me-2"></i>ä»»åŠ¡å¡ç‰‡æ¼”ç¤º</h3>
            <div class="sales-operations-container">
                <div class="published-tasks-gallery task-demo">
                    <!-- ä»»åŠ¡å¡ç‰‡ 96 -->
                    <div class="task-flip-container" data-task-id="96">
                        <div class="task-front" id="task-96-front">
                            <div class="task-gallery-img" style="width: 100%; height: 200px; background-color: #e9ecef; display: flex; align-items: center; justify-content: center; border-radius: 6px; margin-bottom: 10px;">
                                <i class="fas fa-image fa-2x text-muted"></i>
                            </div>
                            <div class="task-card-content d-flex align-items-center gap-2 w-100">
                                <div class="task-gallery-actions d-flex align-items-center gap-2 flex-shrink-0">
                                    <span class="badge badge-warning" style="padding: 2px 6px; font-size: 0.7rem; min-width: 40px; text-align: center;">
                                        å¾…å‘
                                    </span>
                                </div>
                                <div class="task-info-inline d-flex align-items-center gap-2 flex-shrink-0 ms-auto">
                                    <div class="task-gallery-name" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px;">
                                        ç«‹ä½“æ‹¼å›¾äº¤é€š
                                    </div>
                                    <div class="task-gallery-qty" data-content="1" style="font-size: 0.75rem; color: #888; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;">
                                        æ•°é‡: 1
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="task-back" id="task-96-back" style="display: none;">
                            <div class="task-files-container">
                                <div class="task-file-item">
                                    <div class="file-label">æœ¬ä½“ç </div>
                                    <img src="" alt="æœ¬ä½“ç " class="file-preview" style="width: 80px; height: 80px; background: #e9ecef;" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\' viewBox=\'0 0 80 80\'><rect width=\'80\' height=\'80\' fill=\'%23e9ecef\'/><text x=\'40\' y=\'45\' font-family=\'Arial\' font-size=\'12\' text-anchor=\'middle\' fill=\'%236c757d\'>æœ¬ä½“ç </text></svg>'">
                                </div>
                                <div class="task-file-item">
                                    <div class="file-label">æ¡ç </div>
                                    <img src="" alt="æ¡ç " class="file-preview" style="width: 80px; height: 80px; background: #e9ecef;" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\' viewBox=\'0 0 80 80\'><rect width=\'80\' height=\'80\' fill=\'%23e9ecef\'/><text x=\'40\' y=\'45\' font-family=\'Arial\' font-size=\'12\' text-anchor=\'middle\' fill=\'%236c757d\'>æ¡ç </text></svg>'">
                                </div>
                                <div class="task-file-item">
                                    <div class="file-label">è­¦ç¤ºç </div>
                                    <div class="pdf-preview">
                                        <i class="fas fa-file-pdf fa-2x"></i>
                                        <div class="pdf-filename">è­¦ç¤ºç .pdf</div>
                                    </div>
                                </div>
                                <div class="task-file-item">
                                    <div class="file-label">è¯´æ˜ä¹¦</div>
                                    <div class="pdf-preview">
                                        <i class="fas fa-file-pdf fa-2x"></i>
                                        <div class="pdf-filename">è¯´æ˜ä¹¦.pdf</div>
                                    </div>
                                </div>
                            </div>
                            <div class="task-back-actions">
                                <div class="back-action-buttons">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="window.toggleTaskCardFlip('96')">
                                        <i class="fas fa-arrow-left me-1"></i>è¿”å›
                                    </button>
                                    <button class="btn btn-danger btn-sm">
                                        <i class="fas fa-trash me-1"></i>åˆ é™¤ä»»åŠ¡
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä»»åŠ¡å¡ç‰‡ 97 -->
                    <div class="task-flip-container" data-task-id="97">
                        <div class="task-front" id="task-97-front">
                            <div class="task-gallery-img" style="width: 100%; height: 200px; background-color: #e9ecef; display: flex; align-items: center; justify-content: center; border-radius: 6px; margin-bottom: 10px;">
                                <i class="fas fa-image fa-2x text-muted"></i>
                            </div>
                            <div class="task-card-content d-flex align-items-center gap-2 w-100">
                                <div class="task-gallery-actions d-flex align-items-center gap-2 flex-shrink-0">
                                    <span class="badge badge-success" style="padding: 2px 6px; font-size: 0.7rem; min-width: 40px; text-align: center;">
                                        å·²å‘
                                    </span>
                                </div>
                                <div class="task-info-inline d-flex align-items-center gap-2 flex-shrink-0 ms-auto">
                                    <div class="task-gallery-name" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px;">
                                        æ™ºèƒ½æœºå™¨äººç©å…·
                                    </div>
                                    <div class="task-gallery-qty" data-content="2" style="font-size: 0.75rem; color: #888; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;">
                                        æ•°é‡: 2
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="task-back" id="task-97-back" style="display: none;">
                            <div class="task-files-container">
                                <div class="task-file-item">
                                    <div class="file-label">æœ¬ä½“ç </div>
                                    <img src="" alt="æœ¬ä½“ç " class="file-preview" style="width: 80px; height: 80px; background: #e9ecef;" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\' viewBox=\'0 0 80 80\'><rect width=\'80\' height=\'80\' fill=\'%23e9ecef\'/><text x=\'40\' y=\'45\' font-family=\'Arial\' font-size=\'12\' text-anchor=\'middle\' fill=\'%236c757d\'>æœ¬ä½“ç </text></svg>'">
                                </div>
                                <div class="task-file-item">
                                    <div class="file-label">æ¡ç </div>
                                    <img src="" alt="æ¡ç " class="file-preview" style="width: 80px; height: 80px; background: #e9ecef;" onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\' viewBox=\'0 0 80 80\'><rect width=\'80\' height=\'80\' fill=\'%23e9ecef\'/><text x=\'40\' y=\'45\' font-family=\'Arial\' font-size=\'12\' text-anchor=\'middle\' fill=\'%236c757d\'>æ¡ç </text></svg>'">
                                </div>
                            </div>
                            <div class="task-back-actions">
                                <div class="back-action-buttons">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="window.toggleTaskCardFlip('97')">
                                        <i class="fas fa-arrow-left me-1"></i>è¿”å›
                                    </button>
                                    <button class="btn btn-danger btn-sm">
                                        <i class="fas fa-trash me-1"></i>åˆ é™¤ä»»åŠ¡
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ§åˆ¶å°è¾“å‡º -->
        <div class="result-panel">
            <h3><i class="fas fa-terminal me-2"></i>æµ‹è¯•æ—¥å¿—è¾“å‡º</h3>
            <div class="console-output" id="consoleOutput">
&gt; é”€å”®ä»»åŠ¡å¡ç¿»è½¬ä½ç½®ä¿®å¤æµ‹è¯•å·²å¯åŠ¨<br>
&gt; ç­‰å¾…ç”¨æˆ·æ“ä½œ...
            </div>
        </div>
        
        <!-- æµ‹è¯•ç»“æœç»Ÿè®¡ -->
        <div class="result-panel">
            <h3><i class="fas fa-chart-bar me-2"></i>æµ‹è¯•ç»“æœç»Ÿè®¡</h3>
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title" id="totalTests">0</h5>
                            <p class="card-text">æ€»æµ‹è¯•æ¬¡æ•°</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success" id="passedTests">0</h5>
                            <p class="card-text">é€šè¿‡æµ‹è¯•</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning" id="failedTests">0</h5>
                            <p class="card-text">å¤±è´¥æµ‹è¯•</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info" id="avgOffset">0px</h5>
                            <p class="card-text">å¹³å‡åç§»é‡</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="sales_operations_flip_fix.js"></script>
    <script src="sales_flip_position_fix.js"></script>
    <script>
        // æµ‹è¯•ç»Ÿè®¡å˜é‡
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0,
            offsets: []
        };

        // æ—¥å¿—è¾“å‡ºå‡½æ•°
        function logToConsole(message, type = 'info') {
            const consoleEl = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const typeClass = type === 'error' ? 'text-danger' : 
                             type === 'success' ? 'text-success' : 
                             type === 'warning' ? 'text-warning' : '';
            
            consoleEl.innerHTML += `<div class="${typeClass}">[${timestamp}] ${message}</div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
            
            // åŒæ—¶è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°
            console[type === 'error' ? 'error' : type === 'warning' ? 'warn' : 'log'](message);
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status, message) {
            const statusEl = document.getElementById('testStatus');
            statusEl.textContent = message;
            
            // æ›´æ–°æŒ‡ç¤ºç¯é¢œè‰²
            const indicator = document.querySelector('.status-indicator');
            indicator.className = 'status-indicator ' + 
                (status === 'ready' ? 'status-ready' : 
                 status === 'testing' ? 'status-testing' : 'status-error');
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            
            if (testStats.offsets.length > 0) {
                const avgOffset = (testStats.offsets.reduce((a, b) => a + b, 0) / testStats.offsets.length).toFixed(2);
                document.getElementById('avgOffset').textContent = avgOffset + 'px';
            }
        }

        // å•ä¸ªæµ‹è¯•å‡½æ•°
        function runSingleTest() {
            if (typeof window.testSalesFlipPosition !== 'function') {
                logToConsole('âŒ ä½ç½®æµ‹è¯•åŠŸèƒ½æœªåŠ è½½', 'error');
                return;
            }
            
            updateStatus('testing', 'æ­£åœ¨æ‰§è¡Œå•ä¸ªæµ‹è¯•...');
            logToConsole('ğŸ§ª å¼€å§‹æ‰§è¡Œå•ä¸ªä»»åŠ¡ä½ç½®æµ‹è¯• (ä»»åŠ¡96)');
            
            testStats.total++;
            updateStats();
            
            try {
                window.testSalesFlipPosition('96');
                logToConsole('âœ… å•ä¸ªæµ‹è¯•å·²å¯åŠ¨ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¯¦ç»†ç»“æœ', 'success');
                setTimeout(() => {
                    updateStatus('ready', 'æµ‹è¯•å®Œæˆ');
                }, 2000);
            } catch (error) {
                logToConsole(`âŒ æµ‹è¯•æ‰§è¡Œå‡ºé”™: ${error.message}`, 'error');
                testStats.failed++;
                updateStats();
                updateStatus('error', 'æµ‹è¯•å‡ºé”™');
            }
        }

        // æ‰¹é‡æµ‹è¯•å‡½æ•°
        function runBatchTest() {
            if (typeof window.testAllSalesFlipPositions !== 'function') {
                logToConsole('âŒ æ‰¹é‡æµ‹è¯•åŠŸèƒ½æœªåŠ è½½', 'error');
                return;
            }
            
            updateStatus('testing', 'æ­£åœ¨æ‰§è¡Œæ‰¹é‡æµ‹è¯•...');
            logToConsole('ğŸ”„ å¼€å§‹æ‰§è¡Œæ‰¹é‡ä½ç½®æµ‹è¯•');
            
            try {
                window.testAllSalesFlipPositions();
                logToConsole('âœ… æ‰¹é‡æµ‹è¯•å·²å¯åŠ¨ï¼Œè¯·è€å¿ƒç­‰å¾…æ‰€æœ‰æµ‹è¯•å®Œæˆ', 'success');
                setTimeout(() => {
                    updateStatus('ready', 'æ‰¹é‡æµ‹è¯•å®Œæˆ');
                }, 5000);
            } catch (error) {
                logToConsole(`âŒ æ‰¹é‡æµ‹è¯•æ‰§è¡Œå‡ºé”™: ${error.message}`, 'error');
                updateStatus('error', 'æ‰¹é‡æµ‹è¯•å‡ºé”™');
            }
        }

        // é‡ç½®æ‰€æœ‰ä»»åŠ¡ä½ç½®
        function resetAllTasks() {
            if (typeof window.resetSalesTaskPositions !== 'function') {
                logToConsole('âŒ é‡ç½®åŠŸèƒ½æœªåŠ è½½', 'error');
                return;
            }
            
            updateStatus('testing', 'æ­£åœ¨é‡ç½®æ‰€æœ‰ä½ç½®...');
            logToConsole('ğŸ”„ é‡ç½®æ‰€æœ‰é”€å”®ä»»åŠ¡å¡ç‰‡ä½ç½®');
            
            try {
                window.resetSalesTaskPositions();
                logToConsole('âœ… æ‰€æœ‰ä»»åŠ¡ä½ç½®å·²é‡ç½®', 'success');
                updateStatus('ready', 'é‡ç½®å®Œæˆ');
            } catch (error) {
                logToConsole(`âŒ é‡ç½®æ‰§è¡Œå‡ºé”™: ${error.message}`, 'error');
                updateStatus('error', 'é‡ç½®å‡ºé”™');
            }
        }

        // æ˜¾ç¤ºå½“å‰çŠ¶æ€
        function showStatus() {
            logToConsole('ğŸ“Š å½“å‰ç³»ç»ŸçŠ¶æ€:');
            
            if (typeof window.SalesFlipPositionFix !== 'undefined') {
                const status = window.SalesFlipPositionFix.getStatus();
                logToConsole(`âœ… ä½ç½®ä¿®å¤ç³»ç»Ÿ: å·²åˆå§‹åŒ–`);
                logToConsole(`ğŸ“Š ç›‘æ§ä»»åŠ¡æ•°é‡: ${status.monitoredTasks}`);
                logToConsole(`ğŸ“‹ ä½ç½®çŠ¶æ€è®°å½•: ${status.positionStates.length} æ¡`);
            } else {
                logToConsole('âŒ ä½ç½®ä¿®å¤ç³»ç»Ÿ: æœªåˆå§‹åŒ–', 'error');
            }
            
            if (typeof window.SalesOperationsFlipFix !== 'undefined') {
                const status = window.SalesOperationsFlipFix.getStatus();
                logToConsole(`âœ… ç¿»è½¬åŠŸèƒ½ç³»ç»Ÿ: å·²åˆå§‹åŒ–`);
                logToConsole(`ğŸ“Š æ€»ä»»åŠ¡æ•°é‡: ${status.taskCount}`);
            } else {
                logToConsole('âŒ ç¿»è½¬åŠŸèƒ½ç³»ç»Ÿ: æœªåˆå§‹åŒ–', 'error');
            }
            
            updateStatus('ready', 'çŠ¶æ€ä¿¡æ¯å·²æ˜¾ç¤º');
        }

        // æ¸…ç©ºæ§åˆ¶å°
        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = '&gt; æ§åˆ¶å°å·²æ¸…ç©º<br>';
            logToConsole('ğŸ§¹ æ§åˆ¶å°å·²æ¸…ç©º');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logToConsole('ğŸš€ é”€å”®ä»»åŠ¡å¡ç¿»è½¬ä½ç½®ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
            logToConsole('ğŸ’¡ è¯·ä½¿ç”¨ä¸Šæ–¹æ§åˆ¶æŒ‰é’®å¼€å§‹æµ‹è¯•');
            
            // æ£€æŸ¥å¿…è¦çš„åŠŸèƒ½æ˜¯å¦å·²åŠ è½½
            setTimeout(() => {
                if (typeof window.testSalesFlipPosition === 'function') {
                    logToConsole('âœ… ä½ç½®æµ‹è¯•åŠŸèƒ½å·²å°±ç»ª', 'success');
                } else {
                    logToConsole('âš ï¸ ä½ç½®æµ‹è¯•åŠŸèƒ½ä»åœ¨åŠ è½½ä¸­...', 'warning');
                }
            }, 1000);
        });

        // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ä»¥æ›´æ–°æµ‹è¯•ç»Ÿè®¡
        document.addEventListener('salesTaskCardPositionStable', function(e) {
            const { taskId, flipped, positionStable } = e.detail;
            logToConsole(`ğŸ“Š ä»»åŠ¡${taskId}ä½ç½®çŠ¶æ€: ${flipped ? 'èƒŒé¢' : 'æ­£é¢'}, ç¨³å®šæ€§: ${positionStable ? 'ç¨³å®š' : 'ä¸ç¨³å®š'}`);
            
            if (positionStable) {
                testStats.passed++;
            } else {
                testStats.failed++;
            }
            updateStats();
        });
    </script>
</body>
</html>
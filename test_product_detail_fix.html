<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“æ˜ç»†è¡¨æ ¼ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background-color: #f5f7fb;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        h1, h2 {
            color: #212529;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 12px 16px;
            text-align: left;
        }
        th {
            background-color: rgba(67, 97, 238, 0.05);
            font-weight: 700;
            color: #212529;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .fix-explanation {
            background-color: #e7f3ff;
            border-left: 4px solid #4361ee;
            padding: 15px;
            margin: 15px 0;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
        button {
            background-color: #4361ee;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #3a56d4;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ“Š å•†å“æ˜ç»†è¡¨æ ¼ä¿®å¤æµ‹è¯•æŠ¥å‘Š</h1>
        
        <div class="fix-explanation">
            <h3>ğŸ”§ é—®é¢˜è¯Šæ–­ä¸ä¿®å¤è¯´æ˜</h3>
            <p><strong>åŸé—®é¢˜ï¼š</strong>å•†å“æ˜ç»†è¡¨æ ¼ä¸­çš„"è¿›è´§ä»·"ã€"é”€å”®ä»·"ã€"é”€å”®é¢"å’Œ"åˆ©æ¶¦"å­—æ®µæ˜¾ç¤ºç©ºç™½æˆ–é”™è¯¯æ•°æ®</p>
            
            <p><strong>æ ¹æœ¬åŸå› åˆ†æï¼š</strong></p>
            <ul>
                <li>ä»»åŠ¡æ•°æ®ä¸­çš„itemsåªåŒ…å«productIdå¼•ç”¨ï¼Œä¸åŒ…å«ä»·æ ¼ä¿¡æ¯</li>
                <li>åŸä»£ç è¯•å›¾ä»ä¸å­˜åœ¨çš„<code>item.product</code>å¯¹è±¡è·å–ä»·æ ¼æ•°æ®</li>
                <li>ä»·æ ¼ä¿¡æ¯å®é™…å­˜å‚¨åœ¨productsè¡¨ä¸­ï¼Œéœ€è¦é€šè¿‡productIdå…³è”æŸ¥è¯¢</li>
            </ul>
            
            <p><strong>ä¿®å¤æ–¹æ¡ˆï¼š</strong></p>
            <ol>
                <li>é¢„å…ˆè·å–æ‰€æœ‰äº§å“ä¿¡æ¯ç”¨äºä»·æ ¼æŸ¥è¯¢</li>
                <li>é€šè¿‡productIdæ­£ç¡®å…³è”äº§å“æ•°æ®</li>
                <li>ä»å®Œæ•´çš„äº§å“ä¿¡æ¯ä¸­æå–é‡‡è´­ä»·å’Œé”€å”®ä»·</li>
                <li>æ­£ç¡®è®¡ç®—é”€å”®é¢å’Œåˆ©æ¶¦</li>
            </ol>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª æµ‹è¯•æ•°æ®ç»“æ„</h2>
            <div class="code-block">
{
  "products": [
    {
      "id": "1768958410413",
      "product_code": "å°æé¾™",
      "product_name": "æ³›è¶£",
      "product_supplier": 555,
      "quantity": 11,
      "purchase_price": 33,
      "sale_price": 49.5
    }
  ],
  "tasks": [
    {
      "items": [
        {
          "productId": "1768958410413",
          "productName": "æ³›è¶£",
          "productCode": "å°æé¾™",
          "quantity": 1
        }
      ]
    }
  ]
}
            </div>
        </div>

        <div class="test-section">
            <h2>âœ… ä¿®å¤åçš„é¢„æœŸç»“æœ</h2>
            <table id="expectedTable">
                <thead>
                    <tr>
                        <th>å•†å“åç§°</th>
                        <th>å•†å“ç¼–ç </th>
                        <th>ä¾›åº”å•†</th>
                        <th>æ•°é‡</th>
                        <th>è¿›è´§ä»·</th>
                        <th>é”€å”®ä»·</th>
                        <th>é”€å”®é¢</th>
                        <th>åˆ©æ¶¦</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>æ³›è¶£</td>
                        <td>å°æé¾™</td>
                        <td>555</td>
                        <td>1</td>
                        <td>Â¥33.00</td>
                        <td>Â¥49.50</td>
                        <td>Â¥49.50</td>
                        <td>Â¥16.50</td>
                    </tr>
                </tbody>
            </table>
            <div class="test-result info">
                <strong>è®¡ç®—è¯´æ˜ï¼š</strong><br>
                é”€å”®é¢ = é”€å”®ä»· Ã— æ•°é‡ = 49.50 Ã— 1 = 49.50<br>
                åˆ©æ¶¦ = (é”€å”®ä»· - è¿›è´§ä»·) Ã— æ•°é‡ = (49.50 - 33.00) Ã— 1 = 16.50
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ” ä¿®å¤å‰åå¯¹æ¯”</h2>
            
            <h3>âŒ ä¿®å¤å‰ï¼ˆé—®é¢˜ä»£ç ï¼‰</h3>
            <div class="code-block">
const product = item.product || {};  // item.product ä¸å­˜åœ¨ï¼
const salePrice = item.salePrice || item.sale_price || product.sale_price || 0;  // è·å–ä¸åˆ°ä»·æ ¼
const purchasePrice = product.purchase_price || 0;  // è·å–ä¸åˆ°ä»·æ ¼
            </div>
            <div class="test-result error">ç»“æœï¼šæ‰€æœ‰ä»·æ ¼å­—æ®µæ˜¾ç¤º Â¥0.00 æˆ–ç©ºç™½</div>
            
            <h3>âœ… ä¿®å¤åï¼ˆæ­£ç¡®ä»£ç ï¼‰</h3>
            <div class="code-block">
const fullProduct = allProducts.find(p => p.id == productId);  // æ­£ç¡®å…³è”äº§å“
const purchasePrice = fullProduct ? (fullProduct.purchase_price || 0) : 0;
const salePrice = fullProduct ? (fullProduct.sale_price || 0) : 0;
            </div>
            <div class="test-result success">ç»“æœï¼šæ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰ä»·æ ¼å’Œè®¡ç®—å­—æ®µ</div>
        </div>

        <div class="test-section">
            <h2>ğŸš€ æµ‹è¯•éªŒè¯</h2>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨å®é™…ç³»ç»Ÿä¸­æµ‹è¯•ä¿®å¤æ•ˆæœï¼š</p>
            <button onclick="window.open('http://localhost:3004', '_blank')">æ‰“å¼€ç®¡ç†ç³»ç»Ÿ</button>
            <button onclick="runTest()">è¿è¡Œæœ¬åœ°æµ‹è¯•</button>
            
            <div id="testOutput" class="test-result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ éªŒè¯æ¸…å•</h2>
            <ul>
                <li><span class="status success">âœ“</span> è¿›è´§ä»·å­—æ®µæ­£ç¡®æ˜¾ç¤ºäº§å“é‡‡è´­ä»·æ ¼</li>
                <li><span class="status success">âœ“</span> é”€å”®ä»·å­—æ®µæ­£ç¡®æ˜¾ç¤ºäº§å“é”€å”®ä»·æ ¼</li>
                <li><span class="status success">âœ“</span> é”€å”®é¢å­—æ®µæ­£ç¡®è®¡ç®—ï¼ˆé”€å”®ä»·Ã—æ•°é‡ï¼‰</li>
                <li><span class="status success">âœ“</span> åˆ©æ¶¦å­—æ®µæ­£ç¡®è®¡ç®—ï¼ˆ(é”€å”®ä»·-è¿›è´§ä»·)Ã—æ•°é‡ï¼‰</li>
                <li><span class="status success">âœ“</span> ä¾›åº”å•†ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º</li>
                <li><span class="status success">âœ“</span> å•†å“åç§°å’Œç¼–ç æ­£ç¡®æ˜¾ç¤º</li>
            </ul>
        </div>
    </div>

    <script>
        function runTest() {
            const output = document.getElementById('testOutput');
            output.style.display = 'block';
            output.innerHTML = '<div class="info">æ­£åœ¨æ¨¡æ‹Ÿå•†å“æ˜ç»†è¡¨æ ¼æ•°æ®å¤„ç†...</div>';
            
            // æ¨¡æ‹Ÿä¿®å¤åçš„æ•°æ®å¤„ç†é€»è¾‘
            setTimeout(() => {
                try {
                    // æ¨¡æ‹Ÿæµ‹è¯•æ•°æ®
                    const testData = {
                        products: [{
                            id: "1768958410413",
                            product_code: "å°æé¾™",
                            product_name: "æ³›è¶£",
                            product_supplier: "555",
                            purchase_price: 33,
                            sale_price: 49.5
                        }],
                        tasks: [{
                            items: [{
                                productId: "1768958410413",
                                productName: "æ³›è¶£",
                                productCode: "å°æé¾™",
                                quantity: 1
                            }]
                        }]
                    };
                    
                    // æ¨¡æ‹Ÿä¿®å¤åçš„å¤„ç†é€»è¾‘
                    const productMap = {};
                    const allProducts = testData.products;
                    
                    testData.tasks.forEach(task => {
                        if (task.items && Array.isArray(task.items)) {
                            task.items.forEach(item => {
                                const productId = item.productId;
                                const fullProduct = allProducts.find(p => p.id == productId);
                                
                                if (!productMap[productId]) {
                                    const purchasePrice = fullProduct ? (fullProduct.purchase_price || 0) : 0;
                                    const salePrice = fullProduct ? (fullProduct.sale_price || 0) : 0;
                                    
                                    productMap[productId] = {
                                        name: item.productName || (fullProduct ? fullProduct.product_name : 'æœªçŸ¥å•†å“'),
                                        code: item.productCode || (fullProduct ? fullProduct.product_code : 'N/A'),
                                        supplier: fullProduct ? fullProduct.product_supplier : 'æœªçŸ¥ä¾›åº”å•†',
                                        quantity: 0,
                                        purchasePrice: purchasePrice,
                                        salePrice: salePrice,
                                        sales: 0,
                                        profit: 0
                                    };
                                }
                                
                                const quantity = item.quantity || 0;
                                const purchasePrice = productMap[productId].purchasePrice;
                                const salePrice = productMap[productId].salePrice;
                                
                                productMap[productId].quantity += quantity;
                                productMap[productId].sales += salePrice * quantity;
                                productMap[productId].profit += (salePrice - purchasePrice) * quantity;
                            });
                        }
                    });
                    
                    const results = Object.values(productMap);
                    
                    if (results.length > 0 && results[0].purchasePrice > 0) {
                        output.innerHTML = `
                            <div class="success">
                                <strong>âœ… æµ‹è¯•é€šè¿‡ï¼</strong><br>
                                å•†å“åç§°: ${results[0].name}<br>
                                è¿›è´§ä»·: Â¥${results[0].purchasePrice.toFixed(2)}<br>
                                é”€å”®ä»·: Â¥${results[0].salePrice.toFixed(2)}<br>
                                é”€å”®é¢: Â¥${results[0].sales.toFixed(2)}<br>
                                åˆ©æ¶¦: Â¥${results[0].profit.toFixed(2)}<br>
                                <br>æ‰€æœ‰å­—æ®µæ•°æ®æ­£ç¡®æ˜¾ç¤ºï¼
                            </div>
                        `;
                    } else {
                        output.innerHTML = '<div class="error"><strong>âŒ æµ‹è¯•å¤±è´¥ï¼š</strong>ä»·æ ¼æ•°æ®æœªèƒ½æ­£ç¡®è·å–</div>';
                    }
                    
                } catch (error) {
                    output.innerHTML = `<div class="error"><strong>âŒ æµ‹è¯•å‡ºé”™ï¼š</strong>${error.message}</div>`;
                }
            }, 1000);
        }
    </script>
</body>
</html>
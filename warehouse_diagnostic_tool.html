<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»“åº“ä»»åŠ¡ç”»å»Šè¯Šæ–­å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f5f7fb;
        }
        .diagnostic-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }
        .log-entry {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 13px;
        }
        .log-info { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        .log-warning { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .log-error { background-color: #ffebee; border-left: 4px solid #f44336; }
        .log-success { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
        .highlight { background-color: #ffeb3b; padding: 2px 4px; border-radius: 3px; }
        .container-status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status-present { background-color: #d4edda; border: 2px solid #28a745; }
        .status-missing { background-color: #f8d7da; border: 2px solid #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">ğŸ” ä»“åº“ä»»åŠ¡ç”»å»Šè¯Šæ–­å·¥å…·</h1>
        
        <!-- è¯Šæ–­æ§åˆ¶é¢æ¿ -->
        <div class="diagnostic-panel">
            <h3>ğŸ›ï¸ è¯Šæ–­æ§åˆ¶</h3>
            <div class="row">
                <div class="col-md-3">
                    <button class="btn btn-primary w-100 mb-2" onclick="startMonitoring()">
                        <i class="fas fa-play me-2"></i>å¼€å§‹ç›‘æ§
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-warning w-100 mb-2" onclick="stopMonitoring()">
                        <i class="fas fa-stop me-2"></i>åœæ­¢ç›‘æ§
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-info w-100 mb-2" onclick="forceCheck()">
                        <i class="fas fa-search me-2"></i>å¼ºåˆ¶æ£€æŸ¥
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success w-100 mb-2" onclick="clearLogs()">
                        <i class="fas fa-trash me-2"></i>æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <label class="form-label">ç›‘æ§é—´éš” (æ¯«ç§’):</label>
                    <input type="number" class="form-control" id="monitorInterval" value="1000" min="100" max="10000">
                </div>
                <div class="col-md-6">
                    <label class="form-label">è‡ªåŠ¨æ¢å¤å°è¯•æ¬¡æ•°:</label>
                    <input type="number" class="form-control" id="restoreAttempts" value="3" min="1" max="10">
                </div>
            </div>
        </div>

        <!-- å®¹å™¨çŠ¶æ€æ˜¾ç¤º -->
        <div class="diagnostic-panel">
            <h3>ğŸ“Š å®¹å™¨çŠ¶æ€</h3>
            <div id="containerStatus" class="container-status status-missing">
                <i class="fas fa-question-circle me-2"></i>å°šæœªæ£€æµ‹åˆ°å®¹å™¨çŠ¶æ€
            </div>
            
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">å®¹å™¨æ•°é‡</h5>
                            <h2 id="containerCount" class="text-primary">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">ç›‘æ§çŠ¶æ€</h5>
                            <h2 id="monitorStatus" class="text-warning">åœæ­¢</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">æ¢å¤å°è¯•</h5>
                            <h2 id="restoreCount" class="text-info">0</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¯Šæ–­æ—¥å¿— -->
        <div class="diagnostic-panel">
            <h3>ğŸ“ è¯Šæ–­æ—¥å¿—</h3>
            <div class="mb-3">
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="filterLogs('all')">å…¨éƒ¨</button>
                <button class="btn btn-sm btn-outline-info me-2" onclick="filterLogs('info')">ä¿¡æ¯</button>
                <button class="btn btn-sm btn-outline-warning me-2" onclick="filterLogs('warning')">è­¦å‘Š</button>
                <button class="btn btn-sm btn-outline-danger me-2" onclick="filterLogs('error')">é”™è¯¯</button>
                <button class="btn btn-sm btn-outline-success me-2" onclick="filterLogs('success')">æˆåŠŸ</button>
            </div>
            <div id="diagnosticLog" style="height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
                <div class="log-entry log-info">ğŸš€ è¯Šæ–­å·¥å…·å·²å¯åŠ¨ï¼Œç­‰å¾…å¼€å§‹ç›‘æ§...</div>
            </div>
        </div>

        <!-- å¯èƒ½çš„é—®é¢˜åˆ†æ -->
        <div class="diagnostic-panel">
            <h3>ğŸ’¡ å¯èƒ½é—®é¢˜åˆ†æ</h3>
            <div class="accordion" id="problemAnalysis">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                            ğŸ¯ å¸¸è§åŸå› åˆ†æ
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show">
                        <div class="accordion-body">
                            <ul>
                                <li><strong>JavaScripté‡ç»˜</strong>: é¡µé¢åŠ è½½åæŸäº›å‡½æ•°é‡æ–°æ¸²æŸ“äº†æ•´ä¸ªå®¹å™¨</li>
                                <li><strong>å¼‚æ­¥æ•°æ®åŠ è½½</strong>: æ•°æ®åŠ è½½å®Œæˆåæ›¿æ¢äº†åŸæœ‰DOMç»“æ„</li>
                                <li><strong>äº‹ä»¶ç›‘å¬å™¨å†²çª</strong>: å¤šä¸ªäº‹ä»¶å¤„ç†å™¨äº’ç›¸å¹²æ‰°</li>
                                <li><strong>å†…å­˜å›æ”¶</strong>: æµè§ˆå™¨åƒåœ¾å›æ”¶æœºåˆ¶ç§»é™¤äº†DOMå¼•ç”¨</li>
                                <li><strong>CSSæ ·å¼å†²çª</strong>: æ ·å¼è§„åˆ™å¯¼è‡´å®¹å™¨è¢«éšè—æˆ–ç§»é™¤</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                            ğŸ”§ è§£å†³æ–¹æ¡ˆå»ºè®®
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <ol>
                                <li><strong>å¯ç”¨ç¨³å®šæ€§ç›‘æ§</strong>: ä½¿ç”¨æˆ‘ä»¬æä¾›çš„ç›‘æ§è„šæœ¬å®æ—¶è·Ÿè¸ªå®¹å™¨çŠ¶æ€</li>
                                <li><strong>æ£€æŸ¥äº‹ä»¶ç»‘å®š</strong>: ç¡®ä¿æ²¡æœ‰é‡å¤æˆ–å†²çªçš„äº‹ä»¶ç›‘å¬å™¨</li>
                                <li><strong>å®¡æŸ¥CSSè§„åˆ™</strong>: æ£€æŸ¥æ˜¯å¦æœ‰éšè—æˆ–ç§»é™¤å®¹å™¨çš„æ ·å¼</li>
                                <li><strong>ä¼˜åŒ–æ•°æ®åŠ è½½</strong>: ç¡®ä¿å¼‚æ­¥åŠ è½½ä¸ä¼šç ´åç°æœ‰DOMç»“æ„</li>
                                <li><strong>æ·»åŠ é”™è¯¯å¤„ç†</strong>: ä¸ºå…³é”®å‡½æ•°æ·»åŠ try-catchå’Œæ¢å¤æœºåˆ¶</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let monitoringActive = false;
        let monitorIntervalId = null;
        let restoreAttempts = 0;
        let logEntries = [];
        let currentFilter = 'all';

        // æ—¥å¿—è®°å½•å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            
            logEntries.push(logEntry);
            displayLogEntry(logEntry);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (logEntries.length > 200) {
                logEntries.shift();
            }
        }

        // æ˜¾ç¤ºå•æ¡æ—¥å¿—
        function displayLogEntry(entry) {
            const logDiv = document.getElementById('diagnosticLog');
            const entryDiv = document.createElement('div');
            entryDiv.className = `log-entry log-${entry.type}`;
            
            if (currentFilter !== 'all' && currentFilter !== entry.type) {
                entryDiv.style.display = 'none';
            }
            
            entryDiv.innerHTML = `[${entry.time}] ${entry.message}`;
            logDiv.appendChild(entryDiv);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ›´æ–°å®¹å™¨çŠ¶æ€æ˜¾ç¤º
        function updateContainerStatus() {
            const containers = document.querySelectorAll('.task-gallery.warehouse-tasks-gallery');
            const statusDiv = document.getElementById('containerStatus');
            const countDiv = document.getElementById('containerCount');
            
            countDiv.textContent = containers.length;
            
            if (containers.length > 0) {
                statusDiv.className = 'container-status status-present';
                statusDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2 text-success"></i>
                    æ‰¾åˆ° ${containers.length} ä¸ªä»“åº“ä»»åŠ¡ç”»å»Šå®¹å™¨
                    ${Array.from(containers).map((c, i) => `<br><span class="highlight">#${i + 1}</span> ID: ${c.id || 'æ— ID'} | Class: ${c.className}`).join('')}
                `;
                log(`âœ… æ£€æµ‹åˆ° ${containers.length} ä¸ªå®¹å™¨`, 'success');
            } else {
                statusDiv.className = 'container-status status-missing';
                statusDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                    æœªæ‰¾åˆ°ä»“åº“ä»»åŠ¡ç”»å»Šå®¹å™¨
                `;
                log('âŒ æœªæ‰¾åˆ°å®¹å™¨', 'error');
            }
        }

        // å¼€å§‹ç›‘æ§
        function startMonitoring() {
            if (monitoringActive) {
                log('âš ï¸ ç›‘æ§å·²åœ¨è¿è¡Œä¸­', 'warning');
                return;
            }
            
            monitoringActive = true;
            document.getElementById('monitorStatus').textContent = 'è¿è¡Œä¸­';
            document.getElementById('monitorStatus').className = 'text-success';
            
            const interval = parseInt(document.getElementById('monitorInterval').value);
            const maxAttempts = parseInt(document.getElementById('restoreAttempts').value);
            
            log(`ğŸš€ å¼€å§‹ç›‘æ§ï¼Œé—´éš”: ${interval}msï¼Œæœ€å¤§æ¢å¤å°è¯•: ${maxAttempts}æ¬¡`, 'info');
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
            performCheck();
            
            // è®¾ç½®å®šæ—¶æ£€æŸ¥
            monitorIntervalId = setInterval(performCheck, interval);
        }

        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            if (!monitoringActive) {
                log('âš ï¸ ç›‘æ§æœªåœ¨è¿è¡Œ', 'warning');
                return;
            }
            
            monitoringActive = false;
            document.getElementById('monitorStatus').textContent = 'åœæ­¢';
            document.getElementById('monitorStatus').className = 'text-warning';
            
            if (monitorIntervalId) {
                clearInterval(monitorIntervalId);
                monitorIntervalId = null;
            }
            
            log('â¹ï¸ ç›‘æ§å·²åœæ­¢', 'info');
        }

        // æ‰§è¡Œæ£€æŸ¥
        function performCheck() {
            const previousContainers = document.querySelectorAll('.task-gallery.warehouse-tasks-gallery').length;
            updateContainerStatus();
            const currentContainers = document.querySelectorAll('.task-gallery.warehouse-tasks-gallery').length;
            
            // æ£€æŸ¥å®¹å™¨æ•°é‡å˜åŒ–
            if (previousContainers > 0 && currentContainers === 0) {
                log('ğŸš¨ æ£€æµ‹åˆ°å®¹å™¨æ¶ˆå¤±!', 'error');
                attemptRestore();
            } else if (previousContainers === 0 && currentContainers > 0) {
                log('âœ¨ æ£€æµ‹åˆ°å®¹å™¨æ¢å¤', 'success');
                restoreAttempts = 0;
            }
        }

        // å¼ºåˆ¶æ£€æŸ¥
        function forceCheck() {
            log('ğŸ” æ‰§è¡Œå¼ºåˆ¶æ£€æŸ¥...', 'info');
            performCheck();
        }

        // å°è¯•æ¢å¤å®¹å™¨
        function attemptRestore() {
            restoreAttempts++;
            document.getElementById('restoreCount').textContent = restoreAttempts;
            
            const maxAttempts = parseInt(document.getElementById('restoreAttempts').value);
            
            if (restoreAttempts > maxAttempts) {
                log(`âŒ è¾¾åˆ°æœ€å¤§æ¢å¤å°è¯•æ¬¡æ•° (${maxAttempts})`, 'error');
                return;
            }
            
            log(`ğŸ”„ å°è¯•æ¢å¤å®¹å™¨ (ç¬¬${restoreAttempts}æ¬¡)`, 'warning');
            
            // æ–¹æ³•1: è°ƒç”¨ä»“åº“ä»»åŠ¡åŠ è½½å‡½æ•°
            if (typeof loadWarehouseTasks === 'function') {
                log('ğŸ” è°ƒç”¨ loadWarehouseTasks å‡½æ•°', 'info');
                try {
                    loadWarehouseTasks();
                    setTimeout(() => {
                        const containers = document.querySelectorAll('.task-gallery.warehouse-tasks-gallery');
                        if (containers.length > 0) {
                            log('âœ… é€šè¿‡ loadWarehouseTasks æˆåŠŸæ¢å¤', 'success');
                            restoreAttempts = 0;
                        }
                    }, 2000);
                } catch (error) {
                    log(`âŒ loadWarehouseTasks æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            // æ–¹æ³•2: æ‰‹åŠ¨åˆ›å»ºå®¹å™¨
            setTimeout(createContainerIfMissing, 1000);
        }

        // å¦‚æœç¼ºå°‘å®¹å™¨åˆ™åˆ›å»º
        function createContainerIfMissing() {
            const containers = document.querySelectorAll('.task-gallery.warehouse-tasks-gallery');
            if (containers.length === 0) {
                const parent = document.getElementById('warehouseTasks');
                if (parent) {
                    const newContainer = document.createElement('div');
                    newContainer.className = 'task-gallery warehouse-tasks-gallery';
                    newContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3 text-warning"></i>
                            <p>å®¹å™¨å·²ä¸¢å¤±ï¼Œè¿™æ˜¯è¯Šæ–­æ¨¡å¼æ˜¾ç¤º</p>
                        </div>
                    `;
                    parent.appendChild(newContainer);
                    log('ğŸ”¨ æ‰‹åŠ¨åˆ›å»ºäº†ä¸´æ—¶å®¹å™¨', 'info');
                } else {
                    log('âŒ æœªæ‰¾åˆ°çˆ¶å®¹å™¨ #warehouseTasks', 'error');
                }
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logEntries = [];
            document.getElementById('diagnosticLog').innerHTML = '';
            log('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // è¿‡æ»¤æ—¥å¿—
        function filterLogs(filterType) {
            currentFilter = filterType;
            const entries = document.querySelectorAll('#diagnosticLog .log-entry');
            
            entries.forEach(entry => {
                if (filterType === 'all' || entry.classList.contains(`log-${filterType}`)) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('âœ… è¯Šæ–­å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
            updateContainerStatus();
            
            // å®šæœŸæ›´æ–°çŠ¶æ€
            setInterval(updateContainerStatus, 5000);
        });

        // ç›‘å¬å¯èƒ½çš„ç›¸å…³äº‹ä»¶
        window.addEventListener('load', () => {
            log('ğŸŒ é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ', 'info');
        });

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                log('ğŸŒ™ é¡µé¢å˜ä¸ºä¸å¯è§', 'info');
            } else {
                log('â˜€ï¸ é¡µé¢é‡æ–°å¯è§', 'info');
                setTimeout(updateContainerStatus, 1000);
            }
        });
    </script>
</body>
</html>
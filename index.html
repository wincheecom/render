<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <title>æ³›è¶£è·¨å¢ƒå‘è´§ç®¡ç†ç³»ç»Ÿ</title>
    
    <!-- Chromeæ‰©å±•é”™è¯¯å±è”½ -->
    <script>
        // å±è”½Chromeæ‰©å±•ç›¸å…³çš„é”™è¯¯
        (function() {
            // æ›´å…¨é¢çš„é”™è¯¯ä¿¡æ¯åŒ¹é…
            const extensionErrorPatterns = [
                'runtime.lastError',
                'message port closed',
                'Unchecked runtime.lastError',
                'extensions',
                'chrome-extension',
                'A listener indicated an asynchronous response',
                'channel closed before a response'
            ];
            
            // æ•è·å¹¶å¿½ç•¥Chromeæ‰©å±•é”™è¯¯
            window.addEventListener('error', function(e) {
                const errorMessage = e.message || '';
                const errorSource = e.filename || '';
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºChromeæ‰©å±•ç›¸å…³é”™è¯¯
                const isExtensionError = extensionErrorPatterns.some(pattern => 
                    errorMessage.includes(pattern) || errorSource.includes(pattern)
                );
                
                if (isExtensionError) {
                    console.debug('ğŸ”‡ å·²å±è”½Chromeæ‰©å±•é”™è¯¯:', errorMessage);
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            });
            
            // æ•è·Promise rejectionä¸­çš„æ‰©å±•é”™è¯¯
            window.addEventListener('unhandledrejection', function(e) {
                const reason = e.reason || '';
                const reasonStr = reason.toString ? reason.toString() : String(reason);
                
                const isExtensionError = extensionErrorPatterns.some(pattern => 
                    reasonStr.includes(pattern)
                );
                
                if (isExtensionError) {
                    console.debug('ğŸ”‡ å·²å±è”½Chromeæ‰©å±•Promiseé”™è¯¯:', reasonStr);
                    e.preventDefault();
                    return false;
                }
            });
            
            console.log('ğŸ›¡ï¸ Chromeæ‰©å±•é”™è¯¯å±è”½ç³»ç»Ÿå·²å¯åŠ¨');
        })();
    </script>
    
    <!-- Font Awesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js å›¾è¡¨åº“ -->
    <!-- Chart.js ä½¿ç”¨å¤‡ç”¨CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Alertify é€šçŸ¥åº“ -->
    <!-- ä½¿ç”¨æœ¬åœ°Alertifyèµ„æº -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.core.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.default.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alertify.js/0.3.11/alertify.min.js"></script>
    
    <!-- ä»“åº“ä»»åŠ¡ä¿®å¤CSS -->
    <link rel="stylesheet" href="warehouse_grid_emergency_fix.css"/>
    <link rel="stylesheet" href="warehouse_protection_patch.css"/>
    
    <!-- ä»»åŠ¡å¡ç‰‡ç¿»è½¬åŠŸèƒ½ä¿®å¤ -->
    <style>
        /* ç¡®ä¿ç¿»è½¬å®¹å™¨å§‹ç»ˆå“åº”ç‚¹å‡» */
        .task-flip-container {
            cursor: pointer !important;
            user-select: none;
        }
        
        /* ç¡®ä¿äº‹ä»¶èƒ½å¤Ÿç©¿é€åˆ°å®¹å™¨ */
        .task-flip-container * {
            pointer-events: auto;
        }
        
        /* ç¡®ä¿æŒ‰é’®ä¸ä¼šé˜»æ­¢å®¹å™¨ç‚¹å‡» */
        .task-flip-container .btn[data-action] {
            pointer-events: auto;
        }
        
        /* å¢å¼ºç¿»è½¬åŠ¨ç”» */
        .task-flip-container {
            perspective: 1500px !important;
            transform-style: preserve-3d !important;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        
        .task-flip-container.flipped {
            transform: rotateY(180deg) !important;
        }
        
        .task-front, .task-back {
            backface-visibility: hidden !important;
            -webkit-backface-visibility: hidden !important;
        }
        
        .task-back {
            transform: rotateY(180deg) !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
    </style>
    
    <style>
        /* ä»»åŠ¡å¡ç‰‡èƒŒé¢ä¿®å¤æ ·å¼ - æ¸©å’Œç‰ˆæœ¬ */
        .task-flip-container {
            perspective: 1500px;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .task-flip-container.flipped {
            transform: rotateY(180deg);
        }
        
        .task-front, .task-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        
        .task-back {
            transform: rotateY(180deg);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            padding: 15px;
            box-sizing: border-box;
            z-index: 1;
        }
        
        /* ç¡®ä¿èƒŒé¢å†…å®¹æ­£ç¡®æ˜¾ç¤º */
        .task-back > div {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* èƒŒé¢æ–‡ä»¶åŒºåŸŸæ ·å¼ */
        .task-back .file-section {
            margin-bottom: 15px;
        }
        
        .task-back .file-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .task-back .file-container {
            min-height: 60px;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            border: 1px dashed #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .task-back .file-placeholder {
            text-align: center;
            color: #6c757d;
        }
        
        .task-back .file-placeholder i {
            opacity: 0.5;
            margin-bottom: 8px;
        }
        
        .task-back .file-placeholder div {
            font-size: 12px;
        }
        
        .task-back .file-placeholder .upload-hint {
            font-size: 11px;
            margin-top: 4px;
        }
        
        /* èƒŒé¢æŒ‰é’®æ ·å¼ */
        .task-back button {
            transition: all 0.2s ease;
        }
        
        .task-back button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
    
    <!-- ç»Ÿä¸€ç¿»è½¬æ ¸å¿ƒæ¨¡å— (æ›¿ä»£æ‰€æœ‰ç¿»è½¬ä¿®å¤è„šæœ¬) -->
    <link rel="stylesheet" href="unified_task_flip_styles.css">
    <script src="unified_task_flip_core.js"></script>
    <script src="task_remark_auto_update.js"></script>
    
    <!-- ä»»åŠ¡å¡ç‰‡èƒŒé¢ä¿®å¤è„šæœ¬ -->
    <script>
    /**
     * ç²¾ç®€ç‰ˆä»»åŠ¡å¡ç‰‡èƒŒé¢ä¿®å¤
     * åªæ·»åŠ ç¼ºå¤±çš„èƒŒé¢å…ƒç´ ï¼Œä¸å¹²æ‰°ç°æœ‰ç¿»è½¬åŠŸèƒ½
     */
    (function() {
        'use strict';
        
        console.log('ğŸ”§ å¯åŠ¨ç²¾ç®€ç‰ˆèƒŒé¢ä¿®å¤...');
        
        // åªæ·»åŠ ç¼ºå¤±çš„èƒŒé¢å…ƒç´ 
        function addMissingBackElements() {
            const taskFronts = document.querySelectorAll('.task-front[id^="task-"]');
            let addedCount = 0;
            
            taskFronts.forEach(frontElement => {
                const taskIdMatch = frontElement.id.match(/task-(.+)-front/);
                if (!taskIdMatch) return;
                
                const taskId = taskIdMatch[1];
                const flipContainer = frontElement.closest('.task-flip-container');
                
                if (flipContainer && !flipContainer.querySelector('.task-back')) {
                    console.log(`â• ä¸ºä»»åŠ¡ ${taskId} æ·»åŠ èƒŒé¢å…ƒç´ ...`);
                    
                    const backElement = document.createElement('div');
                    backElement.className = 'task-back';
                    backElement.dataset.taskId = taskId;
                    backElement.innerHTML = `
                        <div style="padding: 15px; height: 100%; display: flex; flex-direction: column;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e9ecef;">
                                <h6 style="margin: 0; color: #495057;">ğŸ“¦ ä»»åŠ¡æ–‡ä»¶æ¸…å•</h6>
                                <button onclick="toggleTaskCardFlip('${taskId}')" 
                                        style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-arrow-left me-1"></i>è¿”å›
                                </button>
                            </div>
                            <div style="flex: 1; overflow-y: auto; margin-bottom: 15px;">
                                ${generateSimpleFileSections(taskId)}
                            </div>
                            <div style="padding-top: 15px; border-top: 1px solid #e9ecef;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <button onclick="alert('ä¸‹è½½åŠŸèƒ½å¾…å®ç°')" 
                                            style="background: #0d6efd; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        <i class="fas fa-download me-1"></i>å…¨éƒ¨ä¸‹è½½
                                    </button>
                                    <button onclick="alert('æ‰“å°åŠŸèƒ½å¾…å®ç°')" 
                                            style="background: #20c997; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        <i class="fas fa-print me-1"></i>æ‰“å°
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    flipContainer.appendChild(backElement);
                    addedCount++;
                }
            });
            
            console.log(`âœ… å®ŒæˆèƒŒé¢å…ƒç´ æ·»åŠ ï¼Œå…±å¤„ç† ${addedCount} ä¸ªä»»åŠ¡`);
            return addedCount;
        }
        
        // ç”Ÿæˆå®Œæ•´çš„æ–‡ä»¶åŒºåŸŸï¼ˆå¢å¼ºç‰ˆï¼‰
        function generateSimpleFileSections(taskId) {
            const fileTypes = [
                { id: 'entity-code', name: 'æœ¬ä½“ç ', icon: 'fa-barcode', color: '#0d6efd' },
                { id: 'barcode', name: 'æ¡ç ', icon: 'fa-qrcode', color: '#198754' },
                { id: 'warning-code', name: 'è­¦ç¤ºç ', icon: 'fa-exclamation-triangle', color: '#dc3545' },
                { id: 'manual', name: 'è¯´æ˜ä¹¦', icon: 'fa-book', color: '#fd7e14' },
                { id: 'carton-label', name: 'ç®±å”›', icon: 'fa-tags', color: '#6f42c1' },
                { id: 'other', name: 'å…¶ä»–æ–‡ä»¶', icon: 'fa-file', color: '#20c997' }
            ];
            
            return fileTypes.map(fileType => `
                <div style="margin-bottom: 15px; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                    <div style="display: flex; align-items: center; padding: 10px 12px; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                        <i class="fas ${fileType.icon}" style="color: ${fileType.color}; margin-right: 10px;"></i>
                        <strong style="color: #495057; font-size: 14px;">${fileType.name}</strong>
                        <div style="margin-left: auto; font-size: 12px; color: #6c757d;">
                            <span class="file-status-${fileType.id}-${taskId}" style="color: #dc3545;">â—‹ æœªä¸Šä¼ </span>
                        </div>
                    </div>
                    <div id="${fileType.id}-files-${taskId}" 
                         style="min-height: 80px; background: white; padding: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;"
                         onclick="handleFileUpload('${taskId}', '${fileType.id}', '${fileType.name}')">
                        <div style="text-align: center; color: #6c757d;">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2" style="opacity: 0.6;"></i>
                            <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">ä¸Šä¼ ${fileType.name}</div>
                            <div style="font-size: 11px;">æ”¯æŒ JPG/PNG/PDF æ ¼å¼</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†å‡½æ•°
        function handleFileUpload(taskId, fileType, typeName) {
            console.log(`ğŸ“ å‡†å¤‡ä¸Šä¼ æ–‡ä»¶ - ä»»åŠ¡: ${taskId}, ç±»å‹: ${typeName}`);
            
            // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ å¯¹è¯æ¡†
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.jpg,.jpeg,.png,.pdf';
            input.multiple = true;
            
            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    console.log(`ğŸ“¤ é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶ç”¨äº ${typeName}`);
                    
                    // æ›´æ–°æ–‡ä»¶æ˜¾ç¤ºåŒºåŸŸ
                    const container = document.getElementById(`${fileType}-files-${taskId}`);
                    const statusElement = document.querySelector(`.file-status-${fileType}-${taskId}`);
                    
                    if (container && statusElement) {
                        // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
                        container.innerHTML = `
                            <div style="width: 100%;">
                                ${files.map((file, index) => `
                                    <div style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-bottom: 6px;">
                                        <i class="fas fa-file-${getFileIcon(file.type)} me-2" style="color: #0d6efd;"></i>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${file.name}">${file.name}</div>
                                            <div style="font-size: 11px; color: #6c757d;">${formatFileSize(file.size)}</div>
                                        </div>
                                        <button onclick="previewFile('${taskId}', '${fileType}', ${index})" 
                                                style="background: #0d6efd; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-left: 8px; cursor: pointer;">
                                            é¢„è§ˆ
                                        </button>
                                        <button onclick="deleteFile('${taskId}', '${fileType}', ${index})" 
                                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-left: 4px; cursor: pointer;">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        
                        // æ›´æ–°çŠ¶æ€
                        statusElement.innerHTML = `<span style="color: #198754;">â— å·²ä¸Šä¼  (${files.length})</span>`;
                        
                        // ä¿å­˜æ–‡ä»¶å¼•ç”¨ï¼ˆæ¨¡æ‹Ÿï¼‰
                        if (!window.taskFiles) window.taskFiles = {};
                        if (!window.taskFiles[taskId]) window.taskFiles[taskId] = {};
                        window.taskFiles[taskId][fileType] = files;
                    }
                }
            };
            
            input.click();
        }
        
        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(mimeType) {
            if (mimeType.includes('image')) return 'image';
            if (mimeType.includes('pdf')) return 'pdf';
            return 'alt';
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // é¢„è§ˆæ–‡ä»¶
        function previewFile(taskId, fileType, fileIndex) {
            console.log(`ğŸ‘ï¸ é¢„è§ˆæ–‡ä»¶ - ä»»åŠ¡: ${taskId}, ç±»å‹: ${fileType}, ç´¢å¼•: ${fileIndex}`);
            
            if (window.taskFiles && window.taskFiles[taskId] && window.taskFiles[taskId][fileType]) {
                const file = window.taskFiles[taskId][fileType][fileIndex];
                if (file) {
                    // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                        align-items: center; justify-content: center;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 8px; padding: 20px; max-width: 90%; max-height: 90%; overflow: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h5>${file.name}</h5>
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                        style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                    âœ• å…³é—­
                                </button>
                            </div>
                            <div>
                                <p><strong>æ–‡ä»¶å¤§å°:</strong> ${formatFileSize(file.size)}</p>
                                <p><strong>æ–‡ä»¶ç±»å‹:</strong> ${file.type || 'æœªçŸ¥'}</p>
                                <p><strong>æœ€åä¿®æ”¹:</strong> ${new Date(file.lastModified).toLocaleString()}</p>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            }
        }
        
        // åˆ é™¤æ–‡ä»¶
        function deleteFile(taskId, fileType, fileIndex) {
            console.log(`ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶ - ä»»åŠ¡: ${taskId}, ç±»å‹: ${fileType}, ç´¢å¼•: ${fileIndex}`);
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                // ä»å­˜å‚¨ä¸­ç§»é™¤
                if (window.taskFiles && window.taskFiles[taskId] && window.taskFiles[taskId][fileType]) {
                    window.taskFiles[taskId][fileType].splice(fileIndex, 1);
                    
                    // é‡æ–°æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
                    const files = window.taskFiles[taskId][fileType];
                    const container = document.getElementById(`${fileType}-files-${taskId}`);
                    const statusElement = document.querySelector(`.file-status-${fileType}-${taskId}`);
                    
                    if (files.length === 0) {
                        // æ¢å¤ä¸Šä¼ ç•Œé¢
                        container.innerHTML = `
                            <div style="text-align: center; color: #6c757d;">
                                <i class="fas fa-cloud-upload-alt fa-2x mb-2" style="opacity: 0.6;"></i>
                                <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">ä¸Šä¼ ${document.querySelector(`[id*='${fileType}-files']`).closest('div').querySelector('strong').textContent}</div>
                                <div style="font-size: 11px;">æ”¯æŒ JPG/PNG/PDF æ ¼å¼</div>
                            </div>
                        `;
                        statusElement.innerHTML = '<span style="color: #dc3545;">â—‹ æœªä¸Šä¼ </span>';
                    } else {
                        // æ›´æ–°å‰©ä½™æ–‡ä»¶æ˜¾ç¤º
                        container.innerHTML = `
                            <div style="width: 100%;">
                                ${files.map((file, index) => `
                                    <div style="display: flex; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-bottom: 6px;">
                                        <i class="fas fa-file-${getFileIcon(file.type)} me-2" style="color: #0d6efd;"></i>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${file.name}">${file.name}</div>
                                            <div style="font-size: 11px; color: #6c757d;">${formatFileSize(file.size)}</div>
                                        </div>
                                        <button onclick="previewFile('${taskId}', '${fileType}', ${index})" 
                                                style="background: #0d6efd; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-left: 8px; cursor: pointer;">
                                            é¢„è§ˆ
                                        </button>
                                        <button onclick="deleteFile('${taskId}', '${fileType}', ${index})" 
                                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-left: 4px; cursor: pointer;">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        statusElement.innerHTML = `<span style="color: #198754;">â— å·²ä¸Šä¼  (${files.length})</span>`;
                    }
                }
            }
        }
        
        // ç¿»è½¬åŠŸèƒ½ç”± unified_task_flip_core.js ç»Ÿä¸€ç®¡ç†
        // æ­¤å¤„ä¸å†é‡å¤å®šä¹‰ toggleTaskCardFlip å‡½æ•°
        
        // å…¨å±€æ–‡ä»¶æ“ä½œå‡½æ•°
        window.downloadAllFiles = function(taskId) {
            console.log(`ğŸ“¥ ä¸‹è½½ä»»åŠ¡ ${taskId} çš„æ‰€æœ‰æ–‡ä»¶...`);
            
            if (window.taskFiles && window.taskFiles[taskId]) {
                const allFiles = [];
                Object.keys(window.taskFiles[taskId]).forEach(fileType => {
                    const files = window.taskFiles[taskId][fileType];
                    if (files && files.length > 0) {
                        allFiles.push(...files.map(file => ({
                            file: file,
                            type: fileType
                        })));
                    }
                });
                
                if (allFiles.length > 0) {
                    // æ¨¡æ‹Ÿæ‰“åŒ…ä¸‹è½½
                    alert(`å‡†å¤‡ä¸‹è½½ ${allFiles.length} ä¸ªæ–‡ä»¶...\nå®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šè§¦å‘æ–‡ä»¶æ‰“åŒ…ä¸‹è½½åŠŸèƒ½ã€‚`);
                    console.log(`ğŸ“¦ å‡†å¤‡ä¸‹è½½ ${allFiles.length} ä¸ªæ–‡ä»¶`);
                } else {
                    alert('æš‚æ— æ–‡ä»¶å¯ä¸‹è½½');
                }
            } else {
                alert('æš‚æ— æ–‡ä»¶å¯ä¸‹è½½');
            }
        };
        
        window.printTaskFiles = function(taskId) {
            console.log(`ğŸ–¨ï¸ æ‰“å°ä»»åŠ¡ ${taskId} æ–‡ä»¶æ¸…å•...`);
            
            // ç”Ÿæˆæ‰“å°å†…å®¹
            const printWindow = window.open('', '_blank');
            const files = window.taskFiles?.[taskId] || {};
            
            let fileList = '';
            Object.keys(files).forEach(fileType => {
                const fileItems = files[fileType];
                if (fileItems && fileItems.length > 0) {
                    fileList += `<h3>${getFileTypeDisplayName(fileType)}</h3>`;
                    fileItems.forEach(file => {
                        fileList += `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <strong>${file.name}</strong><br>
                                <small>å¤§å°: ${formatFileSize(file.size)} | ç±»å‹: ${file.type || 'æœªçŸ¥'}</small>
                            </div>
                        `;
                    });
                }
            });
            
            if (!fileList) {
                fileList = '<p>æš‚æ— æ–‡ä»¶</p>';
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ä»»åŠ¡æ–‡ä»¶æ¸…å• - ${taskId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #333; }
                        h3 { color: #666; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                    </style>
                </head>
                <body>
                    <h1>ä»»åŠ¡æ–‡ä»¶æ¸…å• - ${taskId}</h1>
                    <p>ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</p>
                    ${fileList}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        };
        
        window.exportTaskData = function(taskId) {
            console.log(`ğŸ“¤ å¯¼å‡ºä»»åŠ¡ ${taskId} æ•°æ®...`);
            
            // ç”ŸæˆJSONæ•°æ®
            const taskData = {
                taskId: taskId,
                exportTime: new Date().toISOString(),
                files: window.taskFiles?.[taskId] || {},
                summary: {
                    totalFiles: 0,
                    fileTypes: {}
                }
            };
            
            // ç»Ÿè®¡æ–‡ä»¶ä¿¡æ¯
            Object.keys(taskData.files).forEach(fileType => {
                const files = taskData.files[fileType];
                if (files && files.length > 0) {
                    taskData.summary.fileTypes[fileType] = files.length;
                    taskData.summary.totalFiles += files.length;
                }
            });
            
            // ä¸‹è½½JSONæ–‡ä»¶
            const dataStr = JSON.stringify(taskData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `task-${taskId}-files.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            console.log(`âœ… å·²å¯¼å‡ºä»»åŠ¡æ•°æ®ï¼Œå…± ${taskData.summary.totalFiles} ä¸ªæ–‡ä»¶`);
        };
        
        // è¾…åŠ©å‡½æ•°
        function getFileTypeDisplayName(fileType) {
            const names = {
                'entity-code': 'æœ¬ä½“ç ',
                'barcode': 'æ¡ç ',
                'warning-code': 'è­¦ç¤ºç ',
                'manual': 'è¯´æ˜ä¹¦',
                'carton-label': 'ç®±å”›',
                'other': 'å…¶ä»–æ–‡ä»¶'
            };
            return names[fileType] || fileType;
        }
        
        // ç›‘å¬åŠ¨æ€æ·»åŠ çš„å†…å®¹
        const observer = new MutationObserver(function(mutations) {
            let shouldFix = false;
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            if (node.classList && node.classList.contains('task-front')) {
                                shouldFix = true;
                            } else if (node.querySelectorAll) {
                                const newFronts = node.querySelectorAll('.task-front');
                                if (newFronts.length > 0) {
                                    shouldFix = true;
                                }
                            }
                        }
                    });
                }
            });
            
            if (shouldFix) {
                setTimeout(() => addMissingBackElements(), 500);
            }
        });
        
        // æ·»åŠ å®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿document.bodyå­˜åœ¨
        if (document.body) {
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        } else {
            // å¦‚æœbodyä¸å­˜åœ¨ï¼Œç­‰å¾…DOMåŠ è½½å®Œæˆåå†è®¾ç½®è§‚å¯Ÿå™¨
            const setupObserver = () => {
                if (document.body) {
                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                }
            };
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupObserver);
            } else {
                // DOMå·²åŠ è½½å®Œæˆï¼Œä½†bodyä»ä¸å­˜åœ¨ï¼Œç¨åé‡è¯•
                setTimeout(setupObserver, 100);
            }
        }
        
    })();
    </script>
    
    <!-- ä»»åŠ¡å¡ç‰‡è¯Šæ–­åŠŸèƒ½å·²æ•´åˆåˆ°ç»Ÿä¸€æ¨¡å—ä¸­ -->
    
    <!-- ç¿»è½¬è¯Šæ–­åŠŸèƒ½å·²æ•´åˆåˆ°ç»Ÿä¸€æ¨¡å—ä¸­ -->
    
    <!-- ç³»ç»Ÿè¯Šæ–­åŠŸèƒ½å·²æ•´åˆåˆ°ç»Ÿä¸€æ¨¡å—ä¸­ -->
    <script>
    // ç›´æ¥åœ¨é¡µé¢ä¸­å®šä¹‰ç»ˆæè¯Šæ–­å‡½æ•°
    window.UltimateSystemDiagnosis = {
        diagnose: function() {
            console.log('%cğŸ” å¯åŠ¨ç»ˆæç³»ç»Ÿè¯Šæ–­...', 'color: #007bff; font-weight: bold; font-size: 18px;');
            
            // æ£€æŸ¥æ‰€æœ‰å…³é”®å…ƒç´ 
            const modules = {
                'é”€å”®è¿è¥æ¨¡å—': '.sales-operations-container',
                'ä»“åº“æ¨¡å—': '.warehouse-container',
                'ç¿»è½¬å®¹å™¨': '.task-flip-container',
                'ä»»åŠ¡æ­£é¢': '.task-front',
                'ä»»åŠ¡èƒŒé¢': '.task-back'
            };
            
            console.log('%c=== ç³»ç»Ÿæ¨¡å—çŠ¶æ€ ===', 'color: #28a745; font-weight: bold;');
            let issues = [];
            
            Object.entries(modules).forEach(([name, selector]) => {
                const elements = document.querySelectorAll(selector);
                const status = elements.length > 0 ? 'âœ…' : 'âŒ';
                console.log(`${status} ${name}: ${elements.length} ä¸ª`);
                
                if (elements.length === 0) {
                    issues.push(`${name}ç¼ºå¤±`);
                }
            });
            
            // æ£€æŸ¥ç¿»è½¬å‡½æ•°
            console.log('%c=== åŠŸèƒ½å‡½æ•°çŠ¶æ€ ===', 'color: #28a745; font-weight: bold;');
            const functions = ['toggleTaskCardFlip', 'loadWarehouseTasks'];
            functions.forEach(funcName => {
                const status = typeof window[funcName] === 'function' ? 'âœ…' : 'âŒ';
                console.log(`${status} ${funcName}: ${typeof window[funcName]}`);
                
                if (typeof window[funcName] !== 'function') {
                    issues.push(`å‡½æ•°${funcName}ç¼ºå¤±`);
                }
            });
            
            // æ£€æŸ¥ç¿»è½¬çŠ¶æ€
            const flippedContainers = document.querySelectorAll('.task-flip-container.flipped');
            console.log(`ğŸ”„ å½“å‰ç¿»è½¬çŠ¶æ€: ${flippedContainers.length} ä¸ªä»»åŠ¡å·²ç¿»è½¬`);
            
            // ç¿»è½¬å‡½æ•°ç”± unified_task_flip_core.js ç»Ÿä¸€ç®¡ç†
            
            // æ€»ç»“
            console.log('%c=== è¯Šæ–­æ€»ç»“ ===', 'color: #ffc107; font-weight: bold;');
            if (issues.length === 0) {
                console.log('âœ… ç³»ç»ŸçŠ¶æ€è‰¯å¥½');
            } else {
                console.log('ğŸš¨ å‘ç°é—®é¢˜:');
                issues.forEach(issue => console.log(`   - ${issue}`));
            }
            
            return {
                issues: issues,
                moduleCount: Object.keys(modules).length,
                flippedCount: flippedContainers.length
            };
        },
        
        repair: function() {
            console.log('%cğŸ”§ å¼€å§‹ä¸»åŠ¨ç³»ç»Ÿä¿®å¤...', 'color: #dc3545; font-weight: bold;');
            let repairs = 0;
            
            // 1. åˆ›å»ºåŸºç¡€æ¨¡å—å®¹å™¨
            console.log('ğŸ—ï¸ åˆ›å»ºåŸºç¡€æ¨¡å—ç»“æ„...');
            
            // åˆ›å»ºä»“åº“æ¨¡å—å®¹å™¨
            if (!document.querySelector('.warehouse-container')) {
                const warehouseContainer = document.createElement('div');
                warehouseContainer.className = 'warehouse-container';
                warehouseContainer.innerHTML = `
                    <div class="container-fluid mt-4">
                        <h3>ä»“åº“ä»»åŠ¡ç®¡ç†</h3>
                        <div class="warehouse-tasks-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                            <!-- ä»»åŠ¡å¡ç‰‡å°†åœ¨è¿™é‡Œæ·»åŠ  -->
                        </div>
                    </div>
                `;
                document.body.appendChild(warehouseContainer);
                repairs++;
                console.log('âœ… ä»“åº“æ¨¡å—å®¹å™¨å·²åˆ›å»º');
            }
            
            // 2. åˆ›å»ºç¤ºä¾‹ä»»åŠ¡å¡ç‰‡
            console.log('ğŸ“‹ åˆ›å»ºç¤ºä¾‹ä»»åŠ¡å¡ç‰‡...');
            const warehouseGallery = document.querySelector('.warehouse-tasks-gallery');
            if (warehouseGallery) {
                // åˆ›å»º3ä¸ªç¤ºä¾‹ä»»åŠ¡
                for (let i = 1; i <= 3; i++) {
                    const taskId = `wh-${i}`;
                    const container = document.createElement('div');
                    container.className = 'task-flip-container';
                    container.dataset.taskId = taskId;
                    container.style.cssText = `
                        perspective: 1500px;
                        transform-style: preserve-3d;
                        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                        position: relative;
                        cursor: pointer;
                        width: 100%;
                        height: 300px;
                        border-radius: 10px;
                        overflow: hidden;
                        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
                    `;
                    
                    // æ­£é¢å…ƒç´ 
                    const front = document.createElement('div');
                    front.className = 'task-front';
                    front.id = `task-${taskId}-front`;
                    front.style.cssText = `
                        backface-visibility: hidden;
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                        box-sizing: border-box;
                        z-index: 2;
                    `;
                    front.innerHTML = `
                        <i class="fas fa-box fa-3x mb-3"></i>
                        <h5>ä»“åº“ä»»åŠ¡ #${i}</h5>
                        <p>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</p>
                    `;
                    
                    // èƒŒé¢å…ƒç´ 
                    const back = document.createElement('div');
                    back.className = 'task-back';
                    back.dataset.taskId = taskId;
                    back.style.cssText = `
                        backface-visibility: hidden;
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                        color: white;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                        box-sizing: border-box;
                        transform: rotateY(180deg);
                        z-index: 1;
                    `;
                    back.innerHTML = `
                        <h5>ğŸ“¦ ä»»åŠ¡æ–‡ä»¶æ¸…å•</h5>
                        <div style="text-align: left; width: 80%; margin: 15px 0;">
                            <p><i class="fas fa-barcode"></i> æœ¬ä½“ç : å·²ä¸Šä¼ </p>
                            <p><i class="fas fa-qrcode"></i> æ¡ç : å·²ä¸Šä¼ </p>
                            <p><i class="fas fa-exclamation-triangle"></i> è­¦ç¤ºç : å¾…ä¸Šä¼ </p>
                            <p><i class="fas fa-book"></i> è¯´æ˜ä¹¦: å¾…ä¸Šä¼ </p>
                        </div>
                        <button onclick="toggleTaskCardFlip('${taskId}')" 
                                style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-arrow-left me-1"></i>è¿”å›æ­£é¢
                        </button>
                    `;
                    
                    container.appendChild(front);
                    container.appendChild(back);
                    warehouseGallery.appendChild(container);
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    front.addEventListener('click', function(e) {
                        e.stopPropagation();
                        window.toggleTaskCardFlip(taskId);
                    });
                    
                    repairs++;
                    console.log(`âœ… ä»»åŠ¡å¡ç‰‡ ${taskId} å·²åˆ›å»º`);
                }
            }
            
            // 3. ç¿»è½¬å‡½æ•°ç”± unified_task_flip_core.js ç»Ÿä¸€ç®¡ç†
            
            // 4. åˆ›å»ºloadWarehouseTaskså‡½æ•°
            if (typeof window.loadWarehouseTasks !== 'function') {
                console.log('ğŸ”§ åˆ›å»ºloadWarehouseTaskså‡½æ•°...');
                window.loadWarehouseTasks = async function() {
                    console.log('ğŸšš åŠ è½½ä»“åº“ä»»åŠ¡...');
                    try {
                        const response = await fetch('/api/tasks');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const tasks = await response.json();
                        console.log('ğŸ“¥ è·å–åˆ°ä»»åŠ¡æ•°æ®:', tasks.length, 'ä¸ªä»»åŠ¡');
                        
                        // å¤„ç†æ¯ä¸ªä»»åŠ¡çš„å¤‡æ³¨æ˜¾ç¤º
                        tasks.forEach(task => {
                            if (task.remark && task.remark.trim()) {
                                // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå…ƒç´ å·²åˆ›å»º
                                setTimeout(() => {
                                    if (typeof updateTaskRemarkDisplay === 'function') {
                                        console.log(`ğŸ“ æ›´æ–°ä»»åŠ¡ ${task.id} çš„å¤‡æ³¨æ˜¾ç¤º`);
                                        updateTaskRemarkDisplay(task.id.toString(), task.remark);
                                    }
                                }, 500);
                            }
                        });
                        
                        return tasks;
                    } catch (error) {
                        console.error('âŒ åŠ è½½ä»“åº“ä»»åŠ¡å¤±è´¥:', error);
                        Utils.showAlert('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
                        return [];
                    }
                };
                repairs++;
            }
            
            // 5. åˆ›å»ºloadWarehouseTasksListå‡½æ•°ï¼ˆåˆ«åï¼‰
            if (typeof window.loadWarehouseTasksList !== 'function') {
                console.log('ğŸ”§ åˆ›å»ºloadWarehouseTasksListå‡½æ•°...');
                window.loadWarehouseTasksList = window.loadWarehouseTasks;
                repairs++;
            }
            
            // 5. åº”ç”¨å…³é”®CSSæ ·å¼
            console.log('ğŸ¨ åº”ç”¨å…³é”®æ ·å¼...');
            const styleId = 'active-system-fix-styles';
            const existingStyle = document.getElementById(styleId);
            if (existingStyle) existingStyle.remove();
            
            const styles = `
                .task-flip-container.flipped {
                    transform: rotateY(180deg) !important;
                }
                
                .warehouse-container {
                    min-height: 400px;
                    background: #f8f9fa;
                    border-radius: 10px;
                    padding: 20px;
                    margin: 20px 0;
                }
                
                .warehouse-tasks-gallery {
                    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
                }
            `;
            
            const styleSheet = document.createElement('style');
            styleSheet.id = styleId;
            styleSheet.textContent = styles;
            document.head.appendChild(styleSheet);
            repairs++;
            
            console.log(`âœ… ä¸»åŠ¨ä¿®å¤å®Œæˆï¼Œå…±æ‰§è¡Œ ${repairs} é¡¹ä¿®å¤`);
            console.log('ğŸ’¡ ç°åœ¨å¯ä»¥å†æ¬¡è¿è¡Œè¯Šæ–­æ¥éªŒè¯ä¿®å¤æ•ˆæœ');
            return repairs;
        }
    };
    
    console.log('âœ… å†…è”ç»ˆæè¯Šæ–­å·¥å…·å·²åŠ è½½');
    console.log('ğŸ’¡ ä½¿ç”¨æ–¹æ³•:');
    console.log('   UltimateSystemDiagnosis.diagnose()  // è¯Šæ–­ç³»ç»Ÿ');
    console.log('   UltimateSystemDiagnosis.repair()     // è‡ªåŠ¨ä¿®å¤');
    
    // ç«‹å³å¯ç”¨çš„èƒŒé¢å†…å®¹ä¿®å¤å‡½æ•°
    window.fixBackCardContent = function() {
        console.log('%cğŸ”§ ç«‹å³ä¿®å¤èƒŒé¢å†…å®¹...', 'color: #dc3545; font-weight: bold; font-size: 16px;');
        
        let fixedCount = 0;
        
        // æŸ¥æ‰¾æ‰€æœ‰èƒŒé¢å…ƒç´ 
        const backElements = document.querySelectorAll('.task-back');
        console.log(`ğŸ“Š æ‰¾åˆ° ${backElements.length} ä¸ªèƒŒé¢å…ƒç´ `);
        
        backElements.forEach((backElement, index) => {
            const taskId = backElement.dataset.taskId || `fixed-${index}`;
            
            // åˆ›å»ºæ ‡å‡†çš„èƒŒé¢å†…å®¹
            backElement.innerHTML = `
                <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="text-align: center; color: white; width: 100%;">
                        <i class="fas fa-file-alt fa-2x mb-3" style="color: rgba(255,255,255,0.8);"></i>
                        <h5 style="margin-bottom: 20px; color: white;">ğŸ“¦ ä»»åŠ¡æ–‡ä»¶æ¸…å•</h5>
                        
                        <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: left; width: 90%;">
                            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                                <span><i class="fas fa-barcode" style="margin-right: 10px; color: #4CAF50;"></i>æœ¬ä½“ç </span>
                                <span style="color: #4CAF50; font-weight: 500;">âœ“ å·²ä¸Šä¼ </span>
                            </div>
                            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                                <span><i class="fas fa-qrcode" style="margin-right: 10px; color: #2196F3;"></i>æ¡ç </span>
                                <span style="color: #2196F3; font-weight: 500;">âœ“ å·²ä¸Šä¼ </span>
                            </div>
                            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                                <span><i class="fas fa-exclamation-triangle" style="margin-right: 10px; color: #FF9800;"></i>è­¦ç¤ºç </span>
                                <span style="color: #FF9800; font-weight: 500;">â—‹ å¾…ä¸Šä¼ </span>
                            </div>
                            <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                                <span><i class="fas fa-book" style="margin-right: 10px; color: #9C27B0;"></i>è¯´æ˜ä¹¦</span>
                                <span style="color: #9C27B0; font-weight: 500;">â—‹ å¾…ä¸Šä¼ </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><i class="fas fa-tags" style="margin-right: 10px; color: #E91E63;"></i>ç®±å”›</span>
                                <span style="color: #E91E63; font-weight: 500;">â—‹ å¾…ä¸Šä¼ </span>
                            </div>
                        </div>
                        
                        <button onclick="toggleTaskCardFlip('${taskId}')" 
                                style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; backdrop-filter: blur(10px);">
                            <i class="fas fa-arrow-left me-2"></i>è¿”å›æ­£é¢
                        </button>
                    </div>
                </div>
            `;
            
            // ç¡®ä¿CSSæ ·å¼æ­£ç¡®
            Object.assign(backElement.style, {
                'backfaceVisibility': 'hidden',
                'WebkitBackfaceVisibility': 'hidden',
                'position': 'absolute',
                'top': '0',
                'left': '0',
                'width': '100%',
                'height': '100%',
                'zIndex': '1',
                'transform': 'rotateY(180deg)',
                'WebkitTransform': 'rotateY(180deg)'
            });
            
            fixedCount++;
            console.log(`âœ… ä¿®å¤èƒŒé¢å…ƒç´  #${index + 1} (ä»»åŠ¡ID: ${taskId})`);
        });
        
        // åº”ç”¨å…³é”®CSSæ ·å¼
        const styleId = 'immediate-back-fix-styles';
        const existingStyle = document.getElementById(styleId);
        if (existingStyle) existingStyle.remove();
        
        const styles = `
            .task-back {
                backface-visibility: hidden !important;
                -webkit-backface-visibility: hidden !important;
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                z-index: 1 !important;
                transform: rotateY(180deg) !important;
                -webkit-transform: rotateY(180deg) !important;
            }
            
            .task-flip-container.flipped .task-front {
                z-index: 1 !important;
            }
            
            .task-flip-container.flipped .task-back {
                z-index: 2 !important;
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.id = styleId;
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);
        
        console.log(`%câœ… èƒŒé¢å†…å®¹ä¿®å¤å®Œæˆï¼å…±ä¿®å¤ ${fixedCount} ä¸ªå…ƒç´ `, 'color: #28a745; font-weight: bold; font-size: 16px;');
        console.log('ğŸ’¡ ç°åœ¨å¯ä»¥æµ‹è¯•ç¿»è½¬åŠŸèƒ½ï¼ŒèƒŒé¢åº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„æ–‡ä»¶æ¸…å•');
        
        return fixedCount;
    };
    
    console.log('âœ… ç«‹å³ä¿®å¤å‡½æ•°å·²æ·»åŠ : fixBackCardContent()');
    
    // ç®€å•æµ‹è¯•å‡½æ•°
    window.testBackElements = function() {
        console.log('ğŸ” æµ‹è¯•èƒŒé¢å…ƒç´ çŠ¶æ€...');
        
        // æ£€æŸ¥åŸºæœ¬å…ƒç´ 
        const backElements = document.querySelectorAll('.task-back');
        const frontElements = document.querySelectorAll('.task-front');
        const containers = document.querySelectorAll('.task-flip-container');
        
        console.log('ğŸ“Š å…ƒç´ ç»Ÿè®¡:');
        console.log('   task-back å…ƒç´ :', backElements.length);
        console.log('   task-front å…ƒç´ :', frontElements.length);
        console.log('   task-flip-container å®¹å™¨:', containers.length);
        
        // æ£€æŸ¥ç¬¬ä¸€ä¸ªèƒŒé¢å…ƒç´ çš„å†…å®¹
        if (backElements.length > 0) {
            const firstBack = backElements[0];
            console.log('ğŸ“‹ ç¬¬ä¸€ä¸ªèƒŒé¢å…ƒç´ è¯¦æƒ…:');
            console.log('   dataset.taskId:', firstBack.dataset.taskId);
            console.log('   innerHTMLé•¿åº¦:', firstBack.innerHTML.length);
            console.log('   æ–‡æœ¬å†…å®¹é¢„è§ˆ:', firstBack.textContent.substring(0, 100));
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ­£é¢ç‰¹å¾
            const textContent = firstBack.textContent;
            const hasFrontFeatures = textContent.includes('ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…') || 
                                   textContent.includes('ä»“åº“ä»»åŠ¡') || 
                                   textContent.includes('box');
            
            console.log('   åŒ…å«æ­£é¢ç‰¹å¾:', hasFrontFeatures ? 'âœ… æ˜¯' : 'âŒ å¦');
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«èƒŒé¢ç‰¹å¾
            const hasBackFeatures = textContent.includes('ä»»åŠ¡æ–‡ä»¶æ¸…å•') || 
                                  textContent.includes('æœ¬ä½“ç ') || 
                                  textContent.includes('æ¡ç ');
            
            console.log('   åŒ…å«èƒŒé¢ç‰¹å¾:', hasBackFeatures ? 'âœ… æ˜¯' : 'âŒ å¦');
        }
        
        return {
            backCount: backElements.length,
            frontCount: frontElements.length,
            containerCount: containers.length
        };
    };
    
    console.log('âœ… æµ‹è¯•å‡½æ•°å·²æ·»åŠ : testBackElements()');
    </script>
    
    <!-- ä»»åŠ¡å…ƒç´ è¯Šæ–­åŠŸèƒ½å·²æ•´åˆåˆ°ç»Ÿä¸€æ¨¡å—ä¸­ -->
    
    <!-- ä»“åº“å®¹å™¨è¯Šæ–­åŠŸèƒ½å·²æ•´åˆåˆ°ç»Ÿä¸€æ¨¡å—ä¸­ -->
    
    <!-- ä»“åº“å®¹å™¨åè°ƒç®¡ç†ç³»ç»Ÿ -->
    <script src="container_coordination_system.js"></script>
    
    <!-- é”™è¯¯æç¤ºå±è”½ç³»ç»Ÿ -->
    <script src="suppress_error_notifications.js"></script>
    
    <!-- ä»»åŠ¡æ‰«æåŠŸèƒ½å·²æ•´åˆåˆ°ç»Ÿä¸€æ¨¡å—ä¸­ -->
    
    <!-- Bootstrap CSS å’Œ JS åº“ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* ===== å…¨å±€æ ·å¼ ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        /* å•†å“æ˜ç»†è¡¨æ ¼å¢å¼ºæ ·å¼ */
        .table-summary {
            background-color: rgba(67, 97, 238, 0.05) !important;
            font-weight: bold;
            border-top: 2px solid var(--primary);
        }
        
        .table-summary td {
            background-color: transparent !important;
        }
        
        /* è°ƒè¯•ä¿¡æ¯æ ·å¼ */
        .debug-info {
            font-size: 0.85em;
            color: #6c757d;
            margin: 4px 0;
        }

        /* éšè—labelå’Œh5å…ƒç´  */
        label {
            display: none !important;
        }
        
        h5 {
            display: none !important;
        }

        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #ef233c;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --sidebar-width: 200px;
            --header-height: 70px;
            --card-radius: 10px;
            --shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            overflow-x: hidden;
        }

        /* ===== ç™»å½•é¡µé¢æ ·å¼ ===== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #4361ee 0%, #7209b7 100%);
            padding: 20px;
        }

        .login-box {
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
            padding: 35px 25px;
            text-align: center;
        }

        .login-logo {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--gray);
            margin-bottom: 25px;
            font-size: 0.95rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .btn {
            padding: 12px 18px;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        /* ===== ä¸»ç³»ç»Ÿæ ·å¼ ===== */
        .main-container {
            display: none;
            min-height: 100vh;
        }

        .header {
            height: var(--header-height);
            background-color: white;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            z-index: 100;
            transition: var(--transition);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .user-role {
            background-color: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
        }

        .logout-btn {
            background-color: var(--gray-light);
            color: var(--dark);
            padding: 6px 14px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background-color: var(--danger);
            color: white;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            padding-top: 25px;
            z-index: 101;
            overflow-y: auto;
        }

        .sidebar-logo {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin-bottom: 25px;
            padding: 0 20px;
        }

        .sidebar-menu {
            list-style: none;
        }

        .menu-link {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 13px 20px;
            color: var(--dark);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            border-left: 4px solid transparent;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 4px;
        }

        .menu-link:hover, .menu-link.active {
            background-color: rgba(67, 97, 238, 0.08);
            color: var(--primary);
            border-left-color: var(--primary);
        }



        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 20px;
            min-height: calc(100vh - var(--header-height));
            transition: var(--transition);
        }

        .module-content {
            display: none;
            animation: fadeIn 0.5s ease;
            height: 100%;
        }

        .module-content.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ===== Alertify å¼¹çª—è‡ªå®šä¹‰æ ·å¼ ===== */
        .alertify .ajs-dialog {
            border-radius: var(--card-radius) !important;
            box-shadow: var(--shadow) !important;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif !important;
            border: none;
        }
        
        .alertify .ajs-header {
            background-color: white !important;
            color: var(--dark) !important;
            font-weight: 600 !important;
            padding: 16px 24px !important;
            border-bottom: 1px solid var(--gray-light) !important;
            font-size: 1.1rem !important;
        }
        
        .alertify .ajs-body {
            background-color: white !important;
        }
        
        .alertify .ajs-content {
            color: var(--dark) !important;
            padding: 24px !important;
            font-size: 0.95rem !important;
            line-height: 1.5 !important;
        }
        
        .alertify .ajs-footer {
            background-color: white !important;
            padding: 16px 24px !important;
            border-top: 1px solid var(--gray-light) !important;
        }
        
        .alertify .ajs-footer .ajs-buttons .ajs-button {
            padding: 8px 16px !important;
            border-radius: 6px !important;
            font-weight: 600 !important;
            cursor: pointer;
            transition: var(--transition) !important;
            border: none !important;
            font-size: 0.9rem !important;
        }
        
        .alertify .ajs-footer .ajs-buttons .ajs-button.ajs-ok {
            background-color: var(--primary) !important;
            color: white !important;
        }
        
        .alertify .ajs-footer .ajs-buttons .ajs-button.ajs-cancel {
            background-color: var(--light) !important;
            color: var(--dark) !important;
        }
        
        .alertify .ajs-footer .ajs-buttons .ajs-button.ajs-ok:hover {
            background-color: var(--primary-dark) !important;
        }
        
        .alertify .ajs-footer .ajs-buttons .ajs-button.ajs-cancel:hover {
            background-color: var(--gray) !important;
            color: white !important;
        }
        
        .alertify-notifier .ajs-message {
            background-color: white !important;
            color: var(--dark) !important;
            border-left: 4px solid var(--primary) !important;
            box-shadow: var(--shadow) !important;
            border-radius: 6px !important;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif !important;
            font-size: 0.9rem !important;
        }
        
        .alertify-notifier .ajs-message.ajs-success {
            border-left-color: var(--success) !important;
        }
        
        .alertify-notifier .ajs-message.ajs-error {
            border-left-color: var(--danger) !important;
        }
        
        .alertify-notifier .ajs-message.ajs-warning {
            border-left-color: var(--warning) !important;
        }
        
        .alertify .ajs-dimmer {
            background-color: rgba(0, 0, 0, 0.5) !important;
        }

        /* ===== é€šç”¨å¡ç‰‡æ ·å¼ ===== */
        /*
        .page-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--dark);
        }
        */

        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 25px;
        }

        .card {
            flex: 1;
            min-width: 280px;
            flex-grow: 1;
            flex-shrink: 1;
            flex-basis: 0;
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: var(--transition);
            border: none;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            display: none;
        }
        
        .stat-card {
            text-align: center;
            background-color: white;
            border-radius: var(--card-radius);
            padding: 20px;
            transition: var(--transition);
            border: none;
            box-shadow: var(--shadow);
            outline: none;
        }
                
        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
                
        .stat-label {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .table-container {
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 25px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            min-height: 60px;
            gap: 12px;
        }
        
        /* äº§å“ç”»å»Šè§†å›¾çš„è¡¨å¤´ä¸éœ€è¦åº•éƒ¨è¾¹æ¡† */
        #productGalleryView .table-header {
            border-bottom: none;
        }
        
        /* å·²å‘å¸ƒä»»åŠ¡ç”»å»Šè§†å›¾å®¹å™¨ä¹Ÿä¸éœ€è¦é¢å¤–çš„è¾¹æ¡† */
        .published-tasks-section {
            border: none;
            box-shadow: none;
            background: transparent;
            padding: 0;
        }
        
        /* ç¡®ä¿ç”»å»Šå®¹å™¨æœ¬èº«æ²¡æœ‰åº•éƒ¨è¾¹æ¡† */
        .published-tasks-gallery {
            border: none !important;
            border-bottom: none !important;
            box-shadow: none !important;
            outline: none !important;
            background: transparent;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
        }

        th {
            font-weight: 700;
            color: var(--dark);
            background-color: rgba(67, 97, 238, 0.05);
            font-size: 0.9rem;
        }
        
        /* è®¾ç½®è¡¨æ ¼åˆ—å®½ä¸ºç›¸ç­‰å®½åº¦ */
        table.equal-width-columns {
            table-layout: fixed;
            width: 100%;
        }
        
        table.equal-width-columns th,
        table.equal-width-columns td {
            width: calc(100% / 5); /* å‡åˆ†ä¸º5åˆ— */
        }

        td {
            font-size: 0.9rem;
        }

        tr:hover {
            background-color: rgba(67, 97, 238, 0.03);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background-color: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
        }

        .badge-warning {
            background-color: rgba(247, 37, 133, 0.2);
            color: #f72585;
        }

        .badge-danger {
            background-color: rgba(239, 35, 60, 0.2);
            color: #ef233c;
        }

        .badge-primary {
            background-color: rgba(67, 97, 238, 0.2);
            color: var(--primary);
        }

        .badge-secondary {
            background-color: rgba(108, 117, 125, 0.2);
            color: var(--gray);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--gray-light);
            color: var(--dark);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px; /* ä¸.btnä¿æŒä¸€è‡´çš„å›¾æ ‡é—´è· */
        }

        .btn-outline:hover {
            background-color: var(--gray-light);
            transform: none;
        }

        /* ===== äº§å“æ·»åŠ æ¨¡å—æ ·å¼ ===== */
        .upload-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .upload-row .upload-area {
            min-height: 110px;
            padding: 15px;
            border: 2px dashed var(--gray-light);
            border-radius: var(--card-radius);
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-row .upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.03);
        }
        
        .upload-row .upload-area.dragover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.08);
        }
        
        .upload-row .upload-area.has-image, 
        .upload-row .upload-area.has-file {
            padding: 10px;
        }
        
        .upload-row .upload-icon {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .upload-row .upload-text {
            color: var(--gray);
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .upload-row .upload-hint {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .upload-row .upload-preview {
            max-width: 100%;
            max-height: 70px;
            object-fit: contain;
            border-radius: 4px;
        }
        
        .upload-row .upload-preview.pdf {
            width: 60px;
            height: 70px;
            object-fit: cover;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            padding: 5px;
        }
        
        .upload-row .upload-remove-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            font-size: 0.8rem;
        }
        
        .upload-row .upload-remove-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .product-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }

        .product-card {
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .product-card:hover {
            transform: translateY(-3px);
        }

        .product-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }

        .product-info {
            padding: 12px;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .product-sku {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        /* ===== é”€å”®è¿è¥æ¨¡å—æ ·å¼ ===== */
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .selected-products {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .selected-tag {
            background-color: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .remove-tag {
            cursor: pointer;
            font-weight: bold;
        }

        .multiselect-dropdown {
            position: absolute;
            background: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            margin-top: 4px;
        }

        /* ===== é”€å”®è¿è¥æ¨¡å—ä»»åŠ¡ä¸Šä¼ åŒºåŸŸæ ·å¼ ===== */
        .task-upload-section {
            margin-top: 16px;
            padding: 16px;
            border: none;
            border-radius: 8px;
            background-color: #FFFFFF;
        }
        
        .task-upload-section h5 {
            margin: 0 0 16px 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* ===== ä»»åŠ¡å¤‡æ³¨åŒºåŸŸæ ·å¼ ===== */
        .task-remark-section {
            margin-top: 16px;
            padding: 16px;
            border: none;
            border-radius: 8px;
            background-color: #FFFFFF;
        }
        
        .task-remark-section h5 {
            margin: 0 0 16px 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .task-remark-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.2s ease;
            margin-top: -20px; /* å†å¾€ä¸Šè°ƒæ•´10pxï¼Œæ€»è®¡20px */
        }
        
        .task-remark-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .task-remark-input::placeholder {
            color: #6c757d;
        }
        
        .form-text {
            margin-top: 6px;
            font-size: 0.85rem;
        }
        
        .task-upload-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .upload-area-col {
            display: flex;
            flex-direction: column;
        }
        
        .upload-area-col label {
            font-size: 0.8rem;
            margin-bottom: 6px;
            color: #666;
            font-weight: 500;
        }
        
        .task-upload-row .upload-area {
            min-height: 110px;
            padding: 15px;
            border: 2px dashed var(--gray-light);
            border-radius: var(--card-radius);
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .task-upload-row .upload-area:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.03);
        }
        
        .task-upload-row .upload-area.dragover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.08);
        }
        
        .task-upload-row .upload-area.has-image, 
        .task-upload-row .upload-area.has-file {
            padding: 10px;
        }
        
        .task-upload-row .upload-icon {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .task-upload-row .upload-text {
            color: var(--gray);
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .task-upload-row .upload-hint {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .task-upload-row .upload-preview {
            max-width: 100%;
            max-height: 70px;
            object-fit: contain;
            border-radius: 4px;
        }
        
        .task-upload-row .upload-preview.pdf {
            width: 60px;
            height: 70px;
            object-fit: cover;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            padding: 5px;
        }
        
        .task-upload-row .upload-remove-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            font-size: 0.8rem;
        }
        
        .task-upload-row .upload-remove-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        /* ===== ä»“åº“å‘è´§æ¨¡å—æ ·å¼ ===== */
        .task-card {
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 16px;
            margin-bottom: 16px;
            transition: var(--transition);
        }

        .task-card:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .task-title {
            font-weight: 700;
            font-size: 1.05rem;
        }

        .task-detail-collapse {
            margin-top: 16px;
            border-top: 1px solid var(--gray-light);
            padding-top: 16px;
        }

        /* ===== ç»Ÿè®¡åˆ†ææ¨¡å—æ ·å¼ ===== */
        .time-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .time-btn {
            padding: 8px 16px;
            background-color: white;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .time-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .stat-card {
            text-align: center;
            background-color: white;
            border-radius: var(--card-radius);
            padding: 20px;
            transition: var(--transition);
            border: none;
            box-shadow: var(--shadow);
            outline: none;
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.85rem;
        }
        
        .user-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .user-btn {
            padding: 8px 16px;
            background-color: white;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .user-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
                
        .stat-card {
            text-align: center;
            background-color: white;
            border-radius: var(--card-radius);
            padding: 20px;
            transition: var(--transition);
            border: none;
            box-shadow: var(--shadow);
            outline: none;
        }
                
        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
                
        .stat-label {
            color: var(--gray);
            font-size: 0.85rem;
        }
                
        /* ===== æœ€è¿‘æ·»åŠ çš„äº§å“å¸ƒå±€ ===== */
        .recent-products-scroll {
            overflow-y: auto;
            height: calc(100% - 50px);
        }

        .recent-product-item {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
        }

        .recent-product-item:last-child {
            border-bottom: none;
        }

        .recent-product-layout {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            font-size: 0.9rem;
        }

        .recent-product-img-container,
        .recent-product-name-container,
        .recent-product-stock-container,
        .recent-product-action-container {
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recent-product-img {
            width: 55px;
            height: 55px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* ===== ç”»å»Šè§†å›¾æ ·å¼ ===== */
        .gallery-view {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-start;
        }

        .gallery-item {
            width: calc(20% - 10px);
            aspect-ratio: 1;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: center;
            display: flex;
            flex-direction: column;
        }

        .gallery-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .gallery-img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background-color: #f8f9fa;
        }

        .gallery-info {
            padding: 8px;
            flex: none;
        }

        .gallery-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }
        
        .gallery-info-row:last-child {
            margin-bottom: 0;
            justify-content: center;
            gap: 8px;
        }

        .gallery-code {
            font-weight: 600;
            color: #333;
            font-size: 0.85rem;
        }

        .gallery-name {
            font-size: 0.8rem;
            color: #666;
        }

        /* è§†å›¾åˆ‡æ¢æŒ‰é’® */
        .view-toggle {
            display: none;
            gap: 8px;
            margin-bottom: 12px;
        }
                
        .view-toggle-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
                
        .view-toggle-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
                
        .view-toggle-btn:hover:not(.active) {
            background-color: #f8f9fa;
        }
                
        /* éšè—ç‰¹å®šçš„view-btnæŒ‰é’® */
        .view-btn {
            display: none;
        }
                
        .view-btn.active {
            display: none;
        }

        /* ===== ä»“åº“ä»»åŠ¡ç”»å»Šè§†å›¾æ ·å¼ ===== */
        .tasks-container {
            min-height: 300px;
        }
        
        /* éšè—ä»“åº“å‘è´§æ¨¡å—çš„æ ‡é¢˜æ–‡å­— */
        #warehouse-operations .card-title {
            display: none;
        }
        
        /* éšè—é”€å”®è¿è¥æ¨¡å—ä¸­åˆ›å»ºå‘è´§ä»»åŠ¡çš„æ ‡é¢˜ */
        .create-task-section .card-title {
            display: none;
        }
        
        .task-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .published-tasks-gallery {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 16px;
            align-content: start;
        }
        
        /* åœ¨è¾ƒå¤§å±å¹•ä¸Šæ˜¾ç¤ºå¤šåˆ—å¡ç‰‡ */
        @media (min-width: 768px) {
            .published-tasks-gallery {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
        }
        
        @media (min-width: 1200px) {
            .published-tasks-gallery {
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }
        }
        
        /* é”€å”®è¿è¥æ¨¡å—ä¸­çš„å·²å‘å¸ƒä»»åŠ¡ï¼šå§‹ç»ˆä¿æŒæ¯è¡Œ2åˆ— */
        .sales-operations-container .published-tasks-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 16px !important;
            margin-top: 16px !important;
            align-content: start;
        }
        
        @media (max-width: 767px) {
            .sales-operations-container .published-tasks-gallery {
                grid-template-columns: repeat(1, 1fr) !important;
            }
        }
        
        @media (min-width: 1200px) {
            .sales-operations-container .published-tasks-gallery {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* ä¸ºå·²å‘å¸ƒçš„ä»»åŠ¡å¡ç‰‡æ·»åŠ ç›¸åŒçš„æ ·å¼ */
        .published-tasks-gallery .task-gallery-item {
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 12px;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            width: 100%;
            height: auto;  /* æ”¹ä¸ºè‡ªåŠ¨é«˜åº¦ */
            perspective: 1500px;
            min-height: 200px;
        }
        
        .published-tasks-gallery .task-gallery-item:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .published-tasks-gallery .task-flip-container {
            width: 100%;
            height: 100%;
        }
        
        .published-tasks-gallery .task-front,
        .published-tasks-gallery .task-back {
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: var(--card-radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 8px 12px;
            overflow: auto;
            position: relative;
        }
        
        .published-tasks-gallery .task-back {
            transform: rotateY(180deg);
            background-color: white;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .published-tasks-gallery .task-back-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            justify-content: center;
            flex: 1;
            min-height: 0;
            padding: 10px 0;
        }
        
        .published-tasks-gallery .task-back-badges {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            width: 100%;
            align-self: center;
            padding: 5px;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .published-tasks-gallery .task-back-actions {
            width: 100%;
            padding: 0;
            flex-shrink: 0;
            margin-top: auto;
            margin-bottom: 0;
            align-self: flex-end;
            flex: 0 0 auto;
        }
        
        .task-gallery-item.flipped .task-flip-container {
            transform: rotateY(180deg);
        }
        
        .task-flip-container.flipped {
            transform: rotateY(180deg);
        }
        
        /* ä»“åº“ä»»åŠ¡ç”»å»Šå›¾ç‰‡å®¹å™¨ - æœ€é«˜ä¼˜å…ˆçº§ä¿®æ­£ */
        .published-tasks-gallery .task-gallery-img {
            width: 100% !important;
            height: 258.66px !important;
            aspect-ratio: 1 / 1 !important;
            object-fit: cover !important;
            border-radius: 6px !important;
            margin-bottom: 8px !important;
            background-color: #f8f9fa !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* ç‰¹å®šIDé€‰æ‹©å™¨ç¡®ä¿æœ€é«˜ä¼˜å…ˆçº§ */
        #warehouseTasks.published-tasks-gallery .task-gallery-img {
            width: 100% !important;
            height: 258.66px !important;
            aspect-ratio: 1 / 1 !important;
            object-fit: cover !important;
        }
        
        .published-tasks-gallery .task-gallery-img img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .published-tasks-gallery .task-gallery-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
            word-break: break-word;
        }
        
        .published-tasks-gallery .task-gallery-code {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }
        
        .published-tasks-gallery .task-gallery-qty {
            font-weight: 600;
            color: var(--warning);
            margin-bottom: 4px;
        }
        
        /* ä½¿ç”¨flexboxä½¿å·²å‘å¸ƒä»»åŠ¡çš„è´§å·å’Œæ•°é‡åœ¨åŒä¸€è¡Œæ˜¾ç¤º */
        .published-tasks-gallery .task-front > div.task-gallery-code,
        .published-tasks-gallery .task-front > div.task-gallery-qty {
            display: inline-block;
            width: 48%;
            text-align: center;
        }
        
        .published-tasks-gallery .task-gallery-actions {
            display: flex;
            gap: 6px;
            width: 100%;
        }
        
        .published-tasks-gallery .task-gallery-actions .btn {
            flex: 1;
            padding: 6px 8px;
            font-size: 0.8rem;
        }
        
        .task-flip-outer-container {
            width: 100%;
            height: 100%;
            perspective: 1500px;
            transform-style: preserve-3d;
        }
        
        .task-flip-container {
            width: 278.66px;
            height: 278.66px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            -webkit-transform-style: preserve-3d;
            -webkit-transition: transform 0.6s;
            transform-origin: center;
            -webkit-transform-origin: center;
            /* ç¡®ä¿å®¹å™¨1:1æ¯”ä¾‹æ˜¾ç¤º */
            max-width: 278.66px;
            max-height: 278.66px;
            flex-shrink: 0;
            align-self: flex-start;
            /* ç¡®ä¿å®¹å™¨ä¸ä¼šå½±å“å¸ƒå±€å®½åº¦ */
            flex: 0 0 auto;
            /* æ·»åŠ 3Dè§†è§’ */
            perspective: 1500px;
        }
        
        .task-flip-container .task-front, .task-flip-container .task-back {
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: var(--card-radius);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            text-align: center;
            padding: 8px 12px;
            overflow: hidden;
            background-color: white;
            box-shadow: var(--shadow);
            box-sizing: border-box;
            -webkit-backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            transform-style: preserve-3d;
            min-height: 220px;
        }
        
        .task-flip-container .task-back {
            transform: rotateY(180deg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            padding: 8px 12px;
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
            height: 100%;
            max-height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform-style: preserve-3d;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            min-height: 220px;
            /* ç¡®ä¿å®½åº¦å›ºå®šï¼Œé˜²æ­¢ç¿»è½¬æ—¶å˜å½¢ */
            flex-shrink: 0;
            align-self: flex-start;
            /* å›ºå®šå®½åº¦ä»¥é˜²æ­¢å¸ƒå±€é”™ä½ */
            flex: 1 1 auto;
            /* ç¡®ä¿ç¿»è½¬åçš„èƒŒé¢å®½åº¦ä¸å®¹å™¨ä¸€è‡´ */
            align-self: stretch;
        }
        
        .task-flip-container .task-front {
            transform-style: preserve-3d;
            position: relative;
            z-index: 2;
            min-height: 220px;
            align-items: center;
        }
        
        /* é€šç”¨ä»»åŠ¡å¡ç‰‡æ­£é¢æ ·å¼ */
        .task-flip-container .task-front {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            justify-content: space-between;
            padding: 8px 12px;
            box-sizing: border-box;
            width: 100%;
            max-width: 100%;
            z-index: 2;
        }
        
        /* å“åº”å¼è°ƒæ•´ï¼šå°å±å¹•ä¸Šé€‚å½“å‡å°é€šç”¨ä»»åŠ¡å¡ç‰‡é«˜åº¦ */
        @media (max-width: 768px) {
            .task-flip-container .task-front,
            .task-flip-container .task-back {
                min-height: 200px;
                width: 100%;
                max-width: 100%;
            }
            
            .task-flip-container .task-front {
                align-items: center;
            }
            
            .task-flip-container .task-back {
                align-items: stretch;
                justify-content: flex-start;
            }
        }
        
        @media (max-width: 576px) {
            .task-flip-container .task-front,
            .task-flip-container .task-back {
                min-height: 180px;
                width: 100%;
                max-width: 100%;
            }
            
            .task-flip-container .task-front {
                align-items: center;
            }
            
            .task-flip-container .task-back {
                align-items: stretch;
                justify-content: flex-start;
            }
        }
        
        .task-flip-container.flipped {
            transform: rotateY(180deg);
        }        
        /* ç¡®ä¿ä»“åº“å‘è´§ç«¯çš„å¡ç‰‡ä¹Ÿå…·æœ‰ä¸å·²å‘å¸ƒä»»åŠ¡ç›¸åŒçš„å¤–è§‚ */
        .task-flip-container .task-front {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        /* ç¡®ä¿ä»“åº“å‘è´§ç«¯çš„å›¾ç‰‡å°ºå¯¸ä¸å·²å‘å¸ƒä»»åŠ¡ç›¸åŒ */
        .task-flip-container .task-gallery-img {
            width: 262.66px;
            height: 258.66px !important;  /* ç»Ÿä¸€é«˜åº¦ä¸º258.66px */
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .task-flip-container .task-gallery-img img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* ç¡®ä¿ä»“åº“å‘è´§ç«¯ä»»åŠ¡ä¿¡æ¯ä¹Ÿä½¿ç”¨ç›¸åŒå¸ƒå±€ */
        .task-flip-container .task-info-container {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .task-flip-container .task-info-container .task-gallery-name,
        .task-flip-container .task-info-container .task-gallery-code,
        .task-flip-container .task-info-container .task-gallery-qty {
            flex: 1;
            text-align: center;
            margin-bottom: 0;
            font-size: 0.8rem;
        }
        
        .task-flip-container .task-info-container .task-gallery-creator {
            flex: 1;
            text-align: center;
            margin-bottom: 0;
            font-size: 0.7rem;
            color: #888;
        }
        
        .task-card-container {
            position: relative;
        }
        
        .delete-task-btn {
            width: auto;
            min-width: 32px;
            padding: 4px 8px !important;
            font-size: 0.75rem;
        }
        
        .task-flip-container .task-info-container .task-gallery-name {
            font-weight: 600;
            margin-bottom: 0;
        }
        
        .task-flip-container .task-info-container .task-gallery-code {
            color: #666;
        }
        
        /* é’ˆå¯¹ç¿»è½¬å¡ç‰‡çš„è´§å·å’Œæ•°é‡éšè—æ ‡ç­¾æ ·å¼ */
        .task-flip-container .task-info-container .task-gallery-code,
        .task-flip-container .task-info-container .task-gallery-qty {
            position: relative;
            /* éšè—åŸå§‹æ ‡ç­¾ */
            text-indent: -9999px;
            overflow: hidden;
        }
        
        /* é’ˆå¯¹ç¿»è½¬å¡ç‰‡çš„åˆ›å»ºäººéšè—æ ‡ç­¾æ ·å¼ */
        .task-flip-container .task-info-container .task-gallery-creator {
            position: relative;
            /* éšè—åŸå§‹æ ‡ç­¾ */
            text-indent: -9999px;
            overflow: hidden;
        }
        
        /* ä½¿ç”¨ä¼ªå…ƒç´ æ˜¾ç¤ºå®é™…å†…å®¹ */
        .task-flip-container .task-info-container .task-gallery-code::before {
            content: attr(data-content);
            position: absolute;
            left: 0;
            right: 0;
            text-indent: 0;
        }
        
        .task-flip-container .task-info-container .task-gallery-qty::before {
            content: attr(data-content);
            position: absolute;
            left: 0;
            right: 0;
            text-indent: 0;
        }
        
        .task-flip-container .task-info-container .task-gallery-creator::before {
            content: attr(data-content);
            position: absolute;
            left: 0;
            right: 0;
            text-indent: 0;
        }
        
        /* ä»“åº“å‘è´§ç«¯ä»»åŠ¡æ“ä½œæŒ‰é’®æ ·å¼ */
        .task-flip-container .task-gallery-actions {
            display: flex;
            gap: 6px;
            width: 100%;
        }
        
        /* ç¡®ä¿ä»»åŠ¡å¡ç‰‡åœ¨ç½‘æ ¼ä¸­æ­£ç¡®æ’åˆ— */
        .task-card-container {
            position: relative;
            display: inline-block;
            vertical-align: top;
        }
        
        /* ç‰¹å®šä»»åŠ¡å¡ç‰‡æ ·å¼ï¼Œé˜²æ­¢é‡å  */
        div[id^="task-"][id$="-front"].task-front {
            position: static !important;
            z-index: auto !important;
        }
        
        /* ä»»åŠ¡ä¿¡æ¯è¦†ç›–å±‚æ ·å¼ */
        .task-info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: #ffffff;
            padding: 12px;
            border-radius: 0 0 6px 6px;
            font-size: 14px;
            min-height: 40px;
            display: flex;
            align-items: center;
            z-index: 10;
            backdrop-filter: blur(2px);
            transition: opacity 0.3s ease;
            opacity: 0.9;
        }
        
        /* è¦†ç›–å±‚å†…å®¹å®¹å™¨ - æ°´å¹³æ’åˆ— */
        .task-info-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 15px;
        }
        
        /* å•†å“åç§°æ ·å¼ */
        .task-info-name {
            font-weight: normal;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
            text-align: left;
        }
        
        /* æ•°é‡æ ·å¼ */
        .task-info-quantity {
            font-weight: bold;
            color: #ff9800;
            font-size: 14px;
            flex: 0 0 auto;
            text-align: center;
            padding: 0 10px;
        }
        
        /* åˆ›å»ºäººæ ·å¼ */
        .task-info-creator {
            color: #ffffff;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 0 0 auto;
            text-align: right;
            min-width: 80px;
        }
        
        /* å›¾ç‰‡å®¹å™¨ç›¸å¯¹å®šä½ */
        .task-gallery-img {
            position: relative !important;
            overflow: visible !important;
        }
        
        /* å·²ç§»é™¤æ‚¬åœæ•ˆæœ */
        
        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            .task-info-overlay {
                padding: 8px;
                min-height: 30px;
            }
            
            .task-info-name {
                font-size: 12px;
            }
            
            .task-info-quantity {
                font-size: 12px;
                padding: 0 8px;
            }
            
            .task-info-creator {
                font-size: 11px;
                min-width: 60px;
            }
            
            .task-info-content {
                gap: 8px;
            }
        }
        
        /* ç¡®ä¿è¦†ç›–å±‚åœ¨æ‰€æœ‰ä»»åŠ¡ç±»å‹ä¸­éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º */
        .published-tasks-gallery .task-info-overlay,
        .warehouse-tasks-gallery .task-info-overlay,
        .task-flip-container .task-info-overlay {
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
        }
        
        /* å®Œå…¨éšè—åŸæœ‰çš„åº•éƒ¨ä»»åŠ¡ä¿¡æ¯æ˜¾ç¤º */
        .task-info-inline {
            display: none !important;
        }
        
        /* éšè—å¾…å‘çŠ¶æ€æ ‡ç­¾ */
        .badge-warning {
            display: none !important;
        }
        
        .published-tasks-gallery .task-card-container {
            margin: 0;
            padding: 0;
        }
        
        .task-flip-container .task-gallery-actions .btn {
            flex: 1;
            padding: 6px 8px;
            font-size: 0.8rem;
        }
        
        .task-back-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 6px;
            justify-content: flex-start;
            flex: 1 1 auto;
            min-height: 0;
            padding: 6px;
            overflow: hidden;
            box-sizing: border-box;
            height: 357px;
            max-height: 357px;
            flex-grow: 1;
            align-self: stretch;
        }
        
        .task-files-container {
            min-width: 250px;
            min-height: 150px;
            width: 100%;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
            margin-top: -2px; /* å‘ä¸‹è°ƒæ•´3px */
            overflow-y: auto;
            padding: 6px;
            box-sizing: border-box;
            flex-shrink: 0;
            max-width: 100%;
            overflow-x: hidden;
            align-self: stretch;
        }
        
        .task-file-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px; /* äº¤æ¢å†…è¾¹è· */
            border: 1px solid #e9ecef;
            border-radius: 8px;
            min-height: 70px; /* è°ƒæ•´é«˜åº¦åˆ°70px */
            justify-content: center;
            background-color: #f8f9fa;
            min-width: 50px; /* äº¤æ¢é«˜åº¦å’Œå®½åº¦ */
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        
        .task-file-item:hover {
            border-color: var(--primary);
            background-color: #eef2ff;
        }
        
        .file-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 2px;
        }
        
        .file-preview {
            max-width: 100%;
            max-height: 70px;
            object-fit: contain;
            border-radius: 4px;
            border: 1px solid #ddd;
            padding: 2px;
            background-color: #fff;
        }
        
        .pdf-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 70px;
            object-fit: cover;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
            font-size: 24px;
            color: #e74c3c;
        }
        
        .pdf-preview i {
            margin-bottom: 4px;
        }
        
        .pdf-filename {
            font-size: 0.6rem;
            text-align: center;
            max-width: 100%;
            word-break: break-all;
            color: #666;
        }
        
        .no-file {
            font-size: 0.65rem;
            color: #aaa;
            font-style: italic;
        }
        
        
        .back-action-buttons {
            display: flex;
            gap: 8px;
            width: 100%;
            margin-top: auto;
            margin-bottom: 0;
            padding: 8px 8px 0 8px; /* æ¢å¤åŸå§‹padding */
        }
        
        .back-action-buttons .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            margin-top: -10px; /* æŒ‰é’®ä¸Šç§»10px */
        }
        
        /* è°ƒæ•´èƒŒé¢æ“ä½œæŒ‰é’®çš„å‚ç›´ä½ç½® */
        .task-back-actions {
            width: 100%;
            padding: 0;
            flex-shrink: 0;
            margin-top: auto;
            margin-bottom: 0;
            align-self: flex-end;
            flex: 0 0 auto;
            background-color: transparent;
        }
        
        /* ç¡®è®¤å‘è´§æŒ‰é’®ä¸Šç§»10px */
        .back-action-buttons .btn.btn-success {
            margin-top: -10px !important;
        }
        
        /* ç»Ÿä¸€ä»»åŠ¡å¡ç‰‡å°ºå¯¸è°ƒæ•´ - 1:1æ¯”ä¾‹æ˜¾ç¤º 278.66px x 278.66px */
        .task-flip-container {
            width: 278.66px !important;
            height: 278.66px !important;
        }
        
        /* é”€å”®è¿è¥æ¨¡å—ä»»åŠ¡å¡ç‰‡ç»Ÿä¸€æ ·å¼ */
        .sales-operations-container .task-flip-container {
            width: 278.66px !important;
            height: 278.66px !important;
        }
        
        /* ä»“åº“å‘è´§æ¨¡å—ä»»åŠ¡å¡ç‰‡ç»Ÿä¸€æ ·å¼ */
        .warehouse-tasks-gallery .task-flip-container {
            width: 278.66px !important;
            height: 278.66px !important;
        }
        
        /* ç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨ç»Ÿä¸€æ ·å¼ */
        #specific-task-card-container .task-flip-container {
            width: 278.66px !important;
            height: 278.66px !important;
        }
        .card {
            flex: 1;
            min-width: 280px;
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: var(--transition);
            border: none;
        }
                
                
        /* ä»»åŠ¡å¡ç‰‡æ ·å¼ */
        .warehouse-tasks-gallery .task-front {
            /* åº”ç”¨ç»Ÿè®¡å¡æ ·å¼ */
            text-align: center;
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 15px;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: auto;
            position: relative;
            width: 282.66px;
            height: 282.66px;
            perspective: 1500px;
            min-height: 282.66px;
            box-sizing: border-box;
            max-width: 282.66px;
            border: none;
        }
        
        /* ç¡®ä¿ä»»åŠ¡ç¿»è½¬å®¹å™¨åœ¨ç½‘æ ¼ä¸­æ­£ç¡®æ˜¾ç¤º */
        .warehouse-tasks-gallery .task-flip-container {
            display: block;
            width: 100%;
            height: auto;
            margin: 0;
            padding: 0;
            min-height: 320px; /* å¢åŠ æœ€å°é«˜åº¦åˆ°320pxç¡®ä¿ä¿¡æ¯æ˜¾ç¤º */
        }
        
        /* ç¡®ä¿ä»»åŠ¡å¡ç‰‡æœ¬èº«ä¸å½±å“ç½‘æ ¼å¸ƒå±€ */
        .warehouse-tasks-gallery .task-front,
        .warehouse-tasks-gallery .task-back {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: auto;
            margin: 0;
            min-height: 320px; /* å¢åŠ æœ€å°é«˜åº¦åˆ°320px */
            padding: 15px; /* å¢åŠ å†…è¾¹è· */
        }
        @media (max-width: 768px) {
            .warehouse-tasks-gallery .task-front {
                min-height: 280px; /* ç§»åŠ¨ç«¯ä¹Ÿå¢åŠ é«˜åº¦åˆ°280px */
                padding: 15px; /* å¢åŠ å†…è¾¹è· */
                width: calc(100% - 20px);
                max-width: 282.66px;
            }
        }
        
        @media (max-width: 576px) {
            .warehouse-tasks-gallery .task-front {
                min-height: 260px; /* å°å±è®¾å¤‡å¢åŠ é«˜åº¦åˆ°260px */
                padding: 12px; /* é€‚å½“å‡å°‘å†…è¾¹è· */
                width: calc(100% - 12px);
                max-width: 282.66px;
            }
        }
        
        .warehouse-tasks-gallery .task-front:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        /* ä»“åº“ä»»åŠ¡ç”»å»Š - æœ€é«˜ä¼˜å…ˆçº§ç½‘æ ¼å¸ƒå±€ */
        .task-gallery.warehouse-tasks-gallery {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 16px !important; /* ç»Ÿä¸€é—´è·ä¸stat-cardä¸€è‡´ */
            margin-top: 15px !important;
            width: 100% !important;
            align-content: start !important;
            justify-content: stretch !important;
            grid-auto-rows: minmax(350px, auto) !important; /* å¢åŠ æœ€å°é«˜åº¦åˆ°350pxç¡®ä¿ä¿¡æ¯æ˜¾ç¤º */
        }
                    
        /* ä»»åŠ¡å¡ç‰‡ç»Ÿä¸€è‡ªé€‚åº”å®½åº¦ - ä¸stat-cardä¿æŒä¸€è‡´ */
        .task-gallery.warehouse-tasks-gallery .task-flip-container {
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            min-height: 300px !important; /* å¢åŠ æœ€å°é«˜åº¦ */
            flex: 1 1 auto !important;
        }
        
        /* ç¡®ä¿ä»»åŠ¡å¡ç‰‡æ­£é¢æœ‰è¶³å¤Ÿçš„æ˜¾ç¤ºç©ºé—´ */
        .task-gallery.warehouse-tasks-gallery .task-front {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: space-between !important;
            padding: 15px !important;
            min-height: 300px !important; /* ç¡®ä¿è¶³å¤Ÿé«˜åº¦ */
            height: 100% !important;
        }
        
        /* ç¡®ä¿ä»»åŠ¡ä¿¡æ¯åŒºåŸŸèƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤º - å·²åºŸå¼ƒï¼Œç”±è¦†ç›–å±‚æ›¿ä»£ */
        .task-gallery.warehouse-tasks-gallery .task-info-inline {
            display: none !important;
        }
        
        /* ç¡®ä¿ä¼ªå…ƒç´ æ­£ç¡®æ˜¾ç¤ºå†…å®¹ */
        .task-gallery.warehouse-tasks-gallery .task-gallery-code::before,
        .task-gallery.warehouse-tasks-gallery .task-gallery-qty::before,
        .task-gallery.warehouse-tasks-gallery .task-gallery-creator::before {
            content: attr(data-content) !important;
            position: static !important;
            display: inline !important;
            text-indent: 0 !important;
            overflow: visible !important;
            white-space: nowrap !important;
            color: inherit !important;
        }
        
        /* ç¡®ä¿å•†å“åç§°æ­£å¸¸æ˜¾ç¤º */
        .task-gallery.warehouse-tasks-gallery .task-gallery-name {
            text-indent: 0 !important;
            overflow: visible !important;
            white-space: nowrap !important;
            color: #333 !important;
            font-weight: 600 !important;
        }
        
        /* ç¡®ä¿å•ä¸ªä¿¡æ¯é¡¹èƒ½å¤Ÿå®Œæ•´æ˜¾ç¤º */
        .task-gallery.warehouse-tasks-gallery .task-gallery-name,
        .task-gallery.warehouse-tasks-gallery .task-gallery-qty,
        .task-gallery.warehouse-tasks-gallery .task-gallery-creator {
            flex: 0 0 auto !important;
            margin-bottom: 0 !important;
            font-size: 0.85rem !important;
            white-space: nowrap !important;
            overflow: visible !important; /* ç¡®ä¿ä¸è¢«éšè— */
            text-overflow: clip !important;
            max-width: none !important; /* ç§»é™¤å®½åº¦é™åˆ¶ */
        }
        
        .task-gallery.warehouse-tasks-gallery .task-gallery-name {
            font-weight: 600 !important;
        }
        
        .task-gallery.warehouse-tasks-gallery .task-gallery-qty {
            color: #666 !important;
        }
        
        .task-gallery.warehouse-tasks-gallery .task-gallery-creator {
            color: #999 !important;
            font-size: 0.8rem !important;
        }
        
        /* ç‰¹å®šä»“åº“å‘è´§ä»»åŠ¡å¡ç‰‡æ ·å¼ - ä¸å½±å“é”€å”®è¿è¥ä»»åŠ¡å¡ */
        .warehouse-tasks-gallery #task-107-front.task-front {
            min-width: 302.66px !important;
            min-height: 302.66px !important;
            aspect-ratio: 1 / 1 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* ä»»åŠ¡å¡ç‰‡æ­£é¢å®½åº¦ä¸stat-cardä¿æŒä¸€è‡´ */
        .task-gallery.warehouse-tasks-gallery .task-front {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 302.66px !important;
            min-height: 302.66px !important;
            aspect-ratio: 1 / 1 !important;
            box-sizing: border-box !important;
        }
                    
        .task-gallery.warehouse-tasks-gallery .task-front,
        .task-gallery.warehouse-tasks-gallery .task-back {
            width: 100% !important;
            max-width: 100% !important;
            height: 100% !important;
            min-width: 302.66px !important;
            min-height: 302.66px !important;
            aspect-ratio: 1 / 1 !important;
            box-sizing: border-box !important;
        }
                    
        /* ç§»é™¤ç‰¹å®šä»»åŠ¡å¡ç‰‡çš„å›ºå®šå®½åº¦é™åˆ¶ */
        #task-96-front.task-front,
        #task-95-front.task-front {
            width: 100% !important;
            max-width: 100% !important;
            min-width: 302.66px !important;
            height: auto !important;
            min-height: 302.66px !important;
            aspect-ratio: 1 / 1 !important;
            box-sizing: border-box !important;
        }
        
        /* å¼ºåˆ¶è¦†ç›–æ‰€æœ‰å­å…ƒç´ æ ·å¼ */
        .task-gallery.warehouse-tasks-gallery .task-flip-container {
            display: block !important;
            width: 100% !important;
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            min-height: 250px !important;
            grid-column: auto !important;
            grid-row: auto !important;
        }
        
        /* å¼ºåˆ¶å¡ç‰‡æ­£é¢æ ·å¼ */
        .task-gallery.warehouse-tasks-gallery .task-front {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            text-align: center !important;
            justify-content: space-between !important;
            padding: 15px !important;
            background-color: white !important;
            border-radius: 10px !important;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08) !important;
            min-height: 250px !important;
            width: 100% !important;
        }
        
        /* ä»»åŠ¡ç¿»è½¬å®¹å™¨ */
        .task-gallery.warehouse-tasks-gallery .task-flip-container {
            display: block;
            width: 100%;
            height: auto;
            margin: 0;
            padding: 0;
            min-height: 250px;
        }
        
        /* ä»»åŠ¡å¡ç‰‡æ­£é¢æ ·å¼ */
        .task-gallery.warehouse-tasks-gallery .task-front {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            justify-content: space-between;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            min-height: 250px;
            width: 100%;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .task-gallery.warehouse-tasks-gallery {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px; /* ç»Ÿä¸€é—´è·ä¸stat-cardä¸€è‡´ */
            }
            
            /* å¹³æ¿è®¾å¤‡ä»»åŠ¡å¡ç‰‡è‡ªé€‚åº” */
            .task-gallery.warehouse-tasks-gallery .task-flip-container {
                width: 100% !important;
                max-width: 100% !important;
                min-height: 280px !important;
            }
            
            .task-gallery.warehouse-tasks-gallery .task-front,
            .task-gallery.warehouse-tasks-gallery .task-back {
                min-height: 280px !important;
                padding: 12px !important;
            }
            
            #task-96-front.task-front,
            #task-95-front.task-front {
                min-height: 302.66px !important;
                min-width: 302.66px !important;
                aspect-ratio: 1 / 1 !important;
            }
            
            .task-gallery.warehouse-tasks-gallery .task-front {
                min-height: 230px;
                padding: 12px;
            }
        }
        
        @media (max-width: 768px) {
            .task-gallery.warehouse-tasks-gallery {
                grid-template-columns: 1fr;
                gap: 16px; /* ç»Ÿä¸€é—´è·ä¸stat-cardä¸€è‡´ */
            }
            
            /* ç§»åŠ¨è®¾å¤‡ä»»åŠ¡å¡ç‰‡è‡ªé€‚åº” */
            .task-gallery.warehouse-tasks-gallery .task-flip-container {
                width: 100% !important;
                max-width: 100% !important;
                min-height: 260px !important;
            }
            
            .task-gallery.warehouse-tasks-gallery .task-front,
            .task-gallery.warehouse-tasks-gallery .task-back {
                min-height: 260px !important;
                padding: 10px !important;
            }
            
            #task-96-front.task-front,
            #task-95-front.task-front {
                min-height: 302.66px !important;
                min-width: 302.66px !important;
                aspect-ratio: 1 / 1 !important;
            }
            
            .task-gallery.warehouse-tasks-gallery .task-front {
                min-height: 220px;
                padding: 10px;
            }
        }
        

        
        
        
        

        

        .btn-complete-shipment {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .task-gallery-img {
            width: 262.66px;
            height: 262.66px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .task-gallery-img img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .published-tasks-gallery .task-gallery-img {
            width: 100% !important;
            height: 258.66px !important;
            aspect-ratio: 1 / 1 !important;
            object-fit: cover !important;
            border-radius: 6px !important;
            margin-bottom: 8px !important;
            background-color: #f8f9fa !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .published-tasks-gallery .task-gallery-img img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .task-gallery-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
            word-break: break-word;
        }
        
        /* è®©è´§å·å’Œæ•°é‡åœ¨åŒä¸€è¡Œæ˜¾ç¤º - ä»…é™å·²å‘å¸ƒä»»åŠ¡ */
        .published-tasks-gallery .task-front {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
            width: 282.66px;
            max-width: 282.66px;
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: var(--card-radius);
            overflow: hidden;
            background-color: white;
            box-shadow: var(--shadow);
            -webkit-backface-visibility: hidden;
            top: 0;
            left: 0;
            min-height: 282.66px;
        }
        
        /* å“åº”å¼è°ƒæ•´ï¼šå°å±å¹•ä¸Šé€‚å½“å‡å°å¡ç‰‡é«˜åº¦ */
        @media (max-width: 768px) {
            .published-tasks-gallery .task-front {
                min-height: 250px;
                width: calc(100% - 20px);
                max-width: 282.66px;
            }
        }
        
        @media (max-width: 576px) {
            .published-tasks-gallery .task-front {
                min-height: 250px;
                width: calc(100% - 12px);
                max-width: 282.66px;
            }
        }
        
        .task-gallery-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
            word-break: break-word;
        }
        
        /* ä½¿ç”¨flexboxä½¿äº§å“åç§°ã€è´§å·å’Œæ•°é‡åœ¨åŒä¸€è¡Œæ˜¾ç¤º */
        .task-info-container {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .task-info-container .task-gallery-name,
        .task-info-container .task-gallery-code,
        .task-info-container .task-gallery-qty {
            flex: 1;
            text-align: center;
            margin-bottom: 0;
            font-size: 0.8rem;
        }
        
        .task-info-container .task-gallery-name {
            font-weight: 600;
            margin-bottom: 0;
        }
        
        .task-info-container .task-gallery-code {
            color: #666;
        }
        
        /* éšè—è´§å·ã€æ•°é‡å’Œåˆ›å»ºäººæ ‡ç­¾ï¼Œåªæ˜¾ç¤ºå®é™…å†…å®¹ */
        .task-gallery-code, .task-gallery-qty, .task-gallery-creator {
            position: relative;
            /* éšè—åŸå§‹æ ‡ç­¾ */
            text-indent: -9999px;
            overflow: hidden;
        }
        
        /* ä½¿ç”¨ä¼ªå…ƒç´ æ˜¾ç¤ºå®é™…å†…å®¹ */
        .task-gallery-code::before {
            content: attr(data-content);
            position: absolute;
            left: 0;
            right: 0;
            text-indent: 0;
        }
        
        .task-gallery-qty::before {
            content: attr(data-content);
            position: absolute;
            left: 0;
            right: 0;
            text-indent: 0;
        }
        
        .task-gallery-creator::before {
            content: attr(data-content);
            position: absolute;
            left: 0;
            right: 0;
            text-indent: 0;
        }
        
        .published-tasks-gallery .task-info-container {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .published-tasks-gallery .task-info-container .task-gallery-name,
        .published-tasks-gallery .task-info-container .task-gallery-code,
        .published-tasks-gallery .task-info-container .task-gallery-qty {
            flex: 1;
            text-align: center;
            margin-bottom: 0;
            font-size: 0.8rem;
        }
        
        .published-tasks-gallery .task-info-container .task-gallery-name {
            font-weight: 600;
            margin-bottom: 0;
        }
        
        .published-tasks-gallery .task-info-container .task-gallery-code {
            color: #666;
        }
        
        /* é’ˆå¯¹å·²å‘å¸ƒä»»åŠ¡çš„è´§å·ã€æ•°é‡å’Œåˆ›å»ºäººéšè—æ ‡ç­¾æ ·å¼ */
        .published-tasks-gallery .task-info-container .task-gallery-code,
        .published-tasks-gallery .task-info-container .task-gallery-qty,
        .published-tasks-gallery .task-info-container .task-gallery-creator {
            position: relative;
            /* éšè—åŸå§‹æ ‡ç­¾ */
            text-indent: -9999px;
            overflow: hidden;
        }
        
        /* ä½¿ç”¨ä¼ªå…ƒç´ æ˜¾ç¤ºå®é™…å†…å®¹ */
        .published-tasks-gallery .task-info-container .task-gallery-code::before {
            content: attr(data-content);
            position: absolute;
            left: 0;
            right: 0;
            text-indent: 0;
        }
        
        .published-tasks-gallery .task-info-container .task-gallery-qty::before {
            content: attr(data-content);
            position: absolute;
            left: 0;
            right: 0;
            text-indent: 0;
        }
        
        .published-tasks-gallery .task-info-container .task-gallery-creator::before {
            content: attr(data-content);
            position: absolute;
            left: 0;
            right: 0;
            text-indent: 0;
        }
        
        /* é’ˆå¯¹ç¿»è½¬å¡ç‰‡çš„æ ·å¼ */

        /* === ä»»åŠ¡å¡ç‰‡å¸ƒå±€è°ƒæ•´ === */
        /* è°ƒæ•´ä»»åŠ¡æ“ä½œæ å®½åº¦ä¸º40px */
        .task-gallery-actions {
            width: 40px !important;
            min-width: 40px !important;
            flex-shrink: 0 !important;
        }
        
        /* ç¡®ä¿ä»»åŠ¡å¡ç‰‡å†…å®¹åŒºåŸŸå……åˆ†åˆ©ç”¨å‰©ä½™ç©ºé—´ */
        .task-card-content {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            width: 100% !important;
        }
        
        /* å•†å“ä¿¡æ¯å®¹å™¨æ ·å¼è°ƒæ•´ */
        .task-info-inline {
            display: none !important;
        }
        
        /* å•ä¸ªä¿¡æ¯é¡¹æ ·å¼ */
        .task-gallery-name,
        .task-gallery-qty,
        .task-gallery-creator {
            flex: 1 !important;
            text-align: center !important;
            font-size: 0.85rem !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            min-width: 0 !important;
        }
        
        /* å•†å“åç§°ç‰¹æ®Šæ ·å¼ */
        .task-gallery-name {
            font-weight: 600 !important;
            color: #333 !important;
        }
        
        /* æ•°é‡å’Œåˆ›å»ºäººæ ·å¼ */
        .task-gallery-qty,
        .task-gallery-creator {
            font-size: 0.75rem !important;
            color: #666 !important;
        }
        
        /* é’ˆå¯¹ä¸åŒå±å¹•å°ºå¯¸çš„å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .task-info-inline {
                gap: 8px !important;
            }
            
            .task-gallery-name,
            .task-gallery-qty,
            .task-gallery-creator {
                font-size: 0.7rem !important;
                max-width: 80px !important;
            }
        }
        
        @media (max-width: 576px) {
            .task-info-inline {
                gap: 6px !important;
            }
            
            .task-gallery-name,
            .task-gallery-qty,
            .task-gallery-creator {
                font-size: 0.65rem !important;
                max-width: 60px !important;
            }
        }
        
        /* ç¡®ä¿åœ¨å·²å‘å¸ƒä»»åŠ¡ç”»å»Šä¸­çš„æ ·å¼ä¹Ÿç”Ÿæ•ˆ */
        .published-tasks-gallery .task-gallery-actions {
            width: 40px !important;
            min-width: 40px !important;
            flex-shrink: 0 !important;
        }
        
        .published-tasks-gallery .task-card-content {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            width: 100% !important;
        }
        
        .published-tasks-gallery .task-info-inline {
            display: none !important;
        }
        /* === ä»»åŠ¡å¡ç‰‡å¸ƒå±€è°ƒæ•´ç»“æŸ === */

/* === ä»“åº“ä»»åŠ¡ä¿æŠ¤è¡¥ä¸ === */
/* ç¡®ä¿ä»“åº“å‘è´§ä»»åŠ¡å¡ç‰‡ä¸å—é€šç”¨æ ·å¼å½±å“ */
.warehouse-tasks-gallery .task-gallery-actions {
    width: auto !important;
    min-width: auto !important;
}

.warehouse-tasks-gallery .task-card-content {
    /* ä¿æŒä»“åº“ä»»åŠ¡åŸæœ‰çš„å¸ƒå±€ */
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
    width: 100% !important;
}

.warehouse-tasks-gallery .task-info-inline {
    /* å·²åºŸå¼ƒï¼Œç”±è¦†ç›–å±‚æ›¿ä»£ */
    display: none !important;
}

/* ç¡®ä¿ä»“åº“ä»»åŠ¡çš„ç½‘æ ¼å¸ƒå±€ä¸å—å½±å“ */
.warehouse-tasks-gallery {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 15px !important;
}
/* === ä»“åº“ä»»åŠ¡ä¿æŠ¤è¡¥ä¸ç»“æŸ === */



        /* === ä»»åŠ¡å¡ç‰‡å¸ƒå±€è°ƒæ•´ === */
        /* è°ƒæ•´ä»»åŠ¡æ“ä½œæ å®½åº¦ä¸º40px */
        .task-gallery-actions {
            width: 40px !important;
            min-width: 40px !important;
            flex-shrink: 0 !important;
        }
        
        /* ç¡®ä¿ä»»åŠ¡å¡ç‰‡å†…å®¹åŒºåŸŸå……åˆ†åˆ©ç”¨å‰©ä½™ç©ºé—´ */
        .task-card-content {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            width: 100% !important;
        }
        
        /* å•†å“ä¿¡æ¯å®¹å™¨æ ·å¼è°ƒæ•´ */
        .task-info-inline {
            display: none !important;
        }
        
        /* å•ä¸ªä¿¡æ¯é¡¹æ ·å¼ */
        .task-gallery-name,
        .task-gallery-qty,
        .task-gallery-creator {
            flex: 1 !important;
            text-align: center !important;
            font-size: 0.85rem !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            min-width: 0 !important;
        }
        
        /* å•†å“åç§°ç‰¹æ®Šæ ·å¼ */
        .task-gallery-name {
            font-weight: 600 !important;
            color: #333 !important;
        }
        
        /* æ•°é‡å’Œåˆ›å»ºäººæ ·å¼ */
        .task-gallery-qty,
        .task-gallery-creator {
            font-size: 0.75rem !important;
            color: #666 !important;
        }
        
        /* é’ˆå¯¹ä¸åŒå±å¹•å°ºå¯¸çš„å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .task-info-inline {
                gap: 8px !important;
            }
            
            .task-gallery-name,
            .task-gallery-qty,
            .task-gallery-creator {
                font-size: 0.7rem !important;
                max-width: 80px !important;
            }
        }
        
        @media (max-width: 576px) {
            .task-info-inline {
                gap: 6px !important;
            }
            
            .task-gallery-name,
            .task-gallery-qty,
            .task-gallery-creator {
                font-size: 0.65rem !important;
                max-width: 60px !important;
            }
        }
        
        /* ç¡®ä¿åœ¨å·²å‘å¸ƒä»»åŠ¡ç”»å»Šä¸­çš„æ ·å¼ä¹Ÿç”Ÿæ•ˆ */
        .published-tasks-gallery .task-gallery-actions {
            width: 40px !important;
            min-width: 40px !important;
            flex-shrink: 0 !important;
        }
        
        .published-tasks-gallery .task-card-content {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            width: 100% !important;
        }
        
        .published-tasks-gallery .task-info-inline {
            display: none !important;
        }
        /* === ä»»åŠ¡å¡ç‰‡å¸ƒå±€è°ƒæ•´ç»“æŸ === */

        .task-flip-container .task-info-container .task-gallery-code {
            color: #666;
        }
        
        .task-gallery-actions {
            display: flex;
            gap: 6px;
            width: auto;
            flex-shrink: 0;
        }
        
        .task-info-inline {
            display: none !important;
        }
        
        .task-gallery-actions .btn {
            flex: 1;
            padding: 6px 8px;
            font-size: 0.8rem;
        }
        
        /* ===== ä»“åº“å‘è´§ç«¯ä»»åŠ¡å¡ç‰‡æ ·å¼ ===== */
        .task-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            position: relative;
        }
        
        /* éšè—å¤–å±‚cardå®¹å™¨ï¼Œä¿ç•™ä»»åŠ¡å¡ç‰‡æœ¬èº« */
        .published-tasks-section .card {
            display: none;
            border: none;
        }

        .task-left-section {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .task-image {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
        }

        .task-middle-section {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 0;
            margin: 0;
        }

        .task-quantity-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .task-quantity-label {
            font-size: 0.9rem;
            color: #666;
            order: 2;
        }

        .task-quantity-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--warning);
            line-height: 1;
            order: 1;
        }

        .task-right-section {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        /* ===== äº§å“ç®¡ç†å¸ƒå±€è°ƒæ•´ ===== */
        .product-management-container {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
        }

        .add-product-section {
            flex: 1;
        }

        .recent-products-section {
            flex: 1;
            min-width: 280px;
        }

        /* ===== é”€å”®è¿è¥å¸ƒå±€è°ƒæ•´ ===== */
        .sales-operations-container {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
        }

        .create-task-section {
            flex: 1;
        }

        .published-tasks-section {
            flex: 1;
            min-width: 280px;
        }
        
        /* ç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨æ ·å¼ - ç”¨äºå°†ç‰¹å®šä»»åŠ¡å¡ç‰‡æ˜¾ç¤ºåœ¨åˆ›å»ºä»»åŠ¡å¡ç‰‡çš„å³è¾¹ */
        #specific-task-card-container.right-side {
            flex: 1;
            min-width: 280px;
            margin-top: 0;
        }
        
        /* å½“ç‰¹å®šä»»åŠ¡å¡ç‰‡è¢«ç§»åˆ°å³è¾¹æ—¶ï¼Œä½¿ç”¨flexå¸ƒå±€è®©å®ƒä¸åˆ›å»ºä»»åŠ¡éƒ¨åˆ†å¹¶æ’ */
        .sales-operations-container.with-specific-task {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
            flex-wrap: nowrap; /* é˜²æ­¢æ¢è¡Œ */
        }
        
        /* ç¡®ä¿åˆ›å»ºä»»åŠ¡éƒ¨åˆ†å’Œå·²å‘å¸ƒä»»åŠ¡éƒ¨åˆ†éƒ½ä½¿ç”¨flexå¸ƒå±€æ­£ç¡®åˆ†é…ç©ºé—´ */
        .sales-operations-container.with-specific-task .create-task-section {
            flex: 1;
            min-width: 282.66px;
        }
        
        .sales-operations-container.with-specific-task .published-tasks-section {
            flex: 1;
            min-width: 282.66px;
        }
        
        /* ç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨åœ¨é”€å”®è¿è¥å®¹å™¨ä¸­çš„æ ·å¼ */
        .sales-operations-container #specific-task-card-container {
            margin: 0;
            flex: 1;
            min-width: 282.66px;
            order: 3; /* ç¡®ä¿å®ƒæ˜¾ç¤ºåœ¨æœ€åé¢ï¼Œå³å³ä¾§ */
            display: block;
        }
        
        /* ç‰¹å®šä»»åŠ¡å¡ç‰‡æœ¬èº«çš„æ ·å¼ */
        #specific-task-card-container .task-front {
            width: 100%;
            max-width: 100%;
        }
        
        /* å·²å‘å¸ƒä»»åŠ¡éƒ¨åˆ†çš„é¡ºåº */
        .sales-operations-container .published-tasks-section {
            order: 2; /* ç¡®ä¿å®ƒåœ¨ä¸­é—´ */
        }
        
        /* åˆ›å»ºä»»åŠ¡éƒ¨åˆ†çš„é¡ºåº */
        .sales-operations-container .create-task-section {
            order: 1; /* ç¡®ä¿å®ƒåœ¨æœ€å‰é¢ */
        }
        
        /* ç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨æ ·å¼ */
        #specific-task-card-container {
            margin-top: 0;
            display: none; /* é»˜è®¤éšè—ï¼Œåªåœ¨éœ€è¦æ—¶æ˜¾ç¤º */
        }
        
        /* å½“åœ¨é”€å”®è¿è¥å®¹å™¨ä¸­æ—¶çš„æ ·å¼ */
        .sales-operations-container #specific-task-card-container {
            margin-top: 0;
        }
        
        /* ç‰¹å®šä»»åŠ¡å¡ç‰‡æ ·å¼ */
        #specific-task-card-container .task-front {
            width: 282.66px;
            max-width: 282.66px;
            position: relative;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: var(--card-radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden;
            background-color: white;
            box-shadow: var(--shadow);
            -webkit-backface-visibility: hidden;
            top: 0;
            left: 0;
            min-height: 220px;
            margin-bottom: 25px;
        }
        
        /* è°ƒæ•´é”€å”®è¿è¥å®¹å™¨ç»“æ„ä»¥ç¡®ä¿æ­£ç¡®å¸ƒå±€ */
        .sales-operations-container {
            position: relative;
        }
        
        /* ç¡®ä¿å½“æ·»åŠ äº†ç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨åï¼Œå®¹å™¨å†…çš„å…ƒç´ æ­£ç¡®æ’åˆ— */
        .sales-operations-container.with-specific-task > * {
            flex-shrink: 0;
        }

        /* ===== å“åº”å¼è®¾è®¡ ===== */
        @media (max-width: 1200px) {
            .product-management-container,
            .sales-operations-container {
                flex-direction: column;
            }
            
            .recent-products-section,
            .published-tasks-section {
                min-width: auto;
            }
            
            .gallery-item {
                width: calc(25% - 9px);
            }
            
            /* é’ˆå¯¹å·²å‘å¸ƒä»»åŠ¡ç”»å»Šçš„å“åº”å¼è°ƒæ•´ï¼šä»ä¸€è¡Œ2ä¸ªæ”¹ä¸ºä¸€è¡Œ1ä¸ª */
            .published-tasks-gallery {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .task-upload-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                transition: var(--transition);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .header {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
                font-size: 1.4rem;
                cursor: pointer;
                color: var(--dark);
                transition: var(--transition);
            }
            
            /* ä¾§è¾¹æ æŠ˜å æ ·å¼ */
            .sidebar.collapsed {
                width: 50px;
            }
            
            .sidebar.collapsed .sidebar-logo {
                font-size: 1rem;
                text-align: center;
            }
            
            .sidebar.collapsed .sidebar-logo {
                font-size: 1rem;
                text-align: center;
                padding: 0 8px;
            }
            
            .sidebar.collapsed .menu-item {
                text-align: center;
            }
            
            .sidebar.collapsed .menu-link {
                justify-content: center;
                padding: 12px 8px;
                font-size: 0.75rem;
            }
            
            .sidebar.collapsed .menu-link span {
                display: none;
            }
            
            .sidebar.collapsed .menu-link::before {
                content: attr(data-icon);
                font-family: "Font Awesome 6 Free", "FontAwesome", sans-serif;
                font-weight: 900;
                margin-right: 0;
            }
            
            /* å±•å¼€çŠ¶æ€ä¸‹æ˜¾ç¤ºæ–‡æœ¬ */
            .sidebar:not(.collapsed) .menu-link span {
                display: inline;
            }
            
            .sidebar:not(.collapsed) .menu-link::before {
                display: none;
            }
            
            /* ä¸»å†…å®¹åŒºåœ¨ä¾§è¾¹æ æŠ˜å æ—¶çš„æ ·å¼ */
            .header.expanded {
                left: var(--sidebar-width);
            }
            
            .header.collapsed {
                left: 50px;
            }
            
            .main-content.expanded {
                margin-left: var(--sidebar-width);
            }
            
            .main-content.collapsed {
                margin-left: 50px;
            }
            
            /* æ¡Œé¢ç«¯å§‹ç»ˆæ˜¾ç¤ºåˆ‡æ¢æŒ‰é’® */
            @media (min-width: 993px) {
                .menu-toggle {
                    display: block;
                }
            }

            .gallery-item {
                width: calc(33.33% - 8px);
            }
            
            .task-upload-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 12px;
            }
            
            .main-content {
                padding: 16px 12px;
            }
            
            .card-container {
                grid-template-columns: 1fr;
            }

            .gallery-item {
                width: calc(50% - 6px);
            }
            
            /* é’ˆå¯¹å·²å‘å¸ƒä»»åŠ¡ç”»å»Šçš„å“åº”å¼è°ƒæ•´ï¼šä¸­ç­‰å±å¹•ä¸‹ä¸€è¡Œæ˜¾ç¤º1ä¸ª */
            .published-tasks-gallery {
                grid-template-columns: repeat(1, 1fr);
            }

            .recent-product-layout {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .recent-product-img-container,
            .recent-product-name-container,
            .recent-product-stock-container,
            .recent-product-action-container {
                text-align: left;
                width: 100%;
                justify-content: flex-start;
            }

            .task-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .task-left-section {
                width: 100%;
            }
            
            .task-middle-section {
                position: static;
                transform: none;
                width: 100%;
                text-align: center;
                padding: 0;
                margin: 8px 0;
                order: 1;
            }
            
            .task-right-section {
                width: 100%;
                align-items: flex-start;
                order: 2;
            }
            
            .task-upload-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .gallery-item {
                width: 100%;
            }
            
            /* é’ˆå¯¹å·²å‘å¸ƒä»»åŠ¡ç”»å»Šçš„å“åº”å¼è°ƒæ•´ï¼šå°å±å¹•ä¸‹ä¸€è¡Œæ˜¾ç¤º1ä¸ª */
            .published-tasks-gallery {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .task-upload-row {
                grid-template-columns: 1fr;
            }
        }

        /* ===== æ–°å¢æ ·å¼ ===== */
        /* äº§å“ä¿¡æ¯å¸ƒå±€è°ƒæ•´ - é”€å”®ä»·å’Œåˆ©æ¶¦ç‡åŒè¡Œ */
        .price-profit-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        /* ä¿å­˜äº§å“æŒ‰é’®è°ƒæ•´ */
        .btn-save-product {
            width: 100%;
            margin: 0 auto;
            display: block;
            padding: 14px 25px;
            font-size: 1rem;
        }
        
        /* åˆ›å»ºå‘è´§ä»»åŠ¡æŒ‰é’®è°ƒæ•´ */
        .btn-create-task {
            width: 100%;
            padding: 12px 16px;
            font-size: 1rem;
        }
        
        /* ç»Ÿè®¡åˆ†æé‡æ–°æ’ç‰ˆ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 25px;
        }
        
        #salesperson-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 25px;
        }
        
        .stats-card {
            background: white;
            border-radius: var(--card-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .stats-card-wide {
            grid-column: span 2;
        }
        
        /* é”€å”®è¿è¥ç»Ÿè®¡å¡ç‰‡ç‰¹å®šæ ·å¼ */
        .salesperson-stat-card {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: var(--transition);
        }
        
        /* ç‹¬ç«‹ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .individual-stat-card {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: var(--transition);
            margin-bottom: 16px;
            min-width: 280px;
        }
        
        .individual-stat-card .stats-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .individual-stat-card .stats-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .individual-stat-card .stat-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .individual-stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            word-break: break-word;
        }
        
        .individual-stat-card .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .stat-card-full-width {
            width: 100%;
        }
        
        /* é”€å”®äººå‘˜åˆ†ç»„å®¹å™¨ */
        .salesperson-group {
            background: #f8f9fa;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .salesperson-group .group-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        .salesperson-group .group-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .salesperson-group .group-title i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        .salesperson-group .group-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .salesperson-stat-card .stats-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .salesperson-stat-card .stats-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .salesperson-stats-grid-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .salesperson-stats-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-lightest);
            align-items: center;
        }
        
        /* æ°´å¹³æ’åˆ—çš„ç»Ÿè®¡é¡¹ - ç”¨äºå·¦å³æ ‡ç­¾å€¼å¸ƒå±€ */
        .stat-item-horizontal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        
        /* å…¨å®½åº¦ç»Ÿè®¡é¡¹ - ç”¨äºè¾ƒé•¿å†…å®¹ï¼Œå¦‚å•†å“æ˜ç»† */
        .stat-item-full-width {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 10px 0;
            gap: 6px;
        }
        
        .stat-item-full-width .stat-label {
            display: block;
            margin-bottom: 4px;
        }
        
        .stat-item-full-width .stat-value {
            display: block;
            width: 100%;
            word-break: break-word;
            line-height: 1.5;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.85rem;
            font-weight: 500;
            min-width: 100px;
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--dark);
            text-align: right;
            max-width: 70%;
        }
        
        /* å¼ºè°ƒå…³é”®æŒ‡æ ‡ */
        .stat-emphasized {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .stat-highlight {
            color: var(--primary);
            font-weight: 700;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 992px) {
            #salesperson-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            #salesperson-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .stats-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .stats-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary);
            margin: 12px 0;
        }
        
        .stats-subtitle {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .stats-chart-container {
            height: 220px;
            margin-top: 16px;
        }
        
        /* è¡¨å•é—´è·è°ƒæ•´ */
        .mb-16 { margin-bottom: 16px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-25 { margin-bottom: 25px; }
        .mt-16 { margin-top: 16px; }
        .mt-20 { margin-top: 20px; }
        .mt-25 { margin-top: 25px; }
        
        /* å·¥å…·ç±» ===== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-8 { margin-bottom: 8px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-12 { margin-bottom: 12px; }
        .mt-8 { margin-top: 8px; }
        .mt-10 { margin-top: 10px; }
        .mt-12 { margin-top: 12px; }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-4 { gap: 4px; }
        .gap-6 { gap: 6px; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .w-100 { width: 100%; }
        .hidden { display: none; }
        .flex-1 { flex: 1; }
        
        /* ===== é¢„è§ˆå°çª—æ ·å¼ ===== */
        .preview-tooltip {
            position: relative;
            display: inline-block;
            z-index: 999;
        }
        
        .preview-content {
            display: none;
            position: absolute;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            z-index: 1000;
            min-width: 200px;
            max-width: 282.66px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .preview-tooltip:hover .preview-content {
            display: block;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }
        
        .preview-pdf {
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
        }
        
        .preview-pdf i {
            font-size: 48px;
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        /* ===== å®Œæˆå‘è´§æŒ‰é’®æ ·å¼è°ƒæ•´ ===== */
        .btn-complete-shipment {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            margin-top: 10px;
        }
        
        /* ç™»å½•å¡ç‰‡æ ·å¼ä¼˜åŒ– */
        .login-box {
            width: 100%;
            max-width: 400px;
            padding: 40px 30px;
            text-align: center;
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            text-align: left;
            margin-bottom: 0;
        }
        
        /* éšè—è¡¨å•æ ‡ç­¾ */
        .login-form .form-group label {
            display: none;
        }
        
        /* è°ƒæ•´è¾“å…¥æ¡†æ ·å¼ä»¥é€‚åº”éšè—æ ‡ç­¾ */
        .login-form .form-group {
            margin-bottom: 16px;
        }
        
        .btn-primary {
            margin-top: 10px;
            padding: 12px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4);
        }
        
        .link-secondary {
            color: var(--gray);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .link-secondary:hover {
            color: var(--primary);
            text-decoration: underline;
        }
        
        /* æ³¨å†Œè¡¨å•å®¹å™¨æ ·å¼ */
        .register-form-container {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            background-color: #f8f9fa;
            display: none; /* é»˜è®¤éšè— */
            animation: slideDown 0.3s ease-out;
        }
        
        .register-form-container.show {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                max-height: 0;
                opacity: 0;
                overflow: hidden;
            }
            to {
                max-height: 500px; /* è¶³å¤Ÿå®¹çº³è¡¨å•çš„é«˜åº¦ */
                opacity: 1;
            }
        }
        
        .register-form-container .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .register-form-container .form-control,
        .register-form-container .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        .register-form-container .form-control:focus,
        .register-form-container .form-select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .modal-header .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
            margin: 0;
        }
        
        /* æ¨¡æ€æ¡†åº•éƒ¨æŒ‰é’®å±…ä¸­å¯¹é½ */
        .modal-footer {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        /* ç”¨æˆ·ç®¡ç†æ¨¡å—æ¨¡æ€æ¡†å®½åº¦è°ƒæ•´ */
        #userModal .modal-dialog {
            max-width: 500px;
            margin: 1.75rem auto;
        }
        
        /* ç¡®ä¿è¡¨å•é¡¹æœ‰è¶³å¤Ÿçš„å®½åº¦ */
        #userModal .form-control,
        #userModal .form-select {
            min-width: 0;
            flex: 1;
        }
        
        /* é’ˆå¯¹é‚®ç®±è¾“å…¥æ¡†çš„ç‰¹æ®Šå¤„ç† */
        #userModal #userEmail {
            width: 100%;
            box-sizing: border-box;
        }
        
        /* ç¡®ä¿æ¨¡æ€æ¡†åœ¨é¡µé¢åŠ è½½æ—¶ä¸æ˜¾ç¤º */
        #userModal:not(.show) .modal-content {
            display: none;
        }
        
        /* ç‰¹å®šä»»åŠ¡å¡ç‰‡æ ·å¼ - ç¡®ä¿å›¾ç‰‡å±…ä¸­ */
        #task-1768315176672-front.task-front {
            width: 282.66px; 
            max-width: 282.66px; 
            display: flex !important;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>

<!-- ä»“åº“ä»»åŠ¡å¡è­¦å‘Šå¾½ç« ä¿æŠ¤è§„åˆ™ -->
<style>
/* éšè—ä»“åº“ä»»åŠ¡å¡ä¸­çš„è­¦å‘Šå¾½ç«  */
.warehouse-tasks-gallery span.badge.badge-warning.flex-fill.text-center,
.warehouse-tasks-gallery span.badge.bg-warning,
.warehouse-tasks-gallery .status-badge.warning,
.task-flip-container[data-task-type="warehouse"] span.badge.warning {
    display: none !important;
}

/* éšè—åŒ…å«ç‰¹å®šæ–‡æœ¬çš„å¾½ç«  */
.warehouse-tasks-gallery span.badge:contains("å¾…å¤„ç†"),
.warehouse-tasks-gallery span.badge:contains("å¾…å‘è´§"),
.warehouse-tasks-gallery .status-badge:contains("å¾…å¤„ç†") {
    display: none !important;
}
</style>

</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="login-logo">æ³›è¶£è·¨å¢ƒ</div>
            <div class="login-subtitle">å‘è´§ç®¡ç†ç³»ç»Ÿ</div>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="username">é‚®ç®±</label>
                    <input type="email" id="username" class="form-control" placeholder="é‚®ç®±åœ°å€" required autocomplete="username">
                </div>
                            
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" class="form-control" placeholder="å¯†ç " required autocomplete="current-password">
                </div>
                            
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> ç™»å½•
                </button>
                            
                <div class="text-center mt-3">
                    <a href="#" id="showRegisterLink" class="link-secondary">è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿç«‹å³æ³¨å†Œ</a>
                </div>
            </form>
                        
            <!-- æ³¨å†Œè¡¨å• (ä¸‹æ‹‰æ˜¾ç¤º) -->
            <div id="registerFormContainer" class="register-form-container">
                <div class="modal-header">
                    <h5 class="modal-title">ç”¨æˆ·æ³¨å†Œ</h5>
                </div>
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="registerName" class="form-label">å§“å</label>
                        <input type="text" class="form-control" id="registerName" placeholder="å¡«å†™å…¬å¸ç®€ç§°" required autocomplete="name">
                    </div>
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">é‚®ç®±</label>
                        <input type="email" class="form-control" id="registerEmail" placeholder="å¡«å†™é‚®ç®±åœ°å€" required autocomplete="email">
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword" class="form-label">å¯†ç </label>
                        <input type="password" class="form-control" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ï¼Œè‡³å°‘6ä½" required autocomplete="new-password">
                    </div>
                    <div class="mb-3">
                        <label for="registerRole" class="form-label">è§’è‰²</label>
                        <select class="form-select" id="registerRole" required>
                            <option value="">è¯·é€‰æ‹©è§’è‰²</option>
                            <option value="sales">é”€å”®è¿è¥</option>
                            <option value="warehouse">ä»“åº“ç®¡ç†</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">æ³¨å†Œ</button>
                </form>
            </div>
            

        </div>
    </div>
    
    <!-- ä¸»ç³»ç»Ÿ -->
    <div class="main-container" id="mainSystem">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-logo">æ³›è¶£è·¨å¢ƒ</div>
            
            <ul class="sidebar-menu" id="menuList">
                <!-- èœå•é¡¹å°†æ ¹æ®ç”¨æˆ·è§’è‰²åŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>
        
        <!-- é¡¶éƒ¨æ  -->
        <div class="header">
            <div class="header-left">
                <div class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="header-title" id="currentModule">æ€»è§ˆ</div>
            </div>
            
            <div class="header-right">
                <div class="user-info">
                    <span id="currentUser">ç®¡ç†å‘˜</span>
                    <span class="user-role" id="currentRole">admin</span>
                </div>
                <div class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> é€€å‡º
                </div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- æ€»è§ˆæ¨¡å— -->
            <div class="module-content active" id="dashboard">
                <!-- å·²ç§»é™¤ï¼š<h1 class="page-title">æ€»è§ˆ</h1> -->
                
                <div class="card-container">
                    <div class="card stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">äº§å“æ€»æ•°</div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-number" id="pendingTasks">0</div>
                        <div class="stat-label">å¾…å‘è´§</div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-number" id="todayTasks">0</div>
                        <div class="stat-label">ä»Šæ—¥å‘è´§</div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-number" id="completedTasks">0</div>
                        <div class="stat-label">å·²å®Œæˆ</div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-number" id="shippingTaskCount">0</div>
                        <div class="stat-label">å‘è´§æ•°é‡</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">æœ€è¿‘æ´»åŠ¨</div>
                    <div class="table-responsive">
                        <table id="recentActivitiesTable">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>æ´»åŠ¨ç±»å‹</th>
                                    <th>è¯¦æƒ…</th>
                                    <th>ç”¨æˆ·</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivities">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">æš‚æ— æ´»åŠ¨è®°å½•</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- äº§å“æ·»åŠ ç«¯æ¨¡å— -->
            <div class="module-content" id="product-add">
                <!-- å·²ç§»é™¤ï¼š<h1 class="page-title">äº§å“ç®¡ç†</h1> -->
                
                <!-- è°ƒæ•´åçš„äº§å“ç®¡ç†å¸ƒå±€ -->
                <div class="product-management-container">
                    <!-- å·¦è¾¹ï¼šæ·»åŠ æ–°äº§å“ -->
                    <div class="add-product-section">
                        <div class="card mb-25">
                            <div class="card-title">æ·»åŠ æ–°äº§å“</div>
                            
                            <form id="productForm">
                                <!-- äº§å“å›¾ç‰‡ä¸Šä¼ éƒ¨åˆ† - åªä¿ç•™ä¸€ä¸ªä¸Šä¼ åŒºåŸŸ -->
                                <div class="mb-16">
                                    <div class="upload-row">
                                        <div class="upload-area" id="productImageUpload">
                                            <!-- åŠ¨æ€å†…å®¹ -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- äº§å“ä¿¡æ¯éƒ¨åˆ† -->
                                <div class="mb-16">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <input type="text" id="productCode" class="form-control" placeholder="è´§å·" required autocomplete="off">
                                        </div>
                                        
                                        <div class="form-group">
                                            <input type="text" id="productName" class="form-control" placeholder="åç§°" required autocomplete="off">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group" style="width: 100%; margin-bottom: 16px;">
                                        <input type="text" id="productSupplier" class="form-control" placeholder="ä¾›åº”å•†" style="width: 100%;" autocomplete="off">
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <input type="number" id="productQuantity" class="form-control" placeholder="æ•°é‡" min="0">
                                        </div>
                                        
                                        <div class="form-group">
                                            <input type="number" id="productPurchasePrice" class="form-control" placeholder="è¿›è´§ä»· (Â¥)" step="0.01" min="0">
                                        </div>
                                    </div>
                                    
                                    <!-- é”€å”®ä»·å’Œåˆ©æ¶¦ç‡åŒè¡Œ -->
                                    <div class="price-profit-row">
                                        <div class="form-group">
                                            <input type="number" id="productSalePrice" class="form-control" placeholder="é”€å”®ä»· (Â¥)" step="0.01" min="0">
                                        </div>
                                        
                                        <div class="form-group">
                                            <input type="text" class="form-control" id="productProfitMargin" placeholder="åˆ©æ¶¦ç‡" readonly style="background-color: #f8f9fa;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary btn-save-product" id="saveProductBtn">
                                        <i class="fas fa-save"></i> ä¿å­˜äº§å“
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- å³è¾¹ï¼šæœ€è¿‘æ·»åŠ çš„äº§å“ -->
                    <div class="recent-products-section">
                        <div class="card">
                            <div class="card-title">æœ€è¿‘æ·»åŠ çš„äº§å“</div>
                            <div class="recent-products-scroll" style="max-height: 480px;">
                                <div id="recentProducts">
                                    <p class="text-muted text-center my-3">æš‚æ— äº§å“</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ‰€æœ‰äº§å“åˆ—è¡¨ -->
                <div class="card">
                    <div class="table-header">
                        <div class="table-title">æ‰€æœ‰äº§å“</div>
                        <div class="d-flex align-center gap-12">
                            <div class="view-toggle">
                                <button class="view-toggle-btn active" data-view="list" onclick="switchProductView('list')">
                                    <i class="fas fa-list"></i> åˆ—è¡¨
                                </button>
                                <button class="view-toggle-btn" data-view="gallery" onclick="switchProductView('gallery')">
                                    <i class="fas fa-th-large"></i> ç”»å»Š
                                </button>
                            </div>
                            <div class="search-box">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" id="productSearch" placeholder="æœç´¢äº§å“åç§°æˆ–è´§å·" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <!-- åˆ—è¡¨è§†å›¾ -->
                        <div id="productListView" class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>å›¾ç‰‡</th>
                                        <th>è´§å·</th>
                                        <th>åç§°</th>
                                        <th>ä¾›åº”å•†</th>
                                        <th>åº“å­˜</th>
                                        <th>è¿›è´§ä»·</th>
                                        <th>é”€å”®ä»·</th>
                                        <th>åˆ©æ¶¦ç‡</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="productTable">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-5">
                                            <i class="fas fa-inbox fa-2x mb-3"></i>
                                            <p>æš‚æ— äº§å“æ•°æ®</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- ç”»å»Šè§†å›¾ -->
                        <div id="productGalleryView" class="gallery-view p-3 hidden">
                            <div class="text-center w-100 py-5 text-muted">
                                <i class="fas fa-inbox fa-2x mb-3"></i>
                                <p>æš‚æ— äº§å“æ•°æ®</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- é”€å”®è¿è¥ç«¯æ¨¡å— -->
            <div class="module-content" id="sales-operations">
                <!-- å·²ç§»é™¤ï¼š<h1 class="page-title">é”€å”®è¿è¥</h1> -->
                
                <!-- é‡æ„åçš„é”€å”®è¿è¥å¸ƒå±€ -->
                <div class="sales-operations-container">
                    <!-- å·¦è¾¹ï¼šåˆ›å»ºå‘è´§ä»»åŠ¡ -->
                    <div class="create-task-section">
                        <div class="card mb-25">
                            <div class="card-title">åˆ›å»ºå‘è´§ä»»åŠ¡</div>
                            
                            <form id="taskForm">
                                <div class="mb-16">
                                    <div class="search-box">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="productSearchInput" placeholder="ç‚¹å‡»æœç´¢å•†å“åç§°æˆ–è´§å·ï¼Œé€‰æ‹©å•†å“ï¼Œåˆ›å»ºå‘è´§ä»»åŠ¡" autocomplete="off">
                                    </div>
                                    
                                    <div class="multiselect-dropdown hidden" id="multiselectDropdown">
                                        <!-- åŠ¨æ€åŠ è½½é€‰é¡¹ -->
                                    </div>
                                    
                                    <div class="selected-products mt-16" id="selectedProductsTags">
                                        <!-- å·²é€‰æ‹©çš„å•†å“æ ‡ç­¾ -->
                                    </div>
                                </div>
                                
                                <div class="mb-16">
                                    <!-- ä»»åŠ¡è´­ç‰©è½¦è¡¨æ ¼ - å·²ç§»é™¤æ ‡é¢˜å’Œæ¡ç /ç®±å”›/è­¦ç¤ºç åˆ— -->
                                    <div class="table-responsive">
                                        <table id="taskCartTable" class="equal-width-columns">
                                            <thead>
                                                <tr>
                                                    <th>å›¾ç‰‡</th>
                                                    <th>åç§°</th>
                                                    <th>è´§å·</th>
                                                    <th>æ•°é‡</th>
                                                    <th>æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="taskCart">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted py-3">
                                                        è¯·ä»ä¸Šæ–¹é€‰æ‹©è¦å‘è´§çš„å•†å“
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- ä»»åŠ¡æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ - é‡æ„ä¸ºæ›´æ¸…æ™°çš„å¸ƒå±€ -->
                                <div class="task-upload-section">
                                    <h5>ä¸Šä¼ ä»»åŠ¡ç›¸å…³æ–‡ä»¶</h5>
                                    <div class="task-upload-row">
                                        <div class="upload-area-col">
                                            <label for="taskBodyCodeFile">æœ¬ä½“ç </label>
                                            <div class="upload-area" id="taskBodyCodeUpload">
                                                <!-- åŠ¨æ€å†…å®¹ -->
                                                <input type="file" id="taskBodyCodeFile" accept="image/*,.pdf" class="hidden">
                                            </div>
                                        </div>
                                        <div class="upload-area-col">
                                            <label for="taskBarcodeFile">æ¡ç </label>
                                            <div class="upload-area" id="taskBarcodeUpload">
                                                <!-- åŠ¨æ€å†…å®¹ -->
                                                <input type="file" id="taskBarcodeFile" accept="image/*,.pdf" class="hidden">
                                            </div>
                                        </div>
                                        <div class="upload-area-col">
                                            <label for="taskWarningCodeFile">è­¦ç¤ºç </label>
                                            <div class="upload-area" id="taskWarningCodeUpload">
                                                <!-- åŠ¨æ€å†…å®¹ -->
                                                <input type="file" id="taskWarningCodeFile" accept="image/*,.pdf" class="hidden">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="task-upload-row">
                                        <div class="upload-area-col">
                                            <label for="taskLabelFile">ç®±å”›</label>
                                            <div class="upload-area" id="taskLabelUpload">
                                                <!-- åŠ¨æ€å†…å®¹ -->
                                                <input type="file" id="taskLabelFile" accept="image/*,.pdf" class="hidden">
                                            </div>
                                        </div>
                                        <div class="upload-area-col">
                                            <label for="taskManualFile">è¯´æ˜ä¹¦</label>
                                            <div class="upload-area" id="taskManualUpload">
                                                <!-- åŠ¨æ€å†…å®¹ -->
                                                <input type="file" id="taskManualFile" accept="image/*,.pdf" class="hidden">
                                            </div>
                                        </div>
                                        <div class="upload-area-col">
                                            <label for="taskOtherFile">å…¶ä»–</label>
                                            <div class="upload-area" id="taskOtherUpload">
                                                <!-- åŠ¨æ€å†…å®¹ -->
                                                <input type="file" id="taskOtherFile" accept="image/*,.pdf" class="hidden">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ä»»åŠ¡å¤‡æ³¨è¾“å…¥åŒºåŸŸ -->
                                <div class="task-remark-section">
                                    <h5>ä»»åŠ¡å¤‡æ³¨</h5>
                                    <div class="form-group">
                                        <textarea 
                                            class="form-control task-remark-input" 
                                            id="taskRemark" 
                                            placeholder="è¯·è¾“å…¥ä»»åŠ¡å¤‡æ³¨ä¿¡æ¯..." 
                                            rows="3"
                                            maxlength="500"></textarea>
                                    </div>
                                </div>
                                
                                <div class="text-right">
                                    <button type="submit" class="btn btn-primary btn-create-task">
                                        <i class="fas fa-plus-circle"></i> åˆ›å»ºå‘è´§ä»»åŠ¡
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- å³è¾¹ï¼šå·²åˆ›å»ºçš„ä»»åŠ¡ -->
                    <div class="published-tasks-section">
                        <div class="card mb-25">
                            <div class="card-title">å·²åˆ›å»ºçš„ä»»åŠ¡</div>
                        </div>
                        <div class="published-tasks-gallery" id="publishedTasksBody">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-2x mb-3"></i>
                                <p>æš‚æ— å·²åˆ›å»ºä»»åŠ¡</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä»“åº“å‘è´§ç«¯æ¨¡å— -->
            <div class="module-content" id="warehouse-operations">
                <!-- å·²ç§»é™¤ï¼š<h1 class="page-title">ä»“åº“å‘è´§</h1> -->
                
                <div class="card-container mb-25">
                    <div class="card stat-card">
                        <div class="stat-number" id="warehousePendingTasks">0</div>
                        <div class="stat-label">å¾…å‘è´§</div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-number" id="warehouseTodayTasks">0</div>
                        <div class="stat-label">ä»Šæ—¥å‘è´§</div>
                    </div>
                    
                    <div class="card stat-card">
                        <div class="stat-number" id="warehouseCompletedTasks">0</div>
                        <div class="stat-label">å·²å®Œæˆ</div>
                    </div>
                </div>
                
                <div id="warehouseTasks" class="published-tasks-gallery task-gallery">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-check-circle fa-2x mb-3"></i>
                        <p>æš‚æ— å¾…å‘è´§ä»»åŠ¡</p>
                    </div>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡åˆ†ææ¨¡å— -->
            <div class="module-content" id="statistics-dashboard">
                <div class="time-filter mb-25">
                    <button class="time-btn active" onclick="filterStatistics('day', this)">ä»Šæ—¥</button>
                    <button class="time-btn" onclick="filterStatistics('week', this)">æœ¬å‘¨</button>
                    <button class="time-btn" onclick="filterStatistics('month', this)">æœ¬æœˆ</button>
                    <button class="time-btn" onclick="filterStatistics('year', this)">æœ¬å¹´</button>
                    <button class="time-btn" onclick="filterStatistics('all', this)">å…¨éƒ¨</button>
                </div>
                
                <div class="user-filter mb-25">
                    <button class="user-btn active" data-user-id="all" onclick="filterByUser('all', this)">å…¨éƒ¨</button>
                </div>
                
                <div class="card-container">
                    <div class="stat-card">
                        <div class="stat-number" id="shipmentTaskCount">0</div>
                        <div class="stat-label">å‘è´§ä»»åŠ¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="dayShipments">0</div>
                        <div class="stat-label">å‘è´§æ•°é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="daySales">0</div>
                        <div class="stat-label">é”€å”®é¢</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="dayProfit">0</div>
                        <div class="stat-label">é”€å”®åˆ©æ¶¦</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">å•†å“æ˜ç»†</div>
                        <button class="btn btn-outline" onclick="downloadProductDetailsCSV()">
                            <i class="fas fa-download"></i> ä¸‹è½½CSV
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>å•†å“åç§°</th>
                                    <th>å•†å“ç¼–ç </th>
                                    <th>ä¾›åº”å•†</th>
                                    <th>æ•°é‡</th>
                                    <th>è¿›è´§ä»·</th>
                                    <th>é”€å”®ä»·</th>
                                    <th>é”€å”®é¢</th>
                                    <th>åˆ©æ¶¦</th>
                                </tr>
                            </thead>
                            <tbody id="productDetailList">
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">æš‚æ— å•†å“æ•°æ®</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è´¦æˆ·ç®¡ç†æ¨¡å— -->
    <div class="module-content" id="user-management" style="display: none;">
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">è´¦æˆ·ç®¡ç†</div>
                <div class="d-flex align-center gap-12" style="align-items: stretch;">
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="fas fa-plus"></i> æ·»åŠ ç”¨æˆ·
                    </button>
                    <button class="btn btn-outline" onclick="refreshUserList()">
                        <i class="fas fa-sync"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="equal-width-columns">
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>é‚®ç®±</th>
                            <th>è§’è‰²</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userList">
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">æ­£åœ¨åŠ è½½ç”¨æˆ·åˆ—è¡¨...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- æ·»åŠ /ç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡† -->
        <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalLabel">æ·»åŠ ç”¨æˆ·</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="userForm">
                            <input type="hidden" id="userId">
                            <div class="form-group mb-3">
                                <label for="userName" class="form-label">å§“å</label>
                                <input type="text" class="form-control" id="userName" placeholder="è¯·è¾“å…¥ç”¨æˆ·å§“å" required autocomplete="name">
                            </div>
                            <div class="form-group mb-3">
                                <label for="userEmail" class="form-label">é‚®ç®±</label>
                                <input type="email" class="form-control" id="userEmail" placeholder="è¯·è¾“å…¥ç”¨æˆ·é‚®ç®±" required autocomplete="email">
                            </div>
                            <div class="form-group mb-3">
                                <label for="userRole" class="form-label">è§’è‰²</label>
                                <select class="form-select" id="userRole" required>
                                    <option value="">è¯·é€‰æ‹©è§’è‰²</option>
                                    <option value="admin">ç®¡ç†å‘˜</option>
                                    <option value="sales">é”€å”®è¿è¥</option>
                                    <option value="warehouse">ä»“åº“</option>
                                </select>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="userPassword" class="form-label">å¯†ç </label>
                                <input type="password" class="form-control" id="userPassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç " autocomplete="new-password">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" onclick="saveUser()">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="salesperson_stats.js"></script>

    <style>
        /* ç»Ÿè®¡åˆ†æé¡µé¢æ ·å¼ä¼˜åŒ– */
        #statistics-analysis .time-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
                
        #statistics-analysis .time-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--gray-light);
            background-color: white;
            color: var(--dark);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
                
        #statistics-analysis .time-btn:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }
                
        #statistics-analysis .time-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }
                
        #statistics-analysis .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
                
        #statistics-analysis .stats-card {
            border-radius: 10px;
            border: 1px solid var(--gray-light);
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }
                
        #statistics-analysis .stats-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
                
        #statistics-analysis .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-light);
            background-color: var(--light);
        }
                
        #statistics-analysis .stats-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
        }
                
        #statistics-analysis .stats-card .card-body {
            padding: 20px;
        }
                
        #statistics-analysis .stats-card .card-body > div {
            height: 280px;
            overflow-y: auto;
        }
                
        #statistics-analysis .card {
            border-radius: 10px;
            border: none;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
                
        #statistics-analysis .card-title {
            padding: 16px 20px;
            background-color: var(--light);
            border-bottom: 1px solid var(--gray-light);
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
        }
                
        #statistics-analysis .card-body {
            padding: 20px;
        }
                
        /* ç»Ÿè®¡åˆ†ææ ·å¼ */
        #statistics-dashboard .time-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        #statistics-dashboard .time-btn {
            padding: 8px 16px;
            background-color: white;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        #statistics-dashboard .time-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        #statistics-dashboard .user-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        #statistics-dashboard .user-btn {
            padding: 8px 16px;
            background-color: white;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        #statistics-dashboard .user-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        #statistics-dashboard .stat-card {
            text-align: center;
            background-color: white;
            border-radius: var(--card-radius);
            padding: 20px;
            transition: var(--transition);
            border: none;
            box-shadow: var(--shadow);
            outline: none;
        }
        
        #statistics-dashboard .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        #statistics-dashboard .stat-label {
            color: var(--gray);
            font-size: 0.85rem;
        }
        
        /* è´¦æˆ·ç®¡ç†æ¨¡å—æ ·å¼ */
        #user-management .table-responsive {
            overflow-x: auto;
        }
        
        #user-management table.equal-width-columns {
            width: 100%;
            border-collapse: collapse;
        }
        
        #user-management table.equal-width-columns th,
        #user-management table.equal-width-columns td {
            width: calc(100% / 5); /* 5åˆ—å¹³å‡åˆ†é… */
            text-align: center;
            padding: 12px 16px;
        }
        
        #user-management table.equal-width-columns th {
            font-weight: 700;
            color: var(--dark);
            background-color: rgba(67, 97, 238, 0.05);
            font-size: 0.9rem;
        }
        
        #user-management table.equal-width-columns td {
            font-size: 0.9rem;
        }
        
        #user-management tr:hover {
            background-color: rgba(67, 97, 238, 0.03);
        }
        
        #user-management .btn-group {
            display: flex;
            gap: 8px;
        }
        
        #user-management .badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        #user-management .badge-primary {
            background-color: rgba(67, 97, 238, 0.2);
            color: var(--primary);
        }
        
        #user-management .badge-success {
            background-color: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
        }
        
        #user-management .badge-warning {
            background-color: rgba(247, 37, 133, 0.2);
            color: #f72585;
        }
        
        #user-management .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-light);
            gap: 12px;
            min-height: 60px;
        }
        
        #user-management .table-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* ä¸ç°æœ‰è¡¨æ ¼æ ·å¼ä¿æŒä¸€è‡´ */
        #user-management .table-container {
            background-color: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 25px;
            flex: 1 1 auto;
        }
        
        /* è°ƒæ•´ç”¨æˆ·ç®¡ç†æ¨¡å—ä»¥ä¸æ€»è§ˆåŒºåŸŸé¡¶éƒ¨å¯¹é½ */
        #user-management {
            padding: 20px;
            margin-left: var(--sidebar-width);
            margin-top: calc(var(--header-height) + 20px); /* ä¸æ€»è§ˆæ¨¡å—é¡¶éƒ¨å¯¹é½: header-height(70px) + main-content padding(20px) */
            min-height: 100vh;
            box-sizing: border-box;
        }
        
        /* ç¡®ä¿è¡¨æ ¼å®¹å™¨å±…ä¸­æ˜¾ç¤º */
        #user-management .table-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* ç¡®ä¿æŒ‰é’®ç»„åœ¨å°å±å¹•ä¸Šä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤º */
        #user-management .btn-group {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        #user-management .btn {
            min-width: auto;
            padding: 6px 10px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px; /* ç»Ÿä¸€å›¾æ ‡é—´è· */
        }
        
        #user-management .btn i {
            margin-right: 0; /* ç§»é™¤å•ç‹¬çš„marginè®¾ç½®ï¼Œä½¿ç”¨gapç»Ÿä¸€æ§åˆ¶ */
        }
                

                

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 992px) {
            /* ç§»åŠ¨ç«¯ç”¨æˆ·ç®¡ç†æ¨¡å—è°ƒæ•´ */
            #user-management {
                margin-left: 0;
                margin-top: calc(var(--header-height) + 16px); /* ç§»åŠ¨ç«¯paddingè¾ƒå° */
            }
        }
        
        @media (max-width: 768px) {
            /* å°å±å¹•ä¸Šçš„ç»Ÿè®¡é¡¹è°ƒæ•´ */
            .stat-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
                    
            .stat-item-horizontal {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
                    
            .stat-label {
                min-width: auto;
            }
                    
            .stat-value {
                text-align: left;
                max-width: 100%;
            }
        }
    </style>
    <script>
        // ============================================
        // æ•°æ®å­˜å‚¨é”®å
        // ============================================
        const STORAGE_KEYS = {
            USER: 'funseek_user',
            PRODUCTS: 'funseek_products',
            TASKS: 'funseek_tasks',
            HISTORY: 'funseek_history',
            ACTIVITIES: 'funseek_activities'
        };

        // ============================================
        // å·¥å…·å‡½æ•°
        // ============================================
        const Utils = {
            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN');
            },
            
            generateTaskNumber() {
                const prefix = 'FQ';
                const date = new Date();
                const dateStr = date.getFullYear().toString().slice(-2) + 
                              (date.getMonth() + 1).toString().padStart(2, '0') + 
                              date.getDate().toString().padStart(2, '0');
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `${prefix}${dateStr}${random}`;
            },
            
            showAlert(message, type = 'success', callback = null) {
                alertify.set('notifier', 'position', 'top-right');
                
                // å¯¹æ¶ˆæ¯å†…å®¹è¿›è¡ŒHTMLè½¬ä¹‰ï¼Œé˜²æ­¢XSSæ”»å‡»
                const sanitizeMessage = function(str) {
                    if (typeof str !== 'string') {
                        str = String(str);
                    }
                    return str
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#x27;')
                        .replace(/`/g, '&#x60;');
                };
                
                const sanitizedMessage = sanitizeMessage(message);
                
                if (type === 'success') {
                    alertify.success(sanitizedMessage);
                } else if (type === 'warning') {
                    alertify.warning(sanitizedMessage);
                } else if (type === 'danger' || type === 'error') {
                    alertify.error(sanitizedMessage);
                } else {
                    alertify.message(sanitizedMessage);
                }
                
                if (callback && typeof callback === 'function') {
                    setTimeout(callback, 2000);
                }
            },
            
            calculateProfitMargin(purchasePrice, salePrice) {
                if (!purchasePrice || !salePrice || salePrice === 0) {
                    return 0;
                }
                const margin = ((salePrice - purchasePrice) / salePrice) * 100;
                return parseFloat(margin.toFixed(2));
            },
            
            formatProfitMargin(margin) {
                if (margin > 0) {
                    return `<span style="color: #27ae60;">${margin}%</span>`;
                } else if (margin < 0) {
                    return `<span style="color: #e74c3c;">${margin}%</span>`;
                } else {
                    return `<span style="color: #666;">${margin}%</span>`;
                }
            },
            
            formatCurrency(amount) {
                if (!amount && amount !== 0) return 'Â¥0.00';
                return `Â¥${parseFloat(amount).toFixed(2)}`;
            },
            
            getDateRange(filter) {
                const now = new Date();
                let startDate, endDate;
                
                switch(filter) {
                    case 'day':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                        break;
                    case 'week':
                        const dayOfWeek = now.getDay();
                        const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff);
                        endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + 7);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        endDate = new Date(now.getFullYear() + 1, 0, 1);
                        break;
                    default:
                        startDate = new Date(0);
                        endDate = new Date(9999, 11, 31);
                }
                
                return { startDate, endDate };
            },
            
            downloadCSV(data, filename) {
                const csvContent = "data:text/csv;charset=utf-8," + data;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            
            isPDF(file) {
                return file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
            },
            
            /*
            previewFile(fileData, fileName) {
                if (!fileData) return null;
                
                if (fileData.startsWith('data:application/pdf') || fileName.toLowerCase().endsWith('.pdf')) {
                    return 'pdf';
                } else if (fileData.startsWith('data:image/')) {
                    return 'image';
                }
                return 'unknown';
            },
            */
            
            onImageError(imgElement) {
                // å½“å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾ç‰‡
                imgElement.onerror = null; // é˜²æ­¢å¾ªç¯è°ƒç”¨
                imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0yNSA2NUgyNS4wMDAxTDQwIDQwTDU1IDU1TDc1IDM1SDc1LjAwMDFMNzUgNjVaIiBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMiIvPgo8cGF0aCBkPSJNNzAgNTBDMCUwMCBDNjAgNjAgODAgODAgODAgODBIMjBaIiBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMiIvPgo8L3N2Zz4='; // ç°è‰²å ä½ç¬¦ SVG
                imgElement.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                imgElement.style.backgroundColor = '#f0f0f0';
                imgElement.style.display = 'flex';
                imgElement.style.alignItems = 'center';
                imgElement.style.justifyContent = 'center';
            }
        };

        // ============================================
        // æ•°æ®ç®¡ç†
        // ============================================
        class DataManager {
            static API_BASE = window.location.origin;
            
            // å­˜å‚¨é”®å¸¸é‡
            static STORAGE_KEYS = {
                USER: 'funseek_user',
                TOKEN: 'funseek_token'
            };
            
            static getCurrentUser() {
                const userStr = localStorage.getItem(DataManager.STORAGE_KEYS.USER);
                const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                
                if (userStr && token) {
                    try {
                        const user = JSON.parse(userStr);
                        
                        // éªŒè¯tokenæ˜¯å¦ä¸ºæœ‰æ•ˆçš„JWTæ ¼å¼
                        if (typeof token !== 'string' || !token.includes('.')) {
                            console.error('Tokenæ ¼å¼æ— æ•ˆ:', token);
                            this.logout();
                            return null;
                        }
                        
                        // è§£æJWT tokenä»¥æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                        const tokenParts = token.split('.');
                        if (tokenParts.length !== 3) {
                            console.error('JWTæ ¼å¼æ— æ•ˆï¼Œç¼ºå°‘å¿…éœ€éƒ¨åˆ†:', token);
                            this.logout();
                            return null;
                        }
                        
                        // è§£ç payloadéƒ¨åˆ†ï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰
                        let payload;
                        try {
                            // å¤„ç†JWT payloadçš„Base64Urlè§£ç 
                            const base64 = tokenParts[1].replace(/-/g, '+').replace(/_/g, '/');
                            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                            }).join(''));
                            payload = JSON.parse(jsonPayload);
                        } catch (decodeError) {
                            console.error('JWT payloadè§£ç å¤±è´¥:', decodeError);
                            // å¦‚æœè§£ç å¤±è´¥ï¼Œä»ç„¶è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œä½†è®°å½•é”™è¯¯
                            console.warn('JWTè§£ç å¤±è´¥ä½†ä»è¿”å›ç”¨æˆ·ä¿¡æ¯');
                            return user;
                        }
                        
                        // æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœå­˜åœ¨çš„è¯
                        const currentTime = Math.floor(Date.now() / 1000);
                        if (payload.exp && payload.exp < currentTime) {
                            // Tokenå·²è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                            this.logout();
                            return null;
                        }
                        
                        return user;
                    } catch (e) {
                        console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                        // å‘ç”Ÿé”™è¯¯æ—¶æ¸…ç†å­˜å‚¨ï¼Œé˜²æ­¢æ— é™é”™è¯¯å¾ªç¯
                        this.logout();
                        return null;
                    }
                }
                
                return null;
            }
            
            static setCurrentUser(user, token) {
                localStorage.setItem(DataManager.STORAGE_KEYS.USER, JSON.stringify(user));
                if (token) {
                    localStorage.setItem(DataManager.STORAGE_KEYS.TOKEN, token);
                }
            }
            
            static logout() {
                localStorage.removeItem(DataManager.STORAGE_KEYS.USER);
                localStorage.removeItem(DataManager.STORAGE_KEYS.TOKEN);
                window.location.reload();
            }
            
            static async getAllProducts() {
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/products`, {
                        headers: headers
                    });
                    if (!response.ok) throw new Error('è·å–äº§å“åˆ—è¡¨å¤±è´¥');
                    const products = await response.json();
                    return products.map(product => {
                        // å°†æ•°æ®åº“å­—æ®µæ˜ å°„åˆ°å‰ç«¯æœŸæœ›çš„å­—æ®µå
                        const mappedProduct = {
                            id: product.id,
                            code: product.product_code || product.code || '',
                            name: product.product_name || product.name || '',
                            supplier: product.product_supplier || product.supplier || '',
                            stock: product.quantity || product.stock || 0,
                            purchasePrice: product.purchase_price || product.purchasePrice || 0,
                            salePrice: product.sale_price || product.salePrice || 0,
                            image: product.image || '',
                            createdAt: product.created_at || product.createdAt || ''
                        };
                                                
                        // å§‹ç»ˆè®¡ç®—åˆ©æ¶¦ç‡ï¼Œä¸ç®¡å±æ€§æ˜¯å¦å­˜åœ¨
                        mappedProduct.profitMargin = Utils.calculateProfitMargin(mappedProduct.purchasePrice, mappedProduct.salePrice);
                        
                        return mappedProduct;
                    });
                } catch (error) {
                    console.error('è·å–äº§å“åˆ—è¡¨å¤±è´¥:', error);
                    Utils.showAlert('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    return [];
                }
            }
            
            static async saveProducts(products) {
                // ç”±äºäº§å“æ˜¯å•ç‹¬æ·»åŠ çš„ï¼Œè¿™é‡Œä¸éœ€è¦å®ç°
            }
            
            static async addProduct(product) {
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/products`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            product_code: product.code,
                            product_name: product.name,
                            product_supplier: product.supplier || '',
                            quantity: parseInt(product.stock) || 0,
                            purchase_price: parseFloat(product.purchasePrice) || 0,
                            sale_price: parseFloat(product.salePrice) || 0,
                            image: product.image || ''
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'æ·»åŠ äº§å“å¤±è´¥');
                    }
                    
                    const newProduct = await response.json();
                    
                    // å°†æ•°æ®åº“è¿”å›çš„æ•°æ®æ˜ å°„åˆ°å‰ç«¯æœŸæœ›çš„æ ¼å¼
                    const mappedProduct = {
                        id: newProduct.id,
                        code: newProduct.product_code || newProduct.code,
                        name: newProduct.product_name || newProduct.name,
                        supplier: newProduct.product_supplier || newProduct.supplier || '',
                        stock: newProduct.quantity || newProduct.stock || 0,
                        purchasePrice: newProduct.purchase_price || newProduct.purchasePrice || 0,
                        salePrice: newProduct.sale_price || newProduct.salePrice || 0,
                        image: newProduct.image || '',
                        profitMargin: Utils.calculateProfitMargin(newProduct.purchase_price || 0, newProduct.sale_price || 0),
                        createdAt: newProduct.created_at || newProduct.createdAt
                    };
                    
                    // è®°å½•æ´»åŠ¨
                    this.addActivity('product', `æ·»åŠ æ–°äº§å“: ${product.name} (${product.code})`);
                    
                    // æ¸…é™¤äº§å“ç¼“å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡è·å–æœ€æ–°çš„äº§å“æ•°æ®
                    this.clearProductsCache();
                    
                    return mappedProduct;
                } catch (error) {
                    console.error('æ·»åŠ äº§å“å¤±è´¥:', error);
                    Utils.showAlert(error.message || 'æ·»åŠ äº§å“å¤±è´¥', 'error');
                    throw error;
                }
            }
            
            // ç§»é™¤æœªä½¿ç”¨çš„updateProductStockæ–¹æ³•
            /*
            static async updateProductStock(productId, quantity) {
                try {
                    const products = await this.getAllProducts();
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        const newQuantity = Math.max(0, (product.stock || product.quantity || 0) - quantity);
                        
                        const headers = {
                            'Content-Type': 'application/json',
                        };
                        
                        // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                        const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                        if (token) {
                            headers['Authorization'] = `Bearer ${token}`;
                        }
                        
                        // æ›´æ–°æ•°æ®åº“ä¸­çš„äº§å“æ•°é‡
                        const response = await fetch(`${this.API_BASE}/api/products/${productId}`, {
                            method: 'PUT',
                            headers: headers,
                            body: JSON.stringify({
                                quantity: newQuantity
                            })
                        });
                        
                        if (!response.ok) {
                            console.error('æ›´æ–°åº“å­˜å¤±è´¥:', response.statusText);
                            return false;
                        }
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('æ›´æ–°åº“å­˜å¤±è´¥:', error);
                    return false;
                }
            }
            */
            
            static async deleteProduct(productId) {
                try {
                    const headers = {};
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/products/${productId}`, {
                        method: 'DELETE',
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        console.error('åˆ é™¤äº§å“å¤±è´¥:', response.statusText);
                        return false;
                    }
                    
                    // æ¸…é™¤äº§å“ç¼“å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡è·å–æœ€æ–°çš„äº§å“æ•°æ®
                    this.clearProductsCache();
                    
                    return true;
                } catch (error) {
                    console.error('åˆ é™¤äº§å“å¤±è´¥:', error);
                    return false;
                }
            }
            
            static async getProductById(productId) {
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/products/${productId}`, {
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            return null; // å•†å“ä¸å­˜åœ¨
                        }
                        throw new Error(`è·å–å•†å“ä¿¡æ¯å¤±è´¥: ${response.statusText}`);
                    }
                    
                    const product = await response.json();
                    
                    // å°†æ•°æ®åº“è¿”å›çš„æ•°æ®æ˜ å°„åˆ°å‰ç«¯æœŸæœ›çš„æ ¼å¼
                    const mappedProduct = {
                        id: product.id,
                        code: product.product_code || product.code,
                        name: product.product_name || product.name,
                        supplier: product.product_supplier || product.supplier || '',
                        quantity: product.quantity || product.stock || 0,
                        purchasePrice: product.purchase_price || product.purchasePrice || 0,
                        salePrice: product.sale_price || product.salePrice || 0,
                        image: product.image || '',
                        profitMargin: Utils.calculateProfitMargin(product.purchase_price || 0, product.sale_price || 0),
                        createdAt: product.created_at || product.createdAt
                    };
                    
                    return mappedProduct;
                } catch (error) {
                    console.error('è·å–å•ä¸ªäº§å“å¤±è´¥:', error);
                    throw error;
                }
            }
            
            static async getAllTasks() {
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/tasks`, {
                        headers: headers
                    });
                    if (!response.ok) throw new Error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
                    const tasks = await response.json();
                    
                    // å°†æ•°æ®åº“å­—æ®µæ˜ å°„åˆ°å‰ç«¯æœŸæœ›çš„å­—æ®µå
                    // åŒæ—¶ä¿®å¤å¯èƒ½å­˜åœ¨çš„å­—æ®µé”™ä½é—®é¢˜
                    return tasks.map(task => {
                        // æ£€æµ‹å¹¶ä¿®å¤å­—æ®µé”™ä½é—®é¢˜
                        let fixedTask = {
                            id: task.id,
                            taskNumber: task.task_number || task.taskNumber || '',
                            status: task.status,
                            items: task.items || [],
                            bodyCodeImage: task.body_code_image || task.bodyCodeImage || '',
                            bodyCodeFileName: task.body_code_file_name || task.bodyCodeFileName || '',
                            bodyCodeType: task.body_code_type || task.bodyCodeType || null,
                            barcodeImage: task.barcode_image || task.barcodeImage || '',
                            barcodeFileName: task.barcode_file_name || task.barcodeFileName || '',
                            barcodeType: task.barcode_type || task.barcodeType || null,
                            warningCodeImage: task.warning_code_image || task.warningCodeImage || '',
                            warningCodeFileName: task.warning_code_file_name || task.warningCodeFileName || '',
                            warningCodeType: task.warning_code_type || task.warningCodeType || null,
                            labelImage: task.label_image || task.labelImage || '',
                            labelFileName: task.label_file_name || task.labelFileName || '',
                            labelType: task.label_type || task.labelType || null,
                            manualImage: task.manual_image || task.manualImage || '',
                            manualFileName: task.manual_file_name || task.manualFileName || '',
                            manualType: task.manual_type || task.manualType || null,
                            otherImage: task.other_image || task.otherImage || '',
                            otherFileName: task.other_file_name || task.otherFileName || '',
                            otherType: task.other_type || task.otherType || null,
                            createdAt: task.created_at || task.createdAt || '',
                            completedAt: task.completed_at || task.completedAt || '',
                            creator_name: task.creator_name || task.creatorName || ''
                        };
                        
                        // æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†å­—æ®µé”™ä½ï¼ˆtaskNumberå­—æ®µåŒ…å«çŠ¶æ€å­—ç¬¦ä¸²è€Œstatuså­—æ®µåŒ…å«JSONå­—ç¬¦ä¸²ï¼‰
                        if (typeof fixedTask.taskNumber === 'string' && 
                            (fixedTask.taskNumber === 'pending' || fixedTask.taskNumber === 'processing' || fixedTask.taskNumber === 'completed') &&
                            typeof fixedTask.status === 'string' && fixedTask.status.startsWith('[{')) {
                            // å‘ç”Ÿäº†å­—æ®µé”™ä½ï¼Œäº¤æ¢è¿™ä¸¤ä¸ªå­—æ®µ
                            const originalTaskNumber = fixedTask.taskNumber;
                            fixedTask.taskNumber = fixedTask.status;
                            fixedTask.status = originalTaskNumber;
                            
                            // åŒæ—¶å°è¯•è§£æåŸæ¥çš„statuså†…å®¹åˆ°itemså­—æ®µ
                            try {
                                fixedTask.items = JSON.parse(fixedTask.taskNumber);
                            } catch (e) {
                                console.warn('æ— æ³•è§£æé”™ä½çš„itemsæ•°æ®:', fixedTask.taskNumber);
                                fixedTask.items = [];
                            }
                        }
                        
                        // ä¹Ÿæ£€æŸ¥å¦ä¸€ç§å¯èƒ½çš„é”™ä½æƒ…å†µï¼ˆstatuså­—æ®µåŒ…å«JSONå­—ç¬¦ä¸²è€ŒtaskNumberæ˜¯çŠ¶æ€å­—ç¬¦ä¸²ï¼‰
                        else if (typeof fixedTask.status === 'string' && fixedTask.status.startsWith('[{') &&
                               typeof fixedTask.taskNumber === 'string' && 
                               (fixedTask.taskNumber === 'pending' || fixedTask.taskNumber === 'processing' || fixedTask.taskNumber === 'completed')) {
                            // å‘ç”Ÿäº†å­—æ®µé”™ä½ï¼Œäº¤æ¢è¿™ä¸¤ä¸ªå­—æ®µ
                            const originalStatus = fixedTask.status;
                            fixedTask.status = fixedTask.taskNumber;
                            fixedTask.taskNumber = originalStatus;
                            
                            // åŒæ—¶å°è¯•è§£æåŸæ¥çš„statuså†…å®¹åˆ°itemså­—æ®µ
                            try {
                                fixedTask.items = JSON.parse(originalStatus);
                            } catch (e) {
                                console.warn('æ— æ³•è§£æé”™ä½çš„itemsæ•°æ®:', originalStatus);
                                fixedTask.items = [];
                            }
                        }
                        
                        // è¿˜éœ€è¦å¤„ç†ä¸€ç§æƒ…å†µï¼šstatusæ˜¯JSONå­—ç¬¦ä¸²ä½†åº”è¯¥æ˜¯ä¸€ä¸ªçŠ¶æ€å€¼
                        else if (typeof fixedTask.status === 'string' && fixedTask.status.startsWith('[{') &&
                               (typeof fixedTask.taskNumber !== 'string' || !['pending', 'processing', 'completed'].includes(fixedTask.taskNumber))) {
                            // è¿™ç§æƒ…å†µä¸‹ï¼Œstatuså¯èƒ½æ˜¯é”™ä½çš„itemsæ•°æ®ï¼Œæˆ‘ä»¬åº”è¯¥ç»™å®ƒä¸€ä¸ªåˆç†çš„çŠ¶æ€å€¼
                            // å‡è®¾å¦‚æœæ˜¯itemsæ•°æ®ï¼Œåˆ™è¯¥ä»»åŠ¡åº”ä¸ºpendingçŠ¶æ€
                            const originalStatus = fixedTask.status;
                            fixedTask.status = 'pending';
                            
                            // å°è¯•è§£æitemsæ•°æ®
                            try {
                                fixedTask.items = JSON.parse(originalStatus);
                            } catch (e) {
                                console.warn('æ— æ³•è§£æitemsæ•°æ®:', originalStatus);
                                fixedTask.items = [];
                            }
                        }
                        
                        // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœtaskNumberå­—æ®µåŒ…å«JSONæ•°ç»„ï¼ˆä»¥[{å¼€å¤´ï¼‰ï¼Œåˆ™ç”Ÿæˆæ–°çš„ä»»åŠ¡å·
                        if (typeof fixedTask.taskNumber === 'string' && fixedTask.taskNumber.startsWith('[{')) {
                            console.warn('æ£€æµ‹åˆ°taskNumberå­—æ®µåŒ…å«JSONæ•°æ®ï¼Œæ­£åœ¨ä¿®å¤:', fixedTask.taskNumber);
                            // ä¸´æ—¶ä¿å­˜åŸå§‹å†…å®¹ç”¨äºè§£æåˆ°items
                            const originalTaskNumber = fixedTask.taskNumber;
                            // ä¸ºè¿™ç§é”™ä½çš„ä»»åŠ¡ç”Ÿæˆæ–°çš„ä»»åŠ¡å·
                            fixedTask.taskNumber = Utils.generateTaskNumber();
                            
                            // å¦‚æœitemsä¸ºç©ºä¸”åŸtaskNumberå†…å®¹çœ‹èµ·æ¥åƒitemsæ•°æ®ï¼Œå°è¯•è§£æå®ƒ
                            if (!fixedTask.items || fixedTask.items.length === 0) {
                                try {
                                    fixedTask.items = JSON.parse(originalTaskNumber);
                                    console.log('å·²å°†é”™ä½çš„taskNumberæ•°æ®è§£æåˆ°itemså­—æ®µ');
                                } catch (e) {
                                    console.warn('æ— æ³•è§£æé”™ä½çš„itemsæ•°æ®:', originalTaskNumber);
                                    fixedTask.items = [];
                                }
                            }
                        }
                        
                        return fixedTask;
                    });
                } catch (error) {
                    console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                    Utils.showAlert('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    return [];
                }
            }
            
            static async saveTasks(tasks) {
                // ç”±äºä»»åŠ¡æ˜¯å•ç‹¬æ·»åŠ çš„ï¼Œè¿™é‡Œä¸éœ€è¦å®ç°
            }
            
            static async addTask(task) {
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/tasks`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            task_number: Utils.generateTaskNumber(),
                            status: 'pending',
                            items: task.items,
                            body_code_image: task.bodyCodeImage || '',
                            barcode_image: task.barcodeImage || '',
                            warning_code_image: task.warningCodeImage || '',
                            label_image: task.labelImage || '',
                            manual_image: task.manualImage || '',
                            other_image: task.otherImage || '',
                            remark: task.remark || '', // æ·»åŠ å¤‡æ³¨å­—æ®µ
                            creator_name: task.creatorName || DataManager.getCurrentUser()?.name || DataManager.getCurrentUser()?.username || null,
                            creator_role: DataManager.getCurrentUser()?.role || null
                        })
                    });
                    
                    if (!response.ok) {
                        let errorData = null;
                        try {
                            errorData = await response.json();
                        } catch (e) {
                            // å¦‚æœæ— æ³•è§£æJSONå“åº”ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯ä¿¡æ¯
                        }
                        throw new Error(errorData?.error || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                    }
                    
                    const newTask = await response.json();
                    
                    // å°†æ•°æ®åº“è¿”å›çš„æ•°æ®æ˜ å°„åˆ°å‰ç«¯æœŸæœ›çš„æ ¼å¼
                    const mappedTask = {
                        id: newTask.id,
                        taskNumber: newTask.task_number || newTask.taskNumber || '',
                        status: newTask.status,
                        items: newTask.items || [],
                        bodyCodeImage: newTask.body_code_image || newTask.bodyCodeImage || '',
                        bodyCodeFileName: newTask.body_code_file_name || newTask.bodyCodeFileName || '',
                        bodyCodeType: newTask.body_code_type || newTask.bodyCodeType || null,
                        barcodeImage: newTask.barcode_image || newTask.barcodeImage || '',
                        barcodeFileName: newTask.barcode_file_name || newTask.barcodeFileName || '',
                        barcodeType: newTask.barcode_type || newTask.barcodeType || null,
                        warningCodeImage: newTask.warning_code_image || newTask.warningCodeImage || '',
                        warningCodeFileName: newTask.warning_code_file_name || newTask.warningCodeFileName || '',
                        warningCodeType: newTask.warning_code_type || newTask.warningCodeType || null,
                        labelImage: newTask.label_image || newTask.labelImage || '',
                        labelFileName: newTask.label_file_name || newTask.labelFileName || '',
                        labelType: newTask.label_type || newTask.labelType || null,
                        manualImage: newTask.manual_image || newTask.manualImage || '',
                        manualFileName: newTask.manual_file_name || newTask.manualFileName || '',
                        manualType: newTask.manual_type || newTask.manualType || null,
                        otherImage: newTask.other_image || newTask.otherImage || '',
                        otherFileName: newTask.other_file_name || newTask.otherFileName || '',
                        otherType: newTask.other_type || newTask.otherType || null,
                        remark: newTask.remark || newTask.remark || '', // æ·»åŠ å¤‡æ³¨å­—æ®µ
                        creator_name: newTask.creator_name || newTask.creatorName || DataManager.getCurrentUser()?.username || DataManager.getCurrentUser()?.name || null,
                        creator_role: newTask.creator_role || newTask.creatorRole || null,
                        createdAt: newTask.created_at || newTask.createdAt || '',
                        completedAt: newTask.completed_at || newTask.completedAt || ''
                    };
                    
                    // è®°å½•æ´»åŠ¨
                    this.addActivity('task', `åˆ›å»ºå‘è´§ä»»åŠ¡: ${mappedTask.taskNumber}`);
                    
                    // æ¸…é™¤å†å²è®°å½•ç¼“å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡è·å–æœ€æ–°çš„ä»»åŠ¡æ•°æ®
                    this.clearHistoryCache();
                    
                    return mappedTask;
                } catch (error) {
                    console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                    Utils.showAlert(error.message || 'åˆ›å»ºä»»åŠ¡å¤±è´¥', 'error');
                    throw error;
                }
            }
            
            static async updateTask(taskId, updates) {
                try {
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/tasks/${taskId}`, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify(updates)
                    });
                    
                    if (!response.ok) {
                        console.error('æ›´æ–°ä»»åŠ¡å¤±è´¥:', response.statusText);
                        return false;
                    }
                    
                    // æ¸…é™¤å†å²è®°å½•ç¼“å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡è·å–æœ€æ–°çš„ä»»åŠ¡æ•°æ®
                    this.clearHistoryCache();
                    
                    return true;
                } catch (error) {
                    console.error('æ›´æ–°ä»»åŠ¡å¤±è´¥:', error);
                    return false;
                }
            }
            
            static async deleteTask(taskId) {
                try {
                    const headers = {};
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/tasks/${taskId}`, {
                        method: 'DELETE',
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        try {
                            const errorData = await response.json();
                            console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', errorData.error || response.statusText);
                        } catch (e) {
                            console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', response.statusText);
                        }
                        return false;
                    }
                    
                    // æ¸…é™¤å†å²è®°å½•ç¼“å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡è·å–æœ€æ–°çš„ä»»åŠ¡æ•°æ®
                    this.clearHistoryCache();
                    
                    return true;
                } catch (error) {
                    console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                    return false;
                }
            }
            
            static cleanupStorage() {
                // å½“ä½¿ç”¨æ•°æ®åº“æ—¶ï¼Œä¸éœ€è¦æ¸…ç†æœ¬åœ°å­˜å‚¨
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šä»æ•°æ®URLæ¨æ–­æ–‡ä»¶ç±»å‹
            static inferFileTypeFromData(dataUrl) {
                if (!dataUrl || typeof dataUrl !== 'string' || !dataUrl.startsWith('data:')) {
                    return null;
                }
                
                // æå–MIMEç±»å‹éƒ¨åˆ†
                const mimeMatch = dataUrl.match(/^data:([^;,]+)/);
                if (mimeMatch && mimeMatch[1]) {
                    const mimeType = mimeMatch[1].toLowerCase();
                    
                    // æ ¹æ®MIMEç±»å‹æ¨æ–­æ–‡ä»¶ç±»å‹
                    if (mimeType.includes('pdf')) {
                        return 'pdf';
                    } else if (mimeType.includes('image')) {
                        return 'image';
                    } else if (mimeType.includes('jpeg') || mimeType.includes('jpg')) {
                        return 'image';
                    } else if (mimeType.includes('png')) {
                        return 'image';
                    } else if (mimeType.includes('gif')) {
                        return 'image';
                    } else if (mimeType.includes('webp')) {
                        return 'image';
                    }
                }
                
                return null; // æ— æ³•æ¨æ–­ç±»å‹
            }
            
            static async getTaskById(taskId) {
                try {
                    // ç›´æ¥è·å–æŒ‡å®šIDçš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯è·å–æ‰€æœ‰ä»»åŠ¡
                    const headers = {};
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/tasks/${taskId}`, {
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        // å¦‚æœè¿”å›404ï¼Œè¯´æ˜ä»»åŠ¡ä¸å­˜åœ¨
                        if (response.status === 404) {
                            console.warn(`ä»»åŠ¡ID ${taskId} ä¸å­˜åœ¨`);
                            return null;
                        }
                        throw new Error(`è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                    
                    const task = await response.json();
                    
                    // å°†æ•°æ®åº“å­—æ®µæ˜ å°„åˆ°å‰ç«¯æœŸæœ›çš„å­—æ®µå
                    // å¹¶ä¿®å¤å¯èƒ½å­˜åœ¨çš„å­—æ®µé”™ä½é—®é¢˜ï¼ˆå¤ç”¨getAllTasksä¸­çš„é€»è¾‘ï¼‰
                    let fixedTask = {
                        id: task.id,
                        taskNumber: task.task_number || task.taskNumber || '',
                        status: task.status,
                        items: task.items || [],
                        bodyCodeImage: task.body_code_image || task.bodyCodeImage || '',
                        bodyCodeFileName: task.body_code_file_name || task.bodyCodeFileName || '',
                        bodyCodeType: task.body_code_type || task.bodyCodeType || DataManager.inferFileTypeFromData(task.body_code_image || task.bodyCodeImage || ''),
                        barcodeImage: task.barcode_image || task.barcodeImage || '',
                        barcodeFileName: task.barcode_file_name || task.barcodeFileName || '',
                        barcodeType: task.barcode_type || task.barcodeType || DataManager.inferFileTypeFromData(task.barcode_image || task.barcodeImage || ''),
                        warningCodeImage: task.warning_code_image || task.warningCodeImage || '',
                        warningCodeFileName: task.warning_code_file_name || task.warningCodeFileName || '',
                        warningCodeType: task.warning_code_type || task.warningCodeType || DataManager.inferFileTypeFromData(task.warning_code_image || task.warningCodeImage || ''),
                        labelImage: task.label_image || task.labelImage || '',
                        labelFileName: task.label_file_name || task.labelFileName || '',
                        labelType: task.label_type || task.labelType || DataManager.inferFileTypeFromData(task.label_image || task.labelImage || ''),
                        manualImage: task.manual_image || task.manualImage || '',
                        manualFileName: task.manual_file_name || task.manualFileName || '',
                        manualType: task.manual_type || task.manualType || DataManager.inferFileTypeFromData(task.manual_image || task.manualImage || ''),
                        otherImage: task.other_image || task.otherImage || '',
                        otherFileName: task.other_file_name || task.otherFileName || '',
                        otherType: task.other_type || task.otherType || DataManager.inferFileTypeFromData(task.other_image || task.otherImage || ''),
                        createdAt: task.created_at || task.createdAt || '',
                        completedAt: task.completed_at || task.completedAt || '',
                        creator_name: task.creator_name || task.creatorName || ''
                    };
                    
                    // æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†å­—æ®µé”™ä½ï¼ˆtaskNumberå­—æ®µåŒ…å«çŠ¶æ€å­—ç¬¦ä¸²è€Œstatuså­—æ®µåŒ…å«JSONå­—ç¬¦ä¸²ï¼‰
                    if (typeof fixedTask.taskNumber === 'string' && 
                        (fixedTask.taskNumber === 'pending' || fixedTask.taskNumber === 'processing' || fixedTask.taskNumber === 'completed') &&
                        typeof fixedTask.status === 'string' && fixedTask.status.startsWith('[{')) {
                        // å‘ç”Ÿäº†å­—æ®µé”™ä½ï¼Œäº¤æ¢è¿™ä¸¤ä¸ªå­—æ®µ
                        const originalTaskNumber = fixedTask.taskNumber;
                        fixedTask.taskNumber = fixedTask.status;
                        fixedTask.status = originalTaskNumber;
                        
                        // åŒæ—¶å°è¯•è§£æåŸæ¥çš„statuså†…å®¹åˆ°itemså­—æ®µ
                        try {
                            fixedTask.items = JSON.parse(fixedTask.taskNumber);
                        } catch (e) {
                            console.warn('æ— æ³•è§£æé”™ä½çš„itemsæ•°æ®:', fixedTask.taskNumber);
                            fixedTask.items = [];
                        }
                    }
                    
                    // ä¹Ÿæ£€æŸ¥å¦ä¸€ç§å¯èƒ½çš„é”™ä½æƒ…å†µï¼ˆstatuså­—æ®µåŒ…å«JSONå­—ç¬¦ä¸²è€ŒtaskNumberæ˜¯çŠ¶æ€å­—ç¬¦ä¸²ï¼‰
                    else if (typeof fixedTask.status === 'string' && fixedTask.status.startsWith('[{') &&
                           typeof fixedTask.taskNumber === 'string' && 
                           (fixedTask.taskNumber === 'pending' || fixedTask.taskNumber === 'processing' || fixedTask.taskNumber === 'completed')) {
                        // å‘ç”Ÿäº†å­—æ®µé”™ä½ï¼Œäº¤æ¢è¿™ä¸¤ä¸ªå­—æ®µ
                        const originalStatus = fixedTask.status;
                        fixedTask.status = fixedTask.taskNumber;
                        fixedTask.taskNumber = originalStatus;
                        
                        // åŒæ—¶å°è¯•è§£æåŸæ¥çš„statuså†…å®¹åˆ°itemså­—æ®µ
                        try {
                            fixedTask.items = JSON.parse(originalStatus);
                        } catch (e) {
                            console.warn('æ— æ³•è§£æé”™ä½çš„itemsæ•°æ®:', originalStatus);
                            fixedTask.items = [];
                        }
                    }
                    
                    // è¿˜éœ€è¦å¤„ç†ä¸€ç§æƒ…å†µï¼šstatusæ˜¯JSONå­—ç¬¦ä¸²ä½†åº”è¯¥æ˜¯ä¸€ä¸ªçŠ¶æ€å€¼
                    else if (typeof fixedTask.status === 'string' && fixedTask.status.startsWith('[{') &&
                           (typeof fixedTask.taskNumber !== 'string' || !['pending', 'processing', 'completed'].includes(fixedTask.taskNumber))) {
                        // è¿™ç§æƒ…å†µä¸‹ï¼Œstatuså¯èƒ½æ˜¯é”™ä½çš„itemsæ•°æ®ï¼Œæˆ‘ä»¬åº”è¯¥ç»™å®ƒä¸€ä¸ªåˆç†çš„çŠ¶æ€å€¼
                        // å‡è®¾å¦‚æœæ˜¯itemsæ•°æ®ï¼Œåˆ™è¯¥ä»»åŠ¡åº”ä¸ºpendingçŠ¶æ€
                        const originalStatus = fixedTask.status;
                        fixedTask.status = 'pending';
                        
                        // å°è¯•è§£æitemsæ•°æ®
                        try {
                            fixedTask.items = JSON.parse(originalStatus);
                        } catch (e) {
                            console.warn('æ— æ³•è§£æitemsæ•°æ®:', originalStatus);
                            fixedTask.items = [];
                        }
                    }
                    
                    // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœtaskNumberå­—æ®µåŒ…å«JSONæ•°ç»„ï¼ˆä»¥[{å¼€å¤´ï¼‰ï¼Œåˆ™ç”Ÿæˆæ–°çš„ä»»åŠ¡å·
                    if (typeof fixedTask.taskNumber === 'string' && fixedTask.taskNumber.startsWith('[{')) {
                        console.warn('æ£€æµ‹åˆ°taskNumberå­—æ®µåŒ…å«JSONæ•°æ®ï¼Œæ­£åœ¨ä¿®å¤:', fixedTask.taskNumber);
                        // ä¸´æ—¶ä¿å­˜åŸå§‹å†…å®¹ç”¨äºè§£æåˆ°items
                        const originalTaskNumber = fixedTask.taskNumber;
                        // ä¸ºè¿™ç§é”™ä½çš„ä»»åŠ¡ç”Ÿæˆæ–°çš„ä»»åŠ¡å·
                        fixedTask.taskNumber = Utils.generateTaskNumber();
                        
                        // å¦‚æœitemsä¸ºç©ºä¸”åŸtaskNumberå†…å®¹çœ‹èµ·æ¥åƒitemsæ•°æ®ï¼Œå°è¯•è§£æå®ƒ
                        if (!fixedTask.items || fixedTask.items.length === 0) {
                            try {
                                fixedTask.items = JSON.parse(originalTaskNumber);
                                console.log('å·²å°†é”™ä½çš„taskNumberæ•°æ®è§£æåˆ°itemså­—æ®µ');
                            } catch (e) {
                                console.warn('æ— æ³•è§£æé”™ä½çš„itemsæ•°æ®:', originalTaskNumber);
                                fixedTask.items = [];
                            }
                        }
                    }
                    
                    return fixedTask;
                } catch (error) {
                    console.error('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
                    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œä¹Ÿè¿”å›null
                    if (error instanceof TypeError && error.message.includes('fetch')) {
                        console.error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥:', error);
                    }
                    return null;
                }
            }
            
            static async getTasksByStatus(status) {
                try {
                    const tasks = await this.getAllTasks();
                    return tasks.filter(t => t.status === status);
                } catch (error) {
                    console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                    return [];
                }
            }
            
            static async addToHistory(task) {
                // æ­¤æ–¹æ³•å·²è¢«å¼ƒç”¨ï¼Œä½¿ç”¨æ–°çš„å®Œæˆä»»åŠ¡APIä»£æ›¿
                console.warn('DataManager.addToHistory æ–¹æ³•å·²è¢«å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨å®Œæˆä»»åŠ¡API');
                try {
                    // ç›´æ¥è°ƒç”¨å®Œæˆä»»åŠ¡çš„APIï¼Œè¿™ä¼šå°†ä»»åŠ¡ç§»åŠ¨åˆ°å†å²è¡¨
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/tasks/${task.id}/complete`, {
                        method: 'POST',
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        console.error('å®Œæˆä»»åŠ¡å¹¶ç§»åŠ¨åˆ°å†å²è®°å½•å¤±è´¥:', response.statusText);
                        return false;
                    }
                    
                    // æ¸…é™¤å†å²è®°å½•ç¼“å­˜ï¼Œä»¥ä¾¿ä¸‹æ¬¡è·å–æœ€æ–°çš„ä»»åŠ¡æ•°æ®
                    this.clearHistoryCache();
                    
                    return true;
                } catch (error) {
                    console.error('å®Œæˆä»»åŠ¡å¹¶ç§»åŠ¨åˆ°å†å²è®°å½•å¤±è´¥:', error);
                    return false;
                }
            }
            
            static async getHistory() {
                try {
                    const headers = {};
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/history`, {
                        headers: headers
                    });
                    if (!response.ok) throw new Error('è·å–å†å²è®°å½•å¤±è´¥');
                    const history = await response.json();
                    
                    // é¦–å…ˆè·å–æ‰€æœ‰äº§å“ä¿¡æ¯ç”¨äºè¡¥å……ä¾›åº”å•†æ•°æ®
                    const products = await this.getAllProducts();
                    
                    // åˆ›å»ºç»“æœæ•°ç»„
                    const result = [];
                    
                    // å¾ªç¯å¤„ç†æ¯æ¡å†å²è®°å½•
                    for (const record of history) {
                        let mappedRecord = {
                            id: record.id,
                            taskNumber: record.task_number || record.taskNumber,
                            status: record.status,
                            items: record.items || [],
                            bodyCodeImage: record.body_code_image || record.bodyCodeImage || '',
                            bodyCodeFileName: record.body_code_file_name || record.bodyCodeFileName || '',
                            bodyCodeType: record.body_code_type || record.bodyCodeType || null,
                            barcodeImage: record.barcode_image || record.barcodeImage || '',
                            barcodeFileName: record.barcode_file_name || record.barcodeFileName || '',
                            barcodeType: record.barcode_type || record.barcodeType || null,
                            warningCodeImage: record.warning_code_image || record.warningCodeImage || '',
                            warningCodeFileName: record.warning_code_file_name || record.warningCodeFileName || '',
                            warningCodeType: record.warning_code_type || record.warningCodeType || null,
                            labelImage: record.label_image || record.labelImage || '',
                            labelFileName: record.label_file_name || record.labelFileName || '',
                            labelType: record.label_type || record.labelType || null,
                            createdAt: record.created_at || record.createdAt,
                            completedAt: record.completed_at || record.completedAt,
                            creator_name: record.creator_name || record.creatorName || ''
                        };
                        
                        // å¢å¼ºitemsæ•°æ®ï¼Œç¡®ä¿æ¯ä¸ªitemåŒ…å«ä¾›åº”å•†ä¿¡æ¯
                        if (mappedRecord.items && Array.isArray(mappedRecord.items)) {
                            mappedRecord.items = mappedRecord.items.map(item => {
                                // å¦‚æœitemä¸­æ²¡æœ‰ä¾›åº”å•†ä¿¡æ¯ï¼Œå°è¯•ä»å…³è”çš„äº§å“ä¸­è·å–
                                let enhancedItem = { ...item };
                                
                                if (!enhancedItem.supplier && !enhancedItem.productSupplier && enhancedItem.productId) {
                                    const product = products.find(p => p.id === enhancedItem.productId);
                                    if (product) {
                                        // è¡¥å……ä¾›åº”å•†ä¿¡æ¯
                                        enhancedItem.supplier = product.supplier || product.product_supplier || '';
                                        enhancedItem.productSupplier = product.supplier || product.product_supplier || '';
                                        
                                        // åŒæ—¶è¡¥å……äº§å“ä¿¡æ¯åˆ°itemä¸­
                                        enhancedItem.product = {
                                            name: product.name,
                                            code: product.code,
                                            supplier: product.supplier || product.product_supplier || '',
                                            purchasePrice: product.purchasePrice,
                                            salePrice: product.salePrice,
                                            profitMargin: product.profitMargin
                                        };
                                                                        
                                        // å¦‚æœitemæœ¬èº«æ²¡æœ‰salePriceï¼Œä»äº§å“ä¸­è·å–
                                        if (!enhancedItem.salePrice && product.salePrice) {
                                            enhancedItem.salePrice = product.salePrice;
                                        }
                                    }
                                }
                                
                                return enhancedItem;
                            });
                        }
                        
                        // æ£€æŸ¥å¹¶ä¿®å¤å†å²è®°å½•ä¸­çš„å­—æ®µé”™ä½é—®é¢˜
                        // å¦‚æœtaskNumberå­—æ®µåŒ…å«JSONæ•°ç»„ï¼ˆä»¥[{å¼€å¤´ï¼‰ï¼Œåˆ™ç”Ÿæˆæ–°çš„ä»»åŠ¡å·
                        if (typeof mappedRecord.taskNumber === 'string' && mappedRecord.taskNumber.startsWith('[{')) {
                            console.warn('æ£€æµ‹åˆ°å†å²è®°å½•taskNumberå­—æ®µåŒ…å«JSONæ•°æ®ï¼Œæ­£åœ¨ä¿®å¤:', mappedRecord.taskNumber);
                            // ä¸´æ—¶ä¿å­˜åŸå§‹å†…å®¹ç”¨äºè§£æåˆ°items
                            const originalTaskNumber = mappedRecord.taskNumber;
                            // ä¸ºè¿™ç§é”™ä½çš„ä»»åŠ¡ç”Ÿæˆæ–°çš„ä»»åŠ¡å·
                            mappedRecord.taskNumber = Utils.generateTaskNumber();
                            
                            // å¦‚æœitemsä¸ºç©ºä¸”åŸtaskNumberå†…å®¹çœ‹èµ·æ¥åƒitemsæ•°æ®ï¼Œå°è¯•è§£æå®ƒ
                            if (!mappedRecord.items || mappedRecord.items.length === 0) {
                                try {
                                    mappedRecord.items = JSON.parse(originalTaskNumber);
                                    console.log('å·²å°†é”™ä½çš„taskNumberæ•°æ®è§£æåˆ°itemså­—æ®µ');
                                } catch (e) {
                                    console.warn('æ— æ³•è§£æé”™ä½çš„itemsæ•°æ®:', originalTaskNumber);
                                    mappedRecord.items = [];
                                }
                            }
                        }
                        
                        result.push(mappedRecord);
                    }
                    
                    return result;
                } catch (error) {
                    console.error('è·å–å†å²è®°å½•å¤±è´¥:', error);
                    Utils.showAlert('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    return [];
                }
            }
            
            static async getActivities() {
                try {
                    const headers = {};
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/activities`, {
                        headers: headers
                    });
                    if (!response.ok) throw new Error('è·å–æ´»åŠ¨è®°å½•å¤±è´¥');
                    const activities = await response.json();
                    
                    // å°†æ•°æ®åº“å­—æ®µæ˜ å°„åˆ°å‰ç«¯æœŸæœ›çš„å­—æ®µå
                    return activities.map(activity => {
                        return {
                            id: activity.id,
                            time: activity.time || activity.created_at || '',
                            type: activity.type,
                            details: activity.details,
                            actor: activity.actor || activity.username || '',
                            createdAt: activity.created_at || activity.createdAt
                        };
                    });
                } catch (error) {
                    console.error('è·å–æ´»åŠ¨è®°å½•å¤±è´¥:', error);
                    Utils.showAlert('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    return [];
                }
            }
            
            static async addActivity(type, details) {
                try {
                    const now = new Date();
                    const time = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    
                    const user = this.getCurrentUser();
                    const userName = user ? user.name : 'æœªçŸ¥ç”¨æˆ·';
                    
                    const activity = {
                        time: time,
                        type: type,
                        details: details,
                        actor: userName
                    };
                    
                    const headers = {
                        'Content-Type': 'application/json',
                    };
                    
                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${this.API_BASE}/api/activities`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(activity)
                    });
                    
                    if (!response.ok) {
                        console.error('æ·»åŠ æ´»åŠ¨è®°å½•å¤±è´¥:', response.statusText);
                    }
                    
                    return activity;
                } catch (error) {
                    console.error('æ·»åŠ æ´»åŠ¨è®°å½•å¤±è´¥:', error);
                }
            }
            
            static async getStatisticsData(filter = 'day', userId = null) {
                try {
                    // ä½¿ç”¨ç¼“å­˜çš„æ•°æ®ï¼Œé¿å…é‡å¤è¯·æ±‚
                    let history, products, allUsers;
                    
                    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæœ‰æ•ˆåˆ™ä½¿ç”¨ç¼“å­˜
                    if (this.cachedHistory && this.cachedHistory.timestamp && 
                        (Date.now() - this.cachedHistory.timestamp) < 30000) { // 30ç§’ç¼“å­˜
                        history = this.cachedHistory.data;
                    } else {
                        history = await this.getHistory();
                        this.cachedHistory = { data: history, timestamp: Date.now() };
                    }
                    
                    if (this.cachedProducts && this.cachedProducts.timestamp && 
                        (Date.now() - this.cachedProducts.timestamp) < 30000) { // 30ç§’ç¼“å­˜
                        products = this.cachedProducts.data;
                    } else {
                        products = await this.getAllProducts();
                        this.cachedProducts = { data: products, timestamp: Date.now() };
                    }
                    
                    if (this.cachedUsers && this.cachedUsers.timestamp && 
                        (Date.now() - this.cachedUsers.timestamp) < 30000) { // 30ç§’ç¼“å­˜
                        allUsers = this.cachedUsers.data;
                    } else {
                        allUsers = await this.getAllUsers();
                        this.cachedUsers = { data: allUsers, timestamp: Date.now() };
                    }
                    
                    const { startDate, endDate } = Utils.getDateRange(filter);
                    
                    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                    const currentUser = this.getCurrentUser();
                    
                    // é¢„å…ˆåˆ›å»ºç”¨æˆ·IDåˆ°ç”¨æˆ·ä¿¡æ¯çš„æ˜ å°„ï¼Œæé«˜æŸ¥æ‰¾æ•ˆç‡
                    const userIdMap = {};
                    allUsers.forEach(user => {
                        userIdMap[user.id] = user;
                    });
                    
                    // é¢„å…ˆåˆ›å»ºç”¨æˆ·åç§°åˆ°ç”¨æˆ·IDçš„æ˜ å°„ï¼Œç”¨äºå¿«é€ŸåŒ¹é…
                    const userNameMap = {};
                    allUsers.forEach(user => {
                        if (user.name) userNameMap[user.name] = user.id;
                        if (user.username) userNameMap[user.username] = user.id;
                        if (user.email) userNameMap[user.email] = user.id;
                    });
                    
                    // ä¼˜åŒ–ç­›é€‰é€»è¾‘ï¼Œå‡å°‘é‡å¤è®¡ç®—
                    const filteredHistory = [];
                    for (let i = 0; i < history.length; i++) {
                        const task = history[i];
                        const taskDate = new Date(task.completedAt || task.createdAt);
                        
                        // æ£€æŸ¥æ—¥æœŸèŒƒå›´
                        if (taskDate < startDate || taskDate >= endDate) continue;
                        
                        // è·å–ä»»åŠ¡åˆ›å»ºè€…ä¿¡æ¯
                        const taskCreator = task.creator_name || task.creatorName || task.creator;
                        
                        // å¦‚æœæŒ‡å®šäº†ç‰¹å®šç”¨æˆ·IDï¼Œåˆ™åªæ˜¾ç¤ºè¯¥ç”¨æˆ·çš„æ•°æ®
                        if (userId && userId !== 'all') {
                            // ä½¿ç”¨é¢„å»ºçš„æ˜ å°„å¿«é€ŸæŸ¥æ‰¾
                            const targetUser = userIdMap[userId];
                            if (targetUser) {
                                // æ¯”è¾ƒä»»åŠ¡åˆ›å»ºè€…ä¸ç›®æ ‡ç”¨æˆ·çš„åç§°æˆ–ID
                                if (taskCreator === targetUser.name || 
                                    taskCreator === targetUser.username ||
                                    taskCreator === targetUser.email) {
                                    filteredHistory.push(task);
                                }
                            } else {
                                // å¦‚æœæ²¡æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·ï¼Œå°è¯•ç›´æ¥æ¯”è¾ƒuserIdä¸ä»»åŠ¡åˆ›å»ºè€…åç§°
                                // è¿™æ˜¯ä¸ºäº†å¤„ç†å¯èƒ½ä¼ å…¥ç”¨æˆ·åè€Œéç”¨æˆ·IDçš„æƒ…å†µ
                                if (taskCreator === userId) {
                                    filteredHistory.push(task);
                                }
                            }
                            continue;
                        }
                        
                        // å¯¹äºéç®¡ç†å‘˜ç”¨æˆ·ï¼Œåªå¤„ç†ä»–ä»¬è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡
                        if (currentUser && currentUser.role !== 'admin') {
                            // æ£€æŸ¥ä»»åŠ¡åˆ›å»ºè€…æ˜¯å¦ä¸å½“å‰ç”¨æˆ·åŒ¹é…ï¼ˆè€ƒè™‘å¤šç§å¯èƒ½çš„æ ‡è¯†ç¬¦ï¼‰
                            if (taskCreator === currentUser.name || 
                                taskCreator === currentUser.username || 
                                taskCreator === currentUser.email) {
                                filteredHistory.push(task);
                            }
                        } else {
                            // ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ•°æ®
                            filteredHistory.push(task);
                        }
                    }
                    

                    
                    let totalShipments = 0;
                    let totalSales = 0;
                    let totalProfit = 0;
                    let totalCost = 0;
                    
                    const productStats = {};
                    
                    filteredHistory.forEach(task => {
                        // å¤„ç†ä»»åŠ¡ä¸­çš„itemsæ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨å­—æ®µé”™ä½
                        let processedItems = task.items;
                        
                        // å¦‚æœitemsçœ‹èµ·æ¥åƒæ˜¯é”™ä½çš„ï¼ˆä¾‹å¦‚åŒ…å«äº†ä»»åŠ¡ç¼–å·è€Œä¸æ˜¯äº§å“é¡¹ï¼‰ï¼Œå°è¯•ä¿®å¤
                        if (Array.isArray(processedItems) && processedItems.length > 0 && 
                            typeof processedItems[0] === 'object' && processedItems[0].hasOwnProperty('taskNumber')) {
                            // è¿™ç§æƒ…å†µè¡¨æ˜itemså­—æ®µå¯èƒ½åŒ…å«é”™è¯¯çš„æ•°æ®
                            console.warn('æ£€æµ‹åˆ°å¯èƒ½é”™ä½çš„itemsæ•°æ®:', processedItems);
                            // å°è¯•ä»ä»»åŠ¡çš„å…¶ä»–å­—æ®µæ¢å¤itemsæ•°æ®
                            if (task.correctedItems) {
                                processedItems = task.correctedItems;
                            } else {
                                // å¦‚æœæ— æ³•æ¢å¤ï¼Œåˆ™è·³è¿‡æ­¤ä»»åŠ¡çš„ç»Ÿè®¡
                                console.warn('æ— æ³•æ¢å¤æ­¤ä»»åŠ¡çš„itemsæ•°æ®ï¼Œè·³è¿‡ç»Ÿè®¡:', task.id);
                                return;
                            }
                        }
                        
                        processedItems.forEach(item => {
                            // ç¡®ä¿itemæœ‰æ­£ç¡®çš„ç»“æ„
                            if (!item || typeof item !== 'object') {
                                console.warn('å‘ç°æ— æ•ˆçš„itemæ•°æ®:', item);
                                return;
                            }
                            
                            // ç¡®ä¿æ•°é‡æ˜¯æ•°å€¼
                            const quantity = parseInt(item.quantity) || 0;
                            if (quantity <= 0) {
                                // å³ä½¿æ•°é‡ä¸º0ï¼Œä¹Ÿè¦ç»§ç»­å¤„ç†ä»¥ç¡®ä¿ä»·æ ¼ä¿¡æ¯è¢«æ­£ç¡®è®¡ç®—
                                console.debug('å‘ç°æ•°é‡ä¸º0æˆ–æ— æ•ˆçš„item:', item);
                            }
                            totalShipments += quantity;
                            
                            // ä¼˜å…ˆä½¿ç”¨itemä¸­å·²å¢å¼ºçš„äº§å“ä¿¡æ¯ï¼ˆåŒ…å«ä¾›åº”å•†ä¿¡æ¯ï¼‰ï¼Œå¦åˆ™æŸ¥æ‰¾äº§å“ä¿¡æ¯
                            let product;
                            if (item.product) {
                                // ä½¿ç”¨å¢å¼ºçš„item.productä¿¡æ¯ï¼Œå…¶ä¸­å·²åŒ…å«ä¾›åº”å•†ä¿¡æ¯
                                product = item.product;
                            } else if (item.productId) {
                                product = products.find(p => p.id === item.productId);
                            } else if (item.product_id) {  // å…¼å®¹ä¸åŒå­—æ®µå
                                product = products.find(p => p.id === item.product_id);
                            }
                            
                            if (product) {
                                // ä¿®æ­£ä»·æ ¼å­—æ®µåç§° - æ ¹æ®æ•°æ®åº“ç»“æ„ï¼Œäº§å“è¡¨ä½¿ç”¨çš„æ˜¯ sale_price å’Œ purchase_price
                                const salePrice = parseFloat(item.salePrice || product.sale_price || product.salePrice) || 0;
                                const purchasePrice = parseFloat(product.purchase_price || product.purchasePrice) || 0;
                                
                                const itemSales = salePrice * quantity;
                                const itemCost = purchasePrice * quantity;
                                const itemProfit = itemSales - itemCost;
                                
                                totalSales += itemSales;
                                totalCost += itemCost;
                                totalProfit += itemProfit;
                                
                                const productId = product.id || item.productId;
                                if (!productStats[productId]) {
                                    productStats[productId] = {
                                        name: item.productName || product.product_name || product.name,
                                        code: product.product_code || product.code,
                                        supplier: product.product_supplier || product.supplier || '',  // ç¡®ä¿ä¾›åº”å•†ä¿¡æ¯ä¸ä¸ºundefined
                                        quantity: 0,
                                        sales: 0,
                                        profit: 0,
                                        profitMargin: product.profitMargin || 0  // ç¡®ä¿åˆ©æ¶¦ç‡ä¸ä¸ºundefined
                                    };
                                }
                                
                                productStats[productId].quantity += quantity;
                                productStats[productId].sales += itemSales;
                                productStats[productId].profit += itemProfit;
                            } else {
                                // å³ä½¿æ‰¾ä¸åˆ°äº§å“ï¼Œå¦‚æœæœ‰item.salePriceï¼Œä¹Ÿå¯ä»¥è®¡ç®—é”€å”®é¢
                                if (item.salePrice) {
                                    const salePrice = parseFloat(item.salePrice) || 0;
                                    const itemSales = salePrice * quantity;
                                    totalSales += itemSales;
                                    
                                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶äº§å“ç»Ÿè®¡é¡¹
                                    const productId = item.productId || `temp_${Date.now()}_${Math.random()}`;
                                    if (!productStats[productId]) {
                                        productStats[productId] = {
                                            name: item.productName || 'æœªçŸ¥äº§å“',
                                            code: item.productCode || '',
                                            supplier: item.productSupplier || '',
                                            quantity: 0,
                                            sales: 0,
                                            profit: 0,
                                            profitMargin: 0
                                        };
                                    }
                                    
                                    productStats[productId].quantity += quantity;
                                    productStats[productId].sales += itemSales;
                                    // ç”±äºæ²¡æœ‰æˆæœ¬ä¿¡æ¯ï¼Œåˆ©æ¶¦æš‚æ—¶è®¾ä¸º0
                                } else {
                                    console.warn('åœ¨å†å²è®°å½•ä¸­æ‰¾ä¸åˆ°å¯¹åº”äº§å“ï¼Œä¹Ÿæ— æ³•ä»itemä¸­è·å–ä»·æ ¼ä¿¡æ¯:', item.productId || item.product_id, 'äº§å“åˆ—è¡¨é•¿åº¦:', products.length);
                                    
                                    // å°è¯•ä½¿ç”¨äº§å“IDç›´æ¥ä»productsæ•°ç»„ä¸­æŸ¥æ‰¾
                                    const productId = item.productId || item.product_id;
                                    if (productId) {
                                        const fallbackProduct = products.find(p => p.id == productId);
                                        if (fallbackProduct) {
                                            // ä½¿ç”¨å¤‡ç”¨äº§å“ä¿¡æ¯è®¡ç®—é”€å”®é¢
                                            const salePrice = parseFloat(fallbackProduct.sale_price || fallbackProduct.salePrice) || 0;
                                            const purchasePrice = parseFloat(fallbackProduct.purchase_price || fallbackProduct.purchasePrice) || 0;
                                            
                                            const itemSales = salePrice * quantity;
                                            const itemCost = purchasePrice * quantity;
                                            const itemProfit = itemSales - itemCost;
                                            
                                            totalSales += itemSales;
                                            totalCost += itemCost;
                                            totalProfit += itemProfit;
                                            
                                            if (!productStats[productId]) {
                                                productStats[productId] = {
                                                    name: fallbackProduct.product_name || fallbackProduct.name,
                                                    code: fallbackProduct.product_code || fallbackProduct.code,
                                                    supplier: fallbackProduct.product_supplier || fallbackProduct.supplier || '',
                                                    quantity: 0,
                                                    sales: 0,
                                                    profit: 0,
                                                    profitMargin: 0
                                                };
                                            }
                                            
                                            productStats[productId].quantity += quantity;
                                            productStats[productId].sales += itemSales;
                                            productStats[productId].profit += itemProfit;
                                        }
                                    }
                                }
                            }
                        });
                    });
                    
                    const salesRanking = Object.values(productStats)
                        .sort((a, b) => (b.quantity || 0) - (a.quantity || 0))
                        .slice(0, 10);
                    
                    const profitRanking = Object.values(productStats)
                        .sort((a, b) => (b.profit || 0) - (a.profit || 0))
                        .slice(0, 10);
                    
                    const monthlySales = await this.getMonthlySalesData();
                    const monthlyShipments = await this.getMonthlyShipmentsData();
                    const monthlyProfit = await this.getMonthlyProfitData();
                    
                    const avgProfitMargin = totalSales > 0 ? ((totalProfit / totalSales) * 100) : 0;
                    
                    return {
                        totalShipments,
                        totalSales,
                        totalCost,
                        totalProfit,
                        avgProfitMargin: avgProfitMargin.toFixed(2),
                        salesRanking,
                        profitRanking,
                        monthlySales,
                        monthlyShipments,
                        monthlyProfit,
                        filteredHistory,
                        allProducts: products
                    };
                } catch (error) {
                    console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                    return {
                        totalShipments: 0,
                        totalSales: 0,
                        totalCost: 0,
                        totalProfit: 0,
                        avgProfitMargin: '0.00',
                        salesRanking: [],
                        profitRanking: [],
                        monthlySales: {},
                        monthlyShipments: {},
                        monthlyProfit: {},
                        filteredHistory: []
                    };
                }
            }
            
            static async getMonthlySalesData() {
                const history = await this.getHistory();
                const products = await this.getAllProducts();
                const now = new Date();
                const monthlyData = {};
                
                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                const currentUser = this.getCurrentUser();
                
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    monthlyData[key] = 0;
                }
                
                history.forEach(task => {
                    const taskDate = new Date(task.completed_at || task.created_at || task.completedAt || task.createdAt);
                    const key = `${taskDate.getFullYear()}-${(taskDate.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    // å¯¹äºéç®¡ç†å‘˜ç”¨æˆ·ï¼Œåªå¤„ç†ä»–ä»¬è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡
                    const taskCreator = task.creator_name || task.creatorName || task.creator;
                    const isCurrentUserTask = currentUser && 
                        (currentUser.role === 'admin' || 
                         taskCreator === currentUser.name || 
                         taskCreator === currentUser.username);
                    
                    if (isCurrentUserTask && monthlyData.hasOwnProperty(key)) {
                        // å¤„ç†ä»»åŠ¡ä¸­çš„itemsæ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨å­—æ®µé”™ä½
                        let processedItems = task.items;
                        
                        // å¦‚æœitemsçœ‹èµ·æ¥åƒæ˜¯é”™ä½çš„ï¼ˆä¾‹å¦‚åŒ…å«äº†ä»»åŠ¡ç¼–å·è€Œä¸æ˜¯äº§å“é¡¹ï¼‰ï¼Œå°è¯•ä¿®å¤
                        if (Array.isArray(processedItems) && processedItems.length > 0 && 
                            typeof processedItems[0] === 'object' && processedItems[0].hasOwnProperty('taskNumber')) {
                            // è¿™ç§æƒ…å†µè¡¨æ˜itemså­—æ®µå¯èƒ½åŒ…å«é”™è¯¯çš„æ•°æ®
                            console.warn('æœˆåº¦é”€å”®æ•°æ®æ£€æµ‹åˆ°å¯èƒ½é”™ä½çš„itemsæ•°æ®:', processedItems);
                            // å°è¯•ä»ä»»åŠ¡çš„å…¶ä»–å­—æ®µæ¢å¤itemsæ•°æ®
                            if (task.correctedItems) {
                                processedItems = task.correctedItems;
                            } else {
                                // å¦‚æœæ— æ³•æ¢å¤ï¼Œåˆ™è·³è¿‡æ­¤ä»»åŠ¡çš„ç»Ÿè®¡
                                console.warn('æœˆåº¦é”€å”®æ•°æ®æ— æ³•æ¢å¤æ­¤ä»»åŠ¡çš„itemsæ•°æ®ï¼Œè·³è¿‡ç»Ÿè®¡:', task.id);
                                return;
                            }
                        }
                        
                        processedItems.forEach(item => {
                            // ç¡®ä¿itemæœ‰æ­£ç¡®çš„ç»“æ„
                            if (!item || typeof item !== 'object' || !item.quantity) {
                                console.warn('æœˆåº¦é”€å”®æ•°æ®å‘ç°æ— æ•ˆçš„itemæ•°æ®:', item);
                                return;
                            }
                            
                            // æŸ¥æ‰¾äº§å“ä¿¡æ¯
                            let product;
                            if (item.productId) {
                                product = products.find(p => p.id === item.productId);
                            } else if (item.product_id) {  // å…¼å®¹ä¸åŒå­—æ®µå
                                product = products.find(p => p.id === item.product_id);
                            }
                            
                            if (product) {
                                // ç¡®ä¿ä»·æ ¼å’Œæ•°é‡æ˜¯æ•°å€¼
                                const quantity = parseInt(item.quantity) || 0;
                                const salePrice = parseFloat(product.sale_price || product.salePrice) || 0;
                                monthlyData[key] += salePrice * quantity;
                            } else {
                                // å¦‚æœåœ¨äº§å“æŸ¥æ‰¾ä¸­å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨itemä¸­çš„productIdç›´æ¥æŸ¥æ‰¾
                                const productId = item.productId || item.product_id;
                                if (productId) {
                                    const fallbackProduct = products.find(p => p.id == productId);
                                    if (fallbackProduct) {
                                        const quantity = parseInt(item.quantity) || 0;
                                        const salePrice = parseFloat(fallbackProduct.sale_price || fallbackProduct.salePrice) || 0;
                                        monthlyData[key] += salePrice * quantity;
                                    }
                                }
                            }
                        });
                    }
                });
                
                return monthlyData;
            }
            
            static async getMonthlyShipmentsData() {
                const history = await this.getHistory();
                const now = new Date();
                const monthlyData = {};
                
                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                const currentUser = this.getCurrentUser();
                
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    monthlyData[key] = 0;
                }
                
                history.forEach(task => {
                    const taskDate = new Date(task.completed_at || task.created_at || task.completedAt || task.createdAt);
                    const key = `${taskDate.getFullYear()}-${(taskDate.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    // å¯¹äºéç®¡ç†å‘˜ç”¨æˆ·ï¼Œåªå¤„ç†ä»–ä»¬è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡
                    const taskCreator = task.creator_name || task.creatorName || task.creator;
                    const isCurrentUserTask = currentUser && 
                        (currentUser.role === 'admin' || 
                         taskCreator === currentUser.name || 
                         taskCreator === currentUser.username);
                    
                    if (isCurrentUserTask && monthlyData.hasOwnProperty(key)) {
                        // å¤„ç†ä»»åŠ¡ä¸­çš„itemsæ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨å­—æ®µé”™ä½
                        let processedItems = task.items;
                        
                        // å¦‚æœitemsçœ‹èµ·æ¥åƒæ˜¯é”™ä½çš„ï¼ˆä¾‹å¦‚åŒ…å«äº†ä»»åŠ¡ç¼–å·è€Œä¸æ˜¯äº§å“é¡¹ï¼‰ï¼Œå°è¯•ä¿®å¤
                        if (Array.isArray(processedItems) && processedItems.length > 0 && 
                            typeof processedItems[0] === 'object' && processedItems[0].hasOwnProperty('taskNumber')) {
                            // è¿™ç§æƒ…å†µè¡¨æ˜itemså­—æ®µå¯èƒ½åŒ…å«é”™è¯¯çš„æ•°æ®
                            console.warn('æœˆåº¦å‘è´§æ•°æ®æ£€æµ‹åˆ°å¯èƒ½é”™ä½çš„itemsæ•°æ®:', processedItems);
                            // å°è¯•ä»ä»»åŠ¡çš„å…¶ä»–å­—æ®µæ¢å¤itemsæ•°æ®
                            if (task.correctedItems) {
                                processedItems = task.correctedItems;
                            } else {
                                // å¦‚æœæ— æ³•æ¢å¤ï¼Œåˆ™è·³è¿‡æ­¤ä»»åŠ¡çš„ç»Ÿè®¡
                                console.warn('æœˆåº¦å‘è´§æ•°æ®æ— æ³•æ¢å¤æ­¤ä»»åŠ¡çš„itemsæ•°æ®ï¼Œè·³è¿‡ç»Ÿè®¡:', task.id);
                                return;
                            }
                        }
                        
                        processedItems.forEach(item => {
                            // ç¡®ä¿itemæœ‰æ­£ç¡®çš„ç»“æ„
                            if (!item || typeof item !== 'object' || !item.quantity) {
                                console.warn('æœˆåº¦å‘è´§æ•°æ®å‘ç°æ— æ•ˆçš„itemæ•°æ®:', item);
                                return;
                            }
                            
                            // ç¡®ä¿æ•°é‡æ˜¯æ•°å€¼
                            const quantity = parseInt(item.quantity) || 0;
                            monthlyData[key] += quantity;
                        });
                    }
                });
                
                return monthlyData;
            }
            
            static async getMonthlyProfitData() {
                const history = await this.getHistory();
                const products = await this.getAllProducts();
                const now = new Date();
                const monthlyData = {};
                
                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                const currentUser = this.getCurrentUser();
                
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    monthlyData[key] = 0;
                }
                
                history.forEach(task => {
                    const taskDate = new Date(task.completed_at || task.created_at || task.completedAt || task.createdAt);
                    const key = `${taskDate.getFullYear()}-${(taskDate.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    // å¯¹äºéç®¡ç†å‘˜ç”¨æˆ·ï¼Œåªå¤„ç†ä»–ä»¬è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡
                    const taskCreator = task.creator_name || task.creatorName || task.creator;
                    const isCurrentUserTask = currentUser && 
                        (currentUser.role === 'admin' || 
                         taskCreator === currentUser.name || 
                         taskCreator === currentUser.username);
                    
                    if (isCurrentUserTask && monthlyData.hasOwnProperty(key)) {
                        // å¤„ç†ä»»åŠ¡ä¸­çš„itemsæ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨å­—æ®µé”™ä½
                        let processedItems = task.items;
                        
                        // å¦‚æœitemsçœ‹èµ·æ¥åƒæ˜¯é”™ä½çš„ï¼ˆä¾‹å¦‚åŒ…å«äº†ä»»åŠ¡ç¼–å·è€Œä¸æ˜¯äº§å“é¡¹ï¼‰ï¼Œå°è¯•ä¿®å¤
                        if (Array.isArray(processedItems) && processedItems.length > 0 && 
                            typeof processedItems[0] === 'object' && processedItems[0].hasOwnProperty('taskNumber')) {
                            // è¿™ç§æƒ…å†µè¡¨æ˜itemså­—æ®µå¯èƒ½åŒ…å«é”™è¯¯çš„æ•°æ®
                            console.warn('æœˆåº¦åˆ©æ¶¦æ•°æ®æ£€æµ‹åˆ°å¯èƒ½é”™ä½çš„itemsæ•°æ®:', processedItems);
                            // å°è¯•ä»ä»»åŠ¡çš„å…¶ä»–å­—æ®µæ¢å¤itemsæ•°æ®
                            if (task.correctedItems) {
                                processedItems = task.correctedItems;
                            } else {
                                // å¦‚æœæ— æ³•æ¢å¤ï¼Œåˆ™è·³è¿‡æ­¤ä»»åŠ¡çš„ç»Ÿè®¡
                                console.warn('æœˆåº¦åˆ©æ¶¦æ•°æ®æ— æ³•æ¢å¤æ­¤ä»»åŠ¡çš„itemsæ•°æ®ï¼Œè·³è¿‡ç»Ÿè®¡:', task.id);
                                return;
                            }
                        }
                        
                        processedItems.forEach(item => {
                            // ç¡®ä¿itemæœ‰æ­£ç¡®çš„ç»“æ„
                            if (!item || typeof item !== 'object' || !item.quantity) {
                                console.warn('æœˆåº¦åˆ©æ¶¦æ•°æ®å‘ç°æ— æ•ˆçš„itemæ•°æ®:', item);
                                return;
                            }
                            
                            // æŸ¥æ‰¾äº§å“ä¿¡æ¯
                            let product;
                            if (item.productId) {
                                product = products.find(p => p.id === item.productId);
                            } else if (item.product_id) {  // å…¼å®¹ä¸åŒå­—æ®µå
                                product = products.find(p => p.id === item.product_id);
                            }
                            
                            if (product) {
                                // ç¡®ä¿ä»·æ ¼å’Œæ•°é‡æ˜¯æ•°å€¼
                                const quantity = parseInt(item.quantity) || 0;
                                const salePrice = parseFloat(product.sale_price || product.salePrice) || 0;
                                const purchasePrice = parseFloat(product.purchase_price || product.purchasePrice) || 0;
                                const profit = (salePrice - purchasePrice) * quantity;
                                monthlyData[key] += profit;
                            } else {
                                // å¦‚æœåœ¨äº§å“æŸ¥æ‰¾ä¸­å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨itemä¸­çš„productIdç›´æ¥æŸ¥æ‰¾
                                const productId = item.productId || item.product_id;
                                if (productId) {
                                    const fallbackProduct = products.find(p => p.id == productId);
                                    if (fallbackProduct) {
                                        const quantity = parseInt(item.quantity) || 0;
                                        const salePrice = parseFloat(fallbackProduct.sale_price || fallbackProduct.salePrice) || 0;
                                        const purchasePrice = parseFloat(fallbackProduct.purchase_price || fallbackProduct.purchasePrice) || 0;
                                        const profit = (salePrice - purchasePrice) * quantity;
                                        monthlyData[key] += profit;
                                    }
                                }
                            }
                        });
                    }
                });
                
                return monthlyData;
            }
            
            static async getAllUsers() {
                try {
                    const headers = {};

                    // ä½¿ç”¨JWTä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯
                    const token = localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN);
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }

                    const response = await fetch(`${this.API_BASE}/api/users/all`, {
                        headers: headers
                    });

                    if (!response.ok) {
                        console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', response.statusText);
                        return [];
                    }

                    const users = await response.json();

                    // å°†æ•°æ®åº“è¿”å›çš„æ•°æ®æ˜ å°„åˆ°å‰ç«¯æœŸæœ›çš„æ ¼å¼
                    return users.map(user => ({
                        id: user.id,
                        email: user.email,
                        name: user.name,
                        role: user.role,
                        companyName: user.company_name || user.companyName || '',
                        isActive: user.is_active || user.isActive,
                        createdAt: user.created_at || user.createdAt,
                        updatedAt: user.updated_at || user.updatedAt
                    }));
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                    Utils.showAlert('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    return [];
                }
            }
            
            static async getCreatorStatistics(filter = 'day') {
                try {
                    const history = await this.getHistory();
                    const products = await this.getAllProducts();
                    const { startDate, endDate } = Utils.getDateRange(filter);
                    
                    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                    const currentUser = this.getCurrentUser();
                    
                    // ä¿®æ”¹è¿‡æ»¤é€»è¾‘ï¼šå…è®¸é”€å”®è¿è¥è§’è‰²æŸ¥çœ‹æ‰€æœ‰æ•°æ®
                    const filteredHistory = history.filter(task => {
                        // ç¡®ä¿taskå¯¹è±¡å­˜åœ¨
                        if (!task) return false;
                        const taskDate = new Date(task.completed_at || task.created_at || task.completedAt || task.createdAt);
                        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                        if (isNaN(taskDate.getTime())) return false;
                        
                        // å¯¹äºç®¡ç†å‘˜å’Œé”€å”®è¿è¥ç”¨æˆ·ï¼Œæ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡
                        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'sales')) {
                            return taskDate >= startDate && taskDate < endDate;
                        } else {
                            // å¯¹äºå…¶ä»–è§’è‰²ï¼Œåªæ˜¾ç¤ºä»–ä»¬è‡ªå·±åˆ›å»ºçš„ä»»åŠ¡
                            const taskCreator = task.creator_name || task.creatorName || task.creator;
                            return taskDate >= startDate && taskDate < endDate && 
                                   (taskCreator === currentUser.name || taskCreator === currentUser.username);
                        }
                    });
                    
                    const creatorStats = {};
                    
                    filteredHistory.forEach(task => {
                        // ç¡®ä¿taskå¯¹è±¡å­˜åœ¨
                        if (!task) return;
                        
                        const creatorName = task.creator_name || task.creatorName || task.creator || 'Unknown';
                        
                        if (!creatorStats[creatorName]) {
                            creatorStats[creatorName] = {
                                name: creatorName,
                                totalShipments: 0,
                                totalSales: 0,
                                totalProfit: 0,
                                totalTasks: 0,
                                tasks: [],
                                productCount: 0,
                                topProducts: []
                            };
                        }
                        
                        creatorStats[creatorName].totalTasks++;
                        creatorStats[creatorName].tasks.push(task);
                        
                        // ç¡®ä¿itemså­˜åœ¨ä¸”ä¸ºæ•°ç»„
                        if (task.items && Array.isArray(task.items)) {
                            task.items.forEach(item => {
                                // ç¡®ä¿itemå’Œquantityå­˜åœ¨
                                if (item && item.quantity) {
                                    creatorStats[creatorName].totalShipments += item.quantity;
                                    
                                    // ç¡®ä¿productIdå­˜åœ¨
                                    if (item.productId) {
                                        const product = products.find(p => p.id === item.productId);
                                        if (product) {
                                            const itemSales = (product.sale_price || product.salePrice || 0) * (item.quantity || 0);
                                            const itemCost = (product.purchase_price || product.purchasePrice || 0) * (item.quantity || 0);
                                            const itemProfit = itemSales - itemCost;
                                            
                                            creatorStats[creatorName].totalSales += itemSales;
                                            creatorStats[creatorName].totalProfit += itemProfit;
                                        }
                                    }
                                }
                            });
                        }
                    });
                    
                    // è®¡ç®—æ¯ä¸ªé”€å”®å‘˜çš„å•†å“ç§ç±»æ•°å’Œç•…é”€å•†å“æ’è¡Œ
                    Object.keys(creatorStats).forEach(creatorName => {
                        const stats = creatorStats[creatorName];
                        
                        // è®¡ç®—å•†å“ç§ç±»æ•°
                        const productIds = new Set();
                        if (stats.tasks && Array.isArray(stats.tasks)) {
                            stats.tasks.forEach(task => {
                                if (task.items && Array.isArray(task.items)) {
                                    task.items.forEach(item => {
                                        if (item && item.productId) {
                                            productIds.add(item.productId);
                                        }
                                    });
                                }
                            });
                        }
                        stats.productCount = productIds.size;
                        
                        // è®¡ç®—ç•…é”€å•†å“æ’è¡Œ
                        const productSales = {};
                        if (stats.tasks && Array.isArray(stats.tasks)) {
                            stats.tasks.forEach(task => {
                                if (task.items && Array.isArray(task.items)) {
                                    task.items.forEach(item => {
                                        if (item && item.productId) {
                                            const product = products.find(p => p.id === item.productId);
                                            if (product) {
                                                if (!productSales[product.id]) {
                                                    productSales[product.id] = {
                                                        id: product.id,
                                                        name: product.name,
                                                        code: product.code,
                                                        quantity: 0
                                                    };
                                                }
                                                productSales[product.id].quantity += item.quantity || 0;
                                            }
                                        }
                                    });
                                }
                            });
                        }
                        
                        // æŒ‰é”€é‡æ’åºå¹¶è·å–å‰5å
                        stats.topProducts = Object.values(productSales)
                            .sort((a, b) => (b.quantity || 0) - (a.quantity || 0))
                            .slice(0, 5);
                    });

                    // å¯¹äºç®¡ç†å‘˜å’Œé”€å”®è¿è¥ç”¨æˆ·ï¼Œè¿”å›æ‰€æœ‰ç»Ÿè®¡æ•°æ®
                    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'sales')) {
                        // è¿”å›æŒ‰é”€å”®é¢æ’åºçš„åˆ›ä½œè€…ç»Ÿè®¡ä¿¡æ¯
                        return Object.values(creatorStats).sort((a, b) => (b.totalSales || 0) - (a.totalSales || 0));
                    } else {
                        // å¯¹äºå…¶ä»–è§’è‰²ï¼Œåªè¿”å›è‡ªå·±çš„ç»Ÿè®¡æ•°æ®
                        const userStats = creatorStats[currentUser.name] || creatorStats[currentUser.username] || null;
                        return userStats ? [userStats] : [];
                    }
                } catch (error) {
                    console.error('è·å–åˆ›å»ºè€…ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                    return [];
                }
            }
            
            // æ¸…é™¤ç¼“å­˜çš„æ–¹æ³•
            static clearCache() {
                this.cachedHistory = null;
                this.cachedProducts = null;
                this.cachedUsers = null;
            }
            
            // åœ¨æ•°æ®æ›´æ–°æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜
            static clearHistoryCache() {
                this.cachedHistory = null;
            }
            
            static clearProductsCache() {
                this.cachedProducts = null;
            }
            
            static clearUsersCache() {
                this.cachedUsers = null;
            }
        }
        
        // ============================================
        // äº§å“é€‰æ‹©åŠŸèƒ½
        // ============================================
        function toggleProductSelection(productId, productElement) {
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
                if (productElement) {
                    productElement.classList.remove('selected');
                }
            } else {
                selectedProducts.add(productId);
                if (productElement) {
                    productElement.classList.add('selected');
                }
            }
            
            // æ›´æ–°é€‰ä¸­äº§å“çš„æ ‡ç­¾æ˜¾ç¤º
            updateSelectedTags();
        }
        
        // ============================================
        // å…¨å±€å˜é‡
        // ============================================
        let taskCart = [];
        let selectedProducts = new Set();
        let expandedTaskId = null;
        let currentProductView = 'list';
        window.currentStatisticsFilter = 'week';
        let salesChart = null;
        let shipmentChart = null;
        let profitChart = null;
        
        // äº§å“æ·»åŠ ç«¯ä¸Šä¼ ç›¸å…³å˜é‡
        let productImagePreview = null;
        
        // é”€å”®è¿è¥æ¨¡å—ä»»åŠ¡æ–‡ä»¶ä¸Šä¼ å˜é‡
        let taskBodyCodePreview = null;
        let taskBodyCodeFileName = null;
        let taskBodyCodeType = null;
        let taskWarningCodePreview = null;
        let taskWarningCodeFileName = null;
        let taskWarningCodeType = null;
        let taskLabelPreview = null;
        let taskLabelFileName = null;
        let taskLabelType = null;

        // ç”¨æˆ·ä¿¡æ¯
        const users = {
            admin: {
                name: 'ç®¡ç†å‘˜',
                role: 'admin',
                modules: ['dashboard', 'product-add', 'sales-operations', 'warehouse-operations', 'statistics-dashboard']
            },
            sales: {
                name: 'é”€å”®è¿è¥',
                role: 'sales',
                modules: ['dashboard', 'product-add', 'sales-operations']
            },
            warehouse: {
                name: 'ä»“åº“ç®¡ç†',
                role: 'warehouse',
                modules: ['dashboard', 'warehouse-operations']
            }
        };

        // æ¨¡å—ä¿¡æ¯
        const modules = {
            'dashboard': { name: 'æ€»è§ˆ', icon: 'fas fa-home' },
            'product-add': { name: 'äº§å“ç®¡ç†', icon: 'fas fa-box-open' },
            'sales-operations': { name: 'é”€å”®è¿è¥', icon: 'fas fa-shopping-cart' },
            'warehouse-operations': { name: 'ä»“åº“å‘è´§', icon: 'fas fa-truck' },
            'statistics-dashboard': { name: 'ç»Ÿè®¡åˆ†æ', icon: 'fas fa-chart-pie' },
            'user-management': { name: 'è´¦æˆ·ç®¡ç†', icon: 'fas fa-users' }
        };

        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                initLogin();
                initRegister();
                await checkLoginStatus();
            } catch (error) {
                console.error('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                // ç¡®ä¿é”™è¯¯å¤„ç†ä¸ä¼šå¯¼è‡´æ¶ˆæ¯é€šé“é—®é¢˜
                DataManager.logout();
            }
        });

        // ============================================
        // ç™»å½•åŠŸèƒ½
        // ============================================
        function initLogin() {
            const loginForm = document.getElementById('loginForm');
            const userBadges = document.querySelectorAll('.user-badge');
            
            // ç™»å½•è¡¨å•æäº¤
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                // ä½¿ç”¨æ–°çš„JWTè®¤è¯ç³»ç»Ÿ
                authenticateUser(email, password);
            });
            
            // ç”¨æˆ·å¿«æ·é€‰æ‹©
            userBadges.forEach(badge => {
                badge.addEventListener('click', function() {
                    const email = this.getAttribute('data-user');
                    document.getElementById('username').value = email;
                    document.getElementById('password').value = '123456';
                });
            });
        }
        
        async function checkLoginStatus() {
            const savedUser = DataManager.getCurrentUser();
            if (savedUser) {
                // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                try {
                    const response = await fetch(`${DataManager.API_BASE}/api/auth/me`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN)}`
                        }
                    });
                    
                    // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºJSONæ ¼å¼
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.error('æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯ï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨');
                        DataManager.logout();
                        return;
                    }
                    
                    const userData = await response.json();
                    
                    if (response.ok) {
                        // ä»¤ç‰Œæœ‰æ•ˆï¼Œç›´æ¥è¿›å…¥ä¸»ç³»ç»Ÿ
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('mainSystem').style.display = 'block';
                        initMainSystem();
                    } else {
                        // ä»¤ç‰Œæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
                        console.error('ä»¤ç‰ŒéªŒè¯å¤±è´¥:', userData.error || 'æœªçŸ¥é”™è¯¯');
                        DataManager.logout();
                    }
                } catch (error) {
                    console.error('éªŒè¯ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                    DataManager.logout();
                }
            }
            
            // ç¡®ä¿å‡½æ•°æ€»æ˜¯è¿”å›ä¸€ä¸ªresolvedçš„Promise
            return Promise.resolve();
        }

        async function authenticateUser(email, password) {
            try {
                console.log('å°è¯•ç™»å½•:', email);
                console.log('APIåŸºç¡€åœ°å€:', DataManager.API_BASE);
                console.log('å®Œæ•´è¯·æ±‚URL:', `${DataManager.API_BASE}/api/auth/login`);
                
                const response = await fetch(`${DataManager.API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                console.log('å“åº”çŠ¶æ€:', response.status);
                console.log('å“åº”å¤´:', [...response.headers.entries()]);
                
                // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºJSONæ ¼å¼
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯');
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'ç™»å½•å¤±è´¥');
                }
                
                // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯å’ŒJWTä»¤ç‰Œ
                DataManager.setCurrentUser(data.user, data.token);
                
                // åˆ‡æ¢åˆ°ä¸»ç³»ç»Ÿ
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                
                // åˆå§‹åŒ–ä¸»ç³»ç»Ÿ
                initMainSystem();
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                Utils.showAlert(error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // æ³¨å†ŒåŠŸèƒ½åˆå§‹åŒ–
        function initRegister() {
            const showRegisterLink = document.getElementById('showRegisterLink');
            const registerForm = document.getElementById('registerForm');
            const registerFormContainer = document.getElementById('registerFormContainer');
            
            // æ˜¾ç¤º/éšè—æ³¨å†Œè¡¨å•
            showRegisterLink.addEventListener('click', function(e) {
                e.preventDefault();
                
                // æ˜¾ç¤º/éšè—æ³¨å†Œè¡¨å•çš„åˆ‡æ¢
                registerFormContainer.classList.toggle('show');
                
                // æ›´æ–°é“¾æ¥æ–‡æœ¬
                if (registerFormContainer.classList.contains('show')) {
                    showRegisterLink.textContent = 'å–æ¶ˆæ³¨å†Œ';
                } else {
                    showRegisterLink.textContent = 'è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿç«‹å³æ³¨å†Œ';
                }
            });
            
            // æ³¨å†Œè¡¨å•æäº¤
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('registerName').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                const role = document.getElementById('registerRole').value;
                
                try {
                    const response = await fetch(`${DataManager.API_BASE}/api/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name, email, password, role })
                    });
                    
                    // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºJSONæ ¼å¼
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯');
                    }
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'æ³¨å†Œå¤±è´¥');
                    }
                    
                    Utils.showAlert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ä½¿ç”¨é‚®ç®±å’Œå¯†ç ç™»å½•', 'success');
                    
                    // éšè—æ³¨å†Œè¡¨å•å¹¶é‡ç½®é“¾æ¥æ–‡æœ¬
                    registerFormContainer.classList.remove('show');
                    showRegisterLink.textContent = 'è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿç«‹å³æ³¨å†Œ';
                    
                    // æ¸…ç©ºè¡¨å•
                    registerForm.reset();
                    
                } catch (error) {
                    console.error('æ³¨å†Œé”™è¯¯:', error);
                    Utils.showAlert(error.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            });
        }
        
        function loginUser(username) {
            const user = {
                username: username,
                name: users[username].name,
                role: users[username].role,
                loginTime: new Date().toISOString()
            };
            
            DataManager.setCurrentUser(user);
            
            // åˆ‡æ¢åˆ°ä¸»ç³»ç»Ÿ
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            
            // åˆå§‹åŒ–ä¸»ç³»ç»Ÿ
            initMainSystem();
        }

        // ============================================
        // ä¸»ç³»ç»Ÿ
        // ============================================
        function initMainSystem() {
            // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('error', function(event) {
                console.error('å…¨å±€é”™è¯¯æ•è·:', event.error);
                if (event.error.message && event.error.message.includes('fetch')) {
                    Utils.showAlert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
                } else {
                    Utils.showAlert('å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
                }
            });
            
            window.addEventListener('unhandledrejection', function(event) {
                const reason = event.reason || '';
                const reasonStr = reason.toString ? reason.toString() : String(reason);
                
                // æ›´å…¨é¢çš„Chromeæ‰©å±•é”™è¯¯åŒ¹é…
                const extensionErrorPatterns = [
                    'runtime.lastError',
                    'message port closed',
                    'Unchecked runtime.lastError',
                    'extensions',
                    'chrome-extension',
                    'A listener indicated an asynchronous response',
                    'channel closed before a response'
                ];
                
                const isExtensionError = extensionErrorPatterns.some(pattern => 
                    reasonStr.includes(pattern)
                );
                
                // å±è”½Chromeæ‰©å±•ç›¸å…³çš„é”™è¯¯
                if (isExtensionError) {
                    console.debug('ğŸ”‡ å·²å±è”½Chromeæ‰©å±•Promiseé”™è¯¯:', reasonStr);
                    event.preventDefault();
                    return false;
                }
                
                console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
                Utils.showAlert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                event.preventDefault();
            });
            const user = DataManager.getCurrentUser();
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ•ˆ
            if (!user) {
                console.error('æ— æ•ˆçš„ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                DataManager.logout();
                return;
            }
            
            // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
            try {
                const currentUserEl = document.getElementById('currentUser');
                if (currentUserEl) {
                    currentUserEl.textContent = user.name;
                }
            } catch (error) {
                console.error('è®¾ç½®å½“å‰ç”¨æˆ·åå¤±è´¥:', error);
            }
            
            try {
                const currentRoleEl = document.getElementById('currentRole');
                if (currentRoleEl) {
                    currentRoleEl.textContent = user.role;
                }
            } catch (error) {
                console.error('è®¾ç½®å½“å‰ç”¨æˆ·è§’è‰²å¤±è´¥:', error);
            }
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²é¢„è®¾ç»Ÿè®¡åˆ†ææ¨¡å—çš„å¯è§æ€§ï¼ˆä»…è®¾ç½®å†…å®¹å¯è§æ€§ï¼Œä¸ç›´æ¥æ˜¾ç¤ºæ¨¡å—ï¼‰
            try {
                const statisticsAnalysisModule = document.getElementById('statistics-analysis');
                if (statisticsAnalysisModule) {
                    // ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°å®Œæ•´ç»Ÿè®¡åˆ†æé¡µé¢
                    if (user.role === 'admin') {
                        
                        // ç¡®ä¿ç®¡ç†å‘˜èƒ½çœ‹åˆ°æ‰€æœ‰ç»Ÿè®¡éƒ¨åˆ†
                        const advancedStatsElements = statisticsAnalysisModule.querySelectorAll(
                            '#salesRanking, #profitRanking, .time-filter'
                        );
                        advancedStatsElements.forEach(el => {
                            if (el) el.style.display = 'block';
                        });
                    } else {
                        // éç®¡ç†å‘˜ç”¨æˆ·ï¼ˆå¦‚é”€å”®è¿è¥ï¼‰åªèƒ½çœ‹åˆ°è‡ªå·±çš„ç»Ÿè®¡ä¿¡æ¯
                                        
                        // éšè—é«˜çº§ç»Ÿè®¡éƒ¨åˆ†ï¼Œä½†ä¿ç•™æ—¶é—´ç­›é€‰å™¨
                        const advancedStatsElements = statisticsAnalysisModule.querySelectorAll(
                            '#salesRanking, #profitRanking'
                        );
                        advancedStatsElements.forEach(el => {
                            if (el) el.style.display = 'none';
                        });
                                        
                        // ç¡®ä¿æ—¶é—´ç­›é€‰å™¨å¯¹æ‰€æœ‰ç”¨æˆ·éƒ½å¯è§
                        const timeFilterElements = statisticsAnalysisModule.querySelectorAll('.time-filter');
                        timeFilterElements.forEach(el => {
                            if (el) el.style.display = 'flex';
                        });
                        
                        // ç¡®ä¿é”€å”®è¿è¥ç»Ÿè®¡ç½‘æ ¼æ˜¯å¯è§çš„
                        try {
                            const salespersonStatsGrid = document.getElementById('salesperson-stats-grid');
                            if (salespersonStatsGrid) {
                                salespersonStatsGrid.style.display = 'grid';
                            }
                        } catch (error) {
                            console.error('è®¾ç½®é”€å”®å‘˜ç»Ÿè®¡ç½‘æ ¼æ˜¾ç¤ºå¤±è´¥:', error);
                        }
                    }
                }
            } catch (error) {
                console.error('è®¾ç½®ç»Ÿè®¡åˆ†ææ¨¡å—å¯è§æ€§å¤±è´¥:', error);
            }
            
            // ç”Ÿæˆä¾§è¾¹æ èœå•
            try {
                generateSidebarMenu();
            } catch (error) {
                console.error('ç”Ÿæˆä¾§è¾¹æ èœå•å¤±è´¥:', error);
            }
            
            // ç»‘å®šèœå•åˆ‡æ¢äº‹ä»¶
            try {
                bindMenuEvents();
            } catch (error) {
                console.error('ç»‘å®šèœå•äº‹ä»¶å¤±è´¥:', error);
            }
            
            // ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶
            document.getElementById('logoutBtn').addEventListener('click', function() {
                DataManager.logout();
            });
            
            // åˆå§‹åŒ–å„æ¨¡å—
            try {
                initDashboard();
            } catch (error) {
                console.error('åˆå§‹åŒ–ä»ªè¡¨æ¿å¤±è´¥:', error);
            }
            
            // é»˜è®¤æ˜¾ç¤ºæ€»è§ˆé¡µé¢
            try {
                switchModule('dashboard');
            } catch (error) {
                console.error('åˆ‡æ¢åˆ°ä»ªè¡¨æ¿æ¨¡å—å¤±è´¥:', error);
            }
            
            // å“åº”å¼èœå•åˆ‡æ¢ - æ”¯æŒç§»åŠ¨ç«¯æ»‘å‡ºå’Œæ¡Œé¢ç«¯æŠ˜å 
            document.getElementById('menuToggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const header = document.querySelector('.header');
                const mainContent = document.querySelector('.main-content');
                
                // æ£€æŸ¥å½“å‰å±å¹•å°ºå¯¸
                if (window.innerWidth <= 992) {
                    // ç§»åŠ¨ç«¯ï¼šä½¿ç”¨æ»‘å‡ºæ•ˆæœ
                    sidebar.classList.toggle('active');
                } else {
                    // æ¡Œé¢ç«¯ï¼šä½¿ç”¨æŠ˜å æ•ˆæœ
                    sidebar.classList.toggle('collapsed');
                    
                    // æ›´æ–°å¤´éƒ¨å’Œä¸»å†…å®¹åŒºçš„æ ·å¼
                    if (sidebar.classList.contains('collapsed')) {
                        header.classList.remove('expanded');
                        header.classList.add('collapsed');
                        mainContent.classList.remove('expanded');
                        mainContent.classList.add('collapsed');
                    } else {
                        header.classList.remove('collapsed');
                        header.classList.add('expanded');
                        mainContent.classList.remove('collapsed');
                        mainContent.classList.add('expanded');
                    }
                }
            });
            
            // æ·»åŠ ä¸€äº›åˆå§‹æ•°æ®ï¼ˆå¦‚æœä»æœªåˆå§‹åŒ–è¿‡ï¼‰
            (async () => {
                try {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è¿è¡Œç³»ç»Ÿ
                    const hasProductsInitialized = localStorage.getItem('products_initialized');
                    if (!hasProductsInitialized) {
                        const products = await DataManager.getAllProducts();
                        if (products.length === 0) {
                            initializeSampleData();
                            // æ ‡è®°äº§å“æ•°æ®å·²åˆå§‹åŒ–
                            localStorage.setItem('products_initialized', 'true');
                        }
                    }
                } catch (error) {
                    console.error('åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®å¤±è´¥:', error);
                }
            })();
        }

        function generateSidebarMenu() {
            const menuList = document.getElementById('menuList');
            menuList.innerHTML = '';
            
            const user = DataManager.getCurrentUser();
            if (!user) return;
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²ç¡®å®šå¯è®¿é—®çš„æ¨¡å—
            let userModules;
            switch(user.role) {
                case 'admin':
                    userModules = ['dashboard', 'product-add', 'sales-operations', 'warehouse-operations', 'statistics-dashboard', 'user-management'];
                    break;
                case 'sales':
                    userModules = ['dashboard', 'product-add', 'sales-operations', 'statistics-dashboard'];
                    break;
                case 'warehouse':
                    userModules = ['dashboard', 'warehouse-operations'];
                    break;
                default:
                    userModules = ['dashboard'];
            }
            
            userModules.forEach(moduleId => {
                const module = modules[moduleId];
                // ä¸ºä¸åŒçš„æ¨¡å—å®šä¹‰ç›¸åº”çš„å›¾æ ‡
                let icon = 'fa-table'; // é»˜è®¤å›¾æ ‡
                if (moduleId === 'dashboard') icon = 'fa-chart-line';
                if (moduleId === 'product-add') icon = 'fa-box-open';
                if (moduleId === 'sales-operations') icon = 'fa-cart-plus';
                if (moduleId === 'warehouse-operations') icon = 'fa-warehouse';
                if (moduleId === 'statistics-dashboard') icon = 'fa-chart-pie';
                if (moduleId === 'user-management') icon = 'fa-users';
                
                // ç¡®ä¿æ¨¡å—å­˜åœ¨
                if (!module) {
                    console.error(`æ¨¡å— ${moduleId} æœªå®šä¹‰`);
                    return;
                }
                
                const menuItem = document.createElement('li');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `
                    <a href="#" class="menu-link" data-module="${moduleId}" data-icon="${icon}">
                        <span>${module.name}</span>
                    </a>
                `;
                menuList.appendChild(menuItem);
            });
        }

        function bindMenuEvents() {
            const menuLinks = document.querySelectorAll('.menu-link');
            
            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // æ›´æ–°æ´»åŠ¨èœå•
                    menuLinks.forEach(item => item.classList.remove('active'));
                    this.classList.add('active');
                    
                    // åˆ‡æ¢æ¨¡å—
                    const moduleId = this.getAttribute('data-module');
                    switchModule(moduleId);
                    
                    // æ›´æ–°å½“å‰æ¨¡å—æ ‡é¢˜
                    document.getElementById('currentModule').textContent = modules[moduleId].name;
                    
                    // åœ¨ç§»åŠ¨ç«¯ç‚¹å‡»èœå•åå…³é—­ä¾§è¾¹æ 
                    if (window.innerWidth <= 992) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                });
            });
            
            // åˆå§‹åŒ–æ—¶ç¡®ä¿æ¡Œé¢ç«¯é»˜è®¤å±•å¼€
            if (window.innerWidth > 992) {
                const sidebar = document.getElementById('sidebar');
                const header = document.querySelector('.header');
                const mainContent = document.querySelector('.main-content');
                
                // ç¡®ä¿æ¡Œé¢ç«¯ä¾§è¾¹æ å±•å¼€çŠ¶æ€
                sidebar.classList.remove('collapsed');
                header.classList.remove('collapsed');
                header.classList.add('expanded');
                mainContent.classList.remove('collapsed');
                mainContent.classList.add('expanded');
            }
        }

        async function switchModule(moduleId) {
            // éšè—æ‰€æœ‰æ¨¡å—
            const moduleContents = document.querySelectorAll('.module-content');
            moduleContents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // æ¸…ç†å¯èƒ½å½±å“å½“å‰æ¨¡å—çš„å…¨å±€çŠ¶æ€
            cleanupModuleStates(moduleId);
            
            // æ˜¾ç¤ºç›®æ ‡æ¨¡å—
            const targetModule = document.getElementById(moduleId);
            if (targetModule) {
                targetModule.style.display = 'block';
                targetModule.classList.add('active');
            }
            
            // æ ¹æ®æ¨¡å—åˆå§‹åŒ–
            switch(moduleId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'product-add':
                    initProductAddModule();
                    break;
                case 'sales-operations':
                    await initSalesOperations();
                    break;
                case 'warehouse-operations':
                    // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨æ ‡è®°ï¼Œç¡®ä¿äº‹ä»¶èƒ½é‡æ–°ç»‘å®š
                    const warehouseContainer = document.getElementById('warehouseTasks');
                    if (warehouseContainer) {
                        warehouseContainer.removeAttribute('data-has-listener');
                    }
                    loadWarehouseTasksList();
                    break;
                case 'statistics-dashboard':
                    // ç¡®ä¿ç»Ÿè®¡åˆ†ææ¨¡å—åŠ è½½æ—¶æœ‰æ­£ç¡®çš„æ—¶é—´ç­›é€‰å™¨çŠ¶æ€
                    if (!currentStatisticsFilter) {
                        currentStatisticsFilter = 'day';
                    }
                    // ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®åŠ è½½å‡½æ•°ï¼Œé¿å…é‡å¤æ›´æ–°
                    loadStatisticsDashboardData();
                    break;
                case 'user-management':
                    loadUserManagementData();
                    break;
                default:
                    // ç¡®ä¿å…¶ä»–æƒ…å†µä¸‹ä¸ä¼šæ„å¤–æ˜¾ç¤ºç”¨æˆ·ç®¡ç†æ¨¡å—
                    const userManagementModule = document.getElementById('user-management');
                    if (userManagementModule) {
                        userManagementModule.classList.remove('active');
                        userManagementModule.style.display = 'none';
                    }
            }
        }
        
        // æ¸…ç†æ¨¡å—é—´å¯èƒ½çš„å¹²æ‰°çŠ¶æ€
        function cleanupModuleStates(currentModuleId) {
            // é¦–å…ˆå…³é—­ä»»ä½•æ‰“å¼€çš„æ¨¡æ€æ¡†
            closeOpenModals();
            
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„å…¨å±€è¿‡æ»¤å™¨çŠ¶æ€
            if (currentModuleId !== 'statistics-dashboard') {
                // å¦‚æœä¸æ˜¯ç»Ÿè®¡åˆ†ææ¨¡å—ï¼Œåˆ™æ¸…é™¤ç»Ÿè®¡ç›¸å…³çš„å…¨å±€çŠ¶æ€
                // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦é‡ç½®currentStatisticsFilterå˜é‡ï¼Œå› ä¸ºå®ƒæ˜¯å±€éƒ¨å˜é‡
                // åªéœ€ç¡®ä¿ä¸‹æ¬¡è¿›å…¥ç»Ÿè®¡åˆ†ææ¨¡å—æ—¶ä¼šé‡æ–°åˆå§‹åŒ–
                
                // éšè—æ•´ä¸ªç»Ÿè®¡åˆ†ææ¨¡å—
                const statisticsDashboardModule = document.getElementById('statistics-dashboard');
                if (statisticsDashboardModule) {
                    statisticsDashboardModule.classList.remove('active');
                    statisticsDashboardModule.style.display = 'none';
                }
                
                // ç¡®ä¿å…¶ä»–ç»Ÿè®¡ç›¸å…³å…ƒç´ ä¹Ÿè¢«éšè—
                const allStatsElements = document.querySelectorAll('#statistics-dashboard [style*="display: block"]');  // é€‰æ‹©æ‰€æœ‰æ˜¾ç¤ºçŠ¶æ€çš„å†…éƒ¨å…ƒç´ 
                allStatsElements.forEach(el => {
                    if (el !== statisticsDashboardModule) {  // é¿å…é‡å¤è®¾ç½®çˆ¶å®¹å™¨
                        el.style.display = 'none';
                    }
                });
                
                // éšè—ç»Ÿè®¡åˆ†æç›¸å…³çš„ç‰¹å®šå…ƒç´ 
                const statsElements = document.querySelectorAll('#statistics-dashboard .stats-grid, #statistics-dashboard .stats-card, #statistics-dashboard .time-filter');
                statsElements.forEach(el => {
                    if (el.style) {
                        el.style.display = 'none';
                    }
                });
            } else {
                // å¦‚æœæ˜¯ç»Ÿè®¡åˆ†ææ¨¡å—ï¼Œç¡®ä¿ç»Ÿè®¡å…ƒç´ å¯è§
                const statisticsDashboardModule = document.getElementById('statistics-dashboard');
                if (statisticsDashboardModule) {
                    statisticsDashboardModule.style.display = 'block';
                    // åœ¨æ˜¾ç¤ºç»Ÿè®¡åˆ†ææ—¶åŠ è½½æ•°æ®
                    loadStatisticsDashboardData();
                }
                
                const statsElements = document.querySelectorAll('#statistics-dashboard .stats-grid, #statistics-dashboard .stats-card, #statistics-dashboard .time-filter');
                statsElements.forEach(el => {
                    if (el.style) {
                        el.style.display = '';
                    }
                });
            }
            
            // ç¡®ä¿è´¦æˆ·ç®¡ç†æ¨¡å—åœ¨éæ¿€æ´»çŠ¶æ€ä¸‹è¢«éšè—
            if (currentModuleId !== 'user-management') {
                const userManagementModule = document.getElementById('user-management');
                if (userManagementModule) {
                    userManagementModule.classList.remove('active');
                    userManagementModule.style.display = 'none';
                }
            } else {
                // å¦‚æœæ˜¯è´¦æˆ·ç®¡ç†æ¨¡å—ï¼Œç¡®ä¿å…¶å†…å®¹æ­£ç¡®æ˜¾ç¤º
                const userManagementModule = document.getElementById('user-management');
                if (userManagementModule) {
                    userManagementModule.style.display = 'block';
                }
            }
        }
        
        // å…³é—­ä»»ä½•æ‰“å¼€çš„æ¨¡æ€æ¡†
        function closeOpenModals() {
            // æ£€æŸ¥æ˜¯å¦æœ‰Bootstrapæ¨¡æ€æ¡†å®ä¾‹æ‰“å¼€ï¼Œå¹¶å…³é—­å®ƒä»¬
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(modal => {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            });
        }

        // ============================================
        // æ€»è§ˆæ¨¡å—
        // ============================================
        function initDashboard() {
            updateDashboard();
        }

        async function updateDashboard() {
            try {
                const products = await DataManager.getAllProducts();
                const tasks = await DataManager.getAllTasks();
                const history = await DataManager.getHistory();
                const activities = await DataManager.getActivities();
                
                document.getElementById('totalProducts').textContent = products.length;
                
                document.getElementById('pendingTasks').textContent = tasks.filter(t => t.status === 'pending').length;
                
                const completedCount = history.length;
                document.getElementById('completedTasks').textContent = completedCount;
                
                const today = new Date().toDateString();
                const todayTasks = tasks.filter(t => {
                    const taskDate = new Date(t.createdAt).toDateString();
                    return taskDate === today;
                }).length;
                document.getElementById('todayTasks').textContent = todayTasks;
                
                // è®¡ç®—å‘è´§æ•°é‡ç»Ÿè®¡
                let shippingCount = 0;
                // ç»Ÿè®¡æ‰€æœ‰ä»»åŠ¡ä¸­çš„å‘è´§æ•°é‡
                [...tasks, ...history].forEach(task => {
                    if (task.items && Array.isArray(task.items)) {
                        task.items.forEach(item => {
                            if (item.quantity) {
                                shippingCount += parseInt(item.quantity) || 0;
                            }
                        });
                    }
                });
                document.getElementById('shippingTaskCount').textContent = shippingCount;
                
                updateRecentActivities(activities);
                await updateWarehouseStats();
            } catch (error) {
                console.error('æ›´æ–°æ€»è§ˆæ•°æ®å¤±è´¥:', error);
                Utils.showAlert('æ›´æ–°æ€»è§ˆæ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function updateWarehouseStats() {
            try {
                const tasks = await DataManager.getAllTasks();
                const history = await DataManager.getHistory();
                
                // åªæœ‰åœ¨å…ƒç´ å­˜åœ¨çš„æƒ…å†µä¸‹æ‰æ›´æ–°å†…å®¹
                const pendingTasksEl = document.getElementById('warehousePendingTasks');
                if (pendingTasksEl) {
                    pendingTasksEl.textContent = tasks.filter(t => t.status === 'pending').length;
                }
                
                const today = new Date().toDateString();
                const todayTasks = tasks.filter(t => {
                    const taskDate = new Date(t.createdAt).toDateString();
                    return taskDate === today;
                }).length;
                
                const todayTasksEl = document.getElementById('warehouseTodayTasks');
                if (todayTasksEl) {
                    todayTasksEl.textContent = todayTasks;
                }
                
                const completedTasksEl = document.getElementById('warehouseCompletedTasks');
                if (completedTasksEl) {
                    completedTasksEl.textContent = history.length;
                }
            } catch (error) {
                console.error('æ›´æ–°ä»“åº“ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                // ä¸æ˜¾ç¤ºé”™è¯¯è­¦å‘Šï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
            }
        }

        function updateRecentActivities(activities) {
            const tbody = document.getElementById('recentActivities');
            
            if (!activities || activities.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-3">æš‚æ— æ´»åŠ¨è®°å½•</td>
                    </tr>
                `;
                return;
            }
            
            const recentActivities = activities.slice(0, 10);
            
            tbody.innerHTML = recentActivities.map(activity => {
                let typeClass = 'badge-primary';
                let typeText = 'ç³»ç»Ÿ';
                
                if (activity.type === 'product') {
                    typeClass = 'badge-success';
                    typeText = 'äº§å“';
                } else if (activity.type === 'task') {
                    typeClass = 'badge-warning';
                    typeText = 'ä»»åŠ¡';
                }
                
                return `
                    <tr>
                        <td>${activity.time}</td>
                        <td><span class="badge ${typeClass}">${typeText}</span></td>
                        <td>${activity.details}</td>
                        <td>${activity.actor}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // äº§å“æ·»åŠ æ¨¡å—
        // ============================================
        function initProductAddModule() {
            // åˆå§‹åŒ–ä¸Šä¼ åŠŸèƒ½
            initProductUpload();
            
            // ç»‘å®šä»·æ ¼è®¡ç®—äº‹ä»¶
            const purchasePriceInput = document.getElementById('productPurchasePrice');
            const salePriceInput = document.getElementById('productSalePrice');
            const profitMarginInput = document.getElementById('productProfitMargin');
            
            function calculateAndDisplayProfitMargin() {
                const purchasePrice = parseFloat(purchasePriceInput.value) || 0;
                const salePrice = parseFloat(salePriceInput.value) || 0;
                const profitMargin = Utils.calculateProfitMargin(purchasePrice, salePrice);
                
                profitMarginInput.value = `${profitMargin}%`;
                
                if (profitMargin > 0) {
                    profitMarginInput.style.color = '#27ae60';
                } else if (profitMargin < 0) {
                    profitMarginInput.style.color = '#e74c3c';
                } else {
                    profitMarginInput.style.color = '#666';
                }
            }
            
            purchasePriceInput.addEventListener('input', calculateAndDisplayProfitMargin);
            salePriceInput.addEventListener('input', calculateAndDisplayProfitMargin);
            
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            const productForm = document.getElementById('productForm');
            productForm.addEventListener('submit', handleProductFormSubmit);
            
            // ç»‘å®šæœç´¢äº‹ä»¶
            document.getElementById('productSearch').addEventListener('input', searchProducts);
            
            // åŠ è½½æ•°æ®
            loadRecentProducts();
            
            if (currentProductView === 'list') {
                loadAllProductsInProductAdd();
            } else {
                loadGalleryProducts();
            }
        }

        function initProductUpload() {
            const uploadArea = document.getElementById('productImageUpload');
            
            // è®¾ç½®åˆå§‹å†…å®¹
            if (!productImagePreview) {
                uploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <div class="upload-text">ç‚¹å‡»ä¸Šä¼ äº§å“å›¾ç‰‡</div>
                    <input type="file" id="productImageFile" accept="image/*" class="hidden">
                `;
                uploadArea.classList.remove('has-image');
            } else {
                uploadArea.innerHTML = `
                    <button type="button" class="upload-remove-btn" onclick="resetProductImageUpload()">
                        <i class="fas fa-times"></i>
                    </button>
                    <img src="${productImagePreview}" class="upload-preview" alt="äº§å“å›¾ç‰‡é¢„è§ˆ" onerror="Utils.onImageError(this)">
                    <input type="file" id="productImageFile" accept="image/*" class="hidden">
                `;
                uploadArea.classList.add('has-image');
            }
            
            // é‡æ–°è·å–æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('productImageFile');
            
            // æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newUploadArea = uploadArea.cloneNode(true);
            uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);
            
            // é‡æ–°è·å–å…ƒç´ 
            const newFileInput = document.getElementById('productImageFile');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            newUploadArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('upload-remove-btn')) return;
                newFileInput.click();
            });
            
            // ç»‘å®šæ‹–æ”¾äº‹ä»¶
            newUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    newFileInput.files = e.dataTransfer.files;
                    handleProductImageUpload({ target: newFileInput });
                }
            });
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            newFileInput.onchange = function(e) {
                handleProductImageUpload(e);
            };
        }

        function handleProductImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                productImagePreview = e.target.result;
                initProductUpload();
            };
            reader.readAsDataURL(file);
        }

        function resetProductImageUpload() {
            productImagePreview = null;
            initProductUpload();
        }

        async function handleProductFormSubmit(e) {
            e.preventDefault();
            
            // æ£€æŸ¥ç”¨æˆ·æƒé™
            const currentUser = DataManager.getCurrentUser();
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'warehouse' && currentUser.role !== 'sales')) {
                Utils.showAlert('åªæœ‰ç®¡ç†å‘˜ã€ä»“åº“ç®¡ç†å’Œé”€å”®è¿è¥è§’è‰²å¯ä»¥æ·»åŠ äº§å“', 'error');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            if (submitBtn.disabled) return;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
            
            // ä»å…¨å±€å˜é‡è·å–å›¾ç‰‡æ•°æ®
            const productData = {
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                supplier: document.getElementById('productSupplier').value,
                stock: parseInt(document.getElementById('productQuantity').value) || 0,
                purchasePrice: parseFloat(document.getElementById('productPurchasePrice').value) || 0,
                salePrice: parseFloat(document.getElementById('productSalePrice').value) || 0,
                image: productImagePreview || ''
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!productData.code || !productData.name) {
                Utils.showAlert('è¯·å¡«å†™è´§å·å’Œäº§å“åç§°', 'warning');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
            
            const quantity = parseInt(productData.stock) || 0;
            if (quantity < 0) {
                Utils.showAlert('åº“å­˜æ•°é‡ä¸èƒ½ä¸ºè´Ÿæ•°', 'warning');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
            
            try {
                const newProduct = await DataManager.addProduct(productData);
                Utils.showAlert(`äº§å“æ·»åŠ æˆåŠŸï¼è´§å·ï¼š${newProduct.code}`, 'success', function() {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜äº§å“';
                    
                    // é‡ç½®è¡¨å•
                    e.target.reset();
                    resetProductImageUpload();
                    const profitMarginInput = document.getElementById('productProfitMargin');
                    profitMarginInput.value = '';
                    profitMarginInput.style.color = '';
                    
                    // åˆ·æ–°é¡µé¢æ•°æ®
                    updateDashboard();
                    loadRecentProducts();
                    if (currentProductView === 'list') {
                        loadAllProductsInProductAdd();
                    } else {
                        loadGalleryProducts();
                    }
                });
            } catch (error) {
                console.error('ä¿å­˜äº§å“å¤±è´¥:', error);
                let errorMessage = 'ä¿å­˜äº§å“å¤±è´¥ï¼Œè¯·é‡è¯•';
                if (error.message && error.message.includes('æƒé™ä¸è¶³')) {
                    errorMessage = 'æƒé™ä¸è¶³ï¼Œåªæœ‰ç®¡ç†å‘˜ã€ä»“åº“ç®¡ç†å’Œé”€å”®è¿è¥è§’è‰²å¯ä»¥æ·»åŠ äº§å“';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                Utils.showAlert(errorMessage, 'error');
                // ç¡®ä¿å³ä½¿åœ¨å›è°ƒå‡½æ•°å¤–ä¹Ÿæ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    if (submitBtn.disabled) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                }, 100);
            }
        }

        async function loadRecentProducts() {
            try {
                const products = await DataManager.getAllProducts();
                // ç¡®ä¿ products æ˜¯æ•°ç»„
                if (!Array.isArray(products)) {
                    console.error('Products is not an array:', products);
                    const container = document.getElementById('recentProducts');
                    if (container) {
                        container.innerHTML = '<p class="text-muted text-center my-3">æš‚æ— äº§å“</p>';
                    }
                    return;
                }
                const recent = products.slice(-10).reverse();
                const container = document.getElementById('recentProducts');
                
                if (!container) return;
                
                if (recent.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center my-3">æš‚æ— äº§å“</p>';
                    return;
                }
                
                container.innerHTML = recent.map(product => `
                    <div class="recent-product-item">
                        <div class="recent-product-layout">
                            <div class="recent-product-img-container">
                                ${product.image ? 
                                    `<img src="${product.image}" alt="${product.name}" class="recent-product-img" onerror="Utils.onImageError(this)">` : 
                                    '<div class="text-center text-muted"><i class="fas fa-image fa-lg"></i></div>'
                                }
                            </div>
                            <div class="recent-product-name-container">
                                <p class="recent-product-name mb-1">${product.name}</p>
                            </div>
                            <div class="recent-product-stock-container">
                                <div class="recent-product-stock">åº“å­˜ï¼š${product.stock}</div>
                            </div>
                            <div class="recent-product-action-container">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteRecentProduct('${product.id}')">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æœ€è¿‘äº§å“å¤±è´¥:', error);
                const container = document.getElementById('recentProducts');
                if (container) {
                    container.innerHTML = '<p class="text-muted text-center my-3">åŠ è½½äº§å“å¤±è´¥</p>';
                }
            }
        }

        async function loadAllProductsInProductAdd() {
            try {
                const products = await DataManager.getAllProducts();
                const tbody = document.getElementById('productTable');
                
                if (!tbody) return;
                
                if (products.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-muted py-5">
                                <i class="fas fa-inbox fa-2x mb-3"></i>
                                <p>æš‚æ— äº§å“æ•°æ®</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = products.map(product => {
                    return `
                    <tr>
                        <td>
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" style="width: 45px; height: 45px; object-fit: cover; border-radius: 4px;" onerror="Utils.onImageError(this)">` : 
                                '<div class="text-center text-muted"><i class="fas fa-image"></i></div>'
                            }
                        </td>
                        <td><code>${product.code}</code></td>
                        <td>${product.name}</td>
                        <td>${product.supplier || ''}</td>
                        <td>
                            <span class="badge ${product.stock > 10 ? 'badge-success' : product.stock > 0 ? 'badge-warning' : 'badge-danger'}">
                                ${product.stock}
                            </span>
                        </td>
                        <td>${Utils.formatCurrency(product.purchasePrice)}</td>
                        <td>${Utils.formatCurrency(product.salePrice)}</td>
                        <td>${Utils.formatProfitMargin(product.profitMargin)}</td>
                        <td>
                            <div class="d-flex gap-4">
                                <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${product.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                                    åˆ é™¤
                                </button>
                            </div>
                        </td>
                    </tr>
                `}).join('');
            } catch (error) {
                console.error('åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥:', error);
                Utils.showAlert('åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function loadGalleryProducts() {
            const products = await DataManager.getAllProducts();
            const galleryContainer = document.getElementById('productGalleryView');
            
            if (!galleryContainer) return;
            
            if (products.length === 0) {
                galleryContainer.innerHTML = `
                    <div class="text-center w-100 py-5 text-muted">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>æš‚æ— äº§å“æ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            galleryContainer.innerHTML = products.map(product => {
                return `
                <div class="gallery-item">
                    <div class="gallery-img">
                        ${product.image ? 
                            `<img src="${product.image}" alt="${product.name}" class="gallery-img" style="object-fit: cover; width: 100%; height: 100%;" onerror="Utils.onImageError(this)">` : 
                            '<div class="d-flex align-items-center justify-content-center h-100"><i class="fas fa-image fa-2x text-muted"></i></div>'
                        }
                    </div>
                    <div class="gallery-info">
                        <!-- ç¬¬ä¸€è¡Œï¼šè´§å·å’Œé”€å”®ä»· -->
                        <div class="gallery-info-row">
                            <span class="gallery-code"><strong>è´§å·:</strong> ${product.code}</span>
                            <span class="gallery-price"><strong>é”€å”®ä»·:</strong> ${Utils.formatCurrency(product.salePrice)}</span>
                        </div>
                        <!-- ç¬¬äºŒè¡Œï¼šåç§°å’Œåº“å­˜ -->
                        <div class="gallery-info-row">
                            <span class="gallery-name"><strong>åç§°:</strong> ${product.name}</span>
                            <span class="gallery-stock"><strong>åº“å­˜:</strong> ${product.stock}</span>
                        </div>
                        <!-- ç¬¬ä¸‰è¡Œï¼šç¼–è¾‘å’Œåˆ é™¤æŒ‰é’® -->
                        <div class="gallery-info-row">
                            <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${product.id}')">
                                ç¼–è¾‘
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        async function editProduct(productId) {
            try {
                const product = await DataManager.getProductById(productId);
                if (!product) {
                    Utils.showAlert('æœªæ‰¾åˆ°æŒ‡å®šçš„äº§å“', 'error');
                    return;
                }
            
            document.getElementById('productCode').value = product.code;
            document.getElementById('productName').value = product.name;
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productQuantity').value = product.stock || '';
            document.getElementById('productPurchasePrice').value = product.purchasePrice;
            document.getElementById('productSalePrice').value = product.salePrice;
            
            const profitMargin = Utils.calculateProfitMargin(product.purchasePrice, product.salePrice);
            const profitMarginInput = document.getElementById('productProfitMargin');
            profitMarginInput.value = `${profitMargin}%`;
            
            if (profitMargin > 0) {
                profitMarginInput.style.color = '#27ae60';
            } else if (profitMargin < 0) {
                profitMarginInput.style.color = '#e74c3c';
            } else {
                profitMarginInput.style.color = '#666';
            }
            
            // åŠ è½½äº§å“å›¾ç‰‡
            productImagePreview = product.image || null;
            initProductUpload();
            
            // é‡æ–°ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            const form = document.getElementById('productForm');
            if (!form) return;
            
            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            form.removeEventListener('submit', handleProductFormSubmit);
            
            // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> æ›´æ–°äº§å“';
            
            // ä¿å­˜å¯¹ç¼–è¾‘æäº¤å¤„ç†å‡½æ•°çš„å¼•ç”¨
            form.editSubmitHandler = async function(e) {
                e.preventDefault();
                            
                const originalText = submitBtn.innerHTML;
                            
                if (submitBtn.disabled) return;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
                            
                const productData = {
                    code: document.getElementById('productCode').value,
                    name: document.getElementById('productName').value,
                    supplier: document.getElementById('productSupplier').value,
                    stock: document.getElementById('productQuantity').value || 0,
                    purchasePrice: document.getElementById('productPurchasePrice').value,
                    salePrice: document.getElementById('productSalePrice').value,
                    image: productImagePreview || ''
                };
                            
                if (!productData.code || !productData.name) {
                    Utils.showAlert('è¯·å¡«å†™è´§å·å’Œäº§å“åç§°', 'warning');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }
                            
                try {
                    // é€šè¿‡APIæ›´æ–°äº§å“
                    const response = await fetch(`${DataManager.API_BASE}/api/products/${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            product_code: productData.code,
                            product_name: productData.name,
                            product_supplier: productData.supplier,
                            quantity: parseInt(productData.stock) || 0,
                            purchase_price: parseFloat(productData.purchasePrice) || 0,
                            sale_price: parseFloat(productData.salePrice) || 0,
                            image: productData.image
                        })
                    });
                                                
                    if (!response.ok) {
                        throw new Error('æ›´æ–°äº§å“å¤±è´¥');
                    }
                                                
                    Utils.showAlert(`äº§å“æ›´æ–°æˆåŠŸï¼è´§å·ï¼š${productData.code}`, 'success', function() {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜äº§å“';
                                    
                        // é‡ç½®è¡¨å•
                        e.target.reset();
                        resetProductImageUpload();
                                    
                        // é‡æ–°ç»‘å®šåŸå§‹äº‹ä»¶
                        form.removeEventListener('submit', form.editSubmitHandler);
                        form.addEventListener('submit', handleProductFormSubmit);
                                    
                        // åˆ·æ–°æ•°æ®
                        initProductAddModule();
                    });
                } catch (error) {
                    console.error('æ›´æ–°äº§å“å¤±è´¥:', error);
                    Utils.showAlert('æ›´æ–°äº§å“å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜äº§å“';
                }
            };
                        
            // ç»‘å®šç¼–è¾‘æäº¤å¤„ç†å‡½æ•°
            form.addEventListener('submit', form.editSubmitHandler);
                        
            // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
            document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('ç¼–è¾‘äº§å“å¤±è´¥:', error);
                Utils.showAlert('ç¼–è¾‘äº§å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        function switchProductView(view) {
            currentProductView = view;
            
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                if (btn.getAttribute('data-view') === view) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            if (view === 'list') {
                document.getElementById('productListView').classList.remove('hidden');
                document.getElementById('productGalleryView').classList.add('hidden');
                loadAllProductsInProductAdd();
            } else {
                document.getElementById('productListView').classList.add('hidden');
                document.getElementById('productGalleryView').classList.remove('hidden');
                loadGalleryProducts();
            }
        }

        async function deleteRecentProduct(productId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº§å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const success = await DataManager.deleteProduct(productId);
                if (success) {
                    Utils.showAlert('äº§å“åˆ é™¤æˆåŠŸï¼', 'success', function() {
                        updateDashboard();
                        loadRecentProducts();
                        if (currentProductView === 'list') {
                            loadAllProductsInProductAdd();
                        } else {
                            loadGalleryProducts();
                        }
                    });
                } else {
                    Utils.showAlert('äº§å“åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤äº§å“å¤±è´¥:', error);
                Utils.showAlert('åˆ é™¤äº§å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº§å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const success = await DataManager.deleteProduct(productId);
                if (success) {
                    Utils.showAlert('äº§å“åˆ é™¤æˆåŠŸï¼', 'success', function() {
                        updateDashboard();
                        loadRecentProducts();
                        if (currentProductView === 'list') {
                            loadAllProductsInProductAdd();
                        } else {
                            loadGalleryProducts();
                        }
                    });
                } else {
                    Utils.showAlert('äº§å“åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤äº§å“å¤±è´¥:', error);
                Utils.showAlert('åˆ é™¤äº§å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            
            try {
                const products = await DataManager.getAllProducts();
            
            const filteredProducts = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.code.toLowerCase().includes(searchTerm)
            );
            
            if (currentProductView === 'list') {
                const tbody = document.getElementById('productTable');
                
                if (filteredProducts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-muted py-5">
                                æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = filteredProducts.map(product => {
                    return `
                    <tr>
                        <td>
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" style="width: 45px; height: 45px; object-fit: cover; border-radius: 4px;" onerror="Utils.onImageError(this)">` : 
                                '<div class="text-center text-muted"><i class="fas fa-image"></i></div>'
                            }
                        </td>
                        <td><code>${product.code}</code></td>
                        <td>${product.name}</td>
                        <td>${product.supplier || ''}</td>
                        <td>
                            <span class="badge ${product.stock > 10 ? 'badge-success' : product.stock > 0 ? 'badge-warning' : 'badge-danger'}">
                                ${product.stock}
                            </span>
                        </td>
                        <td>${Utils.formatCurrency(product.purchasePrice)}</td>
                        <td>${Utils.formatCurrency(product.salePrice)}</td>
                        <td>${Utils.formatProfitMargin(product.profitMargin)}</td>
                        <td>
                            <div class="d-flex gap-4">
                                <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${product.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                                    åˆ é™¤
                                </button>
                            </div>
                        </td>
                    </tr>
                `}).join('');
            } else {
                const galleryContainer = document.getElementById('productGalleryView');
                
                if (filteredProducts.length === 0) {
                    galleryContainer.innerHTML = `
                        <div class="text-center w-100 py-5 text-muted">
                            æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“
                        </div>
                    `;
                    return;
                }
                
                galleryContainer.innerHTML = filteredProducts.map(product => {
                    return `
                    <div class="gallery-item">
                        <div class="gallery-img">
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" class="gallery-img" style="object-fit: cover;" onerror="Utils.onImageError(this)">` : 
                                '<div class="d-flex align-items-center justify-content-center h-100"><i class="fas fa-image fa-2x text-muted"></i></div>'
                            }
                        </div>
                        <div class="gallery-info">
                            <div class="gallery-code">${product.code}</div>
                            <div class="gallery-name">${product.name}</div>
                            <div class="gallery-stock">åº“å­˜ï¼š${product.stock}</div>
                            <div class="gallery-price">å”®ä»·ï¼š${Utils.formatCurrency(product.salePrice)}</div>
                            <div class="gallery-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${product.id}')">
                                    ç¼–è¾‘
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }
        } catch (error) {
            console.error('æœç´¢äº§å“å¤±è´¥:', error);
            if (currentProductView === 'list') {
                const tbody = document.getElementById('productTable');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-muted py-5">
                                æœç´¢äº§å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                            </td>
                        </tr>
                    `;
                }
            } else {
                const galleryContainer = document.getElementById('productGalleryView');
                if (galleryContainer) {
                    galleryContainer.innerHTML = `
                        <div class="text-center w-100 py-5 text-muted">
                            æœç´¢äº§å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•
                        </div>
                    `;
                }
            }
        }
    }
    
        async function addToTaskFromList(productId) {
            switchModule('sales-operations');
            
            setTimeout(async () => {
                try {
                    const products = await DataManager.getAllProducts();
                    const product = products.find(p => String(p.id) === String(productId));
                    if (product) {
                        selectSingleProduct(product.id, product.name, product.code, product.image);
                    }
                } catch (error) {
                    console.error('åŠ è½½äº§å“æ•°æ®å¤±è´¥:', error);
                    Utils.showAlert('åŠ è½½äº§å“æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            }, 100);
        }

        // ============================================
        // é”€å”®è¿è¥æ¨¡å—
        // ============================================
        async function initSalesOperations() {
            taskCart = [];
            selectedProduct = null;
            
            // åˆå§‹åŒ–ä»»åŠ¡æ–‡ä»¶ä¸Šä¼ ç›¸å…³å˜é‡
            taskBodyCodePreview = null;
            taskBodyCodeFileName = null;
            taskBodyCodeType = null;
            
            taskBarcodePreview = null;
            taskBarcodeFileName = null;
            taskBarcodeType = null;
            
            taskWarningCodePreview = null;
            taskWarningCodeFileName = null;
            taskWarningCodeType = null;
            
            taskLabelPreview = null;
            taskLabelFileName = null;
            taskLabelType = null;
            
            taskManualPreview = null;
            taskManualFileName = null;
            taskManualType = null;
            
            taskOtherPreview = null;
            taskOtherFileName = null;
            taskOtherType = null;
            
            (async () => {
                await updateMultiselectDropdown();
            })();
            updateTaskCart();
            
            // åˆå§‹åŒ–ä»»åŠ¡æ–‡ä»¶ä¸Šä¼ 
            initTaskBodyCodeUpload();
            initTaskBarcodeUpload();
            initTaskWarningCodeUpload();
            initTaskLabelUpload();
            initTaskManualUpload();
            initTaskOtherUpload();
            
            // é‡æ–°ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            const form = document.getElementById('taskForm');
            if (form) {
                form.removeEventListener('submit', createShipmentTask);
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    createShipmentTask();
                });
            }
            
            const searchInput = document.getElementById('productSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', async function() {
                    await updateMultiselectDropdown(this.value.toLowerCase());
                });
                
                // ç‚¹å‡»è¾“å…¥æ¡†æ˜¾ç¤ºä¸‹æ‹‰èœå•
                searchInput.addEventListener('click', function(e) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å…¨å±€éšè—é€»è¾‘
                    const dropdown = document.getElementById('multiselectDropdown');
                    dropdown.classList.remove('hidden');
                });
            }
            
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('multiselectDropdown');
                const searchInput = document.getElementById('productSearchInput');
                
                // ä½¿ç”¨ setTimeout ç¡®ä¿äº‹ä»¶å¤„ç†åœ¨æ‰€æœ‰åŒæ­¥æ“ä½œå®Œæˆåæ‰§è¡Œ
                setTimeout(() => {
                    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                }, 0);
            });
            
            await loadSalesPublishedTasks();
        }

        // åˆå§‹åŒ–ä»»åŠ¡æœ¬ä½“ç ä¸Šä¼ 
        function initTaskBodyCodeUpload() {
            const uploadArea = document.getElementById('taskBodyCodeUpload');
            
            // è®¾ç½®åˆå§‹å†…å®¹
            if (!taskBodyCodePreview) {
                uploadArea.innerHTML = `
                    <i class="fas fa-barcode upload-icon" style="font-size: 1.8rem;"></i>
                    <div class="upload-hint">ä¸Šä¼ æœ¬ä½“ç </div>
                    <input type="file" id="taskBodyCodeFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.remove('has-file');
            } else {
                let previewHtml = '';
                if (taskBodyCodeType === 'pdf') {
                    previewHtml = `
                        <div class="upload-preview pdf">
                            <i class="fas fa-file-pdf" style="font-size: 2.5rem; color: #e74c3c;"></i>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskBodyCodeFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">PDFæ–‡ä»¶</div>
                    `;
                } else {
                    previewHtml = `
                        <img src="${taskBodyCodePreview}" class="upload-preview" alt="æœ¬ä½“ç é¢„è§ˆ" onerror="Utils.onImageError(this)">
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskBodyCodeFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">å·²ä¸Šä¼ æœ¬ä½“ç æ–‡ä»¶</div>
                    `;
                }
                
                uploadArea.innerHTML = `
                    <button type="button" class="upload-remove-btn" onclick="resetTaskBodyCodeUpload()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="text-align: left; width: 100%;">
                        ${previewHtml}
                    </div>
                    <input type="file" id="taskBodyCodeFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.add('has-file');
            }
            
            // é‡æ–°è·å–æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('taskBodyCodeFile');
            
            // æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newUploadArea = uploadArea.cloneNode(true);
            uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);
            
            // é‡æ–°è·å–å…ƒç´ 
            const newFileInput = document.getElementById('taskBodyCodeFile');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            newUploadArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('upload-remove-btn')) return;
                newFileInput.click();
            });
            
            // ç»‘å®šæ‹–æ”¾äº‹ä»¶
            newUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    newFileInput.files = e.dataTransfer.files;
                    handleTaskBodyCodeUpload({ target: newFileInput });
                }
            });
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            newFileInput.onchange = function(e) {
                handleTaskBodyCodeUpload(e);
            };
        }

        function handleTaskBodyCodeUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*') && !Utils.isPDF(file)) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                taskBodyCodePreview = e.target.result;
                taskBodyCodeFileName = file.name;
                taskBodyCodeType = Utils.isPDF(file) ? 'pdf' : 'image';
                initTaskBodyCodeUpload();
            };
            reader.readAsDataURL(file);
        }

        function resetTaskBodyCodeUpload() {
            taskBodyCodePreview = null;
            taskBodyCodeFileName = null;
            taskBodyCodeType = null;
            initTaskBodyCodeUpload();
        }

        // åˆå§‹åŒ–ä»»åŠ¡è­¦ç¤ºç ä¸Šä¼ 
        function initTaskWarningCodeUpload() {
            const uploadArea = document.getElementById('taskWarningCodeUpload');
            
            // è®¾ç½®åˆå§‹å†…å®¹
            if (!taskWarningCodePreview) {
                uploadArea.innerHTML = `
                    <i class="fas fa-exclamation-triangle upload-icon" style="font-size: 1.8rem;"></i>
                    <div class="upload-hint">ä¸Šä¼ è­¦ç¤ºç </div>
                    <input type="file" id="taskWarningCodeFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.remove('has-file');
            } else {
                let previewHtml = '';
                if (taskWarningCodeType === 'pdf') {
                    previewHtml = `
                        <div class="upload-preview pdf">
                            <i class="fas fa-file-pdf" style="font-size: 2.5rem; color: #e74c3c;"></i>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskWarningCodeFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">PDFæ–‡ä»¶</div>
                    `;
                } else {
                    previewHtml = `
                        <img src="${taskWarningCodePreview}" class="upload-preview" alt="è­¦ç¤ºç é¢„è§ˆ" onerror="Utils.onImageError(this)">
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskWarningCodeFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">å·²ä¸Šä¼ è­¦ç¤ºç æ–‡ä»¶</div>
                    `;
                }
                
                uploadArea.innerHTML = `
                    <button type="button" class="upload-remove-btn" onclick="resetTaskWarningCodeUpload()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="text-align: left; width: 100%;">
                        ${previewHtml}
                    </div>
                    <input type="file" id="taskWarningCodeFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.add('has-file');
            }
            
            // é‡æ–°è·å–æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('taskWarningCodeFile');
            
            // æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newUploadArea = uploadArea.cloneNode(true);
            uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);
            
            // é‡æ–°è·å–å…ƒç´ 
            const newFileInput = document.getElementById('taskWarningCodeFile');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            newUploadArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('upload-remove-btn')) return;
                newFileInput.click();
            });
            
            // ç»‘å®šæ‹–æ”¾äº‹ä»¶
            newUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    newFileInput.files = e.dataTransfer.files;
                    handleTaskWarningCodeUpload({ target: newFileInput });
                }
            });
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            newFileInput.onchange = function(e) {
                handleTaskWarningCodeUpload(e);
            };
        }

        function initProductUpload() {
            const uploadArea = document.getElementById('productImageUpload');
            
            // è®¾ç½®åˆå§‹å†…å®¹
            if (!productImagePreview) {
                uploadArea.innerHTML = `
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <div class="upload-text">ç‚¹å‡»ä¸Šä¼ äº§å“å›¾ç‰‡</div>
                    <input type="file" id="productImageFile" accept="image/*" class="hidden">
                `;
                uploadArea.classList.remove('has-image');
            } else {
                uploadArea.innerHTML = `
                    <button type="button" class="upload-remove-btn" onclick="resetProductImageUpload()">
                        <i class="fas fa-times"></i>
                    </button>
                    <img src="${productImagePreview}" class="upload-preview" alt="äº§å“å›¾ç‰‡é¢„è§ˆ" onerror="Utils.onImageError(this)">
                    <input type="file" id="productImageFile" accept="image/*" class="hidden">
                `;
                uploadArea.classList.add('has-image');
            }
            
            // æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newUploadArea = uploadArea.cloneNode(true);
            uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);
            
            // é‡æ–°è·å–å…ƒç´ 
            const newFileInput = document.getElementById('productImageFile');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            newUploadArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('upload-remove-btn')) return;
                newFileInput.click();
            });
            
            // ç»‘å®šæ‹–æ”¾äº‹ä»¶
            newUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    newFileInput.files = e.dataTransfer.files;
                    handleProductImageUpload({ target: newFileInput });
                }
            });
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            newFileInput.onchange = function(e) {
                handleProductImageUpload(e);
            };
        }

        function handleTaskWarningCodeUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*') && !Utils.isPDF(file)) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                taskWarningCodePreview = e.target.result;
                taskWarningCodeFileName = file.name;
                taskWarningCodeType = Utils.isPDF(file) ? 'pdf' : 'image';
                initTaskWarningCodeUpload();
            };
            reader.readAsDataURL(file);
        }

        function resetTaskWarningCodeUpload() {
            taskWarningCodePreview = null;
            taskWarningCodeFileName = null;
            taskWarningCodeType = null;
            initTaskWarningCodeUpload();
        }

        // åˆå§‹åŒ–ä»»åŠ¡æ¡ç ä¸Šä¼ 
        function initTaskBarcodeUpload() {
            const uploadArea = document.getElementById('taskBarcodeUpload');
            
            // è®¾ç½®åˆå§‹å†…å®¹
            if (!taskBarcodePreview) {
                uploadArea.innerHTML = `
                    <i class="fas fa-barcode upload-icon" style="font-size: 1.8rem;"></i>
                    <div class="upload-hint">ä¸Šä¼ æ¡ç </div>
                    <input type="file" id="taskBarcodeFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.remove('has-file');
            } else {
                let previewHtml;
                if (taskBarcodeType === 'pdf') {
                    previewHtml = `
                        <div class="upload-preview pdf">
                            <i class="fas fa-file-pdf" style="font-size: 2.5rem; color: #e74c3c;"></i>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskBarcodeFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">PDFæ–‡ä»¶</div>
                    `;
                } else {
                    previewHtml = `
                        <img src="${taskBarcodePreview}" class="upload-preview" alt="æ¡ç é¢„è§ˆ" onerror="Utils.onImageError(this)">
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskBarcodeFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">å·²ä¸Šä¼ æ¡ç æ–‡ä»¶</div>
                    `;
                }
                
                uploadArea.innerHTML = `
                    <button type="button" class="upload-remove-btn" onclick="resetTaskBarcodeUpload()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="text-align: left; width: 100%;">
                        ${previewHtml}
                    </div>
                    <input type="file" id="taskBarcodeFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.add('has-file');
            }
            
            // é‡æ–°è·å–æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('taskBarcodeFile');
            
            // æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newUploadArea = uploadArea.cloneNode(true);
            uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);
            
            // é‡æ–°è·å–å…ƒç´ 
            const newFileInput = document.getElementById('taskBarcodeFile');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            newUploadArea.addEventListener('click', function(e) {
                if (e.target && e.target.classList && e.target.classList.contains('upload-remove-btn')) return;
                newFileInput.click();
            });
            
            // ç»‘å®šæ‹–æ”¾äº‹ä»¶
            newUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    newFileInput.files = e.dataTransfer.files;
                    handleTaskBarcodeUpload({ target: newFileInput });
                }
            });
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            newFileInput.onchange = function(e) {
                handleTaskBarcodeUpload(e);
            };
        }

        function handleTaskBarcodeUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*') && !Utils.isPDF(file)) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ3Mé™åˆ¶ï¼‰
            if (file.size > 3 * 1024 * 1024) { // 3MB
                Utils.showAlert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡3MB', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                taskBarcodePreview = e.target.result;
                taskBarcodeFileName = file.name;
                taskBarcodeType = Utils.isPDF(file) ? 'pdf' : 'image';
                initTaskBarcodeUpload();
            };
            reader.readAsDataURL(file);
        }

        function resetTaskBarcodeUpload() {
            taskBarcodePreview = null;
            taskBarcodeFileName = null;
            taskBarcodeType = null;
            initTaskBarcodeUpload();
        }

        // åˆå§‹åŒ–ä»»åŠ¡ç®±å”›ä¸Šä¼ 
        function initTaskLabelUpload() {
            const uploadArea = document.getElementById('taskLabelUpload');
            
            // è®¾ç½®åˆå§‹å†…å®¹
            if (!taskLabelPreview) {
                uploadArea.innerHTML = `
                    <i class="fas fa-box upload-icon" style="font-size: 1.8rem;"></i>
                    <div class="upload-hint">ä¸Šä¼ ç®±å”›</div>
                    <input type="file" id="taskLabelFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.remove('has-file');
            } else {
                let previewHtml;
                if (taskLabelType === 'pdf') {
                    previewHtml = `
                        <div class="upload-preview pdf">
                            <i class="fas fa-file-pdf" style="font-size: 2.5rem; color: #e74c3c;"></i>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskLabelFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">PDFæ–‡ä»¶</div>
                    `;
                } else {
                    previewHtml = `
                        <img src="${taskLabelPreview}" class="upload-preview" alt="ç®±å”›é¢„è§ˆ" onerror="Utils.onImageError(this)">
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskLabelFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">å·²ä¸Šä¼ ç®±å”›æ–‡ä»¶</div>
                    `;
                }
                
                uploadArea.innerHTML = `
                    <button type="button" class="upload-remove-btn" onclick="resetTaskLabelUpload()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="text-align: left; width: 100%;">
                        ${previewHtml}
                    </div>
                    <input type="file" id="taskLabelFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.add('has-file');
            }
            
            // é‡æ–°è·å–æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('taskLabelFile');
            
            // æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newUploadArea = uploadArea.cloneNode(true);
            uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);
            
            // é‡æ–°è·å–å…ƒç´ 
            const newFileInput = document.getElementById('taskLabelFile');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            newUploadArea.addEventListener('click', function(e) {
                if (e.target && e.target.classList && e.target.classList.contains('upload-remove-btn')) return;
                newFileInput.click();
            });
            
            // ç»‘å®šæ‹–æ”¾äº‹ä»¶
            newUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    newFileInput.files = e.dataTransfer.files;
                    handleTaskLabelUpload({ target: newFileInput });
                }
            });
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            newFileInput.onchange = function(e) {
                handleTaskLabelUpload(e);
            };
        }

        function handleTaskLabelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*') && !Utils.isPDF(file)) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ3Mé™åˆ¶ï¼‰
            if (file.size > 3 * 1024 * 1024) { // 3MB
                Utils.showAlert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡3MB', 'warning');
                return;
            }
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    newFileInput.files = e.dataTransfer.files;
                    handleTaskLabelUpload({ target: newFileInput });
                }
            });
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            newFileInput.onchange = function(e) {
                handleTaskLabelUpload(e);
            };
        }

        function handleTaskLabelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*') && !Utils.isPDF(file)) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                taskLabelPreview = e.target.result;
                taskLabelFileName = file.name;
                taskLabelType = Utils.isPDF(file) ? 'pdf' : 'image';
                initTaskLabelUpload();
            };
            reader.readAsDataURL(file);
        }

        function resetTaskLabelUpload() {
            taskLabelPreview = null;
            taskLabelFileName = null;
            taskLabelType = null;
            initTaskLabelUpload();
        }
        
        // åˆå§‹åŒ–ä»»åŠ¡è¯´æ˜ä¹¦ä¸Šä¼ 
        function initTaskManualUpload() {
            const uploadArea = document.getElementById('taskManualUpload');
            
            // è®¾ç½®åˆå§‹å†…å®¹
            if (!taskManualPreview) {
                uploadArea.innerHTML = `
                    <i class="fas fa-book upload-icon" style="font-size: 1.8rem;"></i>
                    <div class="upload-hint">ä¸Šä¼ è¯´æ˜ä¹¦</div>
                    <input type="file" id="taskManualFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.remove('has-file');
            } else {
                let previewHtml = '';
                if (taskManualType === 'pdf') {
                    previewHtml = `
                        <div class="upload-preview pdf">
                            <i class="fas fa-file-pdf" style="font-size: 2.5rem; color: #e74c3c;"></i>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskManualFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">PDFæ–‡ä»¶</div>
                    `;
                } else {
                    previewHtml = `
                        <img src="${taskManualPreview}" class="upload-preview" alt="è¯´æ˜ä¹¦é¢„è§ˆ" onerror="Utils.onImageError(this)">
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskManualFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">å·²ä¸Šä¼ è¯´æ˜ä¹¦æ–‡ä»¶</div>
                    `;
                }
                
                uploadArea.innerHTML = `
                    <button type="button" class="upload-remove-btn" onclick="resetTaskManualUpload()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="text-align: left; width: 100%;">
                        ${previewHtml}
                    </div>
                    <input type="file" id="taskManualFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.add('has-file');
            }
            
            // é‡æ–°è·å–æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('taskManualFile');
            
            // æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newUploadArea = uploadArea.cloneNode(true);
            uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);
            
            // é‡æ–°è·å–å…ƒç´ 
            const newFileInput = document.getElementById('taskManualFile');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            newUploadArea.addEventListener('click', function(e) {
                if (e.target && e.target.classList && e.target.classList.contains('upload-remove-btn')) return;
                newFileInput.click();
            });
            
            // ç»‘å®šæ‹–æ”¾äº‹ä»¶
            newUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    newFileInput.files = e.dataTransfer.files;
                    handleTaskManualUpload({ target: newFileInput });
                }
            });
            
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            newFileInput.onchange = function(e) {
                handleTaskManualUpload(e);
            };
        }
        
        function handleTaskManualUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*') && !Utils.isPDF(file)) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                taskManualPreview = e.target.result;
                taskManualFileName = file.name;
                taskManualType = Utils.isPDF(file) ? 'pdf' : 'image';
                initTaskManualUpload();
            };
            reader.readAsDataURL(file);
        }
        
        function resetTaskManualUpload() {
            taskManualPreview = null;
            taskManualFileName = null;
            taskManualType = null;
            initTaskManualUpload();
        }
        
        // åˆå§‹åŒ–ä»»åŠ¡å…¶ä»–æ–‡ä»¶ä¸Šä¼ 
        function initTaskOtherUpload() {
            const uploadArea = document.getElementById('taskOtherUpload');
        
            // è®¾ç½®åˆå§‹å†…å®¹
            if (!taskOtherPreview) {
                uploadArea.innerHTML = `
                    <i class="fas fa-paperclip upload-icon" style="font-size: 1.8rem;"></i>
                    <div class="upload-hint">ä¸Šä¼ å…¶ä»–</div>
                    <input type="file" id="taskOtherFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.remove('has-file');
            } else {
                let previewHtml = '';
                if (taskOtherType === 'pdf') {
                    previewHtml = `
                        <div class="upload-preview pdf">
                            <i class="fas fa-file-pdf" style="font-size: 2.5rem; color: #e74c3c;"></i>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskOtherFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">PDFæ–‡ä»¶</div>
                    `;
                } else {
                    previewHtml = `
                        <img src="${taskOtherPreview}" class="upload-preview" alt="å…¶ä»–æ–‡ä»¶é¢„è§ˆ" onerror="Utils.onImageError(this)">
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${taskOtherFileName}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">å·²ä¸Šä¼ å…¶ä»–æ–‡ä»¶</div>
                    `;
                }
                        
                uploadArea.innerHTML = `
                    <button type="button" class="upload-remove-btn" onclick="resetTaskOtherUpload()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="text-align: left; width: 100%;">
                        ${previewHtml}
                    </div>
                    <input type="file" id="taskOtherFile" accept="image/*,.pdf" class="hidden">
                `;
                uploadArea.classList.add('has-file');
            }
                    
            // é‡æ–°è·å–æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('taskOtherFile');
                    
            // æ¸…é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
            const newUploadArea = uploadArea.cloneNode(true);
            uploadArea.parentNode.replaceChild(newUploadArea, uploadArea);
                    
            // é‡æ–°è·å–å…ƒç´ 
            const newFileInput = document.getElementById('taskOtherFile');
                    
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            newUploadArea.addEventListener('click', function(e) {
                if (e.target && e.target.classList && e.target.classList.contains('upload-remove-btn')) return;
                newFileInput.click();
            });
                    
            // ç»‘å®šæ‹–æ”¾äº‹ä»¶
            newUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
                    
            newUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
                    
            newUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    newFileInput.files = e.dataTransfer.files;
                    handleTaskOtherUpload({ target: newFileInput });
                }
            });
                    
            // ç»‘å®šæ–‡ä»¶è¾“å…¥å˜åŒ–äº‹ä»¶
            newFileInput.onchange = function(e) {
                handleTaskOtherUpload(e);
            };
        }
                
        function handleTaskOtherUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
                    
            if (!file.type.match('image.*') && !Utils.isPDF(file)) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                return;
            }
                    
            const reader = new FileReader();
            reader.onload = function(e) {
                taskOtherPreview = e.target.result;
                taskOtherFileName = file.name;
                taskOtherType = Utils.isPDF(file) ? 'pdf' : 'image';
                initTaskOtherUpload();
            };
            reader.readAsDataURL(file);
        }
                
        function resetTaskOtherUpload() {
            taskOtherPreview = null;
            taskOtherFileName = null;
            taskOtherType = null;
            initTaskOtherUpload();
        }
        
        // éªŒè¯ä¸Šä¼ åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
        function validateUploadFunctionality() {
            console.log('ä¸Šä¼ åŠŸèƒ½å·²æ›´æ–°ï¼ŒåŒ…å«ï¼šæœ¬ä½“ç ã€æ¡ç ã€è­¦ç¤ºç ã€ç®±å”›ã€è¯´æ˜ä¹¦ã€å…¶ä»–å…±6ä¸ªä¸Šä¼ åŒºåŸŸ');
            console.log('ä»»åŠ¡ä¸Šä¼ åŒºåŸŸç°åœ¨æ”¯æŒ6ä¸ªä¸Šä¼ åŠŸèƒ½');
        }

        async function updateMultiselectDropdown(searchTerm = '') {
            const dropdown = document.getElementById('multiselectDropdown');
            if (!dropdown) return;
            
            try {
                const allProducts = await DataManager.getAllProducts();
                const products = allProducts.filter(p => p.stock > 0);
                
                let filteredProducts = products;
                if (searchTerm) {
                    filteredProducts = products.filter(p => 
                        p.name.toLowerCase().includes(searchTerm) || 
                        p.code.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filteredProducts.length === 0) {
                    dropdown.innerHTML = `
                        <div style="padding: 8px 12px; color: #666; text-align: center; font-size: 0.85rem;">
                            æœªæ‰¾åˆ°å¯ç”¨äº§å“
                        </div>
                    `;
                    return;
                }
                
                dropdown.innerHTML = filteredProducts.map(product => {
                    const isSelected = selectedProduct && selectedProduct.id === product.id;
                    
                    return `
                        <div style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; ${isSelected ? 'background-color: rgba(67, 97, 238, 0.08);' : ''}" 
                             data-id="${product.id}"
                             onclick="handleSelectSingleProduct('${product.id}', '${product.name}', '${product.code}', '${product.image}')">
                            ${product.image ? 
                                `<img src="${product.image}" alt="${product.name}" style="width: 28px; height: 28px; object-fit: cover; border-radius: 4px;" onerror="Utils.onImageError(this)">` : 
                                '<div class="text-center text-muted"><i class="fas fa-image"></i></div>'
                            }
                            ${product.name} (${product.code}) - åº“å­˜: ${product.stock}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥:', error);
                dropdown.innerHTML = `
                    <div style="padding: 8px 12px; color: #666; text-align: center; font-size: 0.85rem;">
                        åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥
                    </div>
                `;
            }
        }
                
        function handleSelectSingleProduct(productId, productName, productCode, productImage) {
            // åŒ…è£…å‡½æ•°ï¼Œç”¨äºä»HTML onclickäº‹ä»¶è°ƒç”¨å¼‚æ­¥çš„ selectSingleProduct å‡½æ•°
            selectSingleProduct(productId, productName, productCode, productImage);
        }
                
        async function selectSingleProduct(productId, productName, productCode, productImage) {
            // ä½¿ç”¨ä¼ å…¥çš„å‚æ•°ä½œä¸ºåŸºç¡€ä¿¡æ¯ï¼Œä½†ä»ç„¶éœ€è¦éªŒè¯å•†å“æ˜¯å¦ä»ç„¶å­˜åœ¨å’Œæœ‰åº“å­˜
            try {
                // ä½¿ç”¨æ–°çš„getProductByIdæ–¹æ³•ï¼Œç›´æ¥è·å–ç‰¹å®šå•†å“ä¿¡æ¯ï¼Œæé«˜æ€§èƒ½
                const product = await DataManager.getProductById(productId);
                
                // éªŒè¯å•†å“æ˜¯å¦å­˜åœ¨
                if (!product) {
                    Utils.showAlert(`å•†å“ ${productName} (ID: ${productId}) ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤`, 'error');
                    // éšè—ä¸‹æ‹‰èœå•
                    const dropdown = document.getElementById('multiselectDropdown');
                    if (dropdown) {
                        dropdown.classList.add('hidden');
                    }
                    return;
                }
                
                // éªŒè¯å•†å“åº“å­˜æ˜¯å¦å……è¶³
                if (product.stock < 1) {
                    Utils.showAlert(`å•†å“ ${product.name || productName} åº“å­˜ä¸è¶³ (å½“å‰åº“å­˜: ${product.stock})ï¼Œæ— æ³•æ·»åŠ åˆ°ä»»åŠ¡`, 'warning');
                    // éšè—ä¸‹æ‹‰èœå•
                    const dropdown = document.getElementById('multiselectDropdown');
                    if (dropdown) {
                        dropdown.classList.add('hidden');
                    }
                    return;
                }
                
                // æ¸…ç©ºä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
                selectedProduct = {
                    id: productId,
                    name: product.name || productName,  // ä½¿ç”¨æ•°æ®åº“ä¸­çš„æœ€æ–°åç§°
                    code: product.code || productCode,    // ä½¿ç”¨æ•°æ®åº“ä¸­çš„æœ€æ–°ç¼–ç 
                    image: product.image || productImage  // ä½¿ç”¨æ•°æ®åº“ä¸­çš„æœ€æ–°å›¾ç‰‡
                };
                
                // æ¸…ç©ºå½“å‰è´­ç‰©è½¦ï¼Œåªæ·»åŠ å½“å‰é€‰ä¸­çš„å•†å“
                taskCart = [{
                    productId: productId,
                    productName: product.name || productName,
                    productCode: product.code || productCode,
                    productImage: product.image || productImage,
                    quantity: 1
                }];
                
                // éšè—ä¸‹æ‹‰èœå•ï¼Œå› ä¸ºç”¨æˆ·å·²ç»é€‰æ‹©äº†å•†å“
                const dropdown = document.getElementById('multiselectDropdown');
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
                
                updateSelectedTags();
                updateTaskCart();
            } catch (error) {
                console.error('éªŒè¯å•†å“å­˜åœ¨æ€§å¤±è´¥:', error);
                Utils.showAlert('æ— æ³•éªŒè¯å•†å“ä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                // éšè—ä¸‹æ‹‰èœå•
                const dropdown = document.getElementById('multiselectDropdown');
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
            }
        }

        async function addProductToTaskCart(product) {
            // éªŒè¯å•†å“æ˜¯å¦ä»ç„¶å­˜åœ¨äºæ•°æ®åº“ä¸­
            try {
                const existingProduct = await DataManager.getProductById(product.id);
                
                if (!existingProduct) {
                    Utils.showAlert(`å•†å“ ${product.name} (ID: ${product.id}) ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤`, 'error');
                    return;
                }
                
                if (existingProduct.stock < 1) {
                    Utils.showAlert(`å•†å“ ${product.name} åº“å­˜ä¸è¶³ï¼Œæ— æ³•æ·»åŠ åˆ°ä»»åŠ¡`, 'warning');
                    return;
                }
            } catch (error) {
                console.error('éªŒè¯å•†å“å­˜åœ¨æ€§å¤±è´¥:', error);
                Utils.showAlert('æ— æ³•éªŒè¯å•†å“ä¿¡æ¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                return;
            }
            
            // å¯¹äºå•é€‰åŠŸèƒ½ï¼Œç›´æ¥æ›¿æ¢è´­ç‰©è½¦ä¸­çš„å•†å“
            taskCart = [{
                productId: product.id,
                productName: product.name,
                productCode: product.code,
                productImage: product.image,
                quantity: 1
            }];
            
            selectedProduct = product;
            
            updateSelectedTags();
            updateTaskCart();
        }

        function updateSelectedTags() {
            const tagsContainer = document.getElementById('selectedProductsTags');
            if (!tagsContainer) return;
            
            if (!selectedProduct) {
                tagsContainer.innerHTML = '';
                return;
            }
            
            tagsContainer.innerHTML = `
                <div class="selected-tag">
                    ${selectedProduct.name} (${selectedProduct.code})
                    <span class="remove-tag" onclick="removeSelectedProduct()">Ã—</span>
                </div>
            `;
        }

        function removeSelectedProduct() {
            selectedProduct = null;
            taskCart = [];
            
            updateSelectedTags();
            updateTaskCart();
        }

        function updateTaskCart() {
            const tbody = document.getElementById('taskCart');
            if (!tbody) return;
            
            if (taskCart.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">
                            
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = taskCart.map((item, index) => {
                return `
                <tr>
                    <td>
                        ${item.productImage ? 
                            `<img src="${item.productImage}" alt="${item.productName}" style="width: 38px; height: 38px; object-fit: cover; border-radius: 4px;" onerror="Utils.onImageError(this)">` : 
                            '<div class="text-center text-muted"><i class="fas fa-image"></i></div>'
                        }
                    </td>
                    <td>${item.productName}</td>
                    <td><code>${item.productCode}</code></td>
                    <td>
                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" onchange="updateTaskCartItemValue(${index}, this.value)" style="width: 60px; padding: 4px 8px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeCartItem(${index})">
                            åˆ é™¤
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        async function updateCartItem(index, delta) {
            if (!taskCart[index]) return;
            
            const newQuantity = taskCart[index].quantity + delta;
            if (newQuantity < 1) return;
            
            try {
                const product = await DataManager.getProductById(taskCart[index].productId);
                
                if (!product) {
                    Utils.showAlert(`å•†å“ ${taskCart[index].productName || 'æœªçŸ¥å•†å“'} (ID: ${taskCart[index].productId}) ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤`, 'error');
                    // ä»è´­ç‰©è½¦ä¸­ç§»é™¤ä¸å­˜åœ¨çš„å•†å“
                    taskCart.splice(index, 1);
                    if (taskCart.length === 0) {
                        selectedProduct = null;
                    }
                    updateTaskCart();
                    updateSelectedTags();
                    return;
                }
                
                if (product.quantity < newQuantity) {
                    Utils.showAlert(`åº“å­˜ä¸è¶³ï¼å½“å‰åº“å­˜ï¼š${product.stock}`, 'warning');
                    return;
                }
                
                taskCart[index].quantity = newQuantity;
                updateTaskCart();
            } catch (error) {
                console.error('æ£€æŸ¥åº“å­˜å¤±è´¥:', error);
                Utils.showAlert('æ£€æŸ¥åº“å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        async function updateTaskCartItemValue(index, value) {
            if (!taskCart[index]) return;
            
            const newQuantity = parseInt(value);
            if (isNaN(newQuantity) || newQuantity < 1) return;
            
            try {
                const product = await DataManager.getProductById(taskCart[index].productId);
                
                if (!product) {
                    Utils.showAlert(`å•†å“ ${taskCart[index].productName || 'æœªçŸ¥å•†å“'} (ID: ${taskCart[index].productId}) ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤`, 'error');
                    // ä»è´­ç‰©è½¦ä¸­ç§»é™¤ä¸å­˜åœ¨çš„å•†å“
                    taskCart.splice(index, 1);
                    if (taskCart.length === 0) {
                        selectedProduct = null;
                    }
                    updateTaskCart();
                    updateSelectedTags();
                    return;
                }
                
                if (product.quantity < newQuantity) {
                    Utils.showAlert(`åº“å­˜ä¸è¶³ï¼å½“å‰åº“å­˜ï¼š${product.stock}`, 'warning');
                    // æ¢å¤è¾“å…¥æ¡†çš„å€¼ä¸ºå½“å‰æ•°é‡
                    updateTaskCart();
                    return;
                }
                
                taskCart[index].quantity = newQuantity;
                updateTaskCart();
            } catch (error) {
                console.error('æ£€æŸ¥åº“å­˜å¤±è´¥:', error);
                Utils.showAlert('æ£€æŸ¥åº“å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        function removeCartItem(index) {
            if (!taskCart[index]) return;
            
            const productId = taskCart[index].productId;
            taskCart.splice(index, 1);
            
            // åœ¨å•é€‰åœºæ™¯ä¸­ï¼Œå¦‚æœç§»é™¤äº†æœ€åçš„å•†å“ï¼Œåˆ™æ¸…ç©ºé€‰ä¸­çš„å•†å“
            if (taskCart.length === 0) {
                selectedProduct = null;
            }
            
            updateSelectedTags();
            updateTaskCart();
        }

        async function loadSalesPublishedTasks() {
            const tasks = await DataManager.getAllTasks();
            const sortedTasks = tasks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const container = document.getElementById('publishedTasksBody');
            
            if (!container) return;
            
            if (sortedTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>æš‚æ— å·²å‘å¸ƒä»»åŠ¡</p>
                    </div>
                `;
                return;
            }
            
            // è·å–æ‰€æœ‰äº§å“ä¿¡æ¯ä»¥è¡¥å……ä»»åŠ¡ä¸­çš„å•†å“è¯¦æƒ…
            const allProducts = await DataManager.getAllProducts();
            
            container.innerHTML = sortedTasks.map(task => {
                // ä»ä»»åŠ¡çš„itemsä¸­è·å–ç¬¬ä¸€ä¸ªå•†å“çš„ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰æˆ–ä¿¡æ¯ä¸å®Œæ•´åˆ™å°è¯•ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾
                let firstProductCode = 'æ— ';
                let firstProductName = 'æ— ';
                let firstProductImage = '';
                
                if (task.items && task.items.length > 0) {
                    // æ£€æŸ¥ç¬¬ä¸€ä¸ªå•†å“çš„ä¿¡æ¯æ˜¯å¦å®Œæ•´
                    const firstItem = task.items[0];
                    
                    console.log('ä»»åŠ¡å•†å“ä¿¡æ¯:', firstItem); // è°ƒè¯•ä¿¡æ¯
                    
                    // å¦‚æœä»»åŠ¡ä¸­çš„å•†å“ä¿¡æ¯å®Œæ•´ï¼Œåˆ™ä½¿ç”¨ä»»åŠ¡ä¸­çš„ä¿¡æ¯
                    if (firstItem.productCode && firstItem.productName) {
                        firstProductCode = firstItem.productCode;
                        firstProductName = firstItem.productName;
                        firstProductImage = firstItem.productImage || '';
                        console.log('ä½¿ç”¨ä»»åŠ¡ä¸­çš„å•†å“ä¿¡æ¯:', firstProductCode, firstProductName); // è°ƒè¯•ä¿¡æ¯
                    } else {
                        // å¦‚æœä»»åŠ¡ä¸­çš„å•†å“ä¿¡æ¯ä¸å®Œæ•´ï¼Œå°è¯•é€šè¿‡productIdæŸ¥æ‰¾å®Œæ•´ä¿¡æ¯
                        if (firstItem.productId) {
                            const productInfo = allProducts.find(p => p.id === firstItem.productId);
                            console.log('é€šè¿‡productIdæŸ¥æ‰¾äº§å“ä¿¡æ¯:', firstItem.productId, productInfo); // è°ƒè¯•ä¿¡æ¯
                            if (productInfo) {
                                firstProductCode = productInfo.product_code || productInfo.code || 'æ— ';
                                firstProductName = productInfo.product_name || productInfo.name || 'æ— ';
                                firstProductImage = productInfo.image || '';
                                console.log('ä»äº§å“æ•°æ®åº“è·å–ä¿¡æ¯:', firstProductCode, firstProductName); // è°ƒè¯•ä¿¡æ¯
                            } else {
                                console.log('æœªæ‰¾åˆ°å¯¹åº”äº§å“ä¿¡æ¯ï¼ŒproductId:', firstItem.productId); // è°ƒè¯•ä¿¡æ¯
                            }
                        } else {
                            console.log('ä»»åŠ¡å•†å“ä¸­æ²¡æœ‰productId:', firstItem); // è°ƒè¯•ä¿¡æ¯
                        }
                    }
                } else {
                    // å¦‚æœä»»åŠ¡ä¸­æ²¡æœ‰å•†å“ä¿¡æ¯ï¼Œå°è¯•ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼Œä½†ä½œä¸ºåå¤‡ï¼‰
                    console.warn('ä»»åŠ¡ä¸­ç¼ºå°‘å•†å“ä¿¡æ¯:', task.id);
                }
                
                // è®¡ç®—ä»»åŠ¡æ€»æ•°é‡
                const itemCount = task.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                
                // è·å–åˆ›å»ºäººID
                const creatorId = task.creatorName || task.creator_name || 'æœªçŸ¥';
                
                // æ„å»ºä»»åŠ¡å¡ç‰‡HTML
                let taskCardHtml = '';
                
                // æ„å»ºæ­£é¢å†…å®¹
                const frontContent = `
                    <div class="task-front" id="task-${task.id}-front" data-task-id="${task.id}">
                        <div class="task-gallery-img">
                            ${firstProductImage ? 
                                `<img src="${firstProductImage}" alt="äº§å“å›¾ç‰‡" onerror="Utils.onImageError(this)">` : 
                                '<div class="d-flex align-items-center justify-content-center h-100"><i class="fas fa-image fa-2x text-muted"></i></div>'
                            }
                        </div>
                        <div class="task-card-content d-flex align-items-center gap-2 w-100">
                            <div class="task-gallery-actions d-flex align-items-center gap-2 flex-shrink-0">
                                <span class="badge ${task.status === 'pending' ? 'badge-warning' : task.status === 'processing' ? 'badge-primary' : 'badge-success'}" style="padding: 2px 6px; font-size: 0.7rem; min-width: 40px; text-align: center;">
                                    ${task.status === 'pending' ? 'å¾…å‘' : task.status === 'processing' ? 'å¤„ç†ä¸­' : 'å·²å®Œæˆ'}
                                </span>
                            </div>
                            <div class="task-info-inline d-flex align-items-center gap-2 flex-shrink-0 ms-auto">
                                <div class="task-gallery-name" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px;">${firstProductName}</div>
                                <div class="task-gallery-qty" data-content="${itemCount}" style="font-size: 0.75rem; color: #888; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;">æ•°é‡: ${itemCount}</div>
                                <div class="task-gallery-creator" data-content="${creatorId}" style="font-size: 0.7rem; color: #999; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px;">åˆ›å»ºäºº: ${creatorId}</div>
                            </div>
                        </div>
                    </div>`;
                
                // æ„å»ºèƒŒé¢å†…å®¹
                const backContent = `
                    <div class="task-back">
                        <div class="task-back-content">
                            <div class="task-files-container">
                                ${generateFileItem('æœ¬ä½“ç ', task.bodyCodeImage, task.bodyCodeType, task.bodyCodeFileName, task.id, 'bodyCode')}
                                ${generateFileItem('æ¡ç ', task.barcodeImage, task.barcodeType, task.barcodeFileName, task.id, 'barcode')}
                                ${generateFileItem('è­¦ç¤ºç ', task.warningCodeImage, task.warningCodeType, task.warningCodeFileName, task.id, 'warningCode')}
                                ${generateFileItem('ç®±å”›', task.labelImage, task.labelType, task.labelFileName, task.id, 'label')}
                                ${generateFileItem('è¯´æ˜ä¹¦', task.manualImage, task.manualType, task.manualFileName, task.id, 'manual')}
                                ${generateFileItem('å…¶ä»–', task.otherImage, task.otherType, task.otherFileName, task.id, 'other')}
                            </div>
                            
                            <!-- ä»»åŠ¡å¤‡æ³¨ä¿¡æ¯ -->
                            <div class="task-remark-display" data-task-id="${task.id}">
                                <div class="remark-header">
                                    <h6><i class="fas fa-sticky-note me-2"></i>ä»»åŠ¡å¤‡æ³¨</h6>
                                </div>
                                <div class="remark-content">
                                    ${task.remark && task.remark.trim() ? 
                                        `<div class="remark-text">${task.remark}</div>` : 
                                        `<div class="remark-placeholder">æš‚æ— å¤‡æ³¨ä¿¡æ¯</div>`}
                                </div>
                            </div>
                            
                            <div class="task-back-actions">
                                <div class="back-action-buttons">
                                    <!-- è¿”å›æŒ‰é’®å·²ç§»é™¤ -->
                                    <button class="btn btn-sm btn-danger" onclick="event.preventDefault(); event.stopPropagation(); setTimeout(() => deleteTaskWithConfirmation('${task.id}', event), 0);">åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                // ç»„åˆå®Œæ•´å¡ç‰‡
                taskCardHtml = `
                    <div class="task-flip-container" data-task-id="${task.id}" onclick="toggleTaskCardFlip('${task.id}')">
                        ${frontContent}
                        ${backContent}
                    </div>`;
                
                return taskCardHtml;
            }).join('');
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ–‡ä»¶é¡¹HTML
        function generateFileItem(label, imageUrl, fileType, fileName, taskId, fileTypeKey) {
            let fileHtml = '';
            
            if (imageUrl) {
                if (fileType === 'pdf') {
                    fileHtml = `
                        <div class="task-file-item">
                            <div class="file-label">${label}</div>
                            <div class="pdf-preview" title="${fileName || 'PDFæ–‡ä»¶'}" onclick="handleFilePreviewClick('${taskId}', '${fileTypeKey}')" oncontextmenu="replaceTaskFile('${taskId}', '${fileTypeKey}'); return false;">
                                <i class="fas fa-file-pdf"></i>
                                <div class="pdf-filename">${fileName ? fileName.substring(0, 12) + (fileName.length > 12 ? '...' : '') : 'PDF'}</div>
                            </div>
                        </div>`;
                } else {
                    fileHtml = `
                        <div class="task-file-item">
                            <div class="file-label">${label}</div>
                            <img src="${imageUrl}" alt="${label}" class="file-preview" onerror="Utils.onImageError(this)" onclick="handleFilePreviewClick('${taskId}', '${fileTypeKey}')" oncontextmenu="replaceTaskFile('${taskId}', '${fileTypeKey}'); return false;">
                        </div>`;
                }
            } else {
                fileHtml = `
                    <div class="task-file-item">
                        <div class="file-label">${label}</div>
                        <div class="no-file">æœªä¸Šä¼ </div>
                    </div>`;
            }
            
            return fileHtml;
        }

        function viewTaskDetail(taskId) {
            // ä½¿ç”¨ç«‹å³æ‰§è¡Œçš„å¼‚æ­¥å‡½æ•°æ¥å¤„ç†å¼‚æ­¥æ“ä½œ
            (async function() {
                try {
                    const task = await DataManager.getTaskById(taskId);
                    if (!task) return;
                    
                    let detailHtml = '<h6>ä»»åŠ¡è¯¦æƒ…</h6>';
                    detailHtml += '<p><strong>ä»»åŠ¡å·ï¼š</strong>' + task.taskNumber + '</p>';
                    detailHtml += '<p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>' + Utils.formatDate(task.createdAt) + '</p>';
                    detailHtml += '<p><strong>åˆ›å»ºè€…ï¼š</strong>' + (task.creatorName || task.creator_name || 'N/A') + '</p>';
                    detailHtml += '<p>' + (task.status === 'pending' ? 'å¾…å¤„ç†' : task.status === 'processing' ? 'å¤„ç†ä¸­' : 'å·²å®Œæˆ') + '</p>';
                    
                    // æ˜¾ç¤ºä»»åŠ¡æ–‡ä»¶
                    if (task.bodyCodeImage) {
                        detailHtml += '<p><strong>æœ¬ä½“ç ï¼š</strong>å·²ä¸Šä¼  (' + (task.bodyCodeType === 'pdf' ? 'PDF' : 'å›¾ç‰‡') + ')</p>';
                    }
                    if (task.warningCodeImage) {
                        detailHtml += '<p><strong>è­¦ç¤ºç ï¼š</strong>å·²ä¸Šä¼  (' + (task.warningCodeType === 'pdf' ? 'PDF' : 'å›¾ç‰‡') + ')</p>';
                    }
                    if (task.labelImage) {
                        detailHtml += '<p><strong>ç®±å”›ï¼š</strong>å·²ä¸Šä¼  (' + (task.labelType === 'pdf' ? 'PDF' : 'å›¾ç‰‡') + ')</p>';
                    }
                    
                    detailHtml += '<h6 class="mt-3">å•†å“æ¸…å•</h6>';
                    detailHtml += '<div class="table-responsive">';
                    detailHtml += '<table class="table table-sm">';
                    detailHtml += '<thead><tr><th>å›¾ç‰‡</th><th>å•†å“åç§°</th><th>è´§å·</th><th>æ•°é‡</th></tr></thead>';
                    detailHtml += '<tbody>';
                    
                    task.items.forEach(item => {
                        var imageHtml = item.productImage ? 
                            '<img src="' + item.productImage + '" alt="' + item.productName + '" style="width: 38px; height: 38px; object-fit: cover; border-radius: 4px;" onerror="Utils.onImageError(this)">' : 
                            '<div class="text-center text-muted"><i class="fas fa-image"></i></div>';
                        detailHtml += 
                            '<tr>' +
                                '<td>' + imageHtml + '</td>' +
                                '<td>' + item.productName + '</td>' +
                                '<td><code>' + item.productCode + '</code></td>' +
                                '<td>' + item.quantity + '</td>' +
                            '</tr>';
                    });
                    
                    detailHtml += '</tbody></table></div>';
                    
                    alertify.alert('ä»»åŠ¡è¯¦æƒ…', detailHtml);
                } catch (error) {
                    console.error("åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:", error);
                    Utils.showAlert('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            })();
        }

        async function deleteSalesTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·²å‘å¸ƒçš„ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
                    
            try {
                // å…ˆå°è¯•ä»æœåŠ¡å™¨åˆ é™¤
                const success = await DataManager.deleteTask(taskId);
                if (success) {
                    // ä»UIä¸Šç«‹å³ç§»é™¤ä»»åŠ¡å…ƒç´ ï¼Œæä¾›å³æ—¶åé¦ˆ
                    // å¯¹äºå¡ç‰‡è§†å›¾ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„å¡ç‰‡å…ƒç´ 
                    const taskCard = document.querySelector(`#publishedTasksBody [data-task-id="${taskId}"]`);
                    if (taskCard) {
                        // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
                        taskCard.style.opacity = '0';
                        taskCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        taskCard.style.transform = 'scale(0.95)';
                                
                        setTimeout(() => {
                            taskCard.remove();
                                    
                            // å¦‚æœä»»åŠ¡åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºç›¸åº”æç¤º
                            const container = document.getElementById('publishedTasksBody');
                            if (container && container.children.length === 0) {
                                container.innerHTML = `
                                    <div class="no-tasks-message text-center text-muted py-5">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <h5>æš‚æ— å·²å‘å¸ƒä»»åŠ¡</h5>
                                        <p>æš‚æ— å¾…å¤„ç†çš„å‘è´§ä»»åŠ¡</p>
                                    </div>
                                `;
                            }
                        }, 300);
                    }
                            
                    // å¯¹äºè¡¨æ ¼è§†å›¾ï¼Œä¹Ÿå°è¯•ç§»é™¤å¯¹åº”çš„è¡Œ
                    const taskRow = document.querySelector(`#publishedTasksBody tr[data-task-id="${taskId}"]`);
                    if (taskRow) {
                        taskRow.style.opacity = '0';
                        taskRow.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        taskRow.style.transform = 'scale(0.95)';
                                
                        setTimeout(() => {
                            taskRow.remove();
                                    
                            // å¦‚æœä»»åŠ¡åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºç›¸åº”æç¤º
                            const tbody = document.getElementById('publishedTasksBody');
                            if (tbody && tbody.children.length === 0) {
                                tbody.innerHTML = `
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-3">
                                            æš‚æ— å·²å‘å¸ƒä»»åŠ¡
                                        </td>
                                    </tr>
                                `;
                            }
                        }, 300);
                    }
                            
                    Utils.showAlert('ä»»åŠ¡åˆ é™¤æˆåŠŸï¼', 'success');
                            
                    // æ›´æ–°ä»ªè¡¨ç›˜å’Œä»»åŠ¡åˆ—è¡¨
                    await updateDashboard();
                            
                    // å»¶é•¿ç­‰å¾…æ—¶é—´ä»¥ç¡®ä¿æœåŠ¡å™¨å®Œå…¨å¤„ç†åˆ é™¤æ“ä½œ
                    await new Promise(resolve => setTimeout(resolve, 800));
                            
                    // é‡æ–°åŠ è½½æ‰€æœ‰ç›¸å…³çš„ä»»åŠ¡åˆ—è¡¨
                    await loadSalesPublishedTasks();
                    loadWarehouseTasksList();
                } else {
                    Utils.showAlert('åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                Utils.showAlert('åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function createShipmentTask() {
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            if (!submitBtn) return;
            
            if (submitBtn.disabled) return;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­...';
            
            if (!selectedProduct) {
                Utils.showAlert('è¯·è‡³å°‘æ·»åŠ ä¸€ä»¶å•†å“', 'warning');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> åˆ›å»ºå‘è´§ä»»åŠ¡';
                return;
            }
            
            try {
                // éªŒè¯è´­ç‰©è½¦ä¸­çš„å•†å“æ˜¯å¦æœ‰æ•ˆ
                if (taskCart.length === 0) {
                    Utils.showAlert('è¯·è‡³å°‘æ·»åŠ ä¸€ä»¶å•†å“', 'warning');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> åˆ›å»ºå‘è´§ä»»åŠ¡';
                    return;
                }
                
                // åœ¨æäº¤å‰é‡æ–°éªŒè¯è´­ç‰©è½¦ä¸­çš„æ¯ä¸ªå•†å“æ˜¯å¦å­˜åœ¨å’Œåº“å­˜æ˜¯å¦å……è¶³
                // é¿å…åœ¨ç”¨æˆ·é€‰æ‹©å•†å“åä½†åœ¨æäº¤å‰å•†å“è¢«åˆ é™¤å¯¼è‡´çš„é”™è¯¯
                for (const item of taskCart) {
                    try {
                        // ä½¿ç”¨å•ä¸ªäº§å“æŸ¥è¯¢APIéªŒè¯å•†å“æ˜¯å¦å­˜åœ¨
                        const product = await DataManager.getProductById(item.productId);
                        
                        if (!product) {
                            Utils.showAlert(`å•†å“ ${item.productName || 'æœªçŸ¥å•†å“'} (ID: ${item.productId}) ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤`, 'error');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> åˆ›å»ºå‘è´§ä»»åŠ¡';
                            return;
                        }
                        
                        // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
                        if (product.quantity < item.quantity) {
                            Utils.showAlert(`å•†å“ ${product.product_name || item.productName} åº“å­˜ä¸è¶³ (éœ€è¦: ${item.quantity}, åº“å­˜: ${product.quantity})`, 'error');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> åˆ›å»ºå‘è´§ä»»åŠ¡';
                            return;
                        }
                    } catch (validationError) {
                        // å¦‚æœè·å–å•†å“ä¿¡æ¯å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–å•†å“ç¡®å®ä¸å­˜åœ¨
                        console.error('éªŒè¯å•†å“å¤±è´¥:', validationError);
                        Utils.showAlert(`éªŒè¯å•†å“ ${item.productName || 'æœªçŸ¥å•†å“'} æ—¶å‡ºç°é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•`, 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> åˆ›å»ºå‘è´§ä»»åŠ¡';
                        return;
                    }
                }
                
                const taskData = {
                    items: taskCart.map(item => ({
                        productId: item.productId,
                        productName: item.productName,
                        productCode: item.productCode,
                        productImage: item.productImage,
                        quantity: item.quantity
                    })),
                    bodyCodeImage: taskBodyCodePreview || '',
                    bodyCodeFileName: taskBodyCodeFileName || '',
                    bodyCodeType: taskBodyCodeType || null,
                    barcodeImage: taskBarcodePreview || '',
                    barcodeFileName: taskBarcodeFileName || '',
                    barcodeType: taskBarcodeType || null,
                    warningCodeImage: taskWarningCodePreview || '',
                    warningCodeFileName: taskWarningCodeFileName || '',
                    warningCodeType: taskWarningCodeType || null,
                    labelImage: taskLabelPreview || '',
                    labelFileName: taskLabelFileName || '',
                    labelType: taskLabelType || null,
                    manualImage: taskManualPreview || '',
                    manualFileName: taskManualFileName || '',
                    manualType: taskManualType || null,
                    otherImage: taskOtherPreview || '',
                    otherFileName: taskOtherFileName || '',
                    otherType: taskOtherType || null,
                    remark: document.getElementById('taskRemark')?.value.trim() || '', // æ·»åŠ å¤‡æ³¨ä¿¡æ¯
                    creatorName: DataManager.getCurrentUser()?.username || DataManager.getCurrentUser()?.name || 'ç³»ç»Ÿç®¡ç†å‘˜',
                    status: 'pending'
                };
                

                
                const newTask = await DataManager.addTask(taskData);
                
                Utils.showAlert(`å‘è´§ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼ä»»åŠ¡å·ï¼š${newTask.taskNumber}`, 'success', async function() {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> åˆ›å»ºå‘è´§ä»»åŠ¡';
                    
                    // æ›´æ–°ä»»åŠ¡å¡ç‰‡èƒŒé¢çš„å¤‡æ³¨ä¿¡æ¯
                    if (newTask.remark && newTask.id) {
                        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå…ƒç´ å·²åˆ›å»º
                        setTimeout(() => {
                            if (typeof window.updateTaskRemarkDisplay === 'function') {
                                window.updateTaskRemarkDisplay(newTask.id.toString(), newTask.remark);
                            }
                        }, 100);
                    }
                    
                    await updateDashboard();
                    (async () => {
                        await loadSalesPublishedTasks();
                    })();
                    
                    taskCart = [];
                    selectedProduct = null;
                    
                    // æ¸…é™¤å¤‡æ³¨è¾“å…¥æ¡†
                    const remarkInput = document.getElementById('taskRemark');
                    if (remarkInput) {
                        remarkInput.value = '';
                    }
                    
                    // é‡ç½®ä¸Šä¼ åŒºåŸŸ
                    resetTaskBodyCodeUpload();
                    resetTaskBarcodeUpload();
                    resetTaskWarningCodeUpload();
                    resetTaskLabelUpload();
                    resetTaskManualUpload();
                    resetTaskOtherUpload();
                    
                    (async () => {
                        await updateMultiselectDropdown();
                    })();
                    updateSelectedTags();
                    updateTaskCart();
                });
                
            } catch (error) {
                console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                // æ£€æŸ¥é”™è¯¯æ¶ˆæ¯æ˜¯å¦ä¸å•†å“ä¸å­˜åœ¨æœ‰å…³
                let errorMessage = 'åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                if (error.message && typeof error.message === 'string') {
                    if (error.message.includes('å•†å“') && (error.message.includes('ä¸å­˜åœ¨') || error.message.includes('ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤'))) {
                        errorMessage = `åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼š${error.message}ã€‚å•†å“å¯èƒ½åœ¨æ­¤æœŸé—´è¢«åˆ é™¤æˆ–åº“å­˜å‘ç”Ÿå˜åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°é€‰æ‹©å•†å“ã€‚`;
                    } else if (error.message.includes('åº“å­˜ä¸è¶³')) {
                        errorMessage = `åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼š${error.message}ã€‚åº“å­˜å¯èƒ½åœ¨æ­¤æœŸé—´å‘ç”Ÿå˜åŒ–ï¼Œè¯·è°ƒæ•´æ•°é‡æˆ–åˆ·æ–°é¡µé¢é‡æ–°é€‰æ‹©å•†å“ã€‚`;
                    } else {
                        errorMessage = `åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼š${error.message}`;
                    }
                } else if (error.error && typeof error.error === 'string') {
                    // å¦‚æœé”™è¯¯å¯¹è±¡åŒ…å« error å±æ€§
                    if (error.error.includes('å•†å“') && (error.error.includes('ä¸å­˜åœ¨') || error.error.includes('ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤'))) {
                        errorMessage = `åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼š${error.error}ã€‚å•†å“å¯èƒ½åœ¨æ­¤æœŸé—´è¢«åˆ é™¤æˆ–åº“å­˜å‘ç”Ÿå˜åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°é€‰æ‹©å•†å“ã€‚`;
                    } else if (error.error.includes('åº“å­˜ä¸è¶³')) {
                        errorMessage = `åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼š${error.error}ã€‚åº“å­˜å¯èƒ½åœ¨æ­¤æœŸé—´å‘ç”Ÿå˜åŒ–ï¼Œè¯·è°ƒæ•´æ•°é‡æˆ–åˆ·æ–°é¡µé¢é‡æ–°é€‰æ‹©å•†å“ã€‚`;
                    } else {
                        errorMessage = `åˆ›å»ºä»»åŠ¡å¤±è´¥ï¼š${error.error}`;
                    }
                }
                Utils.showAlert(errorMessage, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> åˆ›å»ºå‘è´§ä»»åŠ¡';
            }
        }
        
        // å¸¦ç¡®è®¤çš„åˆ é™¤ä»»åŠ¡å‡½æ•°
        async function deleteTaskWithConfirmation(taskId, event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            try {
                // å…ˆå°è¯•ä»æœåŠ¡å™¨åˆ é™¤
                const success = await DataManager.deleteTask(taskId);
                if (success) {
                    // ä»UIä¸Šç«‹å³ç§»é™¤ä»»åŠ¡å…ƒç´ ï¼Œæä¾›å³æ—¶åé¦ˆ
                    // æ ¹æ®ä¸Šä¸‹æ–‡æŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡å¡ç‰‡å…ƒç´ 
                    // ç›´æ¥æŸ¥æ‰¾ä»»åŠ¡ç¿»è½¬å®¹å™¨ï¼ŒåŸºäºonclickå±æ€§
                    let taskElement = document.querySelector(`.task-flip-container[onclick*="toggleTaskCardFlip('${taskId}')"]`);
                    if (!taskElement) {
                        // å°è¯•åœ¨å·²å‘å¸ƒä»»åŠ¡å®¹å™¨ä¸­æŸ¥æ‰¾
                        taskElement = document.querySelector(`#publishedTasksBody [data-task-id="${taskId}"]`);
                    }
                    if (!taskElement) {
                        // å°è¯•åœ¨é€šç”¨ä»»åŠ¡å®¹å™¨ä¸­æŸ¥æ‰¾
                        taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                    }
                    // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œå°è¯•é€šè¿‡ä»»åŠ¡IDåœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾
                    if (!taskElement) {
                        // æœç´¢åŒ…å«ç‰¹å®šä»»åŠ¡IDçš„å…ƒç´ 
                        const allTaskElements = document.querySelectorAll('.task-flip-container');
                        for (let element of allTaskElements) {
                            if (element.onclick && element.onclick.toString().includes(taskId)) {
                                taskElement = element;
                                break;
                            }
                        }
                    }
                    if (taskElement) {
                        // æ·»åŠ è¿‡æ¸¡æ•ˆæœ
                        taskElement.style.opacity = '0';
                        taskElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        taskElement.style.transform = 'scale(0.95)';
                                                        
                        setTimeout(() => {
                            taskElement.remove();
                                                        
                            // å°è¯•æ›´æ–°ä¸åŒå¯èƒ½çš„å®¹å™¨æç¤º
                            const publishedContainer = document.getElementById('publishedTasksBody');
                            if (publishedContainer && publishedContainer.children.length === 0) {
                                publishedContainer.innerHTML = `
                                    <div class="no-tasks-message text-center text-muted py-5">
                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                        <h5>æš‚æ— å·²åˆ›å»ºä»»åŠ¡</h5>
                                        <p>æš‚æ— å¾…å¤„ç†çš„å‘è´§ä»»åŠ¡</p>
                                    </div>
                                `;
                            }
                                            
                            // æ£€æŸ¥ä»“åº“ä»»åŠ¡å®¹å™¨
                            const warehouseContainer = document.querySelector('.warehouse-tasks-gallery');
                            if (warehouseContainer && warehouseContainer.children.length === 0) {
                                warehouseContainer.innerHTML = `
                                    <div class="text-center py-5 text-muted">
                                        <i class="fas fa-check-circle fa-2x mb-3"></i>
                                        <p>æš‚æ— å¾…å‘è´§ä»»åŠ¡</p>
                                    </div>
                                `;
                            }
                        }, 300);
                    }
                }
                        
                Utils.showAlert('ä»»åŠ¡åˆ é™¤æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error("åˆ é™¤ä»»åŠ¡å¤±è´¥:", error);
                Utils.showAlert('åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // ============================================
        // ä»“åº“å‘è´§æ¨¡å—
        // ============================================
        async function loadWarehouseTasksList() {
            await updateWarehouseStats();
                    
            try {
                // é¦–å…ˆå°è¯•ä½¿ç”¨DataManagerè·å–ä»»åŠ¡
                let tasks = [];
                try {
                    tasks = await DataManager.getAllTasks();
                } catch (dmError) {
                    console.warn('DataManagerè·å–ä»»åŠ¡å¤±è´¥ï¼Œå°è¯•ç›´æ¥APIè°ƒç”¨:', dmError);
                    // å¦‚æœDataManagerå¤±è´¥ï¼Œç›´æ¥è°ƒç”¨API
                    const response = await fetch('/api/tasks');
                    if (response.ok) {
                        tasks = await response.json();
                    }
                }
                
                const pendingTasks = tasks.filter(t => t.status === 'pending').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                const container = document.getElementById('warehouseTasks');
                        
                if (!container) return;
                        
                if (pendingTasks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-check-circle fa-2x mb-3"></i>
                            <p>æš‚æ— å¾…å‘è´§ä»»åŠ¡</p>
                        </div>
                    `;
                    return;
                }
                        
                // ç”»å»Šè§†å›¾ - ç›´æ¥åœ¨ä¸»å®¹å™¨ä¸­æ˜¾ç¤ºä»»åŠ¡å¡ç‰‡
                container.innerHTML = `
                    ${pendingTasks.map((task, index) => {
                            const itemCount = task.items.reduce((sum, item) => sum + item.quantity, 0);
                            const firstItemImage = task.items.length > 0 ? task.items[0].productImage : '';
                            const creatorId = task.creatorName || task.creator_name || 'æœªçŸ¥';
                            
                            // æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨
                            if (!task.items || !Array.isArray(task.items)) {
                                console.error(`ä»»åŠ¡ ${task.id} ç¼ºå°‘æœ‰æ•ˆçš„itemsæ•°ç»„`);
                                return '';
                            }
                            
                            return `
                                <div class="task-flip-container" data-task-id="${task.id}">
                                    <!-- å¡ç‰‡æ­£é¢ -->
                                    <div class="task-front" id="task-${task.id}-front">
                                        <div class="task-gallery-img">
                                            ${firstItemImage ? 
                                                `<img src="${firstItemImage}" alt="äº§å“å›¾ç‰‡" onerror="Utils.onImageError(this)">` : 
                                                '<div class="d-flex align-items-center justify-content-center h-100"><i class="fas fa-image fa-2x text-muted"></i></div>'
                                            }
                                        </div>
                                        <div class="task-card-content d-flex align-items-center gap-2 w-100">
                                            
                                            <div class="task-info-inline d-flex align-items-center gap-2 flex-shrink-0 ms-auto">
                                                <div class="task-gallery-name" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px;">${task.items.length > 0 ? task.items[0].productName : 'æ— '}</div>
                                                <div class="task-gallery-code" data-content="${task.items.length > 0 ? task.items[0].productCode : 'æ— '}" style="font-size: 0.75rem; color: #666; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;">è´§å·: ${task.items.length > 0 ? task.items[0].productCode : 'æ— '}</div>
                                                <div class="task-gallery-qty" data-content="${itemCount}" style="font-size: 0.75rem; color: #888; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;">æ•°é‡: ${itemCount}</div>
                                                <div class="task-gallery-creator" data-content="${creatorId}" style="font-size: 0.7rem; color: #999; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px;">åˆ›å»ºäºº: ${creatorId}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- å¡ç‰‡èƒŒé¢ -->
                                    <div class="task-back">
                                        <div class="task-back-content">
                                            <div class="task-files-container">
                                                ${generateFileItem('æœ¬ä½“ç ', task.bodyCodeImage, task.bodyCodeType, task.bodyCodeFileName, task.id, 'bodyCode')}
                                                ${generateFileItem('æ¡ç ', task.barcodeImage, task.barcodeType, task.barcodeFileName, task.id, 'barcode')}
                                                ${generateFileItem('è­¦ç¤ºç ', task.warningCodeImage, task.warningCodeType, task.warningCodeFileName, task.id, 'warningCode')}
                                                ${generateFileItem('ç®±å”›', task.labelImage, task.labelType, task.labelFileName, task.id, 'label')}
                                                ${generateFileItem('è¯´æ˜ä¹¦', task.manualImage, task.manualType, task.manualFileName, task.id, 'manual')}
                                                ${generateFileItem('å…¶ä»–', task.otherImage, task.otherType, task.otherFileName, task.id, 'other')}
                                            </div>
                                            
                                            <!-- ä»»åŠ¡å¤‡æ³¨ä¿¡æ¯ -->
                                            <div class="task-remark-display warehouse-remark-display" data-task-id="${task.id}">
                                                <div class="remark-header">
                                                    <h6><i class="fas fa-sticky-note me-2"></i>ä»»åŠ¡å¤‡æ³¨</h6>
                                                </div>
                                                <div class="remark-content">
                                                    ${task.remark && task.remark.trim() ? 
                                                        `<div class="remark-text">${task.remark}</div>` : 
                                                        `<div class="remark-placeholder">æš‚æ— å¤‡æ³¨ä¿¡æ¯</div>`}
                                                </div>
                                            </div>
                                            </div>
                                            <div class="task-back-actions">
                                                <div class="back-action-buttons">
                                                    <!-- è¿”å›æŒ‰é’®å·²ç§»é™¤ -->
                                                    <button class="btn btn-sm btn-success" data-task-id="${task.id}" data-action="complete-shipment">ç¡®è®¤å‘è´§</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                        }).join('')}
                `;
                

                
                // ä¸ºæ–°ç”Ÿæˆçš„å†…å®¹ç»‘å®šäº‹ä»¶
                bindWarehouseTaskEvents();
            } catch (error) {
                console.error('åŠ è½½ä»“åº“ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                const container = document.getElementById('warehouseTasks');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-5 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>åŠ è½½ä»»åŠ¡å¤±è´¥: ${error.message}</p>
                            <button class="btn btn-primary mt-3" onclick="loadWarehouseTasksList()">
                                <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                            </button>
                        </div>
                    `;
                }
            }
        }
                
        // ä»“åº“ä»»åŠ¡è§†å›¾æ¨¡å¼ - å›ºå®šç”»å»Šè§†å›¾
        let warehouseTaskViewMode = 'gallery'; // ç”»å»Šè§†å›¾
                
        function toggleTaskDetail(taskId) {
            // ç”±äºå·²ç§»é™¤ç¿»è½¬åŠŸèƒ½ï¼Œæ­¤å‡½æ•°å¯ä»¥ä¿ç•™ä½œä¸ºç©ºå‡½æ•°æˆ–æ‰§è¡Œå…¶ä»–æ“ä½œ
            console.log('ä»»åŠ¡è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½ï¼Œå½“å‰ä¸ºå ä½å‡½æ•°');
        }
        
        // æ·»åŠ é˜²æŠ–æ§åˆ¶ï¼Œé¿å…å¿«é€Ÿç‚¹å‡»å¯¼è‡´çš„é—®é¢˜
        const flipCooldown = new Map();
        
        // toggleTaskCardFlipå‡½æ•°å·²ç§»è‡³unified_task_flip_core.jsç»Ÿä¸€ç®¡ç†
        // é¿å…å‡½æ•°å®šä¹‰å†²çª
        
        function bindWarehouseTaskEvents() {
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜æ¥å¤„ç†ä»“åº“ä»»åŠ¡å¡ç‰‡çš„æ‰€æœ‰äº¤äº’äº‹ä»¶
            const container = document.getElementById('warehouseTasks');
            
            // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
            const existingListener = container.getAttribute('data-event-listener-bound');
            if (existingListener) {
                // å¦‚æœå·²ç»æœ‰ç›‘å¬å™¨ï¼Œå…ˆç§»é™¤å®ƒ
                // æˆ‘ä»¬ä½¿ç”¨ä¸€ç§æ–¹å¼æ¥é‡æ–°ç»‘å®šäº‹ä»¶ï¼Œå³å…ˆç§»é™¤å†æ·»åŠ 
                container.removeEventListener('click', warehouseTaskEventHandler);
            }
            
            // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
            container.addEventListener('click', warehouseTaskEventHandler);
            
            // æ ‡è®°å·²ç»ç»‘å®šäº†äº‹ä»¶ç›‘å¬å™¨
            container.setAttribute('data-event-listener-bound', 'true');
        }
        
        // å®šä¹‰äº‹ä»¶å¤„ç†å‡½æ•°
        function warehouseTaskEventHandler(e) {
            // å¤„ç†ç¿»è½¬å¡ç‰‡äº‹ä»¶
            if (e.target.closest('[data-action="flip"]')) {
                e.stopPropagation();
                const button = e.target.closest('[data-action="flip"]');
                const taskId = button.getAttribute('data-task-id');
                toggleTaskCardFlip(taskId);
            }
            // å¤„ç†ç¡®è®¤å‘è´§äº‹ä»¶
            else if (e.target.closest('[data-action="complete-shipment"]')) {
                e.stopPropagation();
                const button = e.target.closest('[data-action="complete-shipment"]');
                const taskId = button.getAttribute('data-task-id');
                completeShipment(taskId);
            }
            // å¤„ç†æ•´ä¸ªç¿»è½¬å®¹å™¨çš„ç‚¹å‡»äº‹ä»¶ï¼ˆä¹Ÿå¯ä»¥ç¿»è½¬å¡ç‰‡ï¼‰
            else if (e.target.closest('.task-flip-container')) {
                const container = e.target.closest('.task-flip-container');
                const taskId = container.getAttribute('data-task-id');
                if (taskId) {
                    toggleTaskCardFlip(taskId);
                }
            }
        }
        
        function handleFileSelect(e, uploadAreaId) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*') && !Utils.isPDF(file)) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadArea = document.getElementById(uploadAreaId);
                let previewHtml = '';
                if (Utils.isPDF(file)) {
                    previewHtml = `
                        <div class="upload-preview pdf">
                            <i class="fas fa-file-pdf" style="font-size: 2.5rem; color: #e74c3c;"></i>
                        </div>
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${file.name}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">PDFæ–‡ä»¶</div>
                    `;
                } else {
                    previewHtml = `
                        <img src="${e.target.result}" class="upload-preview" style="max-width: 100px; max-height: 100px;" alt="é¢„è§ˆ" onerror="Utils.onImageError(this)">
                        <div style="font-weight: 500; margin-bottom: 4px; font-size: 0.85rem;">${file.name}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-bottom: 8px;">å·²ä¸Šä¼ æ–‡ä»¶</div>
                    `;
                }
                
                uploadArea.innerHTML = `
                    <button type="button" class="upload-remove-btn" onclick="resetEditTaskFile('${uploadAreaId}')">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="text-align: left; width: 100%;">
                        ${previewHtml}
                    </div>
                `;
                uploadArea.classList.add('has-file');
                
                // ä¿å­˜æ–‡ä»¶åˆ°å…¨å±€å˜é‡ï¼Œç”¨äºåç»­ä¸Šä¼ 
                if (uploadAreaId === 'editBodyCodeUpload') {
                    editTaskBodyCodeFile = file;
                    editTaskBodyCodeData = e.target.result;
                } else if (uploadAreaId === 'editBarcodeUpload') {
                    editTaskBarcodeFile = file;
                    editTaskBarcodeData = e.target.result;
                } else if (uploadAreaId === 'editWarningCodeUpload') {
                    editTaskWarningCodeFile = file;
                    editTaskWarningCodeData = e.target.result;
                } else if (uploadAreaId === 'editLabelUpload') {
                    editTaskLabelFile = file;
                    editTaskLabelData = e.target.result;
                } else if (uploadAreaId === 'editManualUpload') {
                    editTaskManualFile = file;
                    editTaskManualData = e.target.result;
                }
            };
            reader.readAsDataURL(file);
        }
        
        function handleFileDrop(event, uploadAreaId) {
            event.preventDefault();
            document.getElementById(uploadAreaId).classList.remove('dragover');
            
            const file = event.dataTransfer.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*') && !Utils.isPDF(file)) {
                Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                return;
            }
            
            const fakeEvent = { target: { files: [file] } };
            handleFileSelect(fakeEvent, uploadAreaId);
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.target.classList.add('dragover');
        }
        
        function resetEditTaskFile(uploadAreaId) {
            const uploadArea = document.getElementById(uploadAreaId);
            if (uploadAreaId === 'editBodyCodeUpload') {
                editTaskBodyCodeFile = null;
                editTaskBodyCodeData = null;
            } else if (uploadAreaId === 'editBarcodeUpload') {
                editTaskBarcodeFile = null;
                editTaskBarcodeData = null;
            } else if (uploadAreaId === 'editWarningCodeUpload') {
                editTaskWarningCodeFile = null;
                editTaskWarningCodeData = null;
            } else if (uploadAreaId === 'editLabelUpload') {
                editTaskLabelFile = null;
                editTaskLabelData = null;
            } else if (uploadAreaId === 'editManualUpload') {
                editTaskManualFile = null;
                editTaskManualData = null;
            }
            
            // é‡ç½®ä¸Šä¼ åŒºåŸŸå†…å®¹
            uploadArea.innerHTML = `
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                <div class="upload-hint">æ”¯æŒJPGã€PNGã€PDFæ ¼å¼</div>
            `;
            uploadArea.classList.remove('has-file');
        }
        
        function editTaskFiles(taskId) {
            // æŸ¥æ‰¾ä»»åŠ¡è¯¦æƒ…
            (async function() {
                try {
                    const task = await DataManager.getTaskById(taskId);
                    if (!task) {
                        Utils.showAlert('ä»»åŠ¡ä¸å­˜åœ¨ï¼', 'error');
                        return;
                    }
                    
                    // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ¥ç¼–è¾‘ä»»åŠ¡æ–‡ä»¶
                    const modalHtml = `
                    <div class="modal fade" id="editTaskFilesModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">ç¼–è¾‘ä»»åŠ¡æ–‡ä»¶ - ${task.taskNumber}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group mb-3">
                                        <label for="editBodyCodeFile">ä¸Šä¼ æœ¬ä½“ç </label>
                                        <div class="upload-area" id="editBodyCodeUpload" ondrop="handleFileDrop(event, 'editBodyCodeUpload')" ondragover="handleDragOver(event)">
                                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                            <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                                            <div class="upload-hint">æ”¯æŒJPGã€PNGã€PDFæ ¼å¼</div>
                                            ${task.bodyCodeImage ? `<div class="upload-preview-container mt-2"><img src="${task.bodyCodeImage}" alt="æœ¬ä½“ç é¢„è§ˆ" style="max-width: 100px; max-height: 100px;" onerror="Utils.onImageError(this)"></div>` : ''}
                                        </div>
                                        <input type="file" id="editBodyCodeFile" accept="image/*,application/pdf" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group mb-3">
                                        <label for="editBarcodeFile">ä¸Šä¼ æ¡ç </label>
                                        <div class="upload-area" id="editBarcodeUpload" ondrop="handleFileDrop(event, 'editBarcodeUpload')" ondragover="handleDragOver(event)">
                                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                            <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                                            <div class="upload-hint">æ”¯æŒJPGã€PNGã€PDFæ ¼å¼</div>
                                            ${task.barcodeImage ? `<div class="upload-preview-container mt-2"><img src="${task.barcodeImage}" alt="æ¡ç é¢„è§ˆ" style="max-width: 100px; max-height: 100px;" onerror="Utils.onImageError(this)"></div>` : ''}
                                        </div>
                                        <input type="file" id="editBarcodeFile" accept="image/*,application/pdf" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group mb-3">
                                        <label for="editWarningCodeFile">ä¸Šä¼ è­¦ç¤ºç </label>
                                        <div class="upload-area" id="editWarningCodeUpload" ondrop="handleFileDrop(event, 'editWarningCodeUpload')" ondragover="handleDragOver(event)">
                                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                            <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                                            <div class="upload-hint">æ”¯æŒJPGã€PNGã€PDFæ ¼å¼</div>
                                            ${task.warningCodeImage ? `<div class="upload-preview-container mt-2"><img src="${task.warningCodeImage}" alt="è­¦ç¤ºç é¢„è§ˆ" style="max-width: 100px; max-height: 100px;" onerror="Utils.onImageError(this)"></div>` : ''}
                                        </div>
                                        <input type="file" id="editWarningCodeFile" accept="image/*,application/pdf" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group mb-3">
                                        <label for="editLabelFile">ä¸Šä¼ ç®±å”›</label>
                                        <div class="upload-area" id="editLabelUpload" ondrop="handleFileDrop(event, 'editLabelUpload')" ondragover="handleDragOver(event)">
                                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                            <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                                            <div class="upload-hint">æ”¯æŒJPGã€PNGã€PDFæ ¼å¼</div>
                                            ${task.labelImage ? `<div class="upload-preview-container mt-2"><img src="${task.labelImage}" alt="ç®±å”›é¢„è§ˆ" style="max-width: 100px; max-height: 100px;" onerror="Utils.onImageError(this)"></div>` : ''}
                                        </div>
                                        <input type="file" id="editLabelFile" accept="image/*,application/pdf" style="display: none;">
                                    </div>
                                    
                                    <div class="form-group mb-3">
                                        <label for="editManualFile">ä¸Šä¼ è¯´æ˜ä¹¦</label>
                                        <div class="upload-area" id="editManualUpload" ondrop="handleFileDrop(event, 'editManualUpload')" ondragover="handleDragOver(event)">
                                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                            <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                                            <div class="upload-hint">æ”¯æŒJPGã€PNGã€PDFæ ¼å¼</div>
                                            ${task.manualImage ? `<div class="upload-preview-container mt-2"><img src="${task.manualImage}" alt="è¯´æ˜ä¹¦é¢„è§ˆ" style="max-width: 100px; max-height: 100px;" onerror="Utils.onImageError(this)"></div>` : ''}
                                        </div>
                                        <input type="file" id="editManualFile" accept="image/*,application/pdf" style="display: none;">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                                    <button type="button" class="btn btn-primary" onclick="saveTaskFiles('${task.id}')">ä¿å­˜æ›´æ”¹</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    
                    // å°†æ¨¡æ€æ¡†æ·»åŠ åˆ°é¡µé¢ä¸­
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    const modalElement = document.getElementById('editTaskFilesModal');
                    const bsModal = new bootstrap.Modal(modalElement);
                    bsModal.show();
                    
                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    document.getElementById('editBodyCodeUpload').addEventListener('click', () => {
                        document.getElementById('editBodyCodeFile').click();
                    });
                    
                    document.getElementById('editBarcodeUpload').addEventListener('click', () => {
                        document.getElementById('editBarcodeFile').click();
                    });
                    
                    document.getElementById('editWarningCodeUpload').addEventListener('click', () => {
                        document.getElementById('editWarningCodeFile').click();
                    });
                    
                    document.getElementById('editLabelUpload').addEventListener('click', () => {
                        document.getElementById('editLabelFile').click();
                    });
                    
                    document.getElementById('editManualUpload').addEventListener('click', () => {
                        document.getElementById('editManualFile').click();
                    });
                    
                    // æ–‡ä»¶é€‰æ‹©äº‹ä»¶ç›‘å¬
                    document.getElementById('editBodyCodeFile').addEventListener('change', function(e) {
                        handleFileSelect(e, 'editBodyCodeUpload');
                    });
                    
                    document.getElementById('editBarcodeFile').addEventListener('change', function(e) {
                        handleFileSelect(e, 'editBarcodeUpload');
                    });
                    
                    document.getElementById('editWarningCodeFile').addEventListener('change', function(e) {
                        handleFileSelect(e, 'editWarningCodeUpload');
                    });
                    
                    document.getElementById('editLabelFile').addEventListener('change', function(e) {
                        handleFileSelect(e, 'editLabelUpload');
                    });
                    
                    document.getElementById('editManualFile').addEventListener('change', function(e) {
                        handleFileSelect(e, 'editManualUpload');
                    });
                    
                    // æ¨¡æ€æ¡†å…³é—­æ—¶æ¸…ç†
                    modalElement.addEventListener('hidden.bs.modal', function() {
                        modalElement.remove();
                    });
                } catch (error) {
                    console.error('ç¼–è¾‘ä»»åŠ¡æ–‡ä»¶å¤±è´¥:', error);
                    Utils.showAlert('ç¼–è¾‘ä»»åŠ¡æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            })();
        }
        
        // å®šä¹‰å…¨å±€å˜é‡æ¥å­˜å‚¨ç¼–è¾‘çš„æ–‡ä»¶
        let editTaskBodyCodeFile = null;
        let editTaskBodyCodeData = null;
        let editTaskBarcodeFile = null;
        let editTaskBarcodeData = null;
        let editTaskWarningCodeFile = null;
        let editTaskWarningCodeData = null;
        let editTaskLabelFile = null;
        let editTaskLabelData = null;
        let editTaskManualFile = null;
        let editTaskManualData = null;
        let editTaskOtherFile = null;
        let editTaskOtherData = null;
        
        async function saveTaskFiles(taskId) {
            try {
                // è·å–å½“å‰ä»»åŠ¡æ•°æ®
                const task = await DataManager.getTaskById(taskId);
                if (!task) {
                    Utils.showAlert('ä»»åŠ¡ä¸å­˜åœ¨ï¼', 'error');
                    return;
                }
                
                // å‡†å¤‡æ›´æ–°æ•°æ®
                const updateData = {};
                
                // å¦‚æœæœ‰æ–°çš„æœ¬ä½“ç æ–‡ä»¶ï¼Œå¤„ç†å¹¶æ›´æ–°
                if (editTaskBodyCodeData) {
                    updateData.bodyCodeImage = editTaskBodyCodeData;
                    updateData.bodyCodeType = Utils.isPDF(editTaskBodyCodeFile) ? 'pdf' : 'image';
                    updateData.bodyCodeFileName = editTaskBodyCodeFile.name;
                }
                
                // å¦‚æœæœ‰æ–°çš„æ¡ç æ–‡ä»¶ï¼Œå¤„ç†å¹¶æ›´æ–°
                if (editTaskBarcodeData) {
                    updateData.barcodeImage = editTaskBarcodeData;
                    updateData.barcodeType = Utils.isPDF(editTaskBarcodeFile) ? 'pdf' : 'image';
                    updateData.barcodeFileName = editTaskBarcodeFile.name;
                }
                
                // å¦‚æœæœ‰æ–°çš„è­¦ç¤ºç æ–‡ä»¶ï¼Œå¤„ç†å¹¶æ›´æ–°
                if (editTaskWarningCodeData) {
                    updateData.warningCodeImage = editTaskWarningCodeData;
                    updateData.warningCodeType = Utils.isPDF(editTaskWarningCodeFile) ? 'pdf' : 'image';
                    updateData.warningCodeFileName = editTaskWarningCodeFile.name;
                }
                
                // å¦‚æœæœ‰æ–°çš„ç®±å”›æ–‡ä»¶ï¼Œå¤„ç†å¹¶æ›´æ–°
                if (editTaskLabelData) {
                    updateData.labelImage = editTaskLabelData;
                    updateData.labelType = Utils.isPDF(editTaskLabelFile) ? 'pdf' : 'image';
                    updateData.labelFileName = editTaskLabelFile.name;
                }
                
                // å¦‚æœæœ‰æ–°çš„è¯´æ˜ä¹¦æ–‡ä»¶ï¼Œå¤„ç†å¹¶æ›´æ–°
                if (editTaskManualData) {
                    updateData.manualImage = editTaskManualData;
                    updateData.manualType = Utils.isPDF(editTaskManualFile) ? 'pdf' : 'image';
                    updateData.manualFileName = editTaskManualFile.name;
                }
                
                // å¦‚æœæœ‰æ–°çš„å…¶ä»–æ–‡ä»¶ï¼Œå¤„ç†å¹¶æ›´æ–°
                if (editTaskOtherData) {
                    updateData.otherImage = editTaskOtherData;
                    updateData.otherType = Utils.isPDF(editTaskOtherFile) ? 'pdf' : 'image';
                    updateData.otherFileName = editTaskOtherFile.name;
                }
                
                // æ›´æ–°ä»»åŠ¡
                const success = await DataManager.updateTask(taskId, updateData);
                if (success) {
                    Utils.showAlert('ä»»åŠ¡æ–‡ä»¶æ›´æ–°æˆåŠŸï¼', 'success', function() {
                        // å…³é—­æ¨¡æ€æ¡†
                        const modalElement = document.querySelector('#editTaskFilesModal');
                        if (modalElement) {
                            const bsModal = bootstrap.Modal.getInstance(modalElement);
                            if (bsModal) {
                                bsModal.hide();
                            }
                        }
                        
                        // é‡ç½®å…¨å±€å˜é‡
                        editTaskBodyCodeFile = null;
                        editTaskBodyCodeData = null;
                        editTaskBarcodeFile = null;
                        editTaskBarcodeData = null;
                        editTaskWarningCodeFile = null;
                        editTaskWarningCodeData = null;
                        editTaskLabelFile = null;
                        editTaskLabelData = null;
                        editTaskManualFile = null;
                        editTaskManualData = null;
                        editTaskOtherFile = null;
                        editTaskOtherData = null;
                        
                        // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                        loadSalesPublishedTasks();
                    });
                } else {
                    Utils.showAlert('æ›´æ–°ä»»åŠ¡æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜ä»»åŠ¡æ–‡ä»¶å¤±è´¥:', error);
                Utils.showAlert('ä¿å­˜ä»»åŠ¡æ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function deleteWarehouseTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¾…å‘è´§ä»»åŠ¡å—ï¼Ÿåˆ é™¤åå•†å“åº“å­˜å°†æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const success = await DataManager.deleteTask(taskId);
                if (success) {
                    // ä»UIä¸Šç«‹å³ç§»é™¤ä»»åŠ¡å…ƒç´ ï¼Œæä¾›å³æ—¶åé¦ˆ
                    // å¯¹äºä»“åº“ä»»åŠ¡ï¼ŒæŸ¥æ‰¾idä¸ºtask-${taskId}çš„å…ƒç´ 
                    const taskElement = document.getElementById(`task-${taskId}`);
                    if (taskElement) {
                        taskElement.style.opacity = '0';
                        taskElement.style.transform = 'translateX(-100%)';
                        taskElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        
                        setTimeout(() => {
                            taskElement.remove();
                            
                            // å¦‚æœä»»åŠ¡åˆ—è¡¨ä¸ºç©ºï¼Œæ˜¾ç¤ºç›¸åº”æç¤º
                            const container = document.getElementById('warehouseTasks');
                            if (container && container.children.length === 0) {
                                container.innerHTML = `
                                    <div class="text-center py-5 text-muted">
                                        <i class="fas fa-check-circle fa-2x mb-3"></i>
                                        <p>æš‚æ— å¾…å‘è´§ä»»åŠ¡</p>
                                    </div>
                                `;
                            }
                        }, 300);
                    }
                    
                    Utils.showAlert('ä»»åŠ¡åˆ é™¤æˆåŠŸï¼å•†å“åº“å­˜å·²æ¢å¤ã€‚', 'success', async function() {
                        if (expandedTaskId === taskId) {
                            expandedTaskId = null;
                        }
                        
                        await updateDashboard();
                        
                        // ç¡®ä¿æ•°æ®å®Œå…¨åŒæ­¥åå†é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                        // å»¶é•¿ç­‰å¾…æ—¶é—´ä»¥ç¡®ä¿æœåŠ¡å™¨å®Œå…¨å¤„ç†åˆ é™¤æ“ä½œ
                        await new Promise(resolve => setTimeout(resolve, 800));
                        
                        // é‡æ–°åŠ è½½æ‰€æœ‰ç›¸å…³çš„ä»»åŠ¡åˆ—è¡¨
                        loadWarehouseTasksList();
                        await loadSalesPublishedTasks();
                    });
                } else {
                    Utils.showAlert('åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                Utils.showAlert('åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        async function completeShipment(taskId) {
            // é˜²æ­¢é‡å¤ç‚¹å‡»ï¼Œæ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²ç»åœ¨å¤„ç†ä¸­
            const processShipmentBtn = document.querySelector(`[data-task-id="${taskId}"][data-action="flip"]`);
            const confirmShipmentBtn = document.querySelector(`[data-task-id="${taskId}"][data-action="complete-shipment"]`);
            
            if ((processShipmentBtn && processShipmentBtn.disabled) || 
                (confirmShipmentBtn && confirmShipmentBtn.disabled)) {
                // å¦‚æœä»»ä¸€æŒ‰é’®å·²ç»è¢«ç¦ç”¨ï¼Œè¯´æ˜æ­£åœ¨å¤„ç†ä¸­ï¼Œç›´æ¥è¿”å›
                return;
            }
            
            // åœ¨å¤„ç†å¼€å§‹å‰ï¼Œå…ˆç¦ç”¨æŒ‰é’®ä»¥é˜²æ­¢é‡å¤ç‚¹å‡»
            if (processShipmentBtn) {
                processShipmentBtn.disabled = true;
                processShipmentBtn.style.opacity = "0.5";
                processShipmentBtn.style.cursor = "not-allowed";
                processShipmentBtn.textContent = "å¤„ç†ä¸­...";
            }
            
            // åŒæ—¶ä¹Ÿç¦ç”¨ç¡®è®¤å‘è´§æŒ‰é’®
            if (confirmShipmentBtn) {
                confirmShipmentBtn.disabled = true;
                confirmShipmentBtn.style.opacity = "0.5";
                confirmShipmentBtn.style.cursor = "not-allowed";
                confirmShipmentBtn.textContent = "å¤„ç†ä¸­...";
            }
            
            // ä½¿ç”¨åŸç”Ÿconfirmæ›¿ä»£æŸåçš„alertify.confirmè°ƒç”¨
            if (!confirm('ç¡®å®šè¦æ ‡è®°æ­¤ä»»åŠ¡ä¸º"å·²å‘è´§"å—ï¼Ÿ')) {
                // ç”¨æˆ·å–æ¶ˆæ“ä½œï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                if (processShipmentBtn) {
                    processShipmentBtn.disabled = false;
                    processShipmentBtn.style.opacity = "1";
                    processShipmentBtn.style.cursor = "pointer";
                    processShipmentBtn.textContent = "å¤„ç†å‘è´§";
                }
                if (confirmShipmentBtn) {
                    confirmShipmentBtn.disabled = false;
                    confirmShipmentBtn.style.opacity = "1";
                    confirmShipmentBtn.style.cursor = "pointer";
                    confirmShipmentBtn.textContent = "ç¡®è®¤å‘è´§";
                }
                return;
            }
            
            try {
                // å…ˆè·å–ä»»åŠ¡è¯¦æƒ…ï¼Œå› ä¸ºåç»­ä¼šæ›´æ–°å’Œåˆ é™¤ä»»åŠ¡
                const task = await DataManager.getTaskById(taskId);
                if (!task) {
                    Utils.showAlert('ä»»åŠ¡ä¸å­˜åœ¨ï¼', 'error');
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (processShipmentBtn) {
                        processShipmentBtn.disabled = false;
                        processShipmentBtn.style.opacity = "1";
                        processShipmentBtn.style.cursor = "pointer";
                        processShipmentBtn.textContent = "å¤„ç†å‘è´§";
                    }
                    if (confirmShipmentBtn) {
                        confirmShipmentBtn.disabled = false;
                        confirmShipmentBtn.style.opacity = "1";
                        confirmShipmentBtn.style.cursor = "pointer";
                        confirmShipmentBtn.textContent = "ç¡®è®¤å‘è´§";
                    }
                    return;
                }

                // ç›´æ¥è°ƒç”¨å®Œæˆä»»åŠ¡çš„APIï¼Œè¿™ä¼šå°†ä»»åŠ¡ç§»åŠ¨åˆ°å†å²è¡¨
                const response = await fetch(`${DataManager.API_BASE}/api/tasks/${taskId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN)}`
                    }
                });

                if (response.ok) {
                    const products = await DataManager.getAllProducts();
                    const taskWithPrice = {
                        ...task,
                        items: task.items.map(item => {
                            const product = products.find(p => p.id === item.productId);
                            return {
                                ...item,
                                purchasePrice: product ? product.purchasePrice : 0,
                                salePrice: product ? product.salePrice : 0
                            };
                        })
                    };

                    // æ›´æ–°é”€å”®è¿è¥ç«¯ä»»åŠ¡å¡ç‰‡ä¸Šçš„çŠ¶æ€æ ‡ç­¾ï¼Œè€Œä¸æ˜¯ç§»é™¤å…ƒç´ 
                    // å…ˆå°è¯•æŸ¥æ‰¾ä»“åº“ä»»åŠ¡å…ƒç´ ï¼ˆidä¸ºtask-ï¼‰
                    let taskElement = document.getElementById(`task-${taskId}-front`);

                    // å¦‚æœæ²¡æ‰¾åˆ°ä»“åº“ä»»åŠ¡ï¼Œåˆ™å°è¯•æŸ¥æ‰¾é”€å”®å‘å¸ƒçš„ä»»åŠ¡å…ƒç´ ï¼ˆdata-task-idå±æ€§ï¼‰
                    if (!taskElement) {
                        taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                    }

                    if (taskElement) {
                        // æŸ¥æ‰¾å¹¶æ›´æ–°çŠ¶æ€æ ‡ç­¾
                        const statusBadge = taskElement.querySelector('.badge.badge-warning.flex-fill.text-center');
                        if (statusBadge) {
                            statusBadge.textContent = 'å·²å‘è´§';
                            statusBadge.classList.remove('badge-warning');
                            statusBadge.classList.add('badge-success');
                        }

                        // ç¦ç”¨å¤„ç†å‘è´§æŒ‰é’®
                        const processShipmentBtn = taskElement.querySelector('button[data-action="flip"]');
                        if (processShipmentBtn) {
                            processShipmentBtn.disabled = true;
                            processShipmentBtn.style.opacity = '0.5';
                            processShipmentBtn.style.cursor = 'not-allowed';
                            processShipmentBtn.textContent = 'å·²å‘è´§';
                        }

                        // ç¦ç”¨ç¡®è®¤å‘è´§æŒ‰é’®ï¼ˆå¦‚æœåœ¨èƒŒé¢ï¼‰
                        const confirmShipmentBtn = taskElement.querySelector('button[data-action="complete-shipment"]');
                        if (confirmShipmentBtn) {
                            confirmShipmentBtn.disabled = true;
                            confirmShipmentBtn.style.opacity = '0.5';
                            confirmShipmentBtn.style.cursor = 'not-allowed';
                            confirmShipmentBtn.textContent = 'å·²å‘è´§';
                        }
                    }

                    Utils.showAlert('ä»»åŠ¡å·²å®Œæˆå‘è´§ï¼', 'success', function() {
                        // ç«‹å³æ›´æ–°UIçŠ¶æ€ï¼Œæä¾›å³æ—¶åé¦ˆ
                        expandedTaskId = null;

                        // å¹¶è¡Œæ›´æ–°ä»ªè¡¨æ¿å’Œä»»åŠ¡åˆ—è¡¨ï¼Œæé«˜æ•ˆç‡
                        updateDashboard();
                        loadWarehouseTasksList().then(() => {
                            // é‡æ–°ç»‘å®šä»“åº“ä»»åŠ¡äº‹ä»¶ï¼Œç¡®ä¿æ–°æ¸²æŸ“çš„å…ƒç´ æœ‰æ­£ç¡®çš„äº‹ä»¶å¤„ç†
                            bindWarehouseTaskEvents();
                        });
                        loadSalesPublishedTasks();
                    });
                } else {
                    // å¦‚æœå“åº”ä¸æ˜¯okçŠ¶æ€ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    const errorData = await response.text();
                    console.error('å®Œæˆå‘è´§ä»»åŠ¡å¤±è´¥:', response.status, errorData);
                    Utils.showAlert(`å®Œæˆå‘è´§ä»»åŠ¡å¤±è´¥: ${response.status}`, 'error');
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (processShipmentBtn) {
                        processShipmentBtn.disabled = false;
                        processShipmentBtn.style.opacity = "1";
                        processShipmentBtn.style.cursor = "pointer";
                        processShipmentBtn.textContent = "å¤„ç†å‘è´§";
                    }
                    if (confirmShipmentBtn) {
                        confirmShipmentBtn.disabled = false;
                        confirmShipmentBtn.style.opacity = "1";
                        confirmShipmentBtn.style.cursor = "pointer";
                        confirmShipmentBtn.textContent = "ç¡®è®¤å‘è´§";
                    }
                }
            } catch (error) {
                console.error('å®Œæˆå‘è´§ä»»åŠ¡å¤±è´¥:', error);
                Utils.showAlert('å®Œæˆå‘è´§ä»»åŠ¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (processShipmentBtn) {
                    processShipmentBtn.disabled = false;
                    processShipmentBtn.style.opacity = "1";
                    processShipmentBtn.style.cursor = "pointer";
                    processShipmentBtn.textContent = "å¤„ç†å‘è´§";
                }
                if (confirmShipmentBtn) {
                    confirmShipmentBtn.disabled = false;
                    confirmShipmentBtn.style.opacity = "1";
                    confirmShipmentBtn.style.cursor = "pointer";
                    confirmShipmentBtn.textContent = "ç¡®è®¤å‘è´§";
                }
            }
        }
        // é¢„è§ˆä»»åŠ¡æœ¬ä½“ç 
        function previewTaskBodyCode(taskId) {
            const task = DataManager.getTaskById(taskId);
            if (!task || !task.bodyCodeImage) return;
            
            const printWindow = window.open('', '_blank');
            if (task.bodyCodeType === 'pdf') {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>ä»»åŠ¡æœ¬ä½“ç é¢„è§ˆ - ${task.taskNumber}</title>
                        <style>
                            body { font-family: Arial; padding: 40px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                            .pdf-container { width: 100%; height: 90vh; }
                            iframe { width: 100%; height: 100%; border: none; }
                            .pdf-info { margin-top: 20px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <div class="pdf-container">
                            <iframe src="${task.bodyCodeImage}"></iframe>
                        </div>
                        <div class="pdf-info">
                            <h3>${task.bodyCodeFileName}</h3>
                            <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                        </div>
                    </body>
                    </html>
                `);
            } else {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>ä»»åŠ¡æœ¬ä½“ç é¢„è§ˆ - ${task.taskNumber}</title>
                        <style>
                            body { font-family: Arial; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                            img { max-width: 100%; max-height: 90vh; }
                            .image-info { margin-top: 20px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <img src="${task.bodyCodeImage}" alt="ä»»åŠ¡æœ¬ä½“ç " onerror="Utils.onImageError(this)">
                        <div class="image-info">
                            <h3>ä»»åŠ¡æœ¬ä½“ç </h3>
                            <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                        </div>
                    </body>
                    </html>
                `);
            }
            printWindow.document.close();
        }

        // é¢„è§ˆä»»åŠ¡æ¡ç 
        function previewTaskBarcode(taskId) {
            const task = DataManager.getTaskById(taskId);
            if (!task || !task.barcodeImage) return;
            
            const printWindow = window.open('', '_blank');
            if (task.barcodeType === 'pdf') {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>ä»»åŠ¡æ¡ç é¢„è§ˆ - ${task.taskNumber}</title>
                        <style>
                            body { font-family: Arial; padding: 40px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                            .pdf-container { width: 100%; height: 90vh; }
                            iframe { width: 100%; height: 100%; border: none; }
                            .pdf-info { margin-top: 20px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <div class="pdf-container">
                            <iframe src="${task.barcodeImage}"></iframe>
                        </div>
                        <div class="pdf-info">
                            <h3>${task.barcodeFileName}</h3>
                            <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                        </div>
                    </body>
                    </html>
                `);
            } else {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>ä»»åŠ¡æ¡ç é¢„è§ˆ - ${task.taskNumber}</title>
                        <style>
                            body { font-family: Arial; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                            img { max-width: 100%; max-height: 90vh; }
                            .image-info { margin-top: 20px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <img src="${task.barcodeImage}" alt="ä»»åŠ¡æ¡ç " onerror="Utils.onImageError(this)">
                        <div class="image-info">
                            <h3>ä»»åŠ¡æ¡ç </h3>
                            <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                        </div>
                    </body>
                    </html>
                `);
            }
            printWindow.document.close();
        }
        
        // é¢„è§ˆä»»åŠ¡è­¦ç¤ºç 
        function previewTaskWarningCode(taskId) {
            const task = DataManager.getTaskById(taskId);
            if (!task || !task.warningCodeImage) return;
            
            const printWindow = window.open('', '_blank');
            if (task.warningCodeType === 'pdf') {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="zh-CN">
                    <head>
                        <title>ä»»åŠ¡è­¦ç¤ºç é¢„è§ˆ - ${task.taskNumber}</title>
                        <style>
                            body { font-family: Arial; padding: 40px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                            .pdf-container { width: 100%; height: 90vh; }
                            iframe { width: 100%; height: 100%; border: none; }
                            .pdf-info { margin-top: 20px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <div class="pdf-container">
                            <iframe src="${task.warningCodeImage}"></iframe>
                        </div>
                        <div class="pdf-info">
                            <h3>${task.warningCodeFileName}</h3>
                            <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                        </div>
                    </body>
                    </html>
                `);
            } else {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="zh-CN">
                    <head>
                        <title>ä»»åŠ¡è­¦ç¤ºç é¢„è§ˆ - ${task.taskNumber}</title>
                        <style>
                            body { font-family: Arial; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                            img { max-width: 100%; max-height: 90vh; }
                            .image-info { margin-top: 20px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <img src="${task.warningCodeImage}" alt="ä»»åŠ¡è­¦ç¤ºç " onerror="Utils.onImageError(this)">
                        <div class="image-info">
                            <h3>ä»»åŠ¡è­¦ç¤ºç </h3>
                            <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                        </div>
                    </body>
                    </html>
                `);
            }
            printWindow.document.close();
        }

        // é¢„è§ˆä»»åŠ¡ç®±å”›
        function previewTaskLabel(taskId) {
            const task = DataManager.getTaskById(taskId);
            if (!task || !task.labelImage) return;
            
            const printWindow = window.open('', '_blank');
            if (task.labelType === 'pdf') {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="zh-CN">
                    <head>
                        <title>ä»»åŠ¡ç®±å”›é¢„è§ˆ - ${task.taskNumber}</title>
                        <style>
                            body { font-family: Arial; padding: 40px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                            .pdf-container { width: 100%; height: 90vh; }
                            iframe { width: 100%; height: 100%; border: none; }
                            .pdf-info { margin-top: 20px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <div class="pdf-container">
                            <iframe src="${task.labelImage}"></iframe>
                        </div>
                        <div class="pdf-info">
                            <h3>${task.labelFileName}</h3>
                            <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                        </div>
                    </body>
                    </html>
                `);
            } else {
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="zh-CN">
                    <head>
                        <title>ä»»åŠ¡ç®±å”›é¢„è§ˆ - ${task.taskNumber}</title>
                        <style>
                            body { font-family: Arial; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                            img { max-width: 100%; max-height: 90vh; }
                            .image-info { margin-top: 20px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <img src="${task.labelImage}" alt="ä»»åŠ¡ç®±å”›" onerror="Utils.onImageError(this)">
                        <div class="image-info">
                            <h3>ä»»åŠ¡ç®±å”›</h3>
                            <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                        </div>
                    </body>
                    </html>
                `);
            }
            printWindow.document.close();
        }

        // é€šç”¨ä»»åŠ¡æ–‡ä»¶é¢„è§ˆå‡½æ•°
        async function previewTaskFile(taskId, fileType) {
            try {
                const task = await DataManager.getTaskById(taskId);
                if (!task) {
                    Utils.showAlert('ä»»åŠ¡ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                let fileUrl, fileName, fileTitle, fileTypeValue;
                
                // æ ¹æ®æ–‡ä»¶ç±»å‹è®¾ç½®å¯¹åº”çš„å±æ€§ï¼ŒåŒæ—¶å¤„ç†å¯èƒ½çš„å­—æ®µé”™ä½é—®é¢˜
                switch(fileType) {
                    case 'bodyCode':
                        // å°è¯•å¤šç§å¯èƒ½çš„å­—æ®µåä»¥åº”å¯¹å­—æ®µé”™ä½é—®é¢˜
                        fileUrl = task.bodyCodeImage || task.body_code_image || '';
                        fileName = task.bodyCodeFileName || task.body_code_file_name || task.bodyCode_file_name || '';
                        fileTypeValue = task.bodyCodeType || task.body_code_type || null;
                        fileTitle = 'æœ¬ä½“ç ';
                        break;
                    case 'barcode':
                        fileUrl = task.barcodeImage || task.barcode_image || '';
                        fileName = task.barcodeFileName || task.barcode_file_name || task.barcode_file_name || '';
                        fileTypeValue = task.barcodeType || task.barcode_type || null;
                        fileTitle = 'æ¡ç ';
                        break;
                    case 'warningCode':
                        fileUrl = task.warningCodeImage || task.warning_code_image || '';
                        fileName = task.warningCodeFileName || task.warning_code_file_name || task.warningCode_file_name || '';
                        fileTypeValue = task.warningCodeType || task.warning_code_type || null;
                        fileTitle = 'è­¦ç¤ºç ';
                        break;
                    case 'label':
                        fileUrl = task.labelImage || task.label_image || '';
                        fileName = task.labelFileName || task.label_file_name || task.label_file_name || '';
                        fileTypeValue = task.labelType || task.label_type || null;
                        fileTitle = 'ç®±å”›';
                        break;
                    case 'manual':
                        fileUrl = task.manualImage || task.manual_image || '';
                        fileName = task.manualFileName || task.manual_file_name || task.manual_file_name || '';
                        fileTypeValue = task.manualType || task.manual_type || null;
                        fileTitle = 'è¯´æ˜ä¹¦';
                        break;
                    case 'other':
                        fileUrl = task.otherImage || task.other_image || '';
                        fileName = task.otherFileName || task.other_file_name || task.other_file_name || '';
                        fileTypeValue = task.otherType || task.other_type || null;
                        fileTitle = 'å…¶ä»–';
                        break;
                    default:
                        console.error('æœªçŸ¥çš„æ–‡ä»¶ç±»å‹:', fileType);
                        Utils.showAlert('æœªçŸ¥çš„æ–‡ä»¶ç±»å‹', 'error');
                        return;
                }
                
                // æ·»åŠ è°ƒè¯•æ—¥å¿—
                console.log('previewTaskFile - Task ID:', taskId);
                console.log('previewTaskFile - File Type:', fileType);
                console.log('previewTaskFile - Original task object:', task);
                console.log('previewTaskFile - File URL:', fileUrl);
                console.log('previewTaskFile - File URL length:', fileUrl ? fileUrl.length : 0);
                console.log('previewTaskFile - File URL starts with data:', fileUrl && fileUrl.startsWith('data:'));
                console.log('previewTaskFile - File Name:', fileName);
                console.log('previewTaskFile - File Type Value:', fileTypeValue);
                
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ - å¢å¼ºæ£€æŸ¥é€»è¾‘ï¼Œè€ƒè™‘ç©ºå­—ç¬¦ä¸²ã€nullã€undefinedç­‰æƒ…å†µ
                if (!fileUrl || fileUrl.trim() === '' || fileUrl === 'null' || fileUrl === 'undefined' || fileUrl === 'data:') {
                    console.warn('æ–‡ä»¶æ£€æŸ¥å¤±è´¥ - ä»¥ä¸‹æƒ…å†µä¼šå¯¼è‡´æ­¤è­¦å‘Š:', {
                        '!fileUrl': !fileUrl,
                        'fileUrl.trim() === ""': fileUrl && fileUrl.trim() === '',
                        'fileUrl === "null"': fileUrl === 'null',
                        'fileUrl === "undefined"': fileUrl === 'undefined',
                        'fileUrl === "data:"': fileUrl === 'data:',
                        'fileUrl is': fileUrl
                    });
                    
                    // æä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                    if (!fileUrl) {
                        Utils.showAlert('æœªæ‰¾åˆ°æ–‡ä»¶æ•°æ®', 'warning');
                    } else if (fileUrl.trim() === '') {
                        Utils.showAlert('æ–‡ä»¶æ•°æ®ä¸ºç©ºå­—ç¬¦ä¸²', 'warning');
                    } else if (fileUrl === 'null') {
                        Utils.showAlert('æ–‡ä»¶æ•°æ®ä¸ºnullå­—ç¬¦ä¸²', 'warning');
                    } else if (fileUrl === 'undefined') {
                        Utils.showAlert('æ–‡ä»¶æ•°æ®ä¸ºundefinedå­—ç¬¦ä¸²', 'warning');
                    } else if (fileUrl === 'data:') {
                        Utils.showAlert('æ–‡ä»¶æ•°æ®æ ¼å¼ä¸å®Œæ•´', 'warning');
                    } else {
                        Utils.showAlert('è¯¥æ–‡ä»¶æœªä¸Šä¼ ', 'warning');
                    }
                    return;
                }
                
                // å¯¹äºbase64å›¾åƒï¼ŒéªŒè¯å…¶æ ¼å¼æ˜¯å¦æ­£ç¡®
                if (fileUrl.startsWith('data:')) {
                    try {
                        // æ£€æŸ¥base64æ•°æ®æ˜¯å¦å®Œæ•´
                        const matches = fileUrl.match(/^data:(.+);base64,/);
                        if (!matches) {
                            console.warn('æ–‡ä»¶æ•°æ®æ ¼å¼å¼‚å¸¸:', fileUrl.substring(0, 50) + '...');
                            Utils.showAlert('æ–‡ä»¶æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œè¯·é‡æ–°ä¸Šä¼ ', 'warning');
                            return;
                        }
                        
                        // éªŒè¯base64éƒ¨åˆ†æ˜¯å¦æœ‰æ•ˆ
                        const base64Data = fileUrl.split(',')[1];
                        if (!base64Data || base64Data.length === 0) {
                            console.warn('æ–‡ä»¶æ•°æ®ä¸ºç©º:', fileType);
                            Utils.showAlert('æ–‡ä»¶æ•°æ®ä¸ºç©ºï¼Œè¯·é‡æ–°ä¸Šä¼ ', 'warning');
                            return;
                        }
                    } catch (e) {
                        console.error('éªŒè¯æ–‡ä»¶æ•°æ®æ—¶å‡ºé”™:', e);
                        Utils.showAlert('æ–‡ä»¶æ•°æ®éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ', 'warning');
                        return;
                    }
                }
                
                const printWindow = window.open('', '_blank');
                
                if (fileTypeValue === 'pdf') {
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="zh-CN">
                        <head>
                            <title>ä»»åŠ¡${fileTitle}é¢„è§ˆ - ${task.taskNumber}</title>
                            <style>
                                body { font-family: Arial; padding: 40px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                                .pdf-container { width: 100%; height: 90vh; }
                                iframe { width: 100%; height: 100%; border: none; }
                                .pdf-info { margin-top: 20px; text-align: center; }
                            </style>
                        </head>
                        <body>
                            <div class="pdf-container">
                                <iframe src="${fileUrl}"></iframe>
                            </div>
                            <div class="pdf-info">
                                <h3>${fileName || fileTitle}</h3>
                                <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                                <p><small>å³é”®ç‚¹å‡»ä¸Šæ–¹æ–‡æ¡£å¯æ›¿æ¢æ–‡ä»¶</small></p>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    // æ·»åŠ å³é”®èœå•åŠŸèƒ½
                    printWindow.addEventListener('load', function() {
                        const pdfFrame = printWindow.document.querySelector('iframe');
                        if (pdfFrame) {
                            pdfFrame.addEventListener('contextmenu', function(e) {
                                e.preventDefault();
                                if (confirm('æ˜¯å¦è¦æ›¿æ¢å½“å‰æ–‡ä»¶?')) {
                                    replaceTaskFile(taskId, fileType);
                                }
                            });
                        }
                    });
                } else {
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="zh-CN">
                        <head>
                            <title>ä»»åŠ¡${fileTitle}é¢„è§ˆ - ${task.taskNumber}</title>
                            <style>
                                body { font-family: Arial; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; flex-direction: column; }
                                img { max-width: 100%; max-height: 90vh; cursor: pointer; }
                                .image-info { margin-top: 20px; text-align: center; }
                            </style>
                        </head>
                        <body>
                            <img src="${fileUrl}" alt="ä»»åŠ¡${fileTitle}" onerror="Utils.onImageError(this)" oncontextmenu="handleFilePreviewRightClick(event, '${taskId}', '${fileType}'); return false;">
                            <div class="image-info">
                                <h3>ä»»åŠ¡${fileTitle}</h3>
                                <p>ä»»åŠ¡å·: ${task.taskNumber}</p>
                                <p><small>å³é”®ç‚¹å‡»ä¸Šæ–¹å›¾ç‰‡å¯æ›¿æ¢æ–‡ä»¶</small></p>
                            </div>
                        </body>
                        </html>
                    `);
                }
                printWindow.document.close();
            } catch (error) {
                console.error('è·å–ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
                Utils.showAlert('è·å–ä»»åŠ¡æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        }
        
        // å¤„ç†æ–‡ä»¶é¢„è§ˆå³é”®ç‚¹å‡»äº‹ä»¶
        function handleFilePreviewRightClick(event, taskId, fileType) {
            event.preventDefault();
            if (confirm('æ˜¯å¦è¦æ›¿æ¢å½“å‰æ–‡ä»¶?')) {
                replaceTaskFile(taskId, fileType);
            }
        }
                    
        // å¤„ç†æ–‡ä»¶é¢„è§ˆç‚¹å‡»ä¸‹è½½äº‹ä»¶
        function handleFilePreviewClick(taskId, fileType) {
            downloadTaskFile(taskId, fileType);
        }
                    
        // ä¸‹è½½ä»»åŠ¡æ–‡ä»¶
        async function downloadTaskFile(taskId, fileType) {
            try {
                const task = await DataManager.getTaskById(taskId);
                if (!task) {
                    Utils.showAlert('ä»»åŠ¡ä¸å­˜åœ¨', 'error');
                    return;
                }
                            
                const fieldName = fileType + 'Image';
                const fileNameField = fileType + 'FileName';
                            
                const fileData = task[fieldName];
                const fileName = task[fileNameField] || `${fileType}_file`;
                            
                if (!fileData) {
                    Utils.showAlert('æ–‡ä»¶æœªä¸Šä¼ ', 'warning');
                    return;
                }
                            
                // åˆ›å»ºä¸´æ—¶é“¾æ¥ä¸‹è½½æ–‡ä»¶
                const link = document.createElement('a');
                link.href = fileData;
                link.download = fileName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
                Utils.showAlert('ä¸‹è½½æ–‡ä»¶å¤±è´¥', 'error');
            }
        }
        
        // æ›¿æ¢ä»»åŠ¡æ–‡ä»¶
        async function replaceTaskFile(taskId, fileType) {
            // åˆ›å»ºéšè—çš„æ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*,.pdf';
            
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!file.type.match('image.*') && !file.type.match(/pdf/)) {
                    if (!file.name.toLowerCase().endsWith('.pdf')) {
                        Utils.showAlert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–PDFæ–‡ä»¶', 'warning');
                        return;
                    }
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ3Mé™åˆ¶ï¼‰
                if (file.size > 3 * 1024 * 1024) { // 3MB
                    Utils.showAlert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡3MB', 'warning');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        // å‡†å¤‡æ›´æ–°æ•°æ®
                        const updateData = {};
                        const fieldName = fileType + 'Image';
                        const fileNameField = fileType + 'FileName';
                        const typeField = fileType + 'Type';
                        
                        updateData[fieldName] = e.target.result;
                        updateData[fileNameField] = file.name;
                        updateData[typeField] = file.type.includes('pdf') ? 'pdf' : 'image';
                        
                        // æ›´æ–°ä»»åŠ¡æ•°æ®
                        await DataManager.updateTask(taskId, updateData);
                        
                        // åˆ·æ–°ä»»åŠ¡å¡ç‰‡æ˜¾ç¤º
                        await loadSalesPublishedTasks();
                        
                        Utils.showAlert('æ–‡ä»¶æ›¿æ¢æˆåŠŸ', 'success');
                    } catch (error) {
                        console.error('æ›¿æ¢æ–‡ä»¶å¤±è´¥:', error);
                        Utils.showAlert('æ›¿æ¢æ–‡ä»¶å¤±è´¥', 'error');
                    }
                };
                reader.readAsDataURL(file);
            };
            
            // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            fileInput.click();
        }

        // ============================================
        // ç»Ÿè®¡åˆ†ææ¨¡å—
        

        function filterStatistics(filter, clickedButton) {
            currentStatisticsFilter = filter;
            
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            loadStatisticsDashboardData();
        }

        function updateSalesRanking(ranking) {
            const container = document.getElementById('salesRanking');
            if (!container) return;
            
            if (ranking.length === 0) {
                container.innerHTML = '<p class="text-muted text-center my-5">æš‚æ— é”€é‡æ•°æ®</p>';
                return;
            }
            
            container.innerHTML = ranking.map((item, index) => `
                <div class="d-flex align-center mb-8" style="border-bottom: 1px solid var(--gray-light); padding-bottom: 8px;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: #666; min-width: 35px;">${index + 1}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 3px; font-size: 0.9rem;">${item.name} (${item.code})</div>
                        <div class="d-flex justify-between" style="font-size: 0.85rem; color: #666;">
                            <span>é”€é‡: ${item.quantity}</span>
                            <span>é”€å”®é¢: ${Utils.formatCurrency(item.sales)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateProfitRanking(ranking) {
            const container = document.getElementById('profitRanking');
            if (!container) return;
            
            if (ranking.length === 0) {
                container.innerHTML = '<p class="text-muted text-center my-5">æš‚æ— åˆ©æ¶¦æ•°æ®</p>';
                return;
            }
            
            container.innerHTML = ranking.map((item, index) => `
                <div class="d-flex align-center mb-8" style="border-bottom: 1px solid var(--gray-light); padding-bottom: 8px;">
                    <div style="font-size: 1.1rem; font-weight: 700; color: #666; min-width: 35px;">${index + 1}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 3px; font-size: 0.9rem;">${item.name} (${item.code})</div>
                        <div class="d-flex justify-between" style="font-size: 0.85rem; color: #666;">
                            <span>åˆ©æ¶¦: ${Utils.formatCurrency(item.profit)}</span>
                            <span>åˆ©æ¶¦ç‡: ${item.profitMargin.toFixed(2)}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateCreatorStatistics(stats) {
            const container = document.getElementById('creatorStatistics');
            if (!container) return;
            
            if (stats.length === 0) {
                container.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">æš‚æ— é”€å”®è¿è¥è´¦æˆ·æ•°æ®</td></tr>';
                return;
            }
            
            container.innerHTML = stats.map(stat => `
                <tr>
                    <td>${stat.name}</td>
                    <td>${stat.totalTasks}</td>
                    <td>${stat.totalShipments}</td>
                    <td>${Utils.formatCurrency(stat.totalSales)}</td>
                    <td>${Utils.formatCurrency(stat.totalProfit)}</td>
                </tr>
            `).join('');
        }

        function updateShipmentChart(monthlyData) {
            const canvas = document.getElementById('shipmentChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (shipmentChart) {
                shipmentChart.destroy();
            }
            
            const labels = Object.keys(monthlyData);
            const data = Object.values(monthlyData);
            
            shipmentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æœˆåº¦å‘è´§é‡',
                        data: data,
                        backgroundColor: 'rgba(76, 201, 240, 0.5)',
                        borderColor: '#4cc9f0',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateSalesChart(monthlyData) {
            const canvas = document.getElementById('salesChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (salesChart) {
                salesChart.destroy();
            }
            
            const labels = Object.keys(monthlyData);
            const data = Object.values(monthlyData);
            
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æœˆåº¦é”€å”®é¢',
                        data: data,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `é”€å”®é¢: ${Utils.formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utils.formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateProfitChart(monthlyData) {
            const canvas = document.getElementById('profitChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (profitChart) {
                profitChart.destroy();
            }
            
            const labels = Object.keys(monthlyData);
            const data = Object.values(monthlyData);
            
            profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æœˆåº¦åˆ©æ¶¦',
                        data: data,
                        backgroundColor: 'rgba(247, 37, 133, 0.5)',
                        borderColor: '#f72585',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `åˆ©æ¶¦: ${Utils.formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return Utils.formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        async function downloadSalesRanking() {
            const stats = await DataManager.getStatisticsData(currentStatisticsFilter);
            let csvContent = "æ’å,äº§å“åç§°,è´§å·,é”€é‡,é”€å”®é¢\n";
            
            stats.salesRanking.forEach((item, index) => {
                csvContent += `${index + 1},${item.name},${item.code},${item.quantity},${item.sales}\n`;
            });
            
            const date = new Date().toISOString().split('T')[0];
            Utils.downloadCSV(csvContent, `é”€é‡æ’è¡Œ_${date}.csv`);
        }

        async function downloadProfitRanking() {
            const stats = await DataManager.getStatisticsData(currentStatisticsFilter);
            let csvContent = "æ’å,äº§å“åç§°,è´§å·,åˆ©æ¶¦,åˆ©æ¶¦ç‡\n";
            
            stats.profitRanking.forEach((item, index) => {
                csvContent += `${index + 1},${item.name},${item.code},${item.profit},${item.profitMargin.toFixed(2)}%\n`;
            });
            
            const date = new Date().toISOString().split('T')[0];
            Utils.downloadCSV(csvContent, `åˆ©æ¶¦æ’è¡Œ_${date}.csv`);
        }

        async function downloadShipmentList() {
            const stats = await DataManager.getStatisticsData(currentStatisticsFilter);
            let csvContent = "ä»»åŠ¡å·,å®Œæˆæ—¶é—´,åˆ›å»ºäºº,å•†å“ç§ç±»,æ€»æ•°é‡\n";
            
            stats.filteredHistory.forEach(task => {
                const itemCount = task.items.reduce((sum, item) => sum + item.quantity, 0);
                const creatorName = task.creatorName || task.creator_name || 'Unknown';
                csvContent += `${task.taskNumber},${Utils.formatDate(task.completedAt || task.createdAt)},${creatorName},${task.items.length},${itemCount}\n`;
            });
            
            const date = new Date().toISOString().split('T')[0];
            Utils.downloadCSV(csvContent, `å‘è´§æ¸…å•_${date}.csv`);
        }

        async function downloadSalesReport() {
            const stats = await DataManager.getStatisticsData(currentStatisticsFilter);
            const products = await DataManager.getAllProducts();
            let csvContent = "äº§å“åç§°,è´§å·,ä¾›åº”å•†,æ€»é”€é‡,æ€»é”€å”®é¢\n";
            
            const allStats = {};
            stats.filteredHistory.forEach(task => {
                task.items.forEach(item => {
                    if (!allStats[item.productId]) {
                        const product = products.find(p => p.id === item.productId);
                        allStats[item.productId] = {
                            name: product ? product.name : 'æœªçŸ¥äº§å“',
                            code: product ? product.code : 'N/A',
                            supplier: product ? product.supplier : 'N/A',
                            quantity: 0,
                            sales: 0
                        };
                    }
                    allStats[item.productId].quantity += item.quantity;
                    
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        allStats[item.productId].sales += product.salePrice * item.quantity;
                    }
                });
            });
            
            Object.values(allStats).forEach(item => {
                csvContent += `${item.name},${item.code},${item.supplier},${item.quantity},${item.sales.toFixed(2)}\n`;
            });
            
            const date = new Date().toISOString().split('T')[0];
            Utils.downloadCSV(csvContent, `é”€å”®æŠ¥è¡¨_${date}.csv`);
        }

        async function downloadProfitReport() {
            const stats = await DataManager.getStatisticsData(currentStatisticsFilter);
            const products = await DataManager.getAllProducts();
            let csvContent = "äº§å“åç§°,è´§å·,æ€»åˆ©æ¶¦,åˆ©æ¶¦ç‡\n";
            
            const allStats = {};
            stats.filteredHistory.forEach(task => {
                task.items.forEach(item => {
                    if (!allStats[item.productId]) {
                        const product = products.find(p => p.id === item.productId);
                        allStats[item.productId] = {
                            name: product ? product.name : 'æœªçŸ¥äº§å“',
                            code: product ? product.code : 'N/A',
                            cost: 0,
                            sales: 0,
                            profit: 0
                        };
                    }
                    
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        allStats[item.productId].cost += product.purchasePrice * item.quantity;
                        allStats[item.productId].sales += product.salePrice * item.quantity;
                        allStats[item.productId].profit += (product.salePrice - product.purchasePrice) * item.quantity;
                    }
                });
            });
            
            Object.values(allStats).forEach(item => {
                const profitMargin = item.sales > 0 ? (item.profit / item.sales * 100) : 0;
                csvContent += `${item.name},${item.code},${item.profit.toFixed(2)},${profitMargin.toFixed(2)}%\n`;
            });
            
            const date = new Date().toISOString().split('T')[0];
            Utils.downloadCSV(csvContent, `åˆ©æ¶¦æŠ¥è¡¨_${date}.csv`);
        }

        async function downloadAllData() {
            const products = await DataManager.getAllProducts();
            const tasks = await DataManager.getAllTasks();
            const history = await DataManager.getHistory();
            
            let csvContent = "=== äº§å“æ•°æ® ===\n";
            csvContent += "è´§å·,äº§å“åç§°,ä¾›åº”å•†,åº“å­˜,è¿›è´§ä»·,é”€å”®ä»·,åˆ©æ¶¦ç‡\n";
            products.forEach(product => {
                csvContent += `${product.code},${product.name},${product.supplier || ''},${product.stock},${product.purchasePrice},${product.salePrice},${product.profitMargin}%\n`;
            });
            
            csvContent += "\n=== å¾…å‘è´§ä»»åŠ¡ ===\n";
            csvContent += "ä»»åŠ¡å·,åˆ›å»ºæ—¶é—´,çŠ¶æ€,åˆ›å»ºäºº,å•†å“ç§ç±»,å•†å“æ•°é‡\n";
            tasks.forEach(task => {
                const itemCount = task.items.reduce((sum, item) => sum + item.quantity, 0);
                const creatorName = task.creatorName || task.creator_name || 'Unknown';
                csvContent += `${task.taskNumber},${Utils.formatDate(task.createdAt)},${task.status},${creatorName},${task.items.length},${itemCount}\n`;
            });
            
            csvContent += "\n=== å†å²å‘è´§è®°å½• ===\n";
            csvContent += "ä»»åŠ¡å·,å®Œæˆæ—¶é—´,åˆ›å»ºäºº,å•†å“ç§ç±»,å•†å“æ•°é‡\n";
            history.forEach(task => {
                const itemCount = task.items.reduce((sum, item) => sum + item.quantity, 0);
                const creatorName = task.creatorName || task.creator_name || 'Unknown';
                csvContent += `${task.taskNumber},${Utils.formatDate(task.completedAt || task.createdAt)},${creatorName},${task.items.length},${itemCount}\n`;
            });
            
            const date = new Date().toISOString().split('T')[0];
            Utils.downloadCSV(csvContent, `å®Œæ•´æ•°æ®_${date}.csv`);
        }

        // ============================================
        // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
        // ============================================
        function initializeSampleData() {
            // æ·»åŠ ç¤ºä¾‹äº§å“
            const sampleProducts = [
                {
                    id: 'PROD_1',
                    code: 'SKU001',
                    name: 'æ— çº¿è“ç‰™è€³æœº',
                    stock: 50,
                    purchasePrice: 120,
                    salePrice: 150,
                    profitMargin: 20.00,
                    image: '',
                    createdAt: '2023-10-15T08:30:00'
                },
                {
                    id: 'PROD_2',
                    code: 'SKU002',
                    name: 'æ™ºèƒ½æ‰‹æœºæ”¯æ¶',
                    stock: 100,
                    purchasePrice: 40,
                    salePrice: 50,
                    profitMargin: 20.00,
                    image: '',
                    createdAt: '2023-10-16T10:15:00'
                },
                {
                    id: 'PROD_3',
                    code: 'SKU003',
                    name: 'ä¾¿æºå……ç”µå®',
                    stock: 80,
                    purchasePrice: 80,
                    salePrice: 100,
                    profitMargin: 20.00,
                    image: '',
                    createdAt: '2023-10-17T14:20:00'
                },
                {
                    id: 'PROD_4',
                    code: 'SKU004',
                    name: 'æ™ºèƒ½æ‰‹ç¯',
                    stock: 60,
                    purchasePrice: 100,
                    salePrice: 125,
                    profitMargin: 20.00,
                    image: '',
                    createdAt: '2023-10-18T09:45:00'
                }
            ];
            
            DataManager.saveProducts(sampleProducts);
            
            // æ·»åŠ ç¤ºä¾‹æ´»åŠ¨è®°å½•
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            const sampleActivities = [
                {
                    time: `${today} 09:30`,
                    type: 'task',
                    details: 'åˆ›å»ºå‘è´§ä»»åŠ¡: FQ231028001',
                    user: 'é”€å”®è¿è¥'
                },
                {
                    time: `${today} 08:45`,
                    type: 'product',
                    details: 'æ·»åŠ æ–°äº§å“: æ™ºèƒ½æ‰‹ç¯ (SKU004)',
                    user: 'ç®¡ç†å‘˜'
                },
                {
                    time: `${yesterday} 16:20`,
                    type: 'task',
                    details: 'å®Œæˆå‘è´§ä»»åŠ¡: FQ231027001',
                    user: 'ä»“åº“ç®¡ç†'
                },
                {
                    time: `${yesterday} 14:15`,
                    type: 'product',
                    details: 'æ·»åŠ æ–°äº§å“: ä¾¿æºå……ç”µå® (SKU003)',
                    user: 'ç®¡ç†å‘˜'
                }
            ];
            
            localStorage.setItem(STORAGE_KEYS.ACTIVITIES, JSON.stringify(sampleActivities));
            
            // æ·»åŠ ç¤ºä¾‹å†å²ä»»åŠ¡
            const sampleHistory = [
                {
                    id: 'TASK_HIST_1',
                    taskNumber: 'FQ231027001',
                    items: [
                        {
                            productId: 'PROD_1',
                            productName: 'æ— çº¿è“ç‰™è€³æœº',
                            productCode: 'SKU001',
                            productImage: '',
                            quantity: 5,
                            purchasePrice: 120,
                            salePrice: 150
                        },
                        {
                            productId: 'PROD_2',
                            productName: 'æ™ºèƒ½æ‰‹æœºæ”¯æ¶',
                            productCode: 'SKU002',
                            productImage: '',
                            quantity: 10,
                            purchasePrice: 40,
                            salePrice: 50
                        }
                    ],
                    status: 'completed',
                    createdAt: `${yesterday}T10:30:00`,
                    completedAt: `${yesterday}T16:20:00`
                }
            ];
            
            localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(sampleHistory));
        }

        // ============================================
        // å…¨çƒå¯¼å‡ºå‡½æ•°
        // ============================================
        // å…¨å±€å¯¼å‡ºå‡½æ•°
        // ============================================
        window.switchProductView = switchProductView;
        window.addToTaskFromList = addToTaskFromList;
        window.addProductToTaskCart = addProductToTaskCart;
        window.updateCartItem = updateCartItem;
        window.removeCartItem = removeCartItem;
        window.searchProducts = searchProducts;
        window.deleteRecentProduct = deleteRecentProduct;
        window.deleteProduct = deleteProduct;
        window.editProduct = editProduct;
        window.deleteSalesTask = deleteSalesTask;
        window.viewTaskDetail = viewTaskDetail;
        window.toggleTaskDetail = toggleTaskDetail;
        window.deleteWarehouseTask = deleteWarehouseTask;
        window.completeShipment = completeShipment;
        window.resetProductImageUpload = resetProductImageUpload;
        window.previewTaskBodyCode = previewTaskBodyCode;
        window.previewTaskBarcode = previewTaskBarcode;
        window.previewTaskWarningCode = previewTaskWarningCode;
        window.previewTaskLabel = previewTaskLabel;
        window.previewTaskFile = previewTaskFile;
        window.filterStatistics = filterStatistics;
        window.downloadSalesRanking = downloadSalesRanking;
        window.downloadProfitRanking = downloadProfitRanking;
        window.downloadShipmentList = downloadShipmentList;
        window.downloadSalesReport = downloadSalesReport;
        window.downloadProfitReport = downloadProfitReport;
        window.downloadAllData = downloadAllData;
        window.toggleProductSelection = toggleProductSelection;
        window.removeSelectedProduct = removeSelectedProduct;
        window.resetTaskBodyCodeUpload = resetTaskBodyCodeUpload;
        window.resetTaskWarningCodeUpload = resetTaskWarningCodeUpload;
        window.resetTaskLabelUpload = resetTaskLabelUpload;
        
        // æ·»åŠ å…¨å±€è½¬ä¹‰å‡½æ•°
        window.escapeHtml = escapeHtml;
        
        // ç‰¹å®šä»»åŠ¡å¡ç‰‡ç§»åŠ¨åŠŸèƒ½
        function moveSpecificTaskCard() {
            // è·å–ç‰¹å®šä»»åŠ¡å¡ç‰‡
            const specificTaskCard = document.getElementById('task-1768315176672-front');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨
            const container = document.getElementById('specific-task-card-container');
            
            if (specificTaskCard && container) {
                // æ£€æŸ¥ä»»åŠ¡å¡ç‰‡æ˜¯å¦å·²ç»åœ¨å®¹å™¨ä¸­
                if (specificTaskCard.parentNode && specificTaskCard.parentNode.id !== 'specific-task-card-container') {
                    // å…‹éš†å…ƒç´ å¹¶æ·»åŠ åˆ°æ–°å®¹å™¨ï¼Œä¿ç•™åŸå§‹äº‹ä»¶å¤„ç†
                    const clonedCard = specificTaskCard.cloneNode(true);
                    
                    // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ å…‹éš†çš„å¡ç‰‡
                    container.innerHTML = '';
                    container.appendChild(clonedCard);
                    
                    // éšè—åŸå§‹å¡ç‰‡
                    specificTaskCard.style.display = 'none';
                    
                    // é‡æ–°ç»‘å®šå¯èƒ½ä¸¢å¤±çš„äº‹ä»¶
                    rebindTaskCardEvents(clonedCard);
                }
                
                // æ˜¾ç¤ºç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨
                container.style.display = 'block';
                
                // å°†ç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨æ·»åŠ åˆ°é”€å”®è¿è¥å®¹å™¨ä¸­ï¼Œä½¿ç”¨CSS orderå±æ€§æ§åˆ¶æ˜¾ç¤ºé¡ºåº
                const salesOpsContainer = document.querySelector('.sales-operations-container');
                
                if (salesOpsContainer && container) {
                    // æ·»åŠ æ ·å¼ç±»ä»¥å¯ç”¨å¹¶æ’å¸ƒå±€
                    salesOpsContainer.classList.add('with-specific-task');
                    
                    // ç¡®ä¿ç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨åœ¨é”€å”®è¿è¥å®¹å™¨å†…ï¼Œä»¥ä¾¿orderå±æ€§ç”Ÿæ•ˆ
                    if (container.parentNode !== salesOpsContainer) {
                        // æ‰¾åˆ°å‘å¸ƒä»»åŠ¡éƒ¨åˆ†ä½œä¸ºå‚è€ƒç‚¹ï¼Œå°†ç‰¹å®šä»»åŠ¡å¡ç‰‡å®¹å™¨æ’å…¥åˆ°å…¶åé¢
                        const publishedTasksSection = salesOpsContainer.querySelector('.published-tasks-section');
                        if (publishedTasksSection) {
                            publishedTasksSection.parentNode.insertBefore(container, publishedTasksSection.nextSibling);
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°å‘å¸ƒä»»åŠ¡éƒ¨åˆ†ï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ°å®¹å™¨æœ«å°¾
                            salesOpsContainer.appendChild(container);
                        }
                    }
                }
            }
        }
        

        
        // åˆ é™¤ç‰¹å®šä»»åŠ¡å¡ç‰‡
        function removeSpecificTaskCard() {
            // æŸ¥æ‰¾å¹¶åˆ é™¤ç‰¹å®šçš„ä»»åŠ¡å¡ç‰‡
            const taskCardToRemove = document.getElementById('task-1768315717638-front');
            
            if (taskCardToRemove) {
                taskCardToRemove.remove();
                console.log('å·²æˆåŠŸåˆ é™¤ä»»åŠ¡å¡ç‰‡: task-1768315717638-front');
            } else {
                // å¦‚æœé€šè¿‡IDæ‰¾ä¸åˆ°ï¼Œå°è¯•é€šè¿‡å…¶ä»–æ–¹å¼æŸ¥æ‰¾
                const taskCardByDataId = document.querySelector('[data-task-id="1768315717638"]');
                if (taskCardByDataId) {
                    taskCardByDataId.remove();
                    console.log('å·²æˆåŠŸåˆ é™¤ä»»åŠ¡å¡ç‰‡: data-task-id="1768315717638"');
                } else {
                    // å°è¯•é€šè¿‡å†…å®¹æŸ¥æ‰¾
                    const allTaskFrontElements = document.querySelectorAll('.task-front');
                    for (let i = 0; i < allTaskFrontElements.length; i++) {
                        const element = allTaskFrontElements[i];
                        if (element.textContent && element.textContent.includes('ä»¥è¯šç©å…·') && 
                            element.textContent.includes('å°æé¾™') && element.textContent.includes('æ•°é‡: 1')) {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ç›®æ ‡å…ƒç´ ï¼ˆä¸æ˜¯æˆ‘ä»¬è¦ä¿ç•™çš„é‚£ä¸ªï¼‰
                            if (element.id !== 'task-1768315176672-front') {
                                element.remove();
                                console.log('å·²é€šè¿‡å†…å®¹åŒ¹é…åˆ é™¤ä»»åŠ¡å¡ç‰‡');
                                break;
                            }
                        }
                    }
                }
            }
        }
        
        // é‡æ–°ç»‘å®šä»»åŠ¡å¡ç‰‡ä¸Šçš„äº‹ä»¶
        function rebindTaskCardEvents(cardElement) {
            // ä¸ºå…‹éš†çš„å¡ç‰‡é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
            const taskId = cardElement.dataset.taskId;
            if (taskId) {
                // æŸ¥æ‰¾å¡ç‰‡ä¸Šçš„æ“ä½œæŒ‰é’®å¹¶é‡æ–°ç»‘å®šäº‹ä»¶
                const actionButtons = cardElement.querySelectorAll('button, .task-gallery-actions');
                actionButtons.forEach(button => {
                    // é‡æ–°ç»‘å®šæŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…çš„äº‹ä»¶
                    if (button.classList.contains('view-task-btn') || button.onclick) {
                        button.onclick = () => viewTaskDetail(taskId);
                    }
                });
            }
        }
        
        // ç›‘å¬æ¨¡å—åˆ‡æ¢äº‹ä»¶ï¼Œåœ¨é”€å”®è¿è¥æ¨¡å—æ¿€æ´»æ—¶ç§»åŠ¨ä»»åŠ¡å¡ç‰‡
        document.addEventListener('DOMContentLoaded', function() {
            // ç­‰å¾…é”€å”®è¿è¥æ¨¡å—æ¿€æ´»åå†ç§»åŠ¨å…ƒç´ 
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.id === 'sales-operations' && node.classList.contains('active')) {
                            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
                            setTimeout(moveSpecificTaskCard, 100);
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // é¡µé¢åŠ è½½å®Œæˆåä¹Ÿå°è¯•ä¸€æ¬¡
            if (document.getElementById('sales-operations') && document.getElementById('sales-operations').classList.contains('active')) {
                setTimeout(moveSpecificTaskCard, 100);
            }
            
            // åˆ é™¤ç‰¹å®šä»»åŠ¡å¡ç‰‡
            setTimeout(removeSpecificTaskCard, 75);
        });
        
        // è´¦æˆ·ç®¡ç†åŠŸèƒ½
        async function loadUserManagementData() {
            try {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç®¡ç†å‘˜æƒé™
                const currentUser = DataManager.getCurrentUser();
                if (!currentUser || currentUser.role !== 'admin') {
                    // éç®¡ç†å‘˜ç”¨æˆ·åªèƒ½çœ‹åˆ°æƒé™æç¤º
                    document.getElementById('userList').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤æ¨¡å—</td>
                        </tr>
                    `;
                    
                    // éšè—æ·»åŠ ç”¨æˆ·çš„æŒ‰é’®
                    const addUserBtn = document.querySelector('#user-management .btn-primary');
                    if (addUserBtn) {
                        addUserBtn.style.display = 'none';
                    }
                    
                    return;
                }
                
                // æ˜¾ç¤ºæ·»åŠ ç”¨æˆ·çš„æŒ‰é’®
                const addUserBtn = document.querySelector('#user-management .btn-primary');
                if (addUserBtn) {
                    addUserBtn.style.display = 'inline-block';
                }
                
                // è·å–ç”¨æˆ·åˆ—è¡¨
                const response = await fetch(`${DataManager.API_BASE}/api/users/all`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN)}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
                }
                
                const users = await response.json();
                renderUserList(users);
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                document.getElementById('userList').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger py-4">åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${error.message}</td>
                    </tr>
                `;
                
                // ç¡®ä¿æŒ‰é’®å¯è§æ€§æ­£ç¡®
                const addUserBtn = document.querySelector('#user-management .btn-primary');
                if (addUserBtn) {
                    addUserBtn.style.display = 'inline-block';
                }
            }
        }
        
        function renderUserList(users) {
            const userListElement = document.getElementById('userList');
                    
            if (!users || users.length === 0) {
                userListElement.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">æš‚æ— ç”¨æˆ·æ•°æ®</td>
                    </tr>
                `;
                return;
            }
                    
            // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
            userListElement.innerHTML = users.map(user => {
                const name = escapeHtml(user.name || user.username || 'N/A');
                const email = escapeHtml(user.email || user.username || 'N/A');
                const userId = escapeHtml(user.id || user._id || '');
                const roleClass = user.role === 'admin' ? 'badge-primary' : user.role === 'sales' ? 'badge-success' : 'badge-warning';
                const roleName = escapeHtml(getRoleDisplayName(user.role));
                const createdAt = formatDate(user.createdAt || user.created_at || Date.now());
                            
                return `
                    <tr>
                        <td>${name}</td>
                        <td>${email}</td>
                        <td>
                            <span class="badge ${roleClass}">
                                ${roleName}
                            </span>
                        </td>
                        <td>${createdAt}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline" onclick="editUser('${userId}')" title="ç¼–è¾‘">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline" onclick="deleteUser('${userId}', '${email}')" title="åˆ é™¤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
                
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                return text;
            }
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>'"]/g, m => map[m]);
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': 'ç®¡ç†å‘˜',
                'sales': 'é”€å”®è¿è¥',
                'warehouse': 'ä»“åº“'
            };
            return roleNames[role] || role;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + 
                   date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
        
        function showAddUserModal(userId = null) {
            const modalTitle = document.getElementById('userModalLabel');
            const userIdField = document.getElementById('userId');
            const userPasswordField = document.getElementById('userPassword');
            
            if (userId) {
                modalTitle.textContent = 'ç¼–è¾‘ç”¨æˆ·';
                // åŠ è½½ç”¨æˆ·æ•°æ®åˆ°è¡¨å•
                loadUserDataForEdit(userId);
            } else {
                modalTitle.textContent = 'æ·»åŠ ç”¨æˆ·';
                // æ¸…ç©ºè¡¨å•
                document.getElementById('userForm').reset();
                userIdField.value = '';
                userPasswordField.required = true;
                userPasswordField.placeholder = 'è¯·è¾“å…¥å¯†ç ';
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modalElement = document.getElementById('userModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        async function loadUserDataForEdit(userId) {
            try {
                const response = await fetch(`${DataManager.API_BASE}/api/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN)}`
                    }
                });
                
                if (!response.ok) {
                    // æ ¹æ®HTTPçŠ¶æ€ç æä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                    if (response.status === 403) {
                        throw new Error('æƒé™ä¸è¶³ï¼šæ‚¨åªèƒ½ç¼–è¾‘è‡ªå·±çš„è´¦æˆ·ä¿¡æ¯ï¼Œå¦‚éœ€ç¼–è¾‘å…¶ä»–ç”¨æˆ·è¯·è”ç³»ç®¡ç†å‘˜');
                    } else if (response.status === 404) {
                        throw new Error('ç”¨æˆ·ä¸å­˜åœ¨ï¼šæ‰¾ä¸åˆ°æŒ‡å®šçš„ç”¨æˆ·');
                    } else if (response.status === 401) {
                        throw new Error('æœªæˆæƒï¼šè¯·é‡æ–°ç™»å½•åå†è¯•');
                    } else {
                        throw new Error(`è·å–ç”¨æˆ·æ•°æ®å¤±è´¥ (${response.status})`);
                    }
                }
                
                const user = await response.json();
                
                document.getElementById('userId').value = user.id || user._id;
                document.getElementById('userName').value = user.name || user.username || '';
                document.getElementById('userEmail').value = user.email || user.username || '';
                document.getElementById('userRole').value = user.role || '';
                
                // ç¼–è¾‘æ—¶å¯†ç ä¸æ˜¯å¿…éœ€çš„
                document.getElementById('userPassword').required = false;
                document.getElementById('userPassword').placeholder = 'ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ';
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                Utils.showAlert(`åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;
            
            if (!name || !email || !role) {
                Utils.showAlert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'warning');
                return;
            }
            
            try {
                let url, method;
                if (userId) {
                    // ç¼–è¾‘ç”¨æˆ·
                    url = `${DataManager.API_BASE}/api/users/${userId}`;
                    method = 'PUT';
                } else {
                    // æ·»åŠ ç”¨æˆ·
                    url = `${DataManager.API_BASE}/api/users`;
                    method = 'POST';
                }
                
                const userData = { name, email, role };
                if (password) {
                    userData.password = password;
                }
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN)}`
                    },
                    body: JSON.stringify(userData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || (userId ? 'æ›´æ–°ç”¨æˆ·å¤±è´¥' : 'æ·»åŠ ç”¨æˆ·å¤±è´¥'));
                }
                
                const result = await response.json();
                
                Utils.showAlert(userId ? 'ç”¨æˆ·æ›´æ–°æˆåŠŸ' : 'ç”¨æˆ·æ·»åŠ æˆåŠŸ', 'success');
                
                // å…³é—­æ¨¡æ€æ¡†
                const modalElement = document.getElementById('userModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                
                // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                refreshUserList();
            } catch (error) {
                console.error(userId ? 'æ›´æ–°ç”¨æˆ·å¤±è´¥:' : 'æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
                Utils.showAlert(`${userId ? 'æ›´æ–°' : 'æ·»åŠ '}ç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function editUser(userId) {
            showAddUserModal(userId);
        }
        
        async function deleteUser(userId, userEmail) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${userEmail}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`${DataManager.API_BASE}/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem(DataManager.STORAGE_KEYS.TOKEN)}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('åˆ é™¤ç”¨æˆ·å¤±è´¥');
                }
                
                Utils.showAlert('ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
                
                // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                refreshUserList();
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                Utils.showAlert(`åˆ é™¤ç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function refreshUserList() {
            await loadUserManagementData();
        }
        
        window.loadUserManagementData = loadUserManagementData;
        window.showAddUserModal = showAddUserModal;
        window.saveUser = saveUser;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.refreshUserList = refreshUserList;
        
        window.moveSpecificTaskCard = moveSpecificTaskCard;
        
        // ============================================
        // ç»Ÿè®¡åˆ†æåŠŸèƒ½
        // ============================================
        
        // å½“å‰ç»Ÿè®¡ç­›é€‰å™¨çŠ¶æ€
        let currentStatisticsFilter = 'day';
        let currentUserFilter = 'all';
        
// æ›´æ–°ç»Ÿè®¡åˆ†ææ•°æ®
        async function loadStatisticsDashboardData() {
            try {
                console.log('å¼€å§‹åŠ è½½ç»Ÿè®¡åˆ†ææ•°æ®ï¼Œå½“å‰ç­›é€‰å™¨:', currentStatisticsFilter, 'å½“å‰ç”¨æˆ·ç­›é€‰:', currentUserFilter);
                
                // è·å–ç”¨æˆ·æ•°æ®ä»¥å¡«å……äººå‘˜ç­›é€‰æ 
                await updateUsersForFilter();
                
                // è·å–ç»Ÿè®¡æ•°æ®ï¼Œåº”ç”¨æ—¶é—´ç­›é€‰å’Œç”¨æˆ·ç­›é€‰
                console.log('å¼€å§‹è·å–ç»Ÿè®¡æ•°æ®ï¼Œç­›é€‰å™¨:', currentStatisticsFilter, 'ç”¨æˆ·:', currentUserFilter);
                const stats = await DataManager.getStatisticsData(currentStatisticsFilter, currentUserFilter);
                console.log('è·å–åˆ°çš„ç»Ÿè®¡æ•°æ®:', stats);
                
                // æ£€æŸ¥æ˜¯å¦è·å–åˆ°æœ‰æ•ˆæ•°æ®
                if (!stats) {
                    console.error('æœªèƒ½è·å–åˆ°ç»Ÿè®¡æ•°æ®');
                    return;
                }
                
                // æ›´æ–°æ•°æ®æŒ‡æ ‡å¡ç‰‡ï¼ŒåŒ…æ‹¬å‘è´§ä»»åŠ¡æ•°é‡å’Œå…¶ä»–ç»Ÿè®¡æŒ‡æ ‡
                updateStatCards(stats);
                
                // ç¡®ä¿å‘è´§ä»»åŠ¡æ•°é‡æ˜¾ç¤ºæ­£ç¡®ï¼ˆä»»åŠ¡æ•°é‡è€Œéå‘è´§æ•°é‡ï¼‰
                const shipmentTaskCountEl = document.getElementById('shipmentTaskCount');
                console.log('å‡†å¤‡æ›´æ–°å‘è´§ä»»åŠ¡æ•°é‡ï¼ŒfilteredHistoryé•¿åº¦:', stats?.filteredHistory?.length, 'å…ƒç´ å­˜åœ¨:', !!shipmentTaskCountEl);
                if (shipmentTaskCountEl) {
                    let shipmentTaskCount = 0;
                    if (stats?.filteredHistory && Array.isArray(stats.filteredHistory)) {
                        shipmentTaskCount = stats.filteredHistory.length;
                    }
                    shipmentTaskCountEl.textContent = shipmentTaskCount;
                    console.log('å·²æ›´æ–°å‘è´§ä»»åŠ¡æ•°é‡å…ƒç´ ï¼Œå†…å®¹:', shipmentTaskCountEl.textContent);
                }
                
                // æ›´æ–°å•†å“æ˜ç»†è¡¨æ ¼
                updateProductDetailTable(stats);
                
                console.log('ç»Ÿè®¡åˆ†ææ•°æ®åŠ è½½å®Œæˆ');
                
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡åˆ†ææ•°æ®å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                Utils.showAlert('åŠ è½½ç»Ÿè®¡åˆ†ææ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }
        
        // æ›´æ–°äººå‘˜ç­›é€‰æ 
        async function updateUsersForFilter() {
            try {
                // è·å–æ‰€æœ‰é”€å”®è¿è¥è´¦æˆ·
                const users = await DataManager.getAllUsers();
                const salesUsers = users.filter(user => user.role === 'sales');
                
                const userFilterContainer = document.querySelector('#statistics-dashboard .user-filter');
                if (!userFilterContainer) return;
                
                // æ¸…ç©ºç°æœ‰æŒ‰é’®ï¼ˆä¿ç•™â€œå…¨éƒ¨â€æŒ‰é’®ï¼‰
                const buttons = userFilterContainer.querySelectorAll('.user-btn:not(:first-child)');
                buttons.forEach(button => button.remove());
                
                // æ·»åŠ é”€å”®è¿è¥è´¦æˆ·æŒ‰é’®
                salesUsers.forEach((user, index) => {
                    const userBtn = document.createElement('button');
                    userBtn.className = 'user-btn';
                    userBtn.textContent = user.name || user.email;
                    userBtn.setAttribute('data-user-id', user.id || user._id);
                    userBtn.onclick = () => filterByUser(user.id || user._id, userBtn);
                    
                    // å¦‚æœè¿™æ˜¯å½“å‰é€‰ä¸­çš„ç”¨æˆ·ï¼Œåˆ™æ·»åŠ activeç±»
                    if (currentUserFilter === (user.id || user._id)) {
                        userBtn.classList.add('active');
                    }
                    
                    userFilterContainer.appendChild(userBtn);
                });
                
                // ç¡®ä¿å½“å‰é€‰ä¸­çš„ç­›é€‰å™¨ä¿æŒæ¿€æ´»çŠ¶æ€
                updateUserFilterActiveState();
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // ç¡®ä¿ç”¨æˆ·ç­›é€‰æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€æ­£ç¡®
        function updateUserFilterActiveState() {
            const userFilterContainer = document.querySelector('#statistics-dashboard .user-filter');
            if (!userFilterContainer) return;
            
            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            const allButtons = userFilterContainer.querySelectorAll('.user-btn');
            allButtons.forEach(btn => btn.classList.remove('active'));
            
            // æ ¹æ®å½“å‰ç­›é€‰å™¨çŠ¶æ€è®¾ç½®æ­£ç¡®çš„æŒ‰é’®ä¸ºæ¿€æ´»çŠ¶æ€
            if (currentUserFilter === 'all') {
                // è®¾ç½®â€œå…¨éƒ¨â€æŒ‰é’®ä¸ºæ¿€æ´»çŠ¶æ€
                const allButton = userFilterContainer.querySelector('.user-btn:first-child');
                if (allButton) allButton.classList.add('active');
            } else {
                // ä¸ºäº†æ­£ç¡®åŒ¹é…ç”¨æˆ·IDå’Œæ˜¾ç¤ºåç§°ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ç”¨æˆ·åˆ—è¡¨
                // ä½†ç”±äºè¿™æ˜¯UIæ›´æ–°å‡½æ•°ï¼Œæˆ‘ä»¬é‡‡ç”¨ç®€åŒ–çš„åŒ¹é…æ–¹å¼
                // é€šè¿‡æŒ‰é’®çš„data-user-idå±æ€§æ¥åŒ¹é…
                const userButtons = userFilterContainer.querySelectorAll('.user-btn:not(:first-child)');
                userButtons.forEach(btn => {
                    const btnUserId = btn.getAttribute('data-user-id');
                    if (btnUserId === currentUserFilter) {
                        btn.classList.add('active');
                    }
                });
            }
        }
        
        // æ ¹æ®ç”¨æˆ·IDè·å–æ˜¾ç¤ºåç§°
        function getUserDisplayNameById(userId, usersList = null) {
            // å¦‚æœæä¾›äº†ç”¨æˆ·åˆ—è¡¨ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
            if (usersList && Array.isArray(usersList)) {
                const user = usersList.find(u => u.id === userId);
                return user ? (user.name || user.email) : userId;
            }
            // å¦åˆ™è¿”å›userIdï¼ˆé€šå¸¸åœ¨æ— æ³•è·å–ç”¨æˆ·åˆ—è¡¨æ—¶ä½¿ç”¨ï¼‰
            return userId;
        }
        
// æ›´æ–°æ•°æ®æŒ‡æ ‡å¡ç‰‡
        function updateStatCards(stats) {
            // ç¡®ä¿statså¯¹è±¡å­˜åœ¨
            if (!stats) {
                console.error('ç»Ÿè®¡æ•°æ®ä¸ºç©º');
                return;
            }
            
            // æ›´æ–°å‘è´§æ•°é‡ - ç¬¬äºŒä¸ªstat-cardå¯¹åº”idä¸ºdayShipments
            const dayShipmentsElement = document.getElementById('dayShipments');
            if (dayShipmentsElement) {
                const shipmentsValue = stats.totalShipments || 0;
                dayShipmentsElement.textContent = Math.round(shipmentsValue);
            }
            
            // æ›´æ–°é”€å”®é¢ - ç¬¬ä¸‰ä¸ªstat-cardå¯¹åº”idä¸ºdaySales
            const daySalesElement = document.getElementById('daySales');
            if (daySalesElement) {
                const salesValue = stats.totalSales || 0;
                daySalesElement.textContent = Utils.formatCurrency(salesValue);
            }
            
            // æ›´æ–°é”€å”®åˆ©æ¶¦ - ç¬¬å››ä¸ªstat-cardå¯¹åº”idä¸ºdayProfit
            const dayProfitElement = document.getElementById('dayProfit');
            if (dayProfitElement) {
                const profitValue = stats.totalProfit || 0;
                dayProfitElement.textContent = Utils.formatCurrency(profitValue);
            }
        }
        
// æ›´æ–°å•†å“æ˜ç»†è¡¨æ ¼
        function updateProductDetailTable(stats) {
            console.log('=== updateProductDetailTable è°ƒç”¨å¼€å§‹ ===');
            console.log('ä¼ å…¥çš„statså¯¹è±¡:', stats);
            
            const tableBody = document.getElementById('productDetailList');
            if (!tableBody) {
                console.error('âŒ æœªæ‰¾åˆ°å•†å“æ˜ç»†è¡¨æ ¼å…ƒç´ ');
                return;
            }
            
            // æ¸…ç©ºç°æœ‰æ•°æ®
            tableBody.innerHTML = '';
            
            // æ•°æ®éªŒè¯
            if (!stats) {
                console.error('âŒ statså‚æ•°ä¸ºç©º');
                showErrorRow(tableBody, 'æ•°æ®åŠ è½½å¤±è´¥ï¼šstatså¯¹è±¡ä¸ºç©º');
                return;
            }
            
            if (!stats.filteredHistory || stats.filteredHistory.length === 0) {
                console.warn('âš ï¸ filteredHistoryä¸ºç©ºæˆ–æœªå®šä¹‰');
                showInfoRow(tableBody, 'æš‚æ— å‘è´§ä»»åŠ¡æ•°æ®');
                return;
            }
            
            // æ£€æŸ¥äº§å“æ•°æ®æº
            let allProducts = [];
            let dataSource = 'unknown';
            
            if (stats.allProducts && Array.isArray(stats.allProducts) && stats.allProducts.length > 0) {
                allProducts = stats.allProducts;
                dataSource = 'allProducts';
                console.log('âœ… ä½¿ç”¨stats.allProductsä½œä¸ºæ•°æ®æºï¼Œå…±', allProducts.length, 'ä¸ªäº§å“');
            } else if (stats.productStats) {
                // ä»productStatsä¸­æå–äº§å“ä¿¡æ¯
                allProducts = Object.values(stats.productStats).map(p => ({
                    id: p.id,
                    product_code: p.code,
                    product_name: p.name,
                    product_supplier: p.supplier,
                    purchase_price: p.purchasePrice,
                    sale_price: p.salePrice
                }));
                dataSource = 'productStats';
                console.log('âœ… ä½¿ç”¨stats.productStatsä½œä¸ºæ•°æ®æºï¼Œå…±', allProducts.length, 'ä¸ªäº§å“');
            } else {
                console.warn('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„äº§å“æ•°æ®æº');
                console.log('statså¯¹è±¡ç»“æ„:', Object.keys(stats));
                showWarningRow(tableBody, 'ç¼ºå°‘äº§å“ä»·æ ¼ä¿¡æ¯ï¼Œæ— æ³•è®¡ç®—æ˜ç»†æ•°æ®');
                return;
            }
            
            console.log('æ•°æ®æºè¯¦æƒ…:', {
                source: dataSource,
                productCount: allProducts.length,
                sampleProduct: allProducts[0],
                taskCount: stats.filteredHistory.length
            });
            
            // å¤„ç†å•†å“æ•°æ®
            const productMap = {};
            
            console.log('å¼€å§‹å¤„ç†ä»»åŠ¡æ•°æ®ï¼Œä»»åŠ¡æ€»æ•°:', stats.filteredHistory.length);
            
            let processedItemCount = 0;
            let missingProductCount = 0;
            
            stats.filteredHistory.forEach((task, taskIndex) => {
                console.log(`å¤„ç†ä»»åŠ¡ ${taskIndex + 1}/${stats.filteredHistory.length}:`, task.taskNumber || task.id);
                
                if (task.items && Array.isArray(task.items)) {
                    task.items.forEach((item, itemIndex) => {
                        processedItemCount++;
                        const productId = item.productId || item.product_id;
                        
                        if (!productId) {
                            console.warn(`âš ï¸ ä»»åŠ¡${taskIndex + 1}çš„ç¬¬${itemIndex + 1}ä¸ªå•†å“ç¼ºå°‘productId:`, item);
                            return;
                        }
                        
                        // æŸ¥æ‰¾å®Œæ•´çš„äº§å“ä¿¡æ¯
                        const fullProduct = allProducts.find(p => p.id == productId);
                        
                        if (!fullProduct) {
                            missingProductCount++;
                            console.warn(`âš ï¸ æœªæ‰¾åˆ°productId=${productId}çš„äº§å“ä¿¡æ¯`);
                            console.log('  å¯ç”¨äº§å“IDåˆ—è¡¨(å‰10ä¸ª):', allProducts.slice(0, 10).map(p => p.id));
                        }
                        
                        if (!productMap[productId]) {
                            // è·å–ä¾›åº”å•†ä¿¡æ¯
                            let supplier = 'æœªçŸ¥ä¾›åº”å•†';
                            if (item.productSupplier) {
                                supplier = item.productSupplier;
                            } else if (item.supplier) {
                                supplier = item.supplier;
                            } else if (fullProduct && fullProduct.product_supplier) {
                                supplier = fullProduct.product_supplier;
                            } else if (fullProduct && fullProduct.supplier) {
                                supplier = fullProduct.supplier;
                            }
                            
                            // è·å–ä»·æ ¼ä¿¡æ¯
                            const purchasePrice = fullProduct ? 
                                (parseFloat(fullProduct.purchase_price) || parseFloat(fullProduct.purchasePrice) || 0) : 0;
                            const salePrice = fullProduct ? 
                                (parseFloat(fullProduct.sale_price) || parseFloat(fullProduct.salePrice) || 0) : 
                                (parseFloat(item.salePrice) || parseFloat(item.sale_price) || 0);
                            
                            productMap[productId] = {
                                name: item.productName || (fullProduct ? (fullProduct.product_name || fullProduct.name) : 'æœªçŸ¥å•†å“'),
                                code: item.productCode || (fullProduct ? (fullProduct.product_code || fullProduct.code) : 'N/A'),
                                supplier: supplier,
                                quantity: 0,
                                purchasePrice: purchasePrice,
                                salePrice: salePrice,
                                sales: 0,
                                profit: 0
                            };
                            
                            console.log(`  åˆ›å»ºå•†å“æ˜ å°„: ${productMap[productId].name}(ID:${productId})`);
                            console.log(`    ä»·æ ¼ä¿¡æ¯: è¿›è´§ä»·=${purchasePrice}, é”€å”®ä»·=${salePrice}`);
                        }
                        
                        const quantity = parseInt(item.quantity) || 0;
                        const purchasePrice = productMap[productId].purchasePrice;
                        const salePrice = productMap[productId].salePrice;
                        
                        productMap[productId].quantity += quantity;
                        productMap[productId].sales += salePrice * quantity;
                        productMap[productId].profit += (salePrice - purchasePrice) * quantity;
                        
                        if (quantity > 0) {
                            console.log(`  ç´¯è®¡å•†å“: ${productMap[productId].name} x${quantity}, é”€å”®é¢: ${(salePrice * quantity).toFixed(2)}`);
                        }
                    });
                } else {
                    console.warn(`âš ï¸ ä»»åŠ¡${taskIndex + 1}ç¼ºå°‘æœ‰æ•ˆçš„itemsæ•°æ®:`, task.items);
                }
            });
            
            console.log('æ•°æ®å¤„ç†å®Œæˆ:', {
                processedItems: processedItemCount,
                missingProducts: missingProductCount,
                uniqueProducts: Object.keys(productMap).length
            });
            
            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            const sortedProducts = Object.values(productMap)
                .filter(p => p.quantity > 0) // åªæ˜¾ç¤ºæœ‰æ•°é‡çš„å•†å“
                .sort((a, b) => b.quantity - a.quantity);
            
            console.log('å‡†å¤‡æ¸²æŸ“è¡¨æ ¼ï¼Œæœ‰æ•ˆå•†å“æ•°é‡:', sortedProducts.length);
            
            if (sortedProducts.length > 0) {
                sortedProducts.forEach((product, index) => {
                    console.log(`æ¸²æŸ“å•†å“ ${index + 1}:`, {
                        name: product.name,
                        quantity: product.quantity,
                        purchasePrice: product.purchasePrice,
                        salePrice: product.salePrice,
                        sales: product.sales,
                        profit: product.profit
                    });
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${escapeHtml(product.name || 'æœªçŸ¥å•†å“')}</td>
                        <td>${escapeHtml(product.code || 'N/A')}</td>
                        <td>${escapeHtml(product.supplier || 'æœªçŸ¥ä¾›åº”å•†')}</td>
                        <td>${product.quantity || 0}</td>
                        <td>${Utils.formatCurrency(product.purchasePrice || 0)}</td>
                        <td>${Utils.formatCurrency(product.salePrice || 0)}</td>
                        <td>${Utils.formatCurrency(product.sales || 0)}</td>
                        <td>${Utils.formatCurrency(product.profit || 0)}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // æ·»åŠ æ±‡æ€»è¡Œ
                const totalQuantity = sortedProducts.reduce((sum, p) => sum + (p.quantity || 0), 0);
                const totalSales = sortedProducts.reduce((sum, p) => sum + (p.sales || 0), 0);
                const totalProfit = sortedProducts.reduce((sum, p) => sum + (p.profit || 0), 0);
                
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'table-summary';
                summaryRow.innerHTML = `
                    <td><strong>æ€»è®¡</strong></td>
                    <td colspan="2"></td>
                    <td><strong>${totalQuantity}</strong></td>
                    <td></td>
                    <td></td>
                    <td><strong>${Utils.formatCurrency(totalSales)}</strong></td>
                    <td><strong>${Utils.formatCurrency(totalProfit)}</strong></td>
                `;
                tableBody.appendChild(summaryRow);
                
                console.log('âœ… è¡¨æ ¼æ¸²æŸ“å®Œæˆï¼Œå…±', sortedProducts.length, 'ä¸ªå•†å“');
            } else {
                console.warn('âš ï¸ æ²¡æœ‰æœ‰æ•ˆå•†å“æ•°æ®å¯æ˜¾ç¤º');
                showInfoRow(tableBody, 'æš‚æ— æœ‰æ•ˆçš„å•†å“æ˜ç»†æ•°æ®');
            }
            
            console.log('=== updateProductDetailTable è°ƒç”¨ç»“æŸ ===');
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºé”™è¯¯è¡Œ
        function showErrorRow(tableBody, message) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="8" class="text-center text-danger py-4"><i class="fas fa-exclamation-circle"></i> ${message}</td>`;
            tableBody.appendChild(row);
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºè­¦å‘Šè¡Œ
        function showWarningRow(tableBody, message) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="8" class="text-center text-warning py-4"><i class="fas fa-exclamation-triangle"></i> ${message}</td>`;
            tableBody.appendChild(row);
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºä¿¡æ¯è¡Œ
        function showInfoRow(tableBody, message) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="8" class="text-center text-muted py-4"><i class="fas fa-info-circle"></i> ${message}</td>`;
            tableBody.appendChild(row);
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šHTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æ—¶é—´ç­›é€‰å‡½æ•°
        function filterStatistics(filter, clickedButton) {
            currentStatisticsFilter = filter;
            
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            loadStatisticsDashboardData();
        }
        
        // äººå‘˜ç­›é€‰å‡½æ•°
        function filterByUser(userId, clickedButton) {
            currentUserFilter = userId;
            
            // ä¸å†æ‰‹åŠ¨å¤„ç†æ¿€æ´»çŠ¶æ€ï¼Œè€Œæ˜¯é€šè¿‡updateUserFilterActiveStateç»Ÿä¸€ç®¡ç†
            
            // é‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®ä»¥åº”ç”¨ç”¨æˆ·ç­›é€‰
            loadStatisticsDashboardData();
        }
        
        // å¯¼å‡ºç»Ÿè®¡åˆ†æç›¸å…³å‡½æ•°
        window.loadStatisticsDashboardData = loadStatisticsDashboardData;
        window.filterStatistics = filterStatistics;
        window.filterByUser = filterByUser;
        
        // CSVä¸‹è½½åŠŸèƒ½
        function downloadProductDetailsCSV() {
            const tableBody = document.getElementById('productDetailList');
            if (!tableBody) {
                alert('æœªæ‰¾åˆ°å•†å“æ˜ç»†è¡¨æ ¼');
                return;
            }
            
            // è·å–è¡¨æ ¼æ•°æ®
            const rows = tableBody.querySelectorAll('tr');
            if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector('td[colspan]'))) {
                alert('æš‚æ— å•†å“æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // æ„å»ºCSVå†…å®¹
            let csvContent = '\uFEFF'; // æ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡
            
            // æ·»åŠ è¡¨å¤´
            csvContent += 'å•†å“åç§°,å•†å“ç¼–ç ,ä¾›åº”å•†,æ•°é‡,è¿›è´§ä»·,é”€å”®ä»·,é”€å”®é¢,åˆ©æ¶¦\n';
            
            // æ·»åŠ æ•°æ®è¡Œ
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
                    const rowData = [
                        cells[0].textContent.trim(),
                        cells[1].textContent.trim(),
                        cells[2].textContent.trim(),
                        cells[3].textContent.trim(),
                        cells[4].textContent.trim().replace('Â¥', ''),
                        cells[5].textContent.trim().replace('Â¥', ''),
                        cells[6].textContent.trim().replace('Â¥', ''),
                        cells[7].textContent.trim().replace('Â¥', '')
                    ];
                    csvContent += rowData.join(',') + '\n';
                }
            });
            
            // ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦å½“å‰æ—¥æœŸï¼‰
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const filename = `å•†å“æ˜ç»†_${year}${month}${day}.csv`;
            
            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        window.downloadProductDetailsCSV = downloadProductDetailsCSV;
    </script>
    
    <!-- ä»“åº“ä»»åŠ¡å¡å»¶è¿Ÿä¿®å¤è„šæœ¬ -->
    <!-- å·²ç§»é™¤ä¸å­˜åœ¨çš„ delayed_warehouse_fix.js -->
    
    <!-- ä»“åº“ä»»åŠ¡æ ·å¼ç»Ÿä¸€è„šæœ¬ -->
    <!-- <script src="warehouse_style_unification.js"></script> -->
    
    <!-- å·²ç§»é™¤MutationObserverä¿®å¤éªŒè¯è„šæœ¬ -->
    
    <!-- ä»“åº“ä»»åŠ¡åµŒå¥—ä¿®å¤åŠŸèƒ½å·²æ•´åˆåˆ°ç»Ÿä¸€æ¨¡å—ä¸­ -->
    <!-- ä»“åº“ä»»åŠ¡æ®‹ç•™é—®é¢˜æ·±åº¦æ¸…ç†è„šæœ¬ -->
    <script src="deep_clean_warehouse_residuals.js"></script>
    <!-- ä»“åº“ä»»åŠ¡å¸ƒå±€å·²æ•´åˆåˆ°ç»Ÿä¸€æ ·å¼ä¸­ -->
    
    <!-- æµ‹è¯•ä»»åŠ¡åŠŸèƒ½å·²ç§»é™¤ -->
    
    <!-- æ ·å¼éªŒè¯è„šæœ¬ -->
    <script src="verify_warehouse_styles.js"></script>
    
    <!-- ä»“åº“ä»»åŠ¡ç»“æ„å’Œé‡å ä¿®å¤åŠŸèƒ½å·²æ•´åˆåˆ°ç»Ÿä¸€æ¨¡å—ä¸­ -->
    
    <!-- ä»“åº“ä»»åŠ¡éªŒè¯åŠŸèƒ½å·²ç§»é™¤ -->
    
    <!-- ä»“åº“ä»»åŠ¡ç»“æ„éªŒè¯è„šæœ¬ -->
    <script src="verify_warehouse_structure.js"></script>
    
    <!-- ä»»åŠ¡ä¿¡æ¯è¦†ç›–å±‚è„šæœ¬ -->
    <script>
    (function() {
        'use strict';
        
        console.log('ğŸ¨ å¼€å§‹åˆå§‹åŒ–ä»»åŠ¡ä¿¡æ¯è¦†ç›–å±‚...');
        
        // è¦†ç›–å±‚é…ç½®
        const OVERLAY_CONFIG = {
            backgroundColor: 'rgba(0, 0, 0, 0.7)',
            textColor: '#ffffff',
            fontSize: '14px',
            padding: '12px',
            borderRadius: '0 0 6px 6px',
            minHeight: '60px'
        };
        
        // åˆ›å»ºä¿¡æ¯è¦†ç›–å±‚
        function createInfoOverlay(imgContainer, taskData) {
            // å¦‚æœå·²æœ‰è¦†ç›–å±‚ï¼Œå…ˆç§»é™¤
            const existingOverlay = imgContainer.querySelector('.task-info-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // åˆ›å»ºè¦†ç›–å±‚å®¹å™¨
            const overlay = document.createElement('div');
            overlay.className = 'task-info-overlay';
            
            // åˆ›å»ºå†…å®¹å®¹å™¨
            const content = document.createElement('div');
            content.className = 'task-info-content';
            
            // å•†å“åç§°
            const nameDiv = document.createElement('div');
            nameDiv.className = 'task-info-name';
            nameDiv.textContent = taskData.name || 'æœªçŸ¥å•†å“';
            
            // æ•°é‡ - åªæ˜¾ç¤ºæ•°å€¼
            const quantitySpan = document.createElement('span');
            quantitySpan.className = 'task-info-quantity';
            quantitySpan.textContent = taskData.quantity || 0;
            
            // åˆ›å»ºäºº
            const creatorSpan = document.createElement('span');
            creatorSpan.className = 'task-info-creator';
            creatorSpan.textContent = taskData.creator || 'æœªçŸ¥åˆ›å»ºäºº';
            
            // ç»„è£…DOMç»“æ„ - æ°´å¹³æ’åˆ—ï¼šå•†å“åç§° - æ•°é‡ - åˆ›å»ºäºº
            content.appendChild(nameDiv);
            content.appendChild(quantitySpan);
            content.appendChild(creatorSpan);
            overlay.appendChild(content);
            
            // æ·»åŠ åˆ°å›¾ç‰‡å®¹å™¨
            imgContainer.style.position = 'relative';
            imgContainer.appendChild(overlay);
            
            return overlay;
        }
        
        // ä»ç°æœ‰DOMç»“æ„æå–ä»»åŠ¡æ•°æ®
        function extractTaskData(taskElement) {
            const data = {};
            
            // æŸ¥æ‰¾å•†å“åç§°
            const nameElement = taskElement.querySelector('.task-gallery-name');
            data.name = nameElement ? nameElement.textContent.trim() : '';
            
            // æŸ¥æ‰¾æ•°é‡ä¿¡æ¯
            const qtyElement = taskElement.querySelector('.task-gallery-qty');
            if (qtyElement) {
                const qtyText = qtyElement.textContent.trim();
                const qtyMatch = qtyText.match(/(\d+)/);
                data.quantity = qtyMatch ? parseInt(qtyMatch[1]) : 0;
            } else {
                data.quantity = 0;
            }
            
            // æŸ¥æ‰¾åˆ›å»ºäººä¿¡æ¯
            const creatorElement = taskElement.querySelector('.task-gallery-creator');
            data.creator = creatorElement ? creatorElement.textContent.replace('åˆ›å»ºäºº:', '').trim() : '';
            
            return data;
        }
        
        // åº”ç”¨è¦†ç›–å±‚åˆ°æ‰€æœ‰ä»»åŠ¡å¡ç‰‡
        function applyOverlays() {
            // æŸ¥æ‰¾æ‰€æœ‰ä»»åŠ¡å›¾ç‰‡å®¹å™¨
            const imgContainers = document.querySelectorAll('.task-gallery-img');
            let appliedCount = 0;
            
            imgContainers.forEach(container => {
                // æ‰¾åˆ°å¯¹åº”çš„çˆ¶çº§ä»»åŠ¡å…ƒç´ 
                const taskFront = container.closest('.task-front');
                if (taskFront) {
                    const taskData = extractTaskData(taskFront);
                    if (taskData.name || taskData.quantity > 0) {
                        createInfoOverlay(container, taskData);
                        appliedCount++;
                    }
                }
            });
            
            console.log(`âœ… å·²ä¸º ${appliedCount} ä¸ªä»»åŠ¡å¡ç‰‡æ·»åŠ ä¿¡æ¯è¦†ç›–å±‚`);
            return appliedCount;
        }
        
        // ç›‘å¬åŠ¨æ€å†…å®¹å˜åŒ–
        function observeDynamicContent() {
            const observer = new MutationObserver((mutations) => {
                let shouldApply = false;
                
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // æ£€æŸ¥æ˜¯å¦æ·»åŠ äº†æ–°çš„ä»»åŠ¡å›¾ç‰‡å®¹å™¨
                                if (node.classList && node.classList.contains('task-gallery-img')) {
                                    shouldApply = true;
                                }
                                
                                // æ£€æŸ¥å­å…ƒç´ ä¸­æ˜¯å¦æœ‰ä»»åŠ¡ç›¸å…³å…ƒç´ 
                                const taskElements = node.querySelectorAll('.task-gallery-img, .task-front');
                                if (taskElements.length > 0) {
                                    shouldApply = true;
                                }
                            }
                        });
                    }
                });
                
                if (shouldApply) {
                    setTimeout(() => {
                        applyOverlays();
                    }, 100);
                }
            });
            
            // å¼€å§‹è§‚å¯Ÿ
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
                    
            // æ·»åŠ å…¨å±€è¯Šæ–­å‡½æ•°
            window.diagnoseBackDisplay = function() {
                console.log('ğŸ” ä»»åŠ¡å¡ç‰‡èƒŒé¢æ˜¾ç¤ºè¯Šæ–­å¼€å§‹...');
                        
                // æ£€æŸ¥èƒŒé¢å…ƒç´ 
                const taskBacks = document.querySelectorAll('.task-back');
                console.log('ğŸ“Š èƒŒé¢å…ƒç´ ç»Ÿè®¡: ' + taskBacks.length + ' ä¸ª');
                        
                // æ£€æŸ¥ç¿»è½¬çŠ¶æ€çš„ä»»åŠ¡
                const flippedContainers = document.querySelectorAll('.task-flip-container.flipped');
                console.log('ğŸ”„ å·²ç¿»è½¬çš„ä»»åŠ¡: ' + flippedContainers.length + ' ä¸ª');
                        
                // è¯¦ç»†æ£€æŸ¥æ¯ä¸ªèƒŒé¢å…ƒç´ 
                for (let i = 0; i < taskBacks.length; i++) {
                    const backElement = taskBacks[i];
                    const taskId = backElement.dataset.taskId || 'unknown';
                    const isVisible = backElement.offsetParent !== null;
                    const hasContent = backElement.children.length > 0;
                    const computedStyle = window.getComputedStyle(backElement);
                            
                    console.log('');
                    console.log('ğŸ“‹ èƒŒé¢å…ƒç´  ' + (i + 1) + ' (ä»»åŠ¡ID: ' + taskId + '):');
                    console.log('   - å¯è§æ€§: ' + (isVisible ? 'âœ… å¯è§' : 'âŒ ä¸å¯è§'));
                    console.log('   - å†…å®¹: ' + (hasContent ? 'âœ… æœ‰å†…å®¹' : 'âŒ æ— å†…å®¹'));
                    console.log('   - display: ' + computedStyle.display);
                    console.log('   - position: ' + computedStyle.position);
                    console.log('   - transform: ' + computedStyle.transform);
                    console.log('   - zIndex: ' + computedStyle.zIndex);
                    console.log('   - backgroundColor: ' + computedStyle.backgroundColor);
                            
                    // æ£€æŸ¥æ–‡ä»¶åŒºåŸŸ
                    const fileSections = backElement.querySelectorAll('[id$="-files-' + taskId + '"]');
                    console.log('   - æ–‡ä»¶åŒºåŸŸ: ' + fileSections.length + ' ä¸ª');
                            
                    for (let j = 0; j < fileSections.length; j++) {
                        const section = fileSections[j];
                        const sectionId = section.id;
                        const sectionContent = section.textContent.trim();
                        console.log('     ' + (j + 1) + '. ' + sectionId + ': "' + sectionContent + '"');
                    }
                }
                        
                // æµ‹è¯•ç¿»è½¬æ˜¾ç¤º
                if (taskBacks.length > 0) {
                    console.log('');
                    console.log('ğŸ§ª æµ‹è¯•ç¿»è½¬æ˜¾ç¤º...');
                    const firstTaskFront = document.querySelector('.task-front[id^="task-"]');
                    if (firstTaskFront) {
                        const taskId = firstTaskFront.id.replace('task-', '').replace('-front', '');
                        console.log('   æµ‹è¯•ä»»åŠ¡ID: ' + taskId);
                                
                        // ç¿»è½¬åˆ°èƒŒé¢
                        if (typeof window.toggleTaskCardFlip === 'function') {
                            window.toggleTaskCardFlip(taskId);
                            setTimeout(function() {
                                const backElement = document.querySelector('.task-back[data-task-id="' + taskId + '"]');
                                if (backElement) {
                                    const isVisible = backElement.offsetParent !== null;
                                    console.log('   ç¿»è½¬åèƒŒé¢å¯è§æ€§: ' + (isVisible ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'));
                                            
                                    // æ£€æŸ¥å…·ä½“å†…å®¹
                                    const fileSections = backElement.querySelectorAll('[id$="-files-' + taskId + '"]');
                                    console.log('   æ–‡ä»¶åŒºåŸŸæ•°é‡: ' + fileSections.length);
                                            
                                    // è¿”å›æ­£é¢
                                    setTimeout(function() {
                                        window.toggleTaskCardFlip(taskId);
                                        console.log('âœ… æµ‹è¯•å®Œæˆï¼Œå·²è¿”å›æ­£é¢');
                                    }, 1000);
                                }
                            }, 600);
                        }
                    }
                }
                        
                console.log('');
                console.log('ğŸ è¯Šæ–­å®Œæˆ');
                return {
                    backCount: taskBacks.length,
                    flippedCount: flippedContainers.length
                };
            };
                    
            console.log('ğŸ”§ ç²¾ç®€ç‰ˆèƒŒé¢ä¿®å¤å®Œæˆï¼Œè¯Šæ–­å‡½æ•°å·²æ·»åŠ åˆ°å…¨å±€');
            console.log('ğŸ’¡ æç¤º: åœ¨æ§åˆ¶å°è¾“å…¥ diagnoseBackDisplay() å¯è¿è¡Œè¯Šæ–­');
            
            console.log('ğŸ” ä»»åŠ¡ä¿¡æ¯è¦†ç›–å±‚ç›‘å¬å™¨å·²å¯åŠ¨');
        }
        
        // åˆå§‹åŒ–å‡½æ•°
        function initialize() {
            // ç­‰å¾…DOMåŠ è½½å®Œæˆååº”ç”¨è¦†ç›–å±‚
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(applyOverlays, 500);
                    observeDynamicContent();
                });
            } else {
                setTimeout(applyOverlays, 500);
                observeDynamicContent();
            }
        }
        
        // æä¾›å…¨å±€æ§åˆ¶å‡½æ•°
        window.toggleTaskInfoOverlay = function(show = true) {
            const overlays = document.querySelectorAll('.task-info-overlay');
            overlays.forEach(overlay => {
                overlay.style.display = show ? 'flex' : 'none';
            });
            
            if (show) {
                console.log('ğŸ‘ï¸ ä»»åŠ¡ä¿¡æ¯è¦†ç›–å±‚å·²æ˜¾ç¤º');
            } else {
                console.log('ğŸ™ˆ ä»»åŠ¡ä¿¡æ¯è¦†ç›–å±‚å·²éšè—');
            }
        };
        
        window.refreshTaskInfoOverlay = function() {
            // ç§»é™¤æ‰€æœ‰ç°æœ‰è¦†ç›–å±‚
            document.querySelectorAll('.task-info-overlay').forEach(overlay => overlay.remove());
            // é‡æ–°åº”ç”¨
            applyOverlays();
            console.log('ğŸ”„ ä»»åŠ¡ä¿¡æ¯è¦†ç›–å±‚å·²åˆ·æ–°');
        };
        
        // å¯åŠ¨åˆå§‹åŒ–
        initialize();
        
        console.log('âœ¨ ä»»åŠ¡ä¿¡æ¯è¦†ç›–å±‚ç³»ç»Ÿå·²åŠ è½½å®Œæˆ');
        
    })();
    </script>
</body>
</html>

<!-- å…¨å±€è¯Šæ–­å‡½æ•° -->
<script>
window.diagnoseBackDisplay = function() {
    console.log('ğŸ” ä»»åŠ¡å¡ç‰‡èƒŒé¢æ˜¾ç¤ºè¯Šæ–­å¼€å§‹...');
    
    // æ£€æŸ¥èƒŒé¢å…ƒç´ 
    const taskBacks = document.querySelectorAll('.task-back');
    console.log('ğŸ“Š èƒŒé¢å…ƒç´ ç»Ÿè®¡: ' + taskBacks.length + ' ä¸ª');
    
    // æ£€æŸ¥ç¿»è½¬çŠ¶æ€çš„ä»»åŠ¡
    const flippedContainers = document.querySelectorAll('.task-flip-container.flipped');
    console.log('ğŸ”„ å·²ç¿»è½¬çš„ä»»åŠ¡: ' + flippedContainers.length + ' ä¸ª');
    
    // è¯¦ç»†æ£€æŸ¥æ¯ä¸ªèƒŒé¢å…ƒç´ 
    for (let i = 0; i < taskBacks.length; i++) {
        const backElement = taskBacks[i];
        const taskId = backElement.dataset.taskId || 'unknown';
        const isVisible = backElement.offsetParent !== null;
        const hasContent = backElement.children.length > 0;
        const computedStyle = window.getComputedStyle(backElement);
        
        console.log('');
        console.log('ğŸ“‹ èƒŒé¢å…ƒç´  ' + (i + 1) + ' (ä»»åŠ¡ID: ' + taskId + '):');
        console.log('   - å¯è§æ€§: ' + (isVisible ? 'âœ… å¯è§' : 'âŒ ä¸å¯è§'));
        console.log('   - å†…å®¹: ' + (hasContent ? 'âœ… æœ‰å†…å®¹' : 'âŒ æ— å†…å®¹'));
        console.log('   - display: ' + computedStyle.display);
        console.log('   - position: ' + computedStyle.position);
        console.log('   - transform: ' + computedStyle.transform);
        console.log('   - zIndex: ' + computedStyle.zIndex);
        console.log('   - backgroundColor: ' + computedStyle.backgroundColor);
        
        // æ£€æŸ¥æ–‡ä»¶åŒºåŸŸ
        const fileSections = backElement.querySelectorAll('[id$="-files-' + taskId + '"]');
        console.log('   - æ–‡ä»¶åŒºåŸŸ: ' + fileSections.length + ' ä¸ª');
        
        for (let j = 0; j < fileSections.length; j++) {
            const section = fileSections[j];
            const sectionId = section.id;
            const sectionContent = section.textContent.trim();
            console.log('     ' + (j + 1) + '. ' + sectionId + ': "' + sectionContent + '"');
        }
    }
    
    // æµ‹è¯•ç¿»è½¬æ˜¾ç¤º
    if (taskBacks.length > 0) {
        console.log('');
        console.log('ğŸ§ª æµ‹è¯•ç¿»è½¬æ˜¾ç¤º...');
        const firstTaskFront = document.querySelector('.task-front[id^="task-"]');
        if (firstTaskFront) {
            const taskId = firstTaskFront.id.replace('task-', '').replace('-front', '');
            console.log('   æµ‹è¯•ä»»åŠ¡ID: ' + taskId);
            
            // ç¿»è½¬åˆ°èƒŒé¢
            if (typeof window.toggleTaskCardFlip === 'function') {
                window.toggleTaskCardFlip(taskId);
                setTimeout(function() {
                    const backElement = document.querySelector('.task-back[data-task-id="' + taskId + '"]');
                    if (backElement) {
                        const isVisible = backElement.offsetParent !== null;
                        console.log('   ç¿»è½¬åèƒŒé¢å¯è§æ€§: ' + (isVisible ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'));
                        
                        // æ£€æŸ¥å…·ä½“å†…å®¹
                        const fileSections = backElement.querySelectorAll('[id$="-files-' + taskId + '"]');
                        console.log('   æ–‡ä»¶åŒºåŸŸæ•°é‡: ' + fileSections.length);
                        
                        // è¿”å›æ­£é¢
                        setTimeout(function() {
                            window.toggleTaskCardFlip(taskId);
                            console.log('âœ… æµ‹è¯•å®Œæˆï¼Œå·²è¿”å›æ­£é¢');
                        }, 1000);
                    }
                }, 600);
            }
        }
    }
    
    console.log('');
    console.log('ğŸ è¯Šæ–­å®Œæˆ');
    return {
        backCount: taskBacks.length,
        flippedCount: flippedContainers.length
    };
};

console.log('âœ… å…¨å±€è¯Šæ–­å‡½æ•°å·²æ·»åŠ ');
console.log('ğŸ’¡ ä½¿ç”¨æ–¹æ³•: åœ¨æ§åˆ¶å°è¾“å…¥ diagnoseBackDisplay()');

// æ·»åŠ ç¿»è½¬æµ‹è¯•å‡½æ•°
window.testCardFlip = function() {
    console.log('ğŸ”„ å¼€å§‹æµ‹è¯•å¡ç‰‡ç¿»è½¬åŠŸèƒ½...');
    
    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªä»»åŠ¡å¡ç‰‡
    const firstTaskFront = document.querySelector('.task-front[id^="task-"]');
    if (!firstTaskFront) {
        console.error('âŒ æœªæ‰¾åˆ°ä»»åŠ¡å¡ç‰‡');
        return;
    }
    
    const taskId = firstTaskFront.id.replace('task-', '').replace('-front', '');
    console.log('ğŸ¯ æµ‹è¯•ä»»åŠ¡ID: ' + taskId);
    
    // æ£€æŸ¥ç¿»è½¬å‡½æ•°æ˜¯å¦å­˜åœ¨
    if (typeof window.toggleTaskCardFlip !== 'function') {
        console.error('âŒ ç¿»è½¬å‡½æ•°ä¸å­˜åœ¨');
        return;
    }
    
    console.log('âœ… ç¿»è½¬å‡½æ•°å¯ç”¨ï¼Œæ‰§è¡Œç¿»è½¬...');
    
    // æ‰§è¡Œç¿»è½¬
    window.toggleTaskCardFlip(taskId);
    
    // ç­‰å¾…ç¿»è½¬å®Œæˆåå†æ£€æŸ¥
    setTimeout(function() {
        const backElement = document.querySelector('.task-back[data-task-id="' + taskId + '"]');
        if (backElement) {
            const isVisible = backElement.offsetParent !== null;
            console.log('ğŸ“Š ç¿»è½¬åçŠ¶æ€:');
            console.log('   èƒŒé¢å…ƒç´ å¯è§: ' + (isVisible ? 'âœ… æ˜¯' : 'âŒ å¦'));
            
            // æ£€æŸ¥æ–‡ä»¶åŒºåŸŸ
            const fileSections = backElement.querySelectorAll('[id$="-files-' + taskId + '"]');
            console.log('   æ–‡ä»¶åŒºåŸŸæ•°é‡: ' + fileSections.length);
            
            // æ˜¾ç¤ºæ–‡ä»¶åŒºåŸŸå†…å®¹
            fileSections.forEach(function(section, index) {
                console.log('   åŒºåŸŸ ' + (index + 1) + ': ' + section.id + ' - "' + section.textContent.trim() + '"');
            });
            
            // 3ç§’åè‡ªåŠ¨è¿”å›
            setTimeout(function() {
                console.log('â†©ï¸ è‡ªåŠ¨è¿”å›æ­£é¢...');
                window.toggleTaskCardFlip(taskId);
            }, 3000);
        }
    }, 600);
};

console.log('ğŸ’¡ ç¿»è½¬æµ‹è¯•å‡½æ•°å·²æ·»åŠ : testCardFlip()');

// æ·»åŠ æŸ¥çœ‹å½“å‰ç¿»è½¬ä»»åŠ¡çš„å‡½æ•°
window.inspectFlippedCard = function() {
    console.log('ğŸ” æ£€æŸ¥å½“å‰ç¿»è½¬çš„ä»»åŠ¡å¡ç‰‡...');
    
    const flippedContainer = document.querySelector('.task-flip-container.flipped');
    if (!flippedContainer) {
        console.log('âŒ å½“å‰æ²¡æœ‰ç¿»è½¬çš„ä»»åŠ¡');
        return;
    }
    
    const taskId = flippedContainer.dataset.taskId;
    console.log('ğŸ¯ å½“å‰ç¿»è½¬çš„ä»»åŠ¡ID: ' + taskId);
    
    const backElement = flippedContainer.querySelector('.task-back');
    if (backElement) {
        console.log('ğŸ“Š èƒŒé¢å…ƒç´ è¯¦æƒ…:');
        console.log('   dataset.taskId: ' + backElement.dataset.taskId);
        console.log('   offsetParent: ' + (backElement.offsetParent ? 'âœ… å¯è§' : 'âŒ ä¸å¯è§'));
        console.log('   childrenæ•°é‡: ' + backElement.children.length);
        
        // æ£€æŸ¥æ–‡ä»¶åŒºåŸŸ
        const fileSections = backElement.querySelectorAll('[id$="-files-' + taskId + '"]');
        console.log('   æ–‡ä»¶åŒºåŸŸæ•°é‡: ' + fileSections.length);
        
        fileSections.forEach(function(section, index) {
            console.log('   åŒºåŸŸ ' + (index + 1) + ': ' + section.id);
            console.log('     å†…å®¹: "' + section.textContent.trim() + '"');
            console.log('     å¯è§æ€§: ' + (section.offsetParent ? 'âœ…' : 'âŒ'));
        });
        
        // æ£€æŸ¥æ ·å¼
        const computedStyle = window.getComputedStyle(backElement);
        console.log('   æ ·å¼ä¿¡æ¯:');
        console.log('     display: ' + computedStyle.display);
        console.log('     position: ' + computedStyle.position);
        console.log('     transform: ' + computedStyle.transform);
        console.log('     zIndex: ' + computedStyle.zIndex);
    }
};

console.log('ğŸ’¡ æŸ¥çœ‹ç¿»è½¬å¡ç‰‡å‡½æ•°å·²æ·»åŠ : inspectFlippedCard()');

// å½»åº•è¯Šæ–­èƒŒé¢å†…å®¹å‡½æ•°
window.thoroughBackDiagnosis = function() {
    console.log('ğŸ” å¼€å§‹å½»åº•è¯Šæ–­èƒŒé¢å…ƒç´ å†…å®¹...');
    
    // å¼ºåˆ¶è¾“å‡ºåˆ°æ§åˆ¶å°
    console.log('%c=== èƒŒé¢å…ƒç´ è¯Šæ–­æŠ¥å‘Š ===', 'color: #007bff; font-weight: bold; font-size: 16px;');
    
    const taskBacks = document.querySelectorAll('.task-back');
    console.log('ğŸ“Š æ‰¾åˆ°èƒŒé¢å…ƒç´ æ•°é‡: ' + taskBacks.length);
    
    if (taskBacks.length === 0) {
        console.log('%câŒ æœªæ‰¾åˆ°ä»»ä½•.task-backå…ƒç´ !', 'color: #dc3545; font-weight: bold;');
        return;
    }
    
    // é€ä¸€æ£€æŸ¥æ¯ä¸ªèƒŒé¢å…ƒç´ 
    taskBacks.forEach(function(backElement, index) {
        const taskId = backElement.dataset.taskId || 'unknown';
        console.log('');
        console.log('%c--- èƒŒé¢å…ƒç´  #' + (index + 1) + ' (ä»»åŠ¡ID: ' + taskId + ') ---', 'color: #28a745; font-weight: bold;');
        
        // åŸºæœ¬ä¿¡æ¯æ£€æŸ¥
        console.log('ğŸ“‹ åŸºæœ¬å±æ€§:');
        console.log('   tagName: ' + backElement.tagName);
        console.log('   className: ' + backElement.className);
        console.log('   id: ' + (backElement.id || 'æ— ')); 
        console.log('   dataset.taskId: ' + backElement.dataset.taskId);
        console.log('   parentNode: ' + (backElement.parentNode ? backElement.parentNode.className : 'æ— çˆ¶èŠ‚ç‚¹'));
        
        // å¯è§æ€§æ£€æŸ¥
        console.log('ğŸ‘ï¸  å¯è§æ€§çŠ¶æ€:');
        console.log('   offsetParent: ' + (backElement.offsetParent ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
        console.log('   offsetWidth: ' + backElement.offsetWidth);
        console.log('   offsetHeight: ' + backElement.offsetHeight);
        
        // å†…å®¹æ£€æŸ¥
        console.log('ğŸ“„ å†…å®¹åˆ†æ:');
        console.log('   innerHTMLé•¿åº¦: ' + backElement.innerHTML.length);
        console.log('   textContenté•¿åº¦: ' + backElement.textContent.length);
        console.log('   HTMLå†…å®¹é¢„è§ˆ:');
        console.log('   ' + backElement.innerHTML.substring(0, 300) + (backElement.innerHTML.length > 300 ? '...' : ''));
        
        // å­å…ƒç´ æ£€æŸ¥
        console.log('ğŸ§© å­å…ƒç´ ç»“æ„:');
        const children = Array.from(backElement.children);
        console.log('   ç›´æ¥å­å…ƒç´ æ•°é‡: ' + children.length);
        children.forEach(function(child, childIndex) {
            console.log('   å­å…ƒç´  ' + (childIndex + 1) + ':');
            console.log('     - tagName: ' + child.tagName);
            console.log('     - id: ' + (child.id || 'æ— '));
            console.log('     - className: ' + (child.className || 'æ— '));
            console.log('     - textContenté¢„è§ˆ: "' + child.textContent.trim().substring(0, 50) + '"');
        });
        
        // æ–‡ä»¶åŒºåŸŸæ£€æŸ¥
        console.log('ğŸ“ æ–‡ä»¶åŒºåŸŸæ£€æŸ¥:');
        const fileSections = backElement.querySelectorAll('[id$="-files-' + taskId + '"]');
        console.log('   åŒ¹é…çš„æ–‡ä»¶åŒºåŸŸæ•°é‡: ' + fileSections.length);
        fileSections.forEach(function(section, secIndex) {
            console.log('   æ–‡ä»¶åŒºåŸŸ ' + (secIndex + 1) + ':');
            console.log('     - id: ' + section.id);
            console.log('     - tagName: ' + section.tagName);
            console.log('     - className: ' + (section.className || 'æ— '));
            console.log('     - å†…å®¹: "' + section.textContent.trim() + '"');
            console.log('     - å¯è§æ€§: ' + (section.offsetParent ? 'âœ… å¯è§' : 'âŒ ä¸å¯è§'));
        });
        
        // CSSæ ·å¼æ£€æŸ¥
        console.log('ğŸ¨ CSSæ ·å¼æ£€æŸ¥:');
        try {
            const computedStyle = window.getComputedStyle(backElement);
            console.log('   display: ' + computedStyle.display);
            console.log('   position: ' + computedStyle.position);
            console.log('   transform: ' + computedStyle.transform);
            console.log('   backfaceVisibility: ' + computedStyle.backfaceVisibility);
            console.log('   webkitBackfaceVisibility: ' + computedStyle.webkitBackfaceVisibility);
            console.log('   zIndex: ' + computedStyle.zIndex);
            console.log('   backgroundColor: ' + computedStyle.backgroundColor);
            console.log('   visibility: ' + computedStyle.visibility);
        } catch (e) {
            console.log('   âŒ è·å–è®¡ç®—æ ·å¼æ—¶å‡ºé”™: ' + e.message);
        }
        
        console.log('---');
    });
    
    // ç¿»è½¬çŠ¶æ€æ£€æŸ¥
    console.log('');
    console.log('%cğŸ”„ ç¿»è½¬çŠ¶æ€æ£€æŸ¥', 'color: #ffc107; font-weight: bold;');
    const flippedContainers = document.querySelectorAll('.task-flip-container.flipped');
    console.log('å½“å‰ç¿»è½¬çš„ä»»åŠ¡æ•°é‡: ' + flippedContainers.length);
    
    flippedContainers.forEach(function(container, index) {
        const taskId = container.dataset.taskId || 'unknown';
        const front = container.querySelector('.task-front');
        const back = container.querySelector('.task-back');
        
        console.log('ç¿»è½¬ä»»åŠ¡ #' + (index + 1) + ' (ID: ' + taskId + '):');
        console.log('  æ­£é¢å…ƒç´ : ' + (front ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
        console.log('  èƒŒé¢å…ƒç´ : ' + (back ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
        
        if (front) {
            console.log('  æ­£é¢å¯è§æ€§: ' + (front.offsetParent ? 'âœ… å¯è§' : 'âŒ ä¸å¯è§'));
        }
        if (back) {
            console.log('  èƒŒé¢å¯è§æ€§: ' + (back.offsetParent ? 'âœ… å¯è§' : 'âŒ ä¸å¯è§'));
            console.log('  èƒŒé¢HTMLé•¿åº¦: ' + back.innerHTML.length);
            console.log('  èƒŒé¢æ–‡æœ¬é¢„è§ˆ: "' + back.textContent.trim().substring(0, 100) + '"');
        }
        
        // æ£€æŸ¥å®¹å™¨æ ·å¼
        try {
            const containerStyle = window.getComputedStyle(container);
            console.log('  å®¹å™¨transform: ' + containerStyle.transform);
            console.log('  å®¹å™¨perspective: ' + containerStyle.perspective);
        } catch (e) {
            console.log('  âŒ è·å–å®¹å™¨æ ·å¼æ—¶å‡ºé”™');
        }
        
        console.log('---');
    });
    
    // æ€»ç»“
    console.log('');
    console.log('%c=== è¯Šæ–­å®Œæˆ ===', 'color: #007bff; font-weight: bold; font-size: 16px;');
    
    return {
        backElements: taskBacks.length,
        flippedContainers: flippedContainers.length
    };
};

console.log('âœ… å½»åº•è¯Šæ–­å‡½æ•°å·²æ›´æ–°: thoroughBackDiagnosis()');
</script>

<!-- ä»»åŠ¡å¡ç‰‡ç¿»è½¬å¢å¼ºæ ·å¼ -->
<style>
/* ä»»åŠ¡å¡ç‰‡ç¿»è½¬å¢å¼ºæ ·å¼ */
.task-flip-container {
    perspective: 1500px !important;
    transform-style: preserve-3d !important;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1) !important;
    position: relative !important;
    width: 100% !important;
    height: 100% !important;
    cursor: pointer !important;
}

.task-flip-container.flipped {
    transform: rotateY(180deg) !important;
}

.task-front, .task-back {
    backface-visibility: hidden !important;
    -webkit-backface-visibility: hidden !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    border-radius: 10px !important;
    display: flex !important;
    flex-direction: column !important;
    box-sizing: border-box !important;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08) !important;
}

.task-front {
    z-index: 2 !important;
    background-color: white !important;
    transform: rotateY(0deg) !important;
}

.task-back {
    z-index: 1 !important;
    background-color: white !important;
    transform: rotateY(180deg) !important;
}

/* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ‚¬åœæ•ˆæœ */
[id$='-files-'] {
    transition: all 0.2s ease !important;
}

[id$='-files-']:hover {
    background-color: #e9ecef !important;
    border-color: #0d6efd !important;
}

/* æ–‡ä»¶é¡¹æ ·å¼ */
.file-item {
    transition: all 0.2s ease !important;
}

.file-item:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
}

/* æŒ‰é’®æ‚¬åœæ•ˆæœ */
button:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
}

/* æ–‡ä»¶çŠ¶æ€æŒ‡ç¤ºå™¨åŠ¨ç”» */
@keyframes pulseSuccess {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}

.file-status-uploaded {
    animation: pulseSuccess 1s ease-in-out !important;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .task-flip-container {
        height: 350px !important;
    }
    
    .task-back-content {
        padding: 10px !important;
    }
    
    [id$='-files-'] {
        min-height: 60px !important;
        padding: 8px !important;
    }
}

/* æ‰“å°æ ·å¼ */
@media print {
    .task-flip-container {
        perspective: none !important;
        transform: none !important;
    }
    
    .task-back {
        transform: none !important;
        position: static !important;
    }
    
    .no-print {
        display: none !important;
    }
}
</style>

<!-- ä»»åŠ¡å¡ç‰‡ç¿»è½¬åŠŸèƒ½ç»ˆæä¿®å¤è„šæœ¬ -->
<script>
(function() {
    'use strict';
    
    // å¼ºåˆ¶å…¨å±€ä¿®å¤æ ‡å¿—
    window.FLIP_FIX_ACTIVE = true;
    
    // ç»ˆæç¿»è½¬è§£å†³æ–¹æ¡ˆ - ç›´æ¥æ“ä½œDOM
    function ultimateFlipSolution() {
        console.log('âš”ï¸ å¯åŠ¨ç»ˆæç¿»è½¬è§£å†³æ–¹æ¡ˆ...');
        
        // é˜²æ­¢é‡å¤å¤„ç†çš„æ ‡è®°
        const processedTasks = new Set();
        let handlerInterval = null;
        
        // ç›´æ¥ä¸ºæ¯ä¸ªä»»åŠ¡å¡ç‰‡æ·»åŠ ç‚¹å‡»å¤„ç†å™¨
        function attachDirectHandlers() {
            const allTasks = document.querySelectorAll('.task-flip-container');
            
            // åªåœ¨æœ‰æ–°ä»»åŠ¡æ—¶æ‰è¾“å‡ºæ—¥å¿—
            if (allTasks.length > processedTasks.size) {
                console.log(`ğŸ¯ æ‰¾åˆ° ${allTasks.length} ä¸ªä»»åŠ¡å®¹å™¨`);
            }
            
            let newTasksAdded = false;
            
            allTasks.forEach((container, index) => {
                const taskId = container.dataset.taskId;
                if (!taskId || processedTasks.has(taskId)) return;
                
                // æ ‡è®°ä¸ºå·²å¤„ç†
                processedTasks.add(taskId);
                newTasksAdded = true;
                
                // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨
                const clone = container.cloneNode(true);
                container.parentNode.replaceChild(clone, container);
                
                // ä¸ºå…‹éš†çš„å®¹å™¨æ·»åŠ ç›´æ¥çš„ç‚¹å‡»å¤„ç†
                clone.onclick = function(e) {
                    // æ’é™¤æŒ‰é’®ç‚¹å‡»
                    if (e.target.closest('button') || 
                        e.target.closest('[data-action]') ||
                        e.target.tagName === 'BUTTON') {
                        return;
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // å‡å°‘æ—¥å¿—è¾“å‡ºé¢‘ç‡
                    if (Math.random() < 0.1) { // 10%çš„æ¦‚ç‡è¾“å‡ºæ—¥å¿—
                        console.log(`âš”ï¸ ç›´æ¥è§¦å‘ç¿»è½¬ - ä»»åŠ¡: ${taskId}`);
                    }
                    
                    // ç›´æ¥æ‰§è¡Œç¿»è½¬æ“ä½œ
                    this.classList.toggle('flipped');
                    const isFlipped = this.classList.contains('flipped');
                    if (Math.random() < 0.05) { // 5%çš„æ¦‚ç‡è¾“å‡ºçŠ¶æ€æ—¥å¿—
                        console.log(`âœ… ä»»åŠ¡ ${taskId} ç¿»è½¬çŠ¶æ€: ${isFlipped ? 'èƒŒé¢' : 'æ­£é¢'}`);
                    }
                };
                
                // æ·»åŠ è§¦æ‘¸æ”¯æŒ
                clone.ontouchstart = clone.onclick;
                
                console.log(`âœ… ä¸ºä»»åŠ¡ ${taskId} æ·»åŠ ç›´æ¥å¤„ç†å™¨`);
            });
            
            // å¦‚æœæ²¡æœ‰æ–°ä»»åŠ¡æ·»åŠ ï¼Œå‡å°‘æ—¥å¿—è¾“å‡º
            if (!newTasksAdded && allTasks.length > 0) {
                if (Math.random() < 0.02) { // 2%çš„æ¦‚ç‡è¾“å‡ºç»´æŠ¤æ—¥å¿—
                    console.log(`ğŸ›¡ï¸ ç»´æŠ¤ç¿»è½¬å¤„ç†å™¨ - å½“å‰ä»»åŠ¡æ•°: ${allTasks.length}`);
                }
            }
        }
        
        // ä½¿ç”¨æ›´é•¿çš„é—´éš”ï¼Œå¹¶æ·»åŠ æ¡ä»¶æ£€æŸ¥
        if (handlerInterval) {
            clearInterval(handlerInterval);
        }
        
        handlerInterval = setInterval(() => {
            // åªåœ¨éœ€è¦æ—¶æ‰æ‰§è¡Œ
            const currentTasks = document.querySelectorAll('.task-flip-container');
            if (currentTasks.length !== processedTasks.size) {
                attachDirectHandlers();
            }
        }, 3000); // 3ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯1ç§’
        
        // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œä½†å‡å°‘é‡å¤è°ƒç”¨
        setTimeout(attachDirectHandlers, 100);
        setTimeout(() => {
            if (document.querySelectorAll('.task-flip-container').length !== processedTasks.size) {
                attachDirectHandlers();
            }
        }, 1000);
        
        console.log('âœ… ç»ˆæç¿»è½¬è§£å†³æ–¹æ¡ˆå·²å¯åŠ¨');
    }
    
    // å¯åŠ¨ç»ˆæè§£å†³æ–¹æ¡ˆ
    setTimeout(ultimateFlipSolution, 2000);
    
    console.log('ğŸš€ å¯åŠ¨ä»»åŠ¡å¡ç‰‡ç¿»è½¬åŠŸèƒ½ä¿®å¤...');
    
    // ç¿»è½¬å†·å´æ§åˆ¶
    const flipCooldown = new Map();
    
    // åˆ›å»ºç»Ÿä¸€ç¿»è½¬å‡½æ•°
    function createFlipFunction() {
        if (typeof window.toggleTaskCardFlip === 'function') {
            console.log('âœ… ç¿»è½¬å‡½æ•°å·²å­˜åœ¨');
            return;
        }
        
        window.toggleTaskCardFlip = function(taskId) {
            console.log(`ğŸ”„ æ‰§è¡Œç¿»è½¬ - ä»»åŠ¡ID: ${taskId}`);
            
            try {
                // é˜²æŠ–æ§åˆ¶
                const now = Date.now();
                const lastFlip = flipCooldown.get(taskId) || 0;
                if (now - lastFlip < 300) {
                    console.log(`â³ ä»»åŠ¡ ${taskId} ç¿»è½¬å†·å´ä¸­`);
                    return;
                }
                flipCooldown.set(taskId, now);
                
                // å¤šé‡ç­–ç•¥æŸ¥æ‰¾ç¿»è½¬å®¹å™¨
                let flipContainer = null;
                
                // ç­–ç•¥1: ç›´æ¥é€šè¿‡data-task-idæŸ¥æ‰¾
                flipContainer = document.querySelector(`.task-flip-container[data-task-id="${taskId}"]`);
                
                // ç­–ç•¥2: é€šè¿‡æ­£é¢å…ƒç´ æŸ¥æ‰¾
                if (!flipContainer) {
                    const frontElement = document.querySelector(`#task-${taskId}-front`);
                    if (frontElement) {
                        flipContainer = frontElement.closest('.task-flip-container');
                    }
                }
                
                // ç­–ç•¥3: é€šè¿‡ä»»åŠ¡IDæ¨¡å¼æŸ¥æ‰¾
                if (!flipContainer) {
                    const allContainers = document.querySelectorAll('.task-flip-container');
                    for (let container of allContainers) {
                        if (container.dataset.taskId === taskId) {
                            flipContainer = container;
                            break;
                        }
                    }
                }
                
                if (!flipContainer) {
                    console.error(`âŒ æœªæ‰¾åˆ°ä»»åŠ¡å®¹å™¨: ${taskId}`);
                    // å¼ºåˆ¶é‡æ–°æ£€æŸ¥DOMç»“æ„
                    ensureDOMStructure();
                    return;
                }
                
                // ç¡®ä¿å®¹å™¨æœ‰å¿…è¦çš„æ ·å¼ç±»
                if (!flipContainer.classList.contains('task-flip-container')) {
                    flipContainer.classList.add('task-flip-container');
                }
                
                // æ‰§è¡Œç¿»è½¬
                flipContainer.classList.toggle('flipped');
                const isFlipped = flipContainer.classList.contains('flipped');
                
                console.log(`âœ… ä»»åŠ¡ ${taskId} ç¿»è½¬çŠ¶æ€: ${isFlipped ? 'èƒŒé¢' : 'æ­£é¢'}`);
                
                // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿æ ·å¼ç”Ÿæ•ˆ
                flipContainer.style.transform = flipContainer.style.transform;
                
                // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
                const flipEvent = new CustomEvent('taskCardFlipped', {
                    detail: {
                        taskId: taskId,
                        flipped: isFlipped,
                        element: flipContainer
                    }
                });
                document.dispatchEvent(flipEvent);
                
            } catch (error) {
                console.error(`âŒ ç¿»è½¬ä»»åŠ¡ ${taskId} æ—¶å‘ç”Ÿé”™è¯¯:`, error);
                // å‘ç”Ÿé”™è¯¯æ—¶æ¸…é™¤å†·å´çŠ¶æ€
                flipCooldown.delete(taskId);
            }
        };
        
        console.log('âœ… ç¿»è½¬å‡½æ•°å·²åˆ›å»º');
    }
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    function bindEventListeners() {
        console.log('ğŸ”— ç»‘å®šäº‹ä»¶ç›‘å¬å™¨...');
        
        // å¼ºåˆ¶ç§»é™¤æ‰€æœ‰å¯èƒ½çš„ç›‘å¬å™¨
        if (window._flipEventListener) {
            document.removeEventListener('click', window._flipEventListener, true);
            document.removeEventListener('click', window._flipEventListener, false);
        }
        
        // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å…¶ä»–ç¿»è½¬ç›‘å¬å™¨
        // æ³¨ï¼šç§»é™¤äº†å¯¹getEventListenersçš„ä¾èµ–ï¼Œè¯¥å‡½æ•°ä»…åœ¨å¼€å‘è€…å·¥å…·ä¸­å¯ç”¨
        console.log('ğŸ§¹ æ¸…ç†ç°æœ‰ç¿»è½¬ç›‘å¬å™¨...');
        
        // åˆ›å»ºå…¨æ–°çš„ç›‘å¬å™¨å‡½æ•°
        window._flipEventListener = function(e) {
            try {
                // å¼ºåˆ¶æ£€æŸ¥ç›®æ ‡å…ƒç´ 
                const target = e.target;
                
                // ç›´æ¥æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å…·æœ‰data-task-idçš„å…ƒç´ 
                let taskId = target.dataset.taskId;
                let flipContainer = target.closest('.task-flip-container');
                
                // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå‘ä¸ŠæŸ¥æ‰¾çˆ¶å…ƒç´ 
                if (!flipContainer) {
                    let parent = target.parentElement;
                    while (parent && !flipContainer) {
                        if (parent.classList && parent.classList.contains('task-flip-container')) {
                            flipContainer = parent;
                            taskId = parent.dataset.taskId;
                        }
                        parent = parent.parentElement;
                    }
                }
                
                // å¦‚æœæ‰¾åˆ°äº†ç¿»è½¬å®¹å™¨å¹¶ä¸”æœ‰ä»»åŠ¡ID
                if (flipContainer && (taskId || flipContainer.dataset.taskId)) {
                    const finalTaskId = taskId || flipContainer.dataset.taskId;
                    
                    // ä¸¥æ ¼æ’é™¤æŒ‰é’®å’Œæ“ä½œåŒºåŸŸ
                    const isActionButton = target.closest('[data-action]') || 
                                         target.closest('button') || 
                                         target.tagName === 'BUTTON' ||
                                         (target.textContent && target.textContent.includes('å‘è´§')) ||
                                         target.classList.contains('btn');
                    
                    if (!isActionButton) {
                        // å‡å°‘æ—¥å¿—è¾“å‡ºé¢‘ç‡
                        if (Math.random() < 0.05) { // 5%æ¦‚ç‡è¾“å‡ºæ—¥å¿—
                            console.log(`ğŸ¯ æ•è·ç¿»è½¬ç‚¹å‡» - ä»»åŠ¡ID: ${finalTaskId}`);
                        }
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        
                        // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿å…¶ä»–äº‹ä»¶å¤„ç†å®Œæˆ
                        setTimeout(() => {
                            if (typeof window.toggleTaskCardFlip === 'function') {
                                window.toggleTaskCardFlip(finalTaskId);
                            } else {
                                if (Math.random() < 0.1) { // 10%æ¦‚ç‡è¾“å‡ºé”™è¯¯æ—¥å¿—
                                    console.error('âŒ ç¿»è½¬å‡½æ•°ä¸å­˜åœ¨');
                                }
                                // ç´§æ€¥é‡æ–°åˆ›å»º
                                createFlipFunction();
                                window.toggleTaskCardFlip(finalTaskId);
                            }
                        }, 0);
                    }
                }
            } catch (error) {
                console.error('âŒ äº‹ä»¶ç›‘å¬å™¨é”™è¯¯:', error);
            }
        };
        
        // ä½¿ç”¨å¤šä¸ªé˜¶æ®µç»‘å®šç¡®ä¿æ•è·æ‰€æœ‰ç‚¹å‡»
        document.addEventListener('click', window._flipEventListener, true);  // æ•è·é˜¶æ®µ
        document.addEventListener('click', window._flipEventListener, false); // å†’æ³¡é˜¶æ®µ
        
        console.log('âœ… äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
    }
    
    // ç¡®ä¿DOMç»“æ„å®Œæ•´
    function ensureDOMStructure() {
        // å‡å°‘æ—¥å¿—è¾“å‡ºé¢‘ç‡
        if (Math.random() < 0.1) { // 10%æ¦‚ç‡è¾“å‡ºæ—¥å¿—
            console.log('ğŸ—ï¸ æ£€æŸ¥DOMç»“æ„å®Œæ•´æ€§...');
        }
        
        const frontElements = document.querySelectorAll('div[id^="task-"][id$="-front"].task-front');
        // åªåœ¨å…ƒç´ æ•°é‡å˜åŒ–æ—¶è¾“å‡ºæ—¥å¿—
        if (frontElements.length > 0 && Math.random() < 0.05) { // 5%æ¦‚ç‡è¾“å‡º
            console.log(`ğŸ” æ‰¾åˆ° ${frontElements.length} ä¸ªä»»åŠ¡æ­£é¢å…ƒç´ `);
        }
        
        frontElements.forEach(frontElement => {
            const taskIdMatch = frontElement.id.match(/task-(.+)-front/);
            if (!taskIdMatch) return;
            
            const taskId = taskIdMatch[1];
            let flipContainer = frontElement.closest('.task-flip-container');
            
            // å¦‚æœæ²¡æœ‰ç¿»è½¬å®¹å™¨ï¼Œåˆ›å»ºä¸€ä¸ª
            if (!flipContainer) {
                console.log(`ğŸ—ï¸ ä¸ºä»»åŠ¡ ${taskId} åˆ›å»ºç¿»è½¬å®¹å™¨...`);
                flipContainer = document.createElement('div');
                flipContainer.className = 'task-flip-container';
                flipContainer.dataset.taskId = taskId;
                
                // è®¾ç½®å¿…è¦æ ·å¼
                Object.assign(flipContainer.style, {
                    'perspective': '1500px',
                    'transform-style': 'preserve-3d',
                    'transition': 'transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)',
                    'position': 'relative',
                    'cursor': 'pointer',
                    'width': '100%',
                    'height': '100%'
                });
                
                // é‡æ–°ç»„ç»‡DOMç»“æ„
                const parent = frontElement.parentElement;
                parent.replaceChild(flipContainer, frontElement);
                flipContainer.appendChild(frontElement);
                
                console.log(`âœ… ä»»åŠ¡ ${taskId} ç¿»è½¬å®¹å™¨åˆ›å»ºå®Œæˆ`);
            }
        });
    }
    
    // ç›‘æ§DOMå˜åŒ–
    function setupDOMObserver() {
        console.log('ğŸ‘ï¸ è®¾ç½®DOMå˜åŒ–ç›‘æ§...');
        
        // æ¸…é™¤å·²å­˜åœ¨çš„è§‚å¯Ÿå™¨
        if (window._flipMutationObserver) {
            window._flipMutationObserver.disconnect();
        }
        
        const observer = new MutationObserver(function(mutations) {
            let shouldRebind = false;
            
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    // æ£€æŸ¥æ–°å¢èŠ‚ç‚¹
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            const newFrontElements = node.querySelectorAll ? 
                                node.querySelectorAll('div[id^="task-"][id$="-front"].task-front') : [];
                            if (newFrontElements.length > 0) {
                                console.log(`ğŸ”„ æ£€æµ‹åˆ°æ–°çš„ä»»åŠ¡å¡ç‰‡`);
                                shouldRebind = true;
                            }
                        }
                    });
                    
                    // æ£€æŸ¥ç§»é™¤èŠ‚ç‚¹ï¼ˆç‰¹åˆ«æ˜¯ç¡®è®¤å‘è´§åï¼‰
                    mutation.removedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // æ£€æŸ¥æ˜¯å¦ç§»é™¤äº†ç¿»è½¬å®¹å™¨
                            if (node.classList && node.classList.contains('task-flip-container')) {
                                console.log('ğŸ”„ æ£€æµ‹åˆ°ç¿»è½¬å®¹å™¨è¢«ç§»é™¤ï¼Œé‡æ–°ç»‘å®šäº‹ä»¶');
                                shouldRebind = true;
                            }
                        }
                    });
                }
                
                // æ£€æŸ¥å±æ€§å˜åŒ–
                if (mutation.type === 'attributes' && mutation.target.classList) {
                    if (mutation.target.classList.contains('task-flip-container')) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯çŠ¶æ€å˜åŒ–ï¼ˆå¦‚ç¡®è®¤å‘è´§åï¼‰
                        if (mutation.attributeName === 'class' || mutation.attributeName === 'data-task-id') {
                            console.log('ğŸ”„ æ£€æµ‹åˆ°ç¿»è½¬å®¹å™¨å±æ€§å˜åŒ–');
                            shouldRebind = true;
                        }
                    }
                }
            });
            
            // å¦‚æœéœ€è¦é‡æ–°ç»‘å®šï¼Œåˆ™æ‰§è¡Œ
            if (shouldRebind) {
                console.log('ğŸ”„ é‡æ–°åˆå§‹åŒ–ç¿»è½¬åŠŸèƒ½...');
                setTimeout(function() {
                    ensureDOMStructure();
                    bindEventListeners();
                }, 50);
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['class', 'data-task-id']
        });
        
        // ä¿å­˜è§‚å¯Ÿå™¨å¼•ç”¨
        window._flipMutationObserver = observer;
        console.log('âœ… DOMç›‘æ§å·²è®¾ç½®');
    }
    
    // å®Œæ•´åˆå§‹åŒ–æµç¨‹
    function initializeFlipFix() {
        console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–ç¿»è½¬åŠŸèƒ½ä¿®å¤...');
        
        try {
            // å¯åŠ¨å…¨å±€äº‹ä»¶ä¿æŠ¤
            protectGlobalEventSystem();
            
            createFlipFunction();
            ensureDOMStructure();
            bindEventListeners();
            setupDOMObserver();
            
            // ç‰¹åˆ«ç›‘æ§ç¡®è®¤å‘è´§æŒ‰é’®
            monitorShipmentConfirmation();
            
            // å¯åŠ¨å¼ºåˆ¶æ£€æŸ¥æœºåˆ¶
            startForcedCheck();
            
            console.log('âœ… ç¿»è½¬åŠŸèƒ½ä¿®å¤åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('âŒ ç¿»è½¬åŠŸèƒ½ä¿®å¤åˆå§‹åŒ–å¤±è´¥:', error);
        }
    }
    
    // å…¨å±€äº‹ä»¶ç³»ç»Ÿä¿æŠ¤
    function protectGlobalEventSystem() {
        console.log('ğŸ›¡ï¸ å¯åŠ¨å…¨å±€äº‹ä»¶ç³»ç»Ÿä¿æŠ¤...');
        
        // ä¿å­˜åŸå§‹çš„addEventListenerå’ŒremoveEventListener
        const originalAddEventListener = EventTarget.prototype.addEventListener;
        const originalRemoveEventListener = EventTarget.prototype.removeEventListener;
        
        // ä¿æŠ¤å…³é”®å…ƒç´ çš„äº‹ä»¶ç›‘å¬å™¨
        const protectedElements = [
            document,
            window,
            document.body
        ];
        
        // é‡å†™addEventListenerä»¥é˜²æ­¢æ„å¤–ç§»é™¤æˆ‘ä»¬çš„ç›‘å¬å™¨
        EventTarget.prototype.addEventListener = function(type, listener, options) {
            // å¦‚æœæ˜¯æˆ‘ä»¬çš„ç¿»è½¬ç›‘å¬å™¨ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è®°
            if (listener && listener.toString().includes('task-flip-container')) {
                if (!this._protectedFlipListeners) {
                    this._protectedFlipListeners = [];
                }
                this._protectedFlipListeners.push({
                    type: type,
                    listener: listener,
                    options: options
                });
            }
            return originalAddEventListener.call(this, type, listener, options);
        };
        
        // é‡å†™removeEventListenerä»¥ä¿æŠ¤æˆ‘ä»¬çš„ç›‘å¬å™¨
        EventTarget.prototype.removeEventListener = function(type, listener, options) {
            // æ£€æŸ¥æ˜¯å¦è¯•å›¾ç§»é™¤æˆ‘ä»¬çš„ç¿»è½¬ç›‘å¬å™¨
            if (this._protectedFlipListeners) {
                const isProtected = this._protectedFlipListeners.some(protectedListener => 
                    protectedListener.type === type && 
                    protectedListener.listener === listener
                );
                
                if (isProtected) {
                    console.log('ğŸ›¡ï¸ é˜»æ­¢ç§»é™¤å—ä¿æŠ¤çš„ç¿»è½¬ç›‘å¬å™¨');
                    return;
                }
            }
            return originalRemoveEventListener.call(this, type, listener, options);
        };
        
        console.log('âœ… å…¨å±€äº‹ä»¶ç³»ç»Ÿä¿æŠ¤å·²å¯åŠ¨');
    }
    
    // ç›‘æ§ç¡®è®¤å‘è´§æ“ä½œ
    function monitorShipmentConfirmation() {
        console.log('ğŸšš ç›‘æ§ç¡®è®¤å‘è´§æ“ä½œ...');
        
        // å¯åŠ¨å…¨å±€äº‹ä»¶ä¿æŠ¤
        protectGlobalEventSystem();
        
        // æ¿€è¿›çš„å‘è´§æŒ‰é’®åŠ«æŒ
        function hijackShipmentButtons() {
            const shipmentButtons = document.querySelectorAll('[data-action="complete-shipment"], .btn-success[data-task-id]');
            
            shipmentButtons.forEach(button => {
                // ä¿å­˜åŸå§‹ç‚¹å‡»å¤„ç†å‡½æ•°
                const originalOnClick = button.onclick;
                const originalListeners = [];
                
                // æ³¨ï¼šç§»é™¤äº†å¯¹getEventListenersçš„ä¾èµ–ï¼Œè¯¥å‡½æ•°ä»…åœ¨å¼€å‘è€…å·¥å…·ä¸­å¯ç”¨
                console.log('ğŸ“‹ ä¿å­˜å‘è´§æŒ‰é’®çš„åŸå§‹äº‹ä»¶å¤„ç†å™¨');
                
                // é‡å†™ç‚¹å‡»å¤„ç†
                button.onclick = function(e) {
                    console.log('âš”ï¸ åŠ«æŒç¡®è®¤å‘è´§ç‚¹å‡»');
                    
                    // å…ˆæ‰§è¡ŒåŸå§‹åŠŸèƒ½
                    if (originalOnClick) {
                        originalOnClick.call(this, e);
                    }
                    
                    // é‡æ–°ç»‘å®šæ‰€æœ‰ç¿»è½¬åŠŸèƒ½
                    setTimeout(() => {
                        console.log('ğŸ”„ å‘è´§åç«‹å³é‡æ–°ç»‘å®šæ‰€æœ‰ç¿»è½¬åŠŸèƒ½');
                        ultimateFlipSolution();
                    }, 50);
                };
                
                console.log('âœ… åŠ«æŒå‘è´§æŒ‰é’®æˆåŠŸ');
            });
        }
        
        // å®šæœŸåŠ«æŒå‘è´§æŒ‰é’®
        setInterval(hijackShipmentButtons, 2000);
        
        // ç«‹å³æ‰§è¡Œ
        setTimeout(hijackShipmentButtons, 1000);
        
        // ç›‘å¬ç¡®è®¤å‘è´§æŒ‰é’®ç‚¹å‡»
        document.addEventListener('click', function(e) {
            const target = e.target;
            if (target.matches('[data-action="complete-shipment"]') || 
                target.matches('.btn-success[data-task-id]') ||
                (target.textContent && target.textContent.includes('ç¡®è®¤å‘è´§'))) {
                
                console.log('ğŸšš æ£€æµ‹åˆ°ç¡®è®¤å‘è´§æ“ä½œ');
                
                // ç«‹å³å¤‡ä»½å½“å‰çš„ç¿»è½¬çŠ¶æ€
                backupFlipState();
                
                // ç¡®è®¤å‘è´§åç«‹å³é‡æ–°ç»‘å®šæ‰€æœ‰äº‹ä»¶
                setTimeout(function() {
                    console.log('ğŸ”„ ç¡®è®¤å‘è´§åç´§æ€¥é‡æ–°åˆå§‹åŒ–');
                    emergencyRebindAll();
                    ultimateFlipSolution();
                }, 100);
                
                // å»¶è¿ŸäºŒæ¬¡æ£€æŸ¥
                setTimeout(function() {
                    ensureDOMStructure();
                    bindEventListeners();
                    ultimateFlipSolution();
                }, 500);
            }
        }, true);
    }
    
    // å¤‡ä»½ç¿»è½¬çŠ¶æ€
    function backupFlipState() {
        console.log('ğŸ’¾ å¤‡ä»½å½“å‰ç¿»è½¬çŠ¶æ€...');
        window._flipBackup = {
            flipFunction: window.toggleTaskCardFlip,
            eventListener: window._flipEventListener,
            cooldown: new Map(flipCooldown)
        };
    }
    
    // ç´§æ€¥é‡æ–°ç»‘å®šæ‰€æœ‰åŠŸèƒ½
    function emergencyRebindAll() {
        console.log('ğŸš¨ æ‰§è¡Œç´§æ€¥é‡æ–°ç»‘å®š...');
        
        // å¼ºåˆ¶é‡æ–°åˆ›å»ºç¿»è½¬å‡½æ•°
        createFlipFunction();
        
        // å¼ºåˆ¶é‡æ–°ç»‘å®šäº‹ä»¶
        bindEventListeners();
        
        // é‡æ–°è®¾ç½®DOMç›‘æ§
        setupDOMObserver();
        
        // æ¢å¤å†·å´çŠ¶æ€
        if (window._flipBackup && window._flipBackup.cooldown) {
            flipCooldown.clear();
            for (let [key, value] of window._flipBackup.cooldown) {
                flipCooldown.set(key, value);
            }
        }
        
        console.log('âœ… ç´§æ€¥é‡æ–°ç»‘å®šå®Œæˆ');
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeFlipFix);
    } else {
        // å¦‚æœé¡µé¢å·²ç»åŠ è½½å®Œæˆï¼Œå»¶è¿Ÿæ‰§è¡Œ
        setTimeout(initializeFlipFix, 1000);
    }
    
    // æä¾›æ‰‹åŠ¨é‡æ–°åˆå§‹åŒ–çš„æ–¹æ³•
    window.reinitializeFlipFix = function() {
        console.log('ğŸ”„ æ‰‹åŠ¨é‡æ–°åˆå§‹åŒ–ç¿»è½¬åŠŸèƒ½...');
        initializeFlipFix();
    };
    
    // å¼ºåˆ¶å®šæ—¶æ£€æŸ¥æœºåˆ¶
    function startForcedCheck() {
        console.log('â° å¯åŠ¨å¼ºåˆ¶å®šæ—¶æ£€æŸ¥...');
        
        // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ç¿»è½¬åŠŸèƒ½çŠ¶æ€
        setInterval(function() {
            try {
                // æ£€æŸ¥ç¿»è½¬å‡½æ•°æ˜¯å¦å­˜åœ¨
                if (typeof window.toggleTaskCardFlip !== 'function') {
                    console.log('ğŸ”§ æ£€æµ‹åˆ°ç¿»è½¬å‡½æ•°ç¼ºå¤±ï¼Œé‡æ–°åˆ›å»º...');
                    createFlipFunction();
                }
                
                // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦æ­£å¸¸
                const testContainer = document.querySelector('.task-flip-container');
                if (testContainer) {
                    // æ£€æŸ¥æ˜¯å¦èƒ½æ­£ç¡®è·å–ä»»åŠ¡ID
                    const taskId = testContainer.dataset.taskId;
                    if (!taskId) {
                        console.log('ğŸ”§ æ£€æµ‹åˆ°ä»»åŠ¡IDç¼ºå¤±ï¼Œé‡æ–°ç»‘å®šç»“æ„...');
                        ensureDOMStructure();
                    }
                }
                
                // ç¡®ä¿äº‹ä»¶ç›‘å¬å™¨å§‹ç»ˆå­˜åœ¨
                if (!window._flipEventListener) {
                    console.log('ğŸ”§ æ£€æµ‹åˆ°äº‹ä»¶ç›‘å¬å™¨ç¼ºå¤±ï¼Œé‡æ–°ç»‘å®š...');
                    bindEventListeners();
                }
                
            } catch (error) {
                console.error('âŒ å®šæ—¶æ£€æŸ¥å‡ºé”™:', error);
            }
        }, 2000);
    }
    
    // ç«‹å³å¯åŠ¨å®šæ—¶æ£€æŸ¥
    setTimeout(startForcedCheck, 3000);
    
    console.log('âœ… ä»»åŠ¡å¡ç‰‡ç¿»è½¬ä¿®å¤è„šæœ¬å·²åŠ è½½');
    
    // æ·»åŠ å¼ºåˆ¶åˆ·æ–°ä»“åº“ä»»åŠ¡å‡½æ•°
    window.forceRefreshWarehouseTasks = async function() {
        console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°ä»“åº“ä»»åŠ¡...');
        try {
            const response = await fetch('/api/tasks');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const tasks = await response.json();
            const pendingTasks = tasks.filter(t => t.status === 'pending');
            
            console.log('ğŸ“‹ è·å–åˆ°å¾…å‘è´§ä»»åŠ¡:', pendingTasks.length, 'ä¸ª');
            
            const container = document.getElementById('warehouseTasks');
            if (!container) {
                console.error('âŒ æœªæ‰¾åˆ°ä»“åº“ä»»åŠ¡å®¹å™¨');
                return;
            }
            
            if (pendingTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-check-circle fa-2x mb-3"></i>
                        <p>æš‚æ— å¾…å‘è´§ä»»åŠ¡</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            pendingTasks.forEach((task, index) => {
                const taskId = task.id || `task-${index}`;
                const firstItem = task.items && task.items[0];
                const productName = firstItem ? firstItem.productName : 'æœªçŸ¥å•†å“';
                const productCode = firstItem ? firstItem.productCode : 'æ— è´§å·';
                const quantity = firstItem ? firstItem.quantity : 0;
                const productImage = firstItem ? firstItem.productImage : null;
                const creatorName = task.creator_name || task.creatorName || 'æœªçŸ¥';
                
                const taskElement = document.createElement('div');
                taskElement.className = 'task-flip-container warehouse-task-initialized';
                taskElement.dataset.taskId = taskId;
                
                taskElement.innerHTML = `
                    <div class="task-front" id="task-${taskId}-front">
                        <div class="task-gallery-img">
                            ${productImage ? 
                                `<img src="${productImage}" alt="äº§å“å›¾ç‰‡" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                '<div class="d-flex align-items-center justify-content-center h-100"><i class="fas fa-image fa-2x text-muted"></i></div>'
                            }
                        </div>
                        <div class="task-card-content d-flex align-items-center gap-2 w-100">
                            <div class="task-info-inline d-flex align-items-center gap-2 flex-shrink-0 ms-auto">
                                <div class="task-gallery-name" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px;">
                                    ${productName}
                                </div>
                                <div class="task-gallery-code" data-content="${productCode}" style="font-size: 0.75rem; color: #666; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;">
                                    è´§å·: ${productCode}
                                </div>
                                <div class="task-gallery-qty" data-content="${quantity}" style="font-size: 0.75rem; color: #888; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100px;">
                                    æ•°é‡: ${quantity}
                                </div>
                                <div class="task-gallery-creator" data-content="${creatorName}" style="font-size: 0.7rem; color: #999; margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 80px;">
                                    åˆ›å»ºäºº: ${creatorName}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="task-back">
                        <div class="task-back-content">
                            <div class="task-back-header">
                                <h5>${productName}</h5>
                                <p>è´§å·: ${productCode} | æ•°é‡: ${quantity}</p>
                            </div>
                            <div class="task-actions">
                                <button class="btn btn-primary btn-sm confirm-shipment-btn" data-task-id="${taskId}">
                                    <i class="fas fa-truck"></i> ç¡®è®¤å‘è´§
                                </button>
                                <button class="btn btn-danger btn-sm delete-task-btn" data-task-id="${taskId}">
                                    <i class="fas fa-trash"></i> åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(taskElement);
            });
            
            bindWarehouseTaskEvents();
            console.log('âœ… ä»“åº“ä»»åŠ¡åˆ·æ–°å®Œæˆ');
            
        } catch (error) {
            console.error('âŒ å¼ºåˆ¶åˆ·æ–°å¤±è´¥:', error);
            alert('åˆ·æ–°å¤±è´¥: ' + error.message);
        }
    };
    
    console.log('âœ… å¼ºåˆ¶åˆ·æ–°å‡½æ•°å·²æ·»åŠ : window.forceRefreshWarehouseTasks()');
    
})();
</script>
